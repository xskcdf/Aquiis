@page "/administration/organizations/view/{Id:guid}"

@using Aquiis.SimpleStart.Core.Entities
@using Aquiis.SimpleStart.Application.Services
@using Aquiis.SimpleStart.Shared.Services
@using Aquiis.SimpleStart.Shared.Components.Account
@using Aquiis.SimpleStart.Core.Constants
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity

@inject OrganizationService OrganizationService
@inject UserContextService UserContext
@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager Navigation
@inject ToastService ToastService

@attribute [OrganizationAuthorize("Owner", "Administrator")]
@rendermode InteractiveServer

<PageTitle>View Organization - Administration</PageTitle>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="bi bi-building"></i> Organization Details</h1>
        <div class="btn-group">
            @if (isOwner)
            {
                <button class="btn btn-primary" @onclick="NavigateToEdit">
                    <i class="bi bi-pencil"></i> Edit
                </button>
            }
            <button class="btn btn-outline-secondary" @onclick="Cancel">
                <i class="bi bi-arrow-left"></i> Back to Organizations
            </button>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (organization == null)
    {
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle"></i> Organization not found or you don't have permission to view it.
        </div>
    }
    else
    {
        <div class="row">
            <div class="col-md-8">
                <!-- Organization Information Card -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Organization Information</h5>
                    </div>
                    <div class="card-body">
                        <dl class="row">
                            <dt class="col-sm-3">Organization Name:</dt>
                            <dd class="col-sm-9"><strong>@organization.Name</strong></dd>

                            <dt class="col-sm-3">Display Name:</dt>
                            <dd class="col-sm-9">@(organization.DisplayName ?? "-")</dd>

                            <dt class="col-sm-3">State:</dt>
                            <dd class="col-sm-9">@(organization.State ?? "-")</dd>

                            <dt class="col-sm-3">Status:</dt>
                            <dd class="col-sm-9">
                                @if (organization.IsActive)
                                {
                                    <span class="badge bg-success">Active</span>
                                }
                                else
                                {
                                    <span class="badge bg-secondary">Inactive</span>
                                }
                            </dd>

                            <dt class="col-sm-3">Owner:</dt>
                            <dd class="col-sm-9">@ownerEmail</dd>

                            <dt class="col-sm-3">Created On:</dt>
                            <dd class="col-sm-9">@organization.CreatedOn.ToString("MMMM dd, yyyy")</dd>

                            @if (organization.LastModifiedOn.HasValue)
                            {
                                <dt class="col-sm-3">Last Modified:</dt>
                                <dd class="col-sm-9">@organization.LastModifiedOn.Value.ToString("MMMM dd, yyyy")</dd>
                            }
                        </dl>
                    </div>
                </div>

                <!-- Users with Access Card -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Users with Access</h5>
                        @if (isOwner || isAdministrator && isCurrentOrganization)
                        {
                            <button class="btn btn-sm btn-primary" @onclick="NavigateToManageUsers">
                                <i class="bi bi-people"></i> Manage Users
                            </button>
                        }
                    </div>
                    <div class="card-body p-0">
                        @if (!organizationUsers.Any())
                        {
                            <div class="p-3 text-center text-muted">
                                No users assigned to this organization.
                            </div>
                        }
                        else
                        {
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead>
                                        <tr>
                                            <th>User</th>
                                            <th>Role</th>
                                            <th>Granted By</th>
                                            <th>Granted On</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var userOrg in organizationUsers)
                                        {
                                            <tr>
                                                <td>
                                                    <div>
                                                        <strong>@GetUserEmail(userOrg.UserId)</strong>
                                                    </div>
                                                </td>
                                                <td>
                                                    <span class="badge @GetRoleBadgeClass(userOrg.Role)">
                                                        @userOrg.Role
                                                    </span>
                                                </td>
                                                <td>@GetUserEmail(userOrg.GrantedBy)</td>
                                                <td>@userOrg.GrantedOn.ToString("MMM dd, yyyy")</td>
                                                <td>
                                                    @if (userOrg.IsActive && userOrg.RevokedOn == null)
                                                    {
                                                        <span class="badge bg-success">Active</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge bg-danger">Revoked</span>
                                                    }
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <!-- Quick Stats Card -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="bi bi-bar-chart"></i> Quick Stats</h6>
                    </div>
                    <div class="card-body">
                        <dl class="row mb-0">
                            <dt class="col-sm-7">Total Users:</dt>
                            <dd class="col-sm-5 text-end"><strong>@organizationUsers.Count</strong></dd>

                            <dt class="col-sm-7">Active Users:</dt>
                            <dd class="col-sm-5 text-end"><strong>@organizationUsers.Count(u => u.IsActive)</strong></dd>

                            <dt class="col-sm-7">Owners:</dt>
                            <dd class="col-sm-5 text-end"><strong>@organizationUsers.Count(u => u.Role == ApplicationConstants.OrganizationRoles.Owner)</strong></dd>

                            <dt class="col-sm-7">Administrators:</dt>
                            <dd class="col-sm-5 text-end"><strong>@organizationUsers.Count(u => u.Role == ApplicationConstants.OrganizationRoles.Administrator)</strong></dd>

                            <dt class="col-sm-7">Property Managers:</dt>
                            <dd class="col-sm-5 text-end"><strong>@organizationUsers.Count(u => u.Role == ApplicationConstants.OrganizationRoles.PropertyManager)</strong></dd>
                        </dl>
                    </div>
                </div>

                <!-- Your Access Card -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="bi bi-shield-check"></i> Your Access</h6>
                    </div>
                    <div class="card-body">
                        <p><strong>Your Role:</strong></p>
                        <p>
                            <span class="badge @GetRoleBadgeClass(currentUserRole) fs-6">
                                @currentUserRole
                            </span>
                        </p>
                        <hr />
                        <p class="small mb-0">
                            @if (isOwner)
                            {
                                <span>You have full control over this organization as the Owner.</span>
                            }
                            else if (isAdministrator)
                            {
                                <span>You have administrative access to this organization.</span>
                            }
                            else
                            {
                                <span>You have limited access to this organization.</span>
                            }
                        </p>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public Guid Id { get; set; } = Guid.Empty;

    private bool isLoading = true;
    private Organization? organization;
    private List<UserOrganization> organizationUsers = new();
    private Dictionary<string, string> userEmails = new();
    private string ownerEmail = string.Empty;
    private string currentUserRole = string.Empty;
    private bool isOwner = false;
    private bool isAdministrator = false;

    private bool isCurrentOrganization = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadOrganization();
    }

    private async Task LoadOrganization()
    {
        isLoading = true;
        try
        {
            var userId = await UserContext.GetUserIdAsync();
            var currentOrganizationId = await UserContext.GetActiveOrganizationIdAsync();
            if (string.IsNullOrEmpty(userId))
            {
                return;
            }

            // if the organization being viewed is the current organization
            // allow user management for Owner/Administrator roles
            isCurrentOrganization = Id == currentOrganizationId;

            // Check if user has access to this organization
            var canAccess = await OrganizationService.CanAccessOrganizationAsync(userId, Id);
            if (!canAccess)
            {
                organization = null;
                return;
            }

            organization = await OrganizationService.GetOrganizationByIdAsync(Id);
            if (organization != null)
            {
                // Get owner email
                var owner = await UserManager.FindByIdAsync(organization.OwnerId);
                ownerEmail = owner?.Email ?? "Unknown";

                // Get users with access to this organization
                organizationUsers = await OrganizationService.GetOrganizationUsersAsync(Id);

                // Load user emails
                foreach (var userOrg in organizationUsers)
                {
                    var user = await UserManager.FindByIdAsync(userOrg.UserId);
                    if (user != null)
                    {
                        userEmails[userOrg.UserId] = user.Email ?? "Unknown";
                    }

                    var grantedByUser = await UserManager.FindByIdAsync(userOrg.GrantedBy);
                    if (grantedByUser != null)
                    {
                        userEmails[userOrg.GrantedBy] = grantedByUser.Email ?? "Unknown";
                    }
                }

                // Get current user's role
                var currentUserOrg = organizationUsers.FirstOrDefault(u => u.UserId == userId);
                currentUserRole = currentUserOrg?.Role ?? "Unknown";
                isOwner = currentUserRole == ApplicationConstants.OrganizationRoles.Owner;
                isAdministrator = currentUserRole == ApplicationConstants.OrganizationRoles.Administrator;
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error loading organization: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private string GetUserEmail(string userId)
    {
        return userEmails.ContainsKey(userId) ? userEmails[userId] : "Unknown";
    }

    private string GetRoleBadgeClass(string role)
    {
        return role switch
        {
            ApplicationConstants.OrganizationRoles.Owner => "bg-primary",
            ApplicationConstants.OrganizationRoles.Administrator => "bg-info",
            ApplicationConstants.OrganizationRoles.PropertyManager => "bg-success",
            ApplicationConstants.OrganizationRoles.User => "bg-secondary",
            _ => "bg-secondary"
        };
    }

    private void NavigateToEdit()
    {
        Navigation.NavigateTo($"/administration/organizations/edit/{Id}");
    }

    private void NavigateToManageUsers()
    {
        Navigation.NavigateTo($"/administration/organizations/{Id}/users");
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/administration/organizations");
    }
}
