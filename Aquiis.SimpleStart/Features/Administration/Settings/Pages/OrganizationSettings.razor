@page "/administration/settings/organization"

@using Aquiis.SimpleStart.Core.Entities
@using OrganizationSettingsEntity = Aquiis.SimpleStart.Core.Entities.OrganizationSettings
@using Aquiis.SimpleStart.Features.PropertyManagement
@using Aquiis.SimpleStart.Application.Services
@using Aquiis.SimpleStart.Shared.Services
@using Aquiis.SimpleStart.Application.Services.PdfGenerators
@using Microsoft.AspNetCore.Authorization
@using System.ComponentModel.DataAnnotations

@inject PropertyManagementService PropertyService
@inject UserContextService UserContext
@inject ToastService ToastService
@inject NavigationManager Navigation

@attribute [OrganizationAuthorize("Owner", "Administrator")]
@rendermode InteractiveServer

<PageTitle>Organization Settings</PageTitle>

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/administration">Administration</a></li>
                    <li class="breadcrumb-item"><a href="/administration/settings">Settings</a></li>
                    <li class="breadcrumb-item active">Organization Settings</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2><i class="bi bi-building me-2"></i>Organization Settings</h2>
                    @if (!string.IsNullOrEmpty(organizationName))
                    {
                        <p class="text-muted mb-0">
                            Settings for <strong>@organizationName</strong>
                            @if (!string.IsNullOrEmpty(userRole))
                            {
                                <span class="badge @GetRoleBadgeClass() ms-2">@userRole</span>
                            }
                        </p>
                    }
                </div>
                @if (canManageOrganizations)
                {
                    <a href="/administration/organizations" class="btn btn-outline-primary">
                        <i class="bi bi-building me-2"></i>Manage Organizations
                    </a>
                }
            </div>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (settings == null)
    {
        <div class="alert alert-warning">
            <h4 class="alert-heading">No Settings Found</h4>
            <p>Organization settings have not been configured yet. Default values will be used.</p>
            <hr>
            <button type="button" class="btn btn-primary" @onclick="CreateDefaultSettings">
                <i class="bi bi-plus-circle me-2"></i>Create Default Settings
            </button>
        </div>
    }
    else
    {
        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                @errorMessage
                <button type="button" class="btn-close" @onclick="() => errorMessage = string.Empty"></button>
            </div>
        }

        @if (!string.IsNullOrEmpty(successMessage))
        {
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                @successMessage
                <button type="button" class="btn-close" @onclick="() => successMessage = string.Empty"></button>
            </div>
        }

        <EditForm Model="settingsModel" OnValidSubmit="HandleSaveSettings" FormName="organization-settings">
            <DataAnnotationsValidator />

            <div class="row">
                <div class="col-lg-8">
                    <!-- General Settings -->
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h5 class="card-title mb-0"><i class="bi bi-gear me-2"></i>General Settings</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Organization Name</label>
                                <InputText @bind-Value="settingsModel.Name" class="form-control" placeholder="My Property Management Company" />
                                <small class="text-muted">This name appears on documents and reports</small>
                            </div>
                        </div>
                    </div>

                    <!-- Application Fee Settings -->
                    <div class="card mb-4">
                        <div class="card-header bg-info text-white">
                            <h5 class="card-title mb-0"><i class="bi bi-file-earmark-text me-2"></i>Application Fee Settings</h5>
                        </div>
                        <div class="card-body">
                            <div class="form-check form-switch mb-3">
                                <InputCheckbox @bind-Value="settingsModel.ApplicationFeeEnabled" class="form-check-input" id="applicationFeeEnabled" />
                                <label class="form-check-label" for="applicationFeeEnabled">
                                    <strong>Enable Application Fees</strong>
                                </label>
                            </div>

                            @if (settingsModel.ApplicationFeeEnabled)
                            {
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Default Application Fee *</label>
                                        <div class="input-group">
                                            <span class="input-group-text">$</span>
                                            <InputNumber @bind-Value="settingsModel.DefaultApplicationFee" class="form-control" step="0.01" />
                                        </div>
                                        <ValidationMessage For="() => settingsModel.DefaultApplicationFee" class="text-danger small" />
                                        <small class="text-muted">Standard fee charged per application (non-refundable)</small>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Application Expiration Period *</label>
                                        <div class="input-group">
                                            <InputNumber @bind-Value="settingsModel.ApplicationExpirationDays" class="form-control" />
                                            <span class="input-group-text">days</span>
                                        </div>
                                        <ValidationMessage For="() => settingsModel.ApplicationExpirationDays" class="text-danger small" />
                                        <small class="text-muted">Applications expire if not processed within this period</small>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Late Fee Settings -->
                    <div class="card mb-4">
                        <div class="card-header bg-warning text-dark">
                            <h5 class="card-title mb-0"><i class="bi bi-exclamation-triangle me-2"></i>Late Fee Settings</h5>
                        </div>
                        <div class="card-body">
                            <div class="form-check form-switch mb-3">
                                <InputCheckbox @bind-Value="settingsModel.LateFeeEnabled" class="form-check-input" id="lateFeeEnabled" />
                                <label class="form-check-label" for="lateFeeEnabled">
                                    <strong>Enable Late Fees</strong>
                                </label>
                            </div>

                            @if (settingsModel.LateFeeEnabled)
                            {
                                <div class="form-check form-switch mb-3">
                                    <InputCheckbox @bind-Value="settingsModel.LateFeeAutoApply" class="form-check-input" id="lateFeeAutoApply" />
                                    <label class="form-check-label" for="lateFeeAutoApply">
                                        Auto-apply late fees after grace period
                                    </label>
                                </div>

                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="form-label">Grace Period *</label>
                                        <div class="input-group">
                                            <InputNumber @bind-Value="settingsModel.LateFeeGracePeriodDays" class="form-control" />
                                            <span class="input-group-text">days</span>
                                        </div>
                                        <ValidationMessage For="() => settingsModel.LateFeeGracePeriodDays" class="text-danger small" />
                                        <small class="text-muted">Days after due date before late fee applies</small>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Late Fee Percentage *</label>
                                        <div class="input-group">
                                            <InputNumber @bind-Value="settingsModel.LateFeePercentage" class="form-control" step="0.01" />
                                            <span class="input-group-text">%</span>
                                        </div>
                                        <ValidationMessage For="() => settingsModel.LateFeePercentage" class="text-danger small" />
                                        <small class="text-muted">Percentage of rent amount (e.g., 0.05 = 5%)</small>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Maximum Late Fee *</label>
                                        <div class="input-group">
                                            <span class="input-group-text">$</span>
                                            <InputNumber @bind-Value="settingsModel.MaxLateFeeAmount" class="form-control" step="0.01" />
                                        </div>
                                        <ValidationMessage For="() => settingsModel.MaxLateFeeAmount" class="text-danger small" />
                                        <small class="text-muted">Cap on late fee amount</small>
                                    </div>
                                </div>

                                @if (settingsModel.LateFeePercentage > 0)
                                {
                                    <div class="alert alert-info mt-3">
                                        <strong>Example:</strong> For a $1,000 rent payment:
                                        <ul class="mb-0 mt-2">
                                            <li>Calculated late fee: $@((1000 * settingsModel.LateFeePercentage).ToString("F2"))</li>
                                            <li>Actual late fee (with cap): $@(Math.Min(1000 * settingsModel.LateFeePercentage, settingsModel.MaxLateFeeAmount).ToString("F2"))</li>
                                        </ul>
                                    </div>
                                }
                            }
                        </div>
                    </div>

                    <!-- Payment Reminder Settings -->
                    <div class="card mb-4">
                        <div class="card-header bg-success text-white">
                            <h5 class="card-title mb-0"><i class="bi bi-bell me-2"></i>Payment Reminder Settings</h5>
                        </div>
                        <div class="card-body">
                            <div class="form-check form-switch mb-3">
                                <InputCheckbox @bind-Value="settingsModel.PaymentReminderEnabled" class="form-check-input" id="paymentReminderEnabled" />
                                <label class="form-check-label" for="paymentReminderEnabled">
                                    <strong>Enable Payment Reminders</strong>
                                </label>
                            </div>

                            @if (settingsModel.PaymentReminderEnabled)
                            {
                                <div class="mb-3">
                                    <label class="form-label">Send Reminder Before Due Date *</label>
                                    <div class="input-group">
                                        <InputNumber @bind-Value="settingsModel.PaymentReminderDaysBefore" class="form-control" />
                                        <span class="input-group-text">days</span>
                                    </div>
                                    <ValidationMessage For="() => settingsModel.PaymentReminderDaysBefore" class="text-danger small" />
                                    <small class="text-muted">Tenants receive reminder this many days before rent is due</small>
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Tour Settings -->
                    <div class="card mb-4">
                        <div class="card-header bg-secondary text-white">
                            <h5 class="card-title mb-0"><i class="bi bi-calendar-check me-2"></i>Tour Settings</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">No-Show Grace Period *</label>
                                <div class="input-group">
                                    <InputNumber @bind-Value="settingsModel.TourNoShowGracePeriodHours" class="form-control" />
                                    <span class="input-group-text">hours</span>
                                </div>
                                <ValidationMessage For="() => settingsModel.TourNoShowGracePeriodHours" class="text-danger small" />
                                <small class="text-muted">Time after scheduled tour before marking as no-show</small>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="d-flex justify-content-between mb-4">
                        <button type="button" class="btn btn-secondary" @onclick="Cancel">
                            <i class="bi bi-x-circle me-2"></i>Cancel
                        </button>
                        <div>
                            <button type="submit" class="btn btn-primary btn-lg" disabled="@(isSubmitting || !canEdit)">
                                @if (isSubmitting)
                                {
                                    <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                    <span>Saving...</span>
                                }
                                else
                                {
                                    <i class="bi bi-save me-2"></i>
                                    <span>Save Settings</span>
                                }
                            </button>
                            @if (!canEdit)
                            {
                                <div class="text-muted mt-2">
                                    <small><i class="bi bi-info-circle me-1"></i>You have read-only access to these settings.</small>
                                </div>
                            }
                        </div>
                    </div>
                </div>

                <div class="col-lg-4">
                    <!-- Settings Summary -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Settings Summary</h5>
                        </div>
                        <div class="card-body">
                            <h6 class="border-bottom pb-2">Application Fees</h6>
                            <ul class="list-unstyled mb-3">
                                <li><strong>Status:</strong> @(settingsModel.ApplicationFeeEnabled ? "✅ Enabled" : "❌ Disabled")</li>
                                @if (settingsModel.ApplicationFeeEnabled)
                                {
                                    <li><strong>Fee:</strong> $@settingsModel.DefaultApplicationFee.ToString("F2")</li>
                                    <li><strong>Expires:</strong> @settingsModel.ApplicationExpirationDays days</li>
                                }
                            </ul>

                            <h6 class="border-bottom pb-2">Late Fees</h6>
                            <ul class="list-unstyled mb-3">
                                <li><strong>Status:</strong> @(settingsModel.LateFeeEnabled ? "✅ Enabled" : "❌ Disabled")</li>
                                @if (settingsModel.LateFeeEnabled)
                                {
                                    <li><strong>Grace Period:</strong> @settingsModel.LateFeeGracePeriodDays days</li>
                                    <li><strong>Percentage:</strong> @(settingsModel.LateFeePercentage * 100)%</li>
                                    <li><strong>Max Fee:</strong> $@settingsModel.MaxLateFeeAmount.ToString("F2")</li>
                                    <li><strong>Auto-Apply:</strong> @(settingsModel.LateFeeAutoApply ? "Yes" : "No")</li>
                                }
                            </ul>

                            <h6 class="border-bottom pb-2">Payment Reminders</h6>
                            <ul class="list-unstyled mb-3">
                                <li><strong>Status:</strong> @(settingsModel.PaymentReminderEnabled ? "✅ Enabled" : "❌ Disabled")</li>
                                @if (settingsModel.PaymentReminderEnabled)
                                {
                                    <li><strong>Reminder:</strong> @settingsModel.PaymentReminderDaysBefore days before due</li>
                                }
                            </ul>

                            <h6 class="border-bottom pb-2">Tour Settings</h6>
                            <ul class="list-unstyled mb-0">
                                <li><strong>No-Show Grace:</strong> @settingsModel.TourNoShowGracePeriodHours hours</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Help Card -->
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">About Settings</h5>
                        </div>
                        <div class="card-body">
                            <p class="small mb-2">
                                <strong>Organization Settings</strong> apply to all properties and tenants within your organization.
                            </p>
                            <p class="small mb-2">
                                Changes take effect immediately but do not retroactively affect existing invoices or applications.
                            </p>
                            <p class="small mb-0">
                                <i class="bi bi-info-circle me-1"></i>
                                <strong>Tip:</strong> Review settings periodically to ensure they align with your current policies.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </EditForm>
    }
</div>

@code {
    private OrganizationSettingsEntity? settings;
    private OrganizationSettingsModel settingsModel = new();
    private bool isLoading = true;
    private bool isSubmitting = false;
    private string errorMessage = string.Empty;
    private string successMessage = string.Empty;
    private Guid organizationId = Guid.Empty;
    private string organizationName = string.Empty;
    private string userRole = string.Empty;
    private bool canEdit = true;
    private bool canManageOrganizations = false;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            organizationId = await UserContext.GetActiveOrganizationIdAsync() ?? Guid.Empty;
            await LoadSettings();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading settings: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadSettings()
    {
        settings = await PropertyService.GetOrganizationSettingsAsync();

        if (settings != null)
        {
            // Map to model
            settingsModel = new OrganizationSettingsModel
            {
                Name = settings.Name,
                ApplicationFeeEnabled = settings.ApplicationFeeEnabled,
                DefaultApplicationFee = settings.DefaultApplicationFee,
                ApplicationExpirationDays = settings.ApplicationExpirationDays,
                LateFeeEnabled = settings.LateFeeEnabled,
                LateFeeAutoApply = settings.LateFeeAutoApply,
                LateFeeGracePeriodDays = settings.LateFeeGracePeriodDays,
                LateFeePercentage = settings.LateFeePercentage,
                MaxLateFeeAmount = settings.MaxLateFeeAmount,
                PaymentReminderEnabled = settings.PaymentReminderEnabled,
                PaymentReminderDaysBefore = settings.PaymentReminderDaysBefore,
                TourNoShowGracePeriodHours = settings.TourNoShowGracePeriodHours
            };
        }
    }

    private async Task CreateDefaultSettings()
    {
        isSubmitting = true;
        errorMessage = string.Empty;

        try
        {
            settings = new OrganizationSettingsEntity
            {
                Id = Guid.NewGuid(),
                OrganizationId = organizationId,
                Name = "My Organization",
                ApplicationFeeEnabled = true,
                DefaultApplicationFee = 50.00m,
                ApplicationExpirationDays = 30,
                LateFeeEnabled = true,
                LateFeeAutoApply = true,
                LateFeeGracePeriodDays = 3,
                LateFeePercentage = 0.05m,
                MaxLateFeeAmount = 50.00m,
                PaymentReminderEnabled = true,
                PaymentReminderDaysBefore = 3,
                TourNoShowGracePeriodHours = 24,
                CreatedOn = DateTime.UtcNow,
                CreatedBy = "System"
            };

            await PropertyService.UpdateOrganizationSettingsAsync(settings);
            successMessage = "Default settings created successfully!";
            await LoadSettings();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error creating default settings: {ex.Message}";
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private async Task HandleSaveSettings()
    {
        if (settings == null) return;

        isSubmitting = true;
        errorMessage = string.Empty;
        successMessage = string.Empty;

        try
        {
            // Update settings from model
            settings.Name = settingsModel.Name;
            settings.ApplicationFeeEnabled = settingsModel.ApplicationFeeEnabled;
            settings.DefaultApplicationFee = settingsModel.DefaultApplicationFee;
            settings.ApplicationExpirationDays = settingsModel.ApplicationExpirationDays;
            settings.LateFeeEnabled = settingsModel.LateFeeEnabled;
            settings.LateFeeAutoApply = settingsModel.LateFeeAutoApply;
            settings.LateFeeGracePeriodDays = settingsModel.LateFeeGracePeriodDays;
            settings.LateFeePercentage = settingsModel.LateFeePercentage;
            settings.MaxLateFeeAmount = settingsModel.MaxLateFeeAmount;
            settings.PaymentReminderEnabled = settingsModel.PaymentReminderEnabled;
            settings.PaymentReminderDaysBefore = settingsModel.PaymentReminderDaysBefore;
            settings.TourNoShowGracePeriodHours = settingsModel.TourNoShowGracePeriodHours;
            settings.LastModifiedOn = DateTime.UtcNow;

            await PropertyService.UpdateOrganizationSettingsAsync(settings);
            
            successMessage = "Settings saved successfully!";
            ToastService.ShowSuccess("Organization settings updated successfully.");
        }
        catch (Exception ex)
        {
            errorMessage = $"Error saving settings: {ex.Message}";
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/administration");
    }

    private string GetRoleBadgeClass()
    {
        return userRole switch
        {
            "Owner" => "bg-primary",
            "Administrator" => "bg-success",
            "PropertyManager" => "bg-info",
            "User" => "bg-secondary",
            _ => "bg-secondary"
        };
    }

    public class OrganizationSettingsModel
    {
        [StringLength(200)]
        public string? Name { get; set; }

        public bool ApplicationFeeEnabled { get; set; } = true;

        [Required]
        [Range(0, 1000, ErrorMessage = "Application fee must be between $0 and $1,000")]
        public decimal DefaultApplicationFee { get; set; } = 50.00m;

        [Required]
        [Range(1, 90, ErrorMessage = "Expiration period must be between 1 and 90 days")]
        public int ApplicationExpirationDays { get; set; } = 30;

        public bool LateFeeEnabled { get; set; } = true;

        public bool LateFeeAutoApply { get; set; } = true;

        [Required]
        [Range(0, 30, ErrorMessage = "Grace period must be between 0 and 30 days")]
        public int LateFeeGracePeriodDays { get; set; } = 3;

        [Required]
        [Range(0, 1, ErrorMessage = "Late fee percentage must be between 0% and 100%")]
        public decimal LateFeePercentage { get; set; } = 0.05m;

        [Required]
        [Range(0, 10000, ErrorMessage = "Maximum late fee must be between $0 and $10,000")]
        public decimal MaxLateFeeAmount { get; set; } = 50.00m;

        public bool PaymentReminderEnabled { get; set; } = true;

        [Required]
        [Range(1, 30, ErrorMessage = "Reminder period must be between 1 and 30 days")]
        public int PaymentReminderDaysBefore { get; set; } = 3;

        [Required]
        [Range(1, 168, ErrorMessage = "Grace period must be between 1 and 168 hours (1 week)")]
        public int TourNoShowGracePeriodHours { get; set; } = 24;
    }
}
