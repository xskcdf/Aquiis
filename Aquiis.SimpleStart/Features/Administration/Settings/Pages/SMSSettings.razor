@page "/settings/sms"
@using Aquiis.SimpleStart.Application.Services
@using Aquiis.SimpleStart.Infrastructure.Services
@using SocketIOClient.Messages
@using System.ComponentModel.DataAnnotations
@inject SMSSettingsService SMSSettingsService
@inject TwilioSMSService TwilioSMSService

@inject ToastService ToastService
@inject IJSRuntime JSRuntime

@inject UserContextService _userContext

<PageTitle>SMS Settings - Aquiis</PageTitle>
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <h2>
                <i class="bi bi-phone-vibrate"></i> SMS Configuration
            </h2>
            <p class="text-muted">
                Configure Twilio integration for automated SMS notifications
            </p>
        </div>
    </div>

    @if (settings == null)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (!settings.IsSMSEnabled)
    {
        <div class="row mt-4">
            <div class="col-lg-8">
                <div class="alert alert-info">
                    <h4><i class="bi bi-info-circle"></i> SMS Integration Not Configured</h4>
                    <p>Enable automated SMS notifications by connecting your Twilio account.</p>

                    <h5 class="mt-4">Why Use Twilio?</h5>
                    <ul>
                        <li><strong>Free trial:</strong> $15 credit for testing (perfect for getting started)</li>
                        <li><strong>Reliable delivery:</strong> Industry-leading SMS infrastructure</li>
                        <li><strong>Analytics:</strong> Track message delivery and status</li>
                        <li><strong>Your account:</strong> You manage billing and usage directly</li>
                    </ul>

                    <h5 class="mt-4">Setup Steps:</h5>
                    <ol class="mb-4">
                        <li>
                            <a href="https://www.twilio.com/try-twilio" target="_blank" rel="noopener" class="alert-link">
                                Create a free Twilio account <i class="bi bi-box-arrow-up-right"></i>
                            </a>
                        </li>
                        <li>Generate an API key with <strong>"Messaging"</strong> permissions</li>
                        <li>Click the button below to configure your API key</li>
                    </ol>

                    <button class="btn btn-primary btn-lg" @onclick="() => showConfigModal = true">
                        <i class="bi bi-phone-fill"></i> Configure Twilio
                    </button>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="bi bi-question-circle"></i> Need Help?</h5>
                    </div>
                    <div class="card-body">
                        <h6>Common Questions</h6>
                        <p class="small mb-2">
                            <strong>Do I need a paid account?</strong><br>
                            You get $15 free trial credit. Pay-as-you-go after that.
                        </p>
                        <p class="small mb-2">
                            <strong>What happens without SMS?</strong><br>
                            The app works fine. Notifications appear in-app only.
                        </p>
                        <p class="small mb-2">
                            <strong>Is my API key secure?</strong><br>
                            Yes, it's encrypted and never shared.
                        </p>
                        <hr>
                        <a href="https://www.twilio.com/docs/usage/api"
                           target="_blank"
                           class="btn btn-sm btn-outline-secondary">
                            <i class="bi bi-book"></i> API Key Guide
                        </a>
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="row mt-4">
            <div class="col-lg-8">
                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <i class="bi bi-check-circle"></i> SMS Integration Active
                    </div>
                    <div class="card-body">
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <h6>Configuration</h6>
                                <p class="mb-1">
                                    <strong>Twilio Phone Number:</strong><br>
                                    <code>@settings.TwilioPhoneNumber</code>
                                </p>
                                <p class="mb-1 text-muted small">
                                    <i class="bi bi-check-circle-fill text-success"></i>
                                    Verified @settings.LastVerifiedOn?.ToString("g")
                                </p>
                            </div>
                            <div class="col-md-6">
                                @* TODO Phase 2.5: Implement SMS usage statistics display *@
                                <h6>Usage Statistics</h6>
                                <p class="text-muted">
                                    <i class="bi bi-info-circle"></i>
                                    SMS usage statistics will be available after Twilio integration (Phase 2.5)
                                </p>
                            </div>
                        </div>

                        @if (!string.IsNullOrEmpty(settings.LastError))
                        {
                            <div class="alert alert-warning mb-3">
                                <i class="bi bi-exclamation-triangle"></i>
                                <strong>Recent Error:</strong> @settings.LastError
                                <br>
                                <small class="text-muted">Try updating your API key or contact Twilio support</small>
                            </div>
                        }

                        <div class="btn-group" role="group">
                            <button class="btn btn-primary" @onclick="() => showConfigModal = true">
                                <i class="bi bi-key"></i> Update API Key
                            </button>
                            <button class="btn btn-info" @onclick="SendTestSMS">
                                <i class="bi bi-phone-check"></i> Send Test SMS
                            </button>
                            <button class="btn btn-secondary" @onclick="RefreshStats" disabled="@isRefreshing">
                                <i class="bi bi-arrow-clockwise @(isRefreshing ? "spin" : "")"></i>
                                Refresh Stats
                            </button>
                            <button class="btn btn-warning" @onclick="DisableSMS">
                                <i class="bi bi-x-circle"></i> Disable SMS
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-graph-up"></i> SMS Activity
                    </div>
                    <div class="card-body">
                        <p class="text-muted">
                            View detailed SMS statistics in your
                            <a href="https://www.twilio.com/console/sms/dashboard" target="_blank" rel="noopener">
                                Twilio Dashboard <i class="bi bi-box-arrow-up-right"></i>
                            </a>
                        </p>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="bi bi-lightbulb"></i> Tips</h5>
                    </div>
                    <div class="card-body">
                        <h6>Optimize SMS Usage</h6>
                        <ul class="small mb-3">
                            <li>Enable daily/weekly digest mode to batch notifications</li>
                            <li>Let users configure their notification preferences</li>
                            <li>Monitor your usage to avoid hitting limits</li>
                            <li>Consider upgrading if you consistently hit daily limits</li>
                        </ul>

                        <h6>Twilio Features</h6>
                        <ul class="small mb-0">
                            <li><strong>Templates:</strong> Use message templates and variables</li>
                            <li><strong>Analytics:</strong> Track delivery and status</li>
                            <li><strong>Webhooks:</strong> Get delivery notifications</li>
                            <li><strong>Phone Numbers:</strong> Purchase dedicated numbers</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@* Configuration Modal *@
@if (showConfigModal)
{
    <div class="modal show d-block" tabindex="-1" style="background: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-phone-vibrate"></i> Configure Twilio
                    </h5>
                    <button type="button" class="btn-close" @onclick="CloseModal"></button>
                </div>
                <EditForm Model="configModel" OnValidSubmit="SaveConfiguration">
                    <DataAnnotationsValidator />
                    <div class="modal-body">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i>
                            <strong>Security Note:</strong> Your API key is encrypted and securely stored.
                            It's never transmitted or visible after saving.
                        </div>

                        <div class="mb-3">
                            <label class="form-label">
                                Twilio Account SID *
                                <a href="https://www.twilio.com/console"
                                   target="_blank"
                                   rel="noopener"
                                   class="small ms-2">
                                    <i class="bi bi-box-arrow-up-right"></i> Get Credentials
                                </a>
                            </label>
                            <InputText @bind-Value="configModel.AccountSid"
                                       class="form-control"
                                       type="password"
                                       placeholder="ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" />
                            <ValidationMessage For="@(() => configModel.AccountSid)" />
                            <small class="form-text text-muted">
                                Found in your Twilio Console dashboard
                            </small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Twilio Auth Token *</label>
                            <InputText @bind-Value="configModel.AuthToken"
                                       class="form-control"
                                       type="password"
                                       placeholder="Auth Token from Twilio Console" />
                            <ValidationMessage For="@(() => configModel.AuthToken)" />
                            <small class="form-text text-muted">
                                Your Auth Token (keep this secret!)
                            </small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Twilio Phone Number *</label>
                            <InputText @bind-Value="configModel.PhoneNumber"
                                       class="form-control"
                                       placeholder="+1234567890" />
                            <ValidationMessage For="@(() => configModel.PhoneNumber)" />
                            <small class="form-text text-muted">
                                Use a verified Twilio phone number. Must be in E.164 format (+1234567890).
                            </small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CloseModal">
                            Cancel
                        </button>
                        <button type="submit" class="btn btn-primary" disabled="@isSaving">
                            @if (isSaving)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                            }
                            <i class="bi bi-save"></i> Save Configuration
                        </button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
}

@code {
    private OrganizationSMSSettings? settings;
    private TwilioStats? stats;
    private bool showConfigModal;
    private bool isSaving;
    private bool isRefreshing;
    private ConfigurationModel configModel = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadSettings();
    }

    private async Task LoadSettings()
    {
        settings = await SMSSettingsService.GetOrCreateSettingsAsync();
        // TODO Phase 2.5: Uncomment when GetTwilioStatsAsync is implemented
        // if (settings.IsSMSEnabled)
        // {
        //     stats = await SMSService.GetTwilioStatsAsync();
        // }
    }

    private async Task SaveConfiguration()
    {
        isSaving = true;

        var result = await SMSSettingsService.UpdateTwilioConfigAsync(
            configModel.AccountSid!,
            configModel.AuthToken!,
            configModel.PhoneNumber!);

        if (result.Success)
        {
            ToastService.ShowSuccess(result.Message);
            showConfigModal = false;
            configModel = new(); // Clear sensitive data
            await LoadSettings();
        }
        else
        {
            ToastService.ShowError(result.Message);
        }

        isSaving = false;
    }

    private async Task SendTestSMS()
    {
        var testPhone = await JSRuntime.InvokeAsync<string?>("prompt",
            "Enter phone number to send test SMS (E.164 format, e.g., +1234567890):",
            "");

        if (!string.IsNullOrEmpty(testPhone))
        {
            var result = await SMSSettingsService.TestSMSConfigurationAsync(testPhone);
            if (result.Success)
                ToastService.ShowSuccess(result.Message);
            else
                ToastService.ShowError(result.Message);
        }
    }

    private async Task DisableSMS()
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm",
            "Are you sure you want to disable SMS notifications?\n\n" +
            "Notifications will only appear in-app until you re-enable SMS.");

        if (confirmed)
        {
            var result = await SMSSettingsService.DisableSMSAsync();
            ToastService.ShowInfo(result.Message);
            await LoadSettings();
        }
    }

    private async Task RefreshStats()
    {
        isRefreshing = true;
        await LoadSettings();
        isRefreshing = false;
        ToastService.ShowSuccess("Statistics refreshed");
    }

    private void CloseModal()
    {
        showConfigModal = false;
        configModel = new(); // Clear sensitive data
    }

    private string GetProgressBarClass(int percent)
    {
        return percent switch
        {
            ( < 50) => "bg-success",
            ( < 75) => "bg-info",
            ( < 90) => "bg-warning",
            _ => "bg-danger"
        };
    }

    public class ConfigurationModel
    {
        [Required(ErrorMessage = "Twilio Account SID is required")]
        [StringLength(100, MinimumLength = 34, ErrorMessage = "Account SID must be at least 34 characters")]
        public string? AccountSid { get; set; }

        [Required(ErrorMessage = "Twilio Auth Token is required")]
        [StringLength(100, MinimumLength = 32, ErrorMessage = "Auth Token must be at least 32 characters")]
        public string? AuthToken { get; set; }

        [Required(ErrorMessage = "Twilio phone number is required")]
        [Phone(ErrorMessage = "Invalid phone number format")]
        public string? PhoneNumber { get; set; }
    }
}

<style>
    .spin {
        animation: spin 1s linear infinite;
    }

    @@keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
</style>