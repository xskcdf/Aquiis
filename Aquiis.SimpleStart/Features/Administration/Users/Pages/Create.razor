@page "/Administration/Users/Create"

@using Aquiis.SimpleStart.Shared.Components.Account
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@inject NavigationManager Navigation
@inject UserManager<ApplicationUser> UserManager
@inject RoleManager<IdentityRole> RoleManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@rendermode InteractiveServer

@attribute [OrganizationAuthorize("Owner", "Administrator")]

<PageTitle>Create User - Administration</PageTitle>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="bi bi-person-plus"></i> Create User</h1>
    <button class="btn btn-outline-secondary" @onclick="Cancel">
        <i class="bi bi-arrow-left"></i> Back to Users
    </button>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">New User Account</h5>
            </div>
            <div class="card-body">
                <EditForm Model="userModel" OnValidSubmit="CreateUser" FormName="create-user">
                    <DataAnnotationsValidator />
                    
                    @if (!string.IsNullOrEmpty(errorMessage))
                    {
                        <div class="alert alert-danger" role="alert">
                            @errorMessage
                        </div>
                    }

                    @if (!string.IsNullOrEmpty(successMessage))
                    {
                        <div class="alert alert-success" role="alert">
                            @successMessage
                        </div>
                    }

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">First Name *</label>
                            <InputText @bind-Value="userModel.FirstName" class="form-control" placeholder="First name" />
                            <ValidationMessage For="() => userModel.FirstName" class="text-danger" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Last Name *</label>
                            <InputText @bind-Value="userModel.LastName" class="form-control" placeholder="Last name" />
                            <ValidationMessage For="() => userModel.LastName" class="text-danger" />
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Email / Username *</label>
                            <InputText @bind-Value="userModel.Email" class="form-control" type="email" placeholder="email@example.com" />
                            <ValidationMessage For="() => userModel.Email" class="text-danger" />
                            <small class="text-muted">This will be used as the username</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Phone Number</label>
                            <InputText @bind-Value="userModel.PhoneNumber" class="form-control" placeholder="(555) 123-4567" />
                            <ValidationMessage For="() => userModel.PhoneNumber" class="text-danger" />
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Password *</label>
                            <InputText @bind-Value="userModel.Password" class="form-control" type="password" placeholder="Enter password" />
                            <ValidationMessage For="() => userModel.Password" class="text-danger" />
                            <small class="text-muted">Min 6 characters, 1 uppercase, 1 lowercase, 1 digit</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Confirm Password *</label>
                            <InputText @bind-Value="userModel.ConfirmPassword" class="form-control" type="password" placeholder="Confirm password" />
                            <ValidationMessage For="() => userModel.ConfirmPassword" class="text-danger" />
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <InputCheckbox @bind-Value="userModel.EmailConfirmed" class="form-check-input" id="emailConfirmed" />
                            <label class="form-check-label" for="emailConfirmed">
                                Email Confirmed (Auto-approve account)
                            </label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Roles *</label>
                        @if (availableRoles == null)
                        {
                            <p>Loading roles...</p>
                        }
                        else
                        {
                            @foreach (var role in availableRoles)
                            {
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="role_@role.Id" 
                                           checked="@userModel.SelectedRoles.Contains(role.Name ?? "")"
                                           @onchange="@((e) => OnRoleChanged(role.Name ?? "", (bool)(e.Value ?? false)))" />
                                    <label class="form-check-label" for="role_@role.Id">
                                        @role.Name
                                    </label>
                                </div>
                            }
                        }
                        @if (userModel.SelectedRoles.Count == 0)
                        {
                            <small class="text-danger">At least one role must be selected</small>
                        }
                    </div>

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary" disabled="@isSubmitting">
                            @if (isSubmitting)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                            }
                            <i class="bi bi-person-plus"></i> Create User
                        </button>
                        <button type="button" class="btn btn-secondary" @onclick="Cancel">Cancel</button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">Password Requirements</h6>
            </div>
            <div class="card-body">
                <ul class="small mb-0">
                    <li>Minimum 6 characters</li>
                    <li>At least 1 uppercase letter</li>
                    <li>At least 1 lowercase letter</li>
                    <li>At least 1 digit (0-9)</li>
                </ul>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0">User Roles</h6>
            </div>
            <div class="card-body">
                <ul class="small mb-0">
                    <li><strong>Administrator:</strong> Full system access</li>
                    <li><strong>PropertyManager:</strong> Manage properties and tenants</li>
                    <li><strong>Tenant:</strong> View own lease and payments</li>
                </ul>
            </div>
        </div>
    </div>
</div>

@code {
    private UserModel userModel = new UserModel();
    private bool isSubmitting = false;
    private string errorMessage = string.Empty;
    private string successMessage = string.Empty;
    private List<IdentityRole>? availableRoles;

    protected override async Task OnInitializedAsync()
    {
        await LoadRoles();
    }

    private async Task LoadRoles()
    {
        availableRoles = RoleManager.Roles.ToList();
        await Task.CompletedTask;
    }

    private void OnRoleChanged(string roleName, bool isChecked)
    {
        if (isChecked)
        {
            if (!userModel.SelectedRoles.Contains(roleName))
            {
                userModel.SelectedRoles.Add(roleName);
            }
        }
        else
        {
            userModel.SelectedRoles.Remove(roleName);
        }
    }

    private async Task CreateUser()
    {
        try
        {
            isSubmitting = true;
            errorMessage = string.Empty;
            successMessage = string.Empty;

            // Validate roles
            if (userModel.SelectedRoles.Count == 0)
            {
                errorMessage = "Please select at least one role for the user.";
                return;
            }

            // Get current user's OrganizationId
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var userId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            
            if (string.IsNullOrEmpty(userId))
            {
                errorMessage = "User not authenticated.";
                return;
            }

            var currentUser = await UserManager.FindByIdAsync(userId);
            if (currentUser == null)
            {
                errorMessage = "Current user not found.";
                return;
            }

            // Check if user already exists
            var existingUser = await UserManager.FindByEmailAsync(userModel.Email);
            if (existingUser != null)
            {
                errorMessage = "A user with this email already exists.";
                return;
            }

            // Create new user
            var newUser = new ApplicationUser
            {
                UserName = userModel.Email,
                Email = userModel.Email,
                EmailConfirmed = userModel.EmailConfirmed,
                PhoneNumber = userModel.PhoneNumber,
                FirstName = userModel.FirstName,
                LastName = userModel.LastName,
                OrganizationId = currentUser.ActiveOrganizationId,
                ActiveOrganizationId = currentUser.ActiveOrganizationId
            };

            var createResult = await UserManager.CreateAsync(newUser, userModel.Password);
            
            if (!createResult.Succeeded)
            {
                errorMessage = $"Error creating user: {string.Join(", ", createResult.Errors.Select(e => e.Description))}";
                return;
            }

            // Add roles to user
            foreach (var roleName in userModel.SelectedRoles)
            {
                var roleExists = await RoleManager.RoleExistsAsync(roleName);
                if (roleExists)
                {
                    await UserManager.AddToRoleAsync(newUser, roleName);
                }
            }

            successMessage = $"User account created successfully! Username: {userModel.Email}";
            
            // Reset form
            userModel = new UserModel();
            
            // Redirect after a brief delay
            await Task.Delay(2000);
            Navigation.NavigateTo("/administration/users/manage");
        }
        catch (Exception ex)
        {
            errorMessage = $"Error creating user: {ex.Message}";
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/administration/users/manage");
    }

    public class UserModel
    {
        [Required(ErrorMessage = "First name is required")]
        [StringLength(100, ErrorMessage = "First name cannot exceed 100 characters")]
        public string FirstName { get; set; } = string.Empty;

        [Required(ErrorMessage = "Last name is required")]
        [StringLength(100, ErrorMessage = "Last name cannot exceed 100 characters")]
        public string LastName { get; set; } = string.Empty;

        [Required(ErrorMessage = "Email is required")]
        [EmailAddress(ErrorMessage = "Please enter a valid email address")]
        public string Email { get; set; } = string.Empty;

        [Phone(ErrorMessage = "Please enter a valid phone number")]
        public string PhoneNumber { get; set; } = string.Empty;

        [Required(ErrorMessage = "Password is required")]
        [StringLength(100, MinimumLength = 6, ErrorMessage = "Password must be at least 6 characters")]
        public string Password { get; set; } = string.Empty;

        [Required(ErrorMessage = "Please confirm the password")]
        [Compare(nameof(Password), ErrorMessage = "Passwords do not match")]
        public string ConfirmPassword { get; set; } = string.Empty;

        public bool EmailConfirmed { get; set; } = true;

        public List<string> SelectedRoles { get; set; } = new List<string>();
    }
}
