@page "/propertymanagement/leases/{LeaseId:guid}/accept"

@using Aquiis.SimpleStart.Core.Entities
@using Aquiis.SimpleStart.Application.Services
@using Aquiis.SimpleStart.Shared.Services
@using Aquiis.SimpleStart.Application.Services.PdfGenerators
@using Aquiis.SimpleStart.Core.Constants
@using Microsoft.AspNetCore.Authorization
@using System.Net
@using System.ComponentModel.DataAnnotations

@inject LeaseService LeaseService
@inject PropertyService PropertyService
@inject RentalApplicationService RentalApplicationService
@inject ProspectiveTenantService ProspectiveTenantService
@inject TenantConversionService TenantConversionService
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider
@inject UserContextService UserContext
@inject ToastService ToastService
@inject SecurityDepositService SecurityDepositService
@inject IHttpContextAccessor HttpContextAccessor

@attribute [OrganizationAuthorize("Owner", "Administrator", "PropertyManager")]
@rendermode InteractiveServer

<PageTitle>Accept Lease Offer</PageTitle>

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/propertymanagement">Property Management</a></li>
                    <li class="breadcrumb-item"><a href="/propertymanagement/leases">Leases</a></li>
                    <li class="breadcrumb-item active">Accept Lease</li>
                </ol>
            </nav>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (lease == null)
    {
        <div class="alert alert-danger">
            <h4 class="alert-heading">Lease Not Found</h4>
            <p>The lease you are trying to access does not exist or you do not have permission to view it.</p>
            <hr>
            <a href="/propertymanagement/leases" class="btn btn-primary">Return to Leases</a>
        </div>
    }
    else if (lease.Status != "Offered")
    {
        <div class="alert alert-warning">
            <h4 class="alert-heading">Invalid Lease Status</h4>
            <p>This lease cannot be accepted. Current status: <strong>@lease.Status</strong></p>
            <hr>
            <a href="/propertymanagement/leases/@LeaseId" class="btn btn-primary">View Lease</a>
        </div>
    }
    else if (isExpired)
    {
        <div class="alert alert-danger">
            <h4 class="alert-heading">Lease Offer Expired</h4>
            <p>This lease offer expired on @lease.ExpiresOn?.ToString("MMM dd, yyyy"). A new offer must be generated.</p>
            <hr>
            <a href="/propertymanagement/leases" class="btn btn-primary">Return to Leases</a>
        </div>
    }
    else
    {
        <div class="row">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h3 class="card-title mb-0">Accept Lease Offer</h3>
                    </div>
                    <div class="card-body">
                        @if (!string.IsNullOrEmpty(errorMessage))
                        {
                            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                                @errorMessage
                                <button type="button" class="btn-close" @onclick="() => errorMessage = string.Empty"></button>
                            </div>
                        }

                        @if (!string.IsNullOrEmpty(successMessage))
                        {
                            <div class="alert alert-success alert-dismissible fade show" role="alert">
                                @successMessage
                                <button type="button" class="btn-close" @onclick="() => successMessage = string.Empty"></button>
                            </div>
                        }

                        <div class="alert alert-info mb-4">
                            <i class="bi bi-clock me-2"></i>
                            <strong>Offer Expires:</strong> @lease.ExpiresOn?.ToString("MMM dd, yyyy h:mm tt") 
                            (@GetTimeRemaining())
                        </div>

                        <div class="mb-4">
                            <h5 class="border-bottom pb-2">Lease Summary</h5>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <strong>Property:</strong><br />
                                    @lease.Property?.Address
                                </div>
                                <div class="col-md-6">
                                    <strong>Lease Term:</strong><br />
                                    @lease.StartDate.ToString("MMM dd, yyyy") - @lease.EndDate.ToString("MMM dd, yyyy")
                                </div>
                                <div class="col-md-6">
                                    <strong>Monthly Rent:</strong><br />
                                    <span class="h5 text-primary">@lease.MonthlyRent.ToString("C")</span>
                                </div>
                                <div class="col-md-6">
                                    <strong>Security Deposit:</strong><br />
                                    <span class="h5 text-info">@lease.SecurityDeposit.ToString("C")</span>
                                </div>
                            </div>
                        </div>

                        <div class="mb-4">
                            <h5 class="border-bottom pb-2">Lease Terms & Conditions</h5>
                            <div class="card bg-light">
                                <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                                    <pre style="white-space: pre-wrap; font-family: inherit;">@lease.Terms</pre>
                                </div>
                            </div>
                        </div>

                        <EditForm Model="acceptanceModel" OnValidSubmit="HandleAcceptLease" FormName="accept-lease">
                            <DataAnnotationsValidator />

                            <div class="mb-4">
                                <h5 class="border-bottom pb-2">Prospective Tenant Information</h5>
                                @if (prospectiveTenant != null)
                                {
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <strong>Name:</strong> @prospectiveTenant.FullName
                                        </div>
                                        <div class="col-md-6">
                                            <strong>Email:</strong> @prospectiveTenant.Email
                                        </div>
                                        <div class="col-md-6">
                                            <strong>Phone:</strong> @prospectiveTenant.Phone
                                        </div>
                                        <div class="col-md-6">
                                            <strong>Date of Birth:</strong> @prospectiveTenant.DateOfBirth?.ToString("MMM dd, yyyy")
                                        </div>
                                    </div>
                                }
                                else
                                {
                                    <div class="alert alert-warning">
                                        Unable to load prospective tenant information.
                                    </div>
                                }
                            </div>

                            <div class="mb-4">
                                <h5 class="border-bottom pb-2">Signature & Acceptance</h5>
                                
                                <div class="form-check mb-3">
                                    <InputCheckbox @bind-Value="acceptanceModel.AgreesToTerms" class="form-check-input" id="agreeTerms" />
                                    <label class="form-check-label" for="agreeTerms">
                                        <strong>I confirm that the tenant has read, understood, and agrees to all terms and conditions of this lease.</strong>
                                    </label>
                                    <ValidationMessage For="() => acceptanceModel.AgreesToTerms" class="text-danger d-block small" />
                                </div>

                                <div class="form-check mb-3">
                                    <InputCheckbox @bind-Value="acceptanceModel.SecurityDepositPaid" class="form-check-input" id="depositPaid" />
                                    <label class="form-check-label" for="depositPaid">
                                        <strong>Security deposit of @lease.SecurityDeposit.ToString("C") has been paid in full.</strong>
                                    </label>
                                    <ValidationMessage For="() => acceptanceModel.SecurityDepositPaid" class="text-danger d-block small" />
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Security Deposit Payment Method *</label>
                                    <InputSelect @bind-Value="acceptanceModel.PaymentMethod" class="form-select">
                                        <option value="">Select payment method...</option>
                                        @foreach (var method in ApplicationConstants.PaymentMethods.AllPaymentMethods)
                                        {
                                            <option value="@method">@method</option>
                                        }
                                    </InputSelect>
                                    <ValidationMessage For="() => acceptanceModel.PaymentMethod" class="text-danger small" />
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Transaction Reference (Optional)</label>
                                    <InputText @bind-Value="acceptanceModel.TransactionReference" class="form-control" 
                                              placeholder="Check number, confirmation number, etc." />
                                    <small class="text-muted">Check number, bank transfer confirmation, etc.</small>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Acceptance Notes (Optional)</label>
                                    <InputTextArea @bind-Value="acceptanceModel.Notes" class="form-control" rows="3" 
                                                  placeholder="Any additional notes about the lease acceptance..." />
                                </div>
                            </div>

                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                <strong>Audit Trail:</strong> This acceptance will be recorded with the following information:
                                <ul class="mb-0 mt-2">
                                    <li>Acceptance timestamp: @DateTime.UtcNow.ToString("MMM dd, yyyy h:mm:ss tt UTC")</li>
                                    <li>IP Address: @GetClientIpAddress()</li>
                                    <li>Processed by: @userId</li>
                                </ul>
                            </div>

                            <div class="d-flex justify-content-between mt-4">
                                <button type="button" class="btn btn-secondary" @onclick="Cancel">
                                    <i class="bi bi-x-circle me-2"></i>Cancel
                                </button>
                                <div>
                                    <button type="button" class="btn btn-outline-danger me-2" @onclick="() => showDeclineModal = true">
                                        <i class="bi bi-x-octagon me-2"></i>Decline Offer
                                    </button>
                                    <button type="submit" class="btn btn-success btn-lg" disabled="@isSubmitting">
                                        @if (isSubmitting)
                                        {
                                            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                            <span>Processing...</span>
                                        }
                                        else
                                        {
                                            <i class="bi bi-check-circle me-2"></i>
                                            <span>Accept Lease & Create Tenant</span>
                                        }
                                    </button>
                                </div>
                            </div>
                        </EditForm>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Next Steps</h5>
                    </div>
                    <div class="card-body">
                        <ol class="ps-3">
                            <li class="mb-2">Tenant record will be created automatically</li>
                            <li class="mb-2">Security deposit will be recorded and tracked</li>
                            <li class="mb-2">Deposit added to investment pool when lease starts</li>
                            <li class="mb-2">Property status will update to "Occupied"</li>
                            <li class="mb-2">All competing applications will be denied</li>
                            <li class="mb-2">Move-in inspection will be scheduled</li>
                        </ol>
                    </div>
                </div>

                @if (lease.Property != null)
                {
                    <div class="card mt-3">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Property Details</h5>
                        </div>
                        <div class="card-body">
                            <p class="mb-1"><strong>Type:</strong> @lease.Property.PropertyType</p>
                            <p class="mb-1"><strong>Bedrooms:</strong> @lease.Property.Bedrooms</p>
                            <p class="mb-1"><strong>Bathrooms:</strong> @lease.Property.Bathrooms</p>
                            <p class="mb-0"><strong>Sq Ft:</strong> @lease.Property.SquareFeet</p>
                        </div>
                    </div>
                }
            </div>
        </div>
    }
</div>

<!-- Decline Modal -->
@if (showDeclineModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Decline Lease Offer</h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="() => showDeclineModal = false"></button>
                </div>
                <div class="modal-body">
                    <p><strong>Are you sure you want to decline this lease offer?</strong></p>
                    <p>This action will:</p>
                    <ul>
                        <li>Mark the lease as declined</li>
                        <li>Return property status to Available (or ApplicationPending if other apps exist)</li>
                        <li>Update the prospective tenant's status</li>
                    </ul>
                    
                    <div class="mb-3">
                        <label class="form-label">Reason for Decline (Optional)</label>
                        <textarea @bind="declineReason" class="form-control" rows="3" 
                                 placeholder="Enter reason for declining..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="() => showDeclineModal = false">Cancel</button>
                    <button type="button" class="btn btn-danger" @onclick="HandleDeclineLease" disabled="@isSubmitting">
                        @if (isSubmitting)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                        }
                        <span>Decline Offer</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public Guid LeaseId { get; set; }

    private Lease? lease;
    private ProspectiveTenant? prospectiveTenant;
    private RentalApplication? application;
    private LeaseAcceptanceModel acceptanceModel = new();
    private bool isLoading = true;
    private bool isSubmitting = false;
    private bool isExpired = false;
    private bool showDeclineModal = false;
    private string errorMessage = string.Empty;
    private string successMessage = string.Empty;
    private string declineReason = string.Empty;
    private string userId = string.Empty;
    private Guid organizationId = Guid.Empty;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            userId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value ?? string.Empty;
            organizationId = await UserContext.GetActiveOrganizationIdAsync() ?? Guid.Empty;

            await LoadLease();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading lease: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadLease()
    {
        lease = await LeaseService.GetByIdAsync(LeaseId);
        
        if (lease != null)
        {
            // Check if expired
            if (lease.ExpiresOn.HasValue && lease.ExpiresOn.Value < DateTime.UtcNow)
            {
                isExpired = true;
            }

            // Find the application and prospective tenant
            if (lease.Property != null)
            {
                var allApplications = await RentalApplicationService.GetAllAsync();
                application = allApplications.FirstOrDefault(a => 
                    a.PropertyId == lease.PropertyId && 
                    a.Status == ApplicationConstants.ApplicationStatuses.Approved);

                if (application != null)
                {
                    prospectiveTenant = await ProspectiveTenantService.GetByIdAsync(
                        application.ProspectiveTenantId);
                }
            }
        }
    }

    private async Task HandleAcceptLease()
    {
        if (lease == null || prospectiveTenant == null) return;

        isSubmitting = true;
        errorMessage = string.Empty;

        try
        {
            // Convert prospect to tenant
            var tenant = await TenantConversionService.ConvertProspectToTenantAsync(
                prospectiveTenant.Id);

            if (tenant == null)
            {
                errorMessage = "Failed to create tenant record.";
                isSubmitting = false;
                ToastService.ShowError(errorMessage);
                Console.WriteLine(errorMessage);
                return;
            }

            // CRITICAL: Collect security deposit - this MUST succeed before proceeding
            SecurityDeposit securityDeposit;
            try
            {
                securityDeposit = await SecurityDepositService.CollectSecurityDepositAsync(
                    lease.Id,
                    lease.SecurityDeposit,
                    acceptanceModel.PaymentMethod,
                    acceptanceModel.TransactionReference,
                    tenant.Id); // Pass the newly created tenant ID
            }
            catch (Exception depositEx)
            {
                var message = depositEx.Message + (depositEx.InnerException != null ? $" Inner: {depositEx.InnerException.Message}" : string.Empty);
                errorMessage = $"CRITICAL ERROR: Failed to collect security deposit. Lease acceptance aborted. Error: {message}";
                isSubmitting = false;
                ToastService.ShowError(errorMessage);
                return;
            }

            if(securityDeposit == null || securityDeposit.Id == Guid.Empty)
            {
                errorMessage = "CRITICAL ERROR: Security deposit record not created. Lease acceptance aborted.";
                isSubmitting = false;
                ToastService.ShowError(errorMessage);
                return;
            }

            // Add deposit to investment pool (will start earning dividends)
            try
            {
                await SecurityDepositService.AddToInvestmentPoolAsync(securityDeposit.Id);
            }
            catch (Exception poolEx)
            {
                // Non-critical: deposit collected but not added to pool yet
                // Can be added manually later from Security Deposits page
                var message = poolEx.Message + (poolEx.InnerException != null ? $" - {poolEx.InnerException}" : string.Empty);
                ToastService.ShowWarning($"Security deposit collected but not added to investment pool: {message}");
            }
            // Update lease with tenant ID and signed status
            lease.TenantId = tenant.Id;
            lease.Status = ApplicationConstants.LeaseStatuses.Active;
            lease.SignedOn = DateTime.UtcNow;
            lease.Notes += $"\n\nAccepted on: {DateTime.UtcNow:MMM dd, yyyy h:mm tt UTC}\n" +
                          $"IP Address: {GetClientIpAddress()}\n" +
                          $"Security Deposit: {lease.SecurityDeposit:C} ({acceptanceModel.PaymentMethod})\n" +
                          $"Transaction Ref: {acceptanceModel.TransactionReference ?? "N/A"}\n" +
                          $"Processed by: {userId}";
            
            if (!string.IsNullOrWhiteSpace(acceptanceModel.Notes))
            {
                lease.Notes += $"\nAcceptance Notes: {acceptanceModel.Notes}";
            }

            
            await LeaseService.UpdateAsync(lease);

            // Update property status to Occupied
            if (lease.Property != null)
            {
                lease.Property.Status = ApplicationConstants.PropertyStatuses.Occupied;
                lease.Property.IsAvailable = false;
                
                await PropertyService.UpdateAsync(lease.Property);
            }

            // Update application status
            if (application != null)
            {
                application.Status = "LeaseAccepted"; // We'll add this status
                
                await RentalApplicationService.UpdateAsync(application);
            }

            // Update prospect status to ConvertedToTenant
            prospectiveTenant.Status = ApplicationConstants.ProspectiveStatuses.ConvertedToTenant;
            
            await ProspectiveTenantService.UpdateAsync(prospectiveTenant);

            ToastService.ShowSuccess($"Lease accepted! Tenant {tenant.FullName} created successfully.");
            
            // Navigate to the tenant view
            Navigation.NavigateTo($"/propertymanagement/tenants/{tenant.Id}");
        }
        catch (Exception ex)
        {
            var message = ex.Message + (ex.InnerException != null ? $" - {ex.InnerException}" : string.Empty);
            errorMessage = $"Error accepting lease: {message}";
            ToastService.ShowError(errorMessage);
            Console.WriteLine(errorMessage);
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private async Task HandleDeclineLease()
    {
        if (lease == null) return;

        isSubmitting = true;
        errorMessage = string.Empty;

        try
        {
            // Update lease status to declined
            lease.Status = "Declined";
            lease.DeclinedOn = DateTime.UtcNow;
            lease.Notes += $"\n\nDeclined on: {DateTime.UtcNow:MMM dd, yyyy h:mm tt UTC}\n" +
                          $"Declined by: {userId}\n" +
                          $"Reason: {(string.IsNullOrWhiteSpace(declineReason) ? "Not specified" : declineReason)}";
            await LeaseService.UpdateAsync(lease);

            // Check if there are other pending applications
            var allApplications = await RentalApplicationService.GetAllAsync();
            var otherPendingApps = allApplications.Any(a => 
                a.PropertyId == lease.PropertyId && 
                (a.Status == ApplicationConstants.ApplicationStatuses.Submitted ||
                 a.Status == ApplicationConstants.ApplicationStatuses.UnderReview ||
                 a.Status == ApplicationConstants.ApplicationStatuses.Screening));

            // Update property status
            if (lease.Property != null)
            {
                lease.Property.Status = otherPendingApps 
                    ? ApplicationConstants.PropertyStatuses.ApplicationPending 
                    : ApplicationConstants.PropertyStatuses.Available;
                lease.Property.IsAvailable = !otherPendingApps;
                
                await PropertyService.UpdateAsync(lease.Property);
            }

            // Update application and prospect status
            if (application != null)
            {
                application.Status = "LeaseDeclined";
               
                await RentalApplicationService.UpdateAsync(application);
            }

            if (prospectiveTenant != null)
            {
                prospectiveTenant.Status = "LeaseDeclined";
                
                await ProspectiveTenantService.UpdateAsync(prospectiveTenant);
            }

            showDeclineModal = false;
            ToastService.ShowInfo("Lease offer declined.");
            Navigation.NavigateTo("/propertymanagement/leases");
        }
        catch (Exception ex)
        {
            errorMessage = $"Error declining lease: {ex.Message}";
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private string GetTimeRemaining()
    {
        if (lease?.ExpiresOn == null) return "N/A";
        
        var timeSpan = lease.ExpiresOn.Value - DateTime.UtcNow;
        
        if (timeSpan.TotalDays > 1)
            return $"{(int)timeSpan.TotalDays} days remaining";
        else if (timeSpan.TotalHours > 1)
            return $"{(int)timeSpan.TotalHours} hours remaining";
        else if (timeSpan.TotalMinutes > 0)
            return $"{(int)timeSpan.TotalMinutes} minutes remaining";
        else
            return "Expired";
    }

    private string GetClientIpAddress()
    {
        try
        {
            var context = HttpContextAccessor.HttpContext;
            if (context != null)
            {
                var forwardedFor = context.Request.Headers["X-Forwarded-For"].FirstOrDefault();
                if (!string.IsNullOrEmpty(forwardedFor))
                {
                    return forwardedFor.Split(',')[0].Trim();
                }
                return context.Connection.RemoteIpAddress?.ToString() ?? "Unknown";
            }
        }
        catch { }
        
        return "Unknown";
    }

    private void Cancel()
    {
        Navigation.NavigateTo($"/propertymanagement/leases/{LeaseId}");
    }

    public class LeaseAcceptanceModel
    {
        [Required(ErrorMessage = "You must confirm that the tenant agrees to the terms")]
        public bool AgreesToTerms { get; set; }

        [Required(ErrorMessage = "You must confirm that the security deposit has been paid")]
        public bool SecurityDepositPaid { get; set; }

        [Required(ErrorMessage = "Payment method is required")]
        public string PaymentMethod { get; set; } = string.Empty;

        [StringLength(100)]
        public string? TransactionReference { get; set; }

        [StringLength(1000)]
        public string? Notes { get; set; }
    }
}
