@page "/PropertyManagement/ProspectiveTenants"
@using Aquiis.SimpleStart.Core.Entities
@using Aquiis.SimpleStart.Application.Services
@using Aquiis.SimpleStart.Shared.Services
@using Aquiis.SimpleStart.Application.Services.PdfGenerators
@using Aquiis.SimpleStart.Core.Constants
@using Aquiis.SimpleStart.Utilities
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = "SuperAdministrator,Administrator,PropertyManager")]
@inject UserContextService UserContext
@inject NavigationManager Navigation
@inject ToastService ToastService
@inject PropertyManagementService PropertyService

@rendermode InteractiveServer

<PageTitle>Prospective Tenants</PageTitle>

<div class="container-fluid">
    <div class="row mb-3">
        <div class="col">
            <h1>Prospective Tenants</h1>
            <p class="text-muted">Manage leads and track the application pipeline</p>
        </div>
        <div class="col-auto">
            <button class="btn btn-primary" @onclick="ShowAddProspect">
                <i class="bi bi-plus-circle"></i> Add New Prospect
            </button>
        </div>
    </div>

    @if (showAddForm)
    {
        <div class="card mb-3">
            <div class="card-header">
                <h5>Add New Prospective Tenant</h5>
            </div>
            <div class="card-body">
                <EditForm Model="newProspect" OnValidSubmit="HandleAddProspect">
                    <DataAnnotationsValidator />
                    <ValidationSummary />

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">First Name *</label>
                            <InputText class="form-control" @bind-Value="newProspect.FirstName" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Last Name *</label>
                            <InputText class="form-control" @bind-Value="newProspect.LastName" />
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Email *</label>
                            <InputText class="form-control" type="email" @bind-Value="newProspect.Email" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Phone *</label>
                            <InputText class="form-control" type="tel" @bind-Value="newProspect.Phone" />
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Date of Birth</label>
                            <InputDate class="form-control" @bind-Value="newProspect.DateOfBirth" />
                        </div>
                        <div class="col-md-5 mb-3">
                            <label class="form-label">Identification Number</label>
                            <InputText class="form-control" @bind-Value="newProspect.IdentificationNumber" placeholder="e.g., Driver's License #" />
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">ID State</label>
                            <InputSelect class="form-select" @bind-Value="newProspect.IdentificationState">
                                <option value="">Select...</option>
                                @foreach (var state in States.StatesArray())
                                {
                                    <option value="@state.Abbreviation">@state.Abbreviation</option>
                                }
                            </InputSelect>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Source</label>
                            <InputSelect class="form-select" @bind-Value="newProspect.Source">
                                <option value="">Select source...</option>
                                @foreach (var source in ApplicationConstants.ProspectiveSources.AllProspectiveSources)
                                {
                                    <option value="@source">@source</option>
                                }
                            </InputSelect>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Interested Property</label>
                            <InputSelect class="form-select" @bind-Value="newProspect.InterestedPropertyId">
                                <option value="">Select property...</option>
                                @foreach (var property in properties)
                                {
                                    <option value="@property.Id">@property.Address</option>
                                }
                            </InputSelect>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Desired Move-In Date</label>
                            <InputDate class="form-control" @bind-Value="newProspect.DesiredMoveInDate" />
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <InputTextArea class="form-control" rows="3" @bind-Value="newProspect.Notes" />
                    </div>

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">Save Prospect</button>
                        <button type="button" class="btn btn-secondary" @onclick="CancelAdd">Cancel</button>
                    </div>
                </EditForm>
            </div>
        </div>
    }

    @if (loading)
    {
        <div class="text-center p-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else
    {
        <div class="card">
            <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs">
                    <li class="nav-item">
                        <a class="nav-link @(filterStatus == "All" ? "active" : "")" 
                           @onclick='() => SetFilter("All")' style="cursor: pointer;">
                            All (@prospects.Count)
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link @(filterStatus == ApplicationConstants.ProspectiveStatuses.Lead ? "active" : "")" 
                           @onclick='() => SetFilter(ApplicationConstants.ProspectiveStatuses.Lead)' style="cursor: pointer;">
                            Leads (@prospects.Count(p => p.Status == ApplicationConstants.ProspectiveStatuses.Lead))
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link @(filterStatus == ApplicationConstants.ProspectiveStatuses.TourScheduled ? "active" : "")" 
                           @onclick='() => SetFilter(ApplicationConstants.ProspectiveStatuses.TourScheduled)' style="cursor: pointer;">
                            Tours Scheduled (@prospects.Count(p => p.Status == ApplicationConstants.ProspectiveStatuses.TourScheduled))
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link @(filterStatus == ApplicationConstants.ProspectiveStatuses.Applied ? "active" : "")" 
                           @onclick='() => SetFilter(ApplicationConstants.ProspectiveStatuses.Applied)' style="cursor: pointer;">
                            Applied (@prospects.Count(p => p.Status == ApplicationConstants.ProspectiveStatuses.Applied))
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link @(filterStatus == ApplicationConstants.ProspectiveStatuses.Approved ? "active" : "")" 
                           @onclick='() => SetFilter(ApplicationConstants.ProspectiveStatuses.Approved)' style="cursor: pointer;">
                            Approved (@prospects.Count(p => p.Status == ApplicationConstants.ProspectiveStatuses.Approved))
                        </a>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                @if (!filteredProspects.Any())
                {
                    <div class="text-center text-muted p-4">
                        <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                        <p class="mt-2">No prospective tenants found</p>
                    </div>
                }
                else
                {
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Contact</th>
                                    <th>Interested Property</th>
                                    <th>Status</th>
                                    <th>Source</th>
                                    <th>First Contact</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var prospect in filteredProspects)
                                {
                                    <tr>
                                        <td>
                                            <strong>@prospect.FullName</strong>
                                        </td>
                                        <td>
                                            <div>@prospect.Email</div>
                                            <small class="text-muted">@prospect.Phone</small>
                                        </td>
                                        <td>
                                            @if (prospect.InterestedProperty != null)
                                            {
                                                <span>@prospect.InterestedProperty.Address</span>
                                            }
                                            else
                                            {
                                                <span class="text-muted">Not specified</span>
                                            }
                                        </td>
                                        <td>
                                            <span class="badge @GetStatusBadgeClass(prospect.Status)">
                                                @GetStatusDisplay(prospect.Status)
                                            </span>
                                        </td>
                                        <td>@(prospect.Source ?? "N/A")</td>
                                        <td>@prospect.FirstContactedOn?.ToString("MM/dd/yyyy")</td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                @if (prospect.Status == ApplicationConstants.ProspectiveStatuses.Lead)
                                                {
                                                    <button class="btn btn-outline-primary" 
                                                            @onclick="() => ScheduleTour(prospect.Id)"
                                                            title="Schedule Tour">
                                                        <i class="bi bi-calendar-plus"></i>
                                                    </button>
                                                }
                                                @if (prospect.Status == ApplicationConstants.ProspectiveStatuses.TourScheduled || 
                                                     prospect.Status == ApplicationConstants.ProspectiveStatuses.Lead)
                                                {
                                                    <button class="btn btn-success" 
                                                            @onclick="() => BeginApplication(prospect.Id)"
                                                            title="Begin Application">
                                                        <i class="bi bi-file-earmark-text"></i> Apply
                                                    </button>
                                                }
                                                <button class="btn btn-outline-info" 
                                                        @onclick="() => ViewDetails(prospect.Id)"
                                                        title="View Details">
                                                    <i class="bi bi-eye"></i>
                                                </button>
                                                <button class="btn btn-outline-danger" 
                                                        @onclick="() => DeleteProspect(prospect.Id)"
                                                        title="Delete">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
            </div>
        </div>
    }
</div>

@code {
    private List<ProspectiveTenant> prospects = new();
    private List<Aquiis.SimpleStart.Core.Entities.Property> properties = new();
    private bool loading = true;
    private bool showAddForm = false;
    private ProspectViewModel newProspect = new();
    private string filterStatus = "All";

    private List<ProspectiveTenant> filteredProspects =>
        filterStatus == "All" 
            ? prospects 
            : prospects.Where(p => p.Status == filterStatus).ToList();

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        loading = true;
        try
        {
            var orgId = await UserContext.GetOrganizationIdAsync();
            if (!string.IsNullOrEmpty(orgId))
            {
                prospects = await PropertyService.GetAllProspectiveTenantsAsync(orgId);
                
                // Load properties for dropdown
                var dbContextFactory = Navigation.ToAbsoluteUri("/").ToString(); // Get service
                // For now, we'll need to inject PropertyManagementService
                var allProperties = await PropertyService.GetPropertiesAsync();
                properties = allProperties.Where(p => p.IsAvailable).ToList();
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error loading prospects: {ex.Message}");
        }
        finally
        {
            loading = false;
        }
    }

    private void ShowAddProspect()
    {
        newProspect = new ProspectViewModel();
        showAddForm = true;
    }

    private void CancelAdd()
    {
        showAddForm = false;
        newProspect = new();
    }

    private async Task HandleAddProspect()
    {
        try
        {
            var orgId = await UserContext.GetOrganizationIdAsync();
            var userId = await UserContext.GetUserIdAsync();

            if (string.IsNullOrEmpty(orgId) || string.IsNullOrEmpty(userId))
            {
                ToastService.ShowError("User context not available");
                return;
            }

            // Map ViewModel to Entity
            var prospect = new ProspectiveTenant
            {
                FirstName = newProspect.FirstName,
                LastName = newProspect.LastName,
                Email = newProspect.Email,
                Phone = newProspect.Phone,
                DateOfBirth = newProspect.DateOfBirth,
                IdentificationNumber = newProspect.IdentificationNumber,
                IdentificationState = newProspect.IdentificationState,
                Source = newProspect.Source,
                Notes = newProspect.Notes,
                InterestedPropertyId = newProspect.InterestedPropertyId,
                DesiredMoveInDate = newProspect.DesiredMoveInDate,
                OrganizationId = orgId,
                CreatedBy = userId
            };
            
            await PropertyService.CreateProspectiveTenantAsync(prospect);
            
            ToastService.ShowSuccess("Prospective tenant added successfully");
            showAddForm = false;
            await LoadData();
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error adding prospect: {ex.Message}");
        }
    }

    private void SetFilter(string status)
    {
        filterStatus = status;
    }

    private void ScheduleTour(int prospectId)
    {
        Navigation.NavigateTo($"/PropertyManagement/Tours/Schedule/{prospectId}");
    }

    private void BeginApplication(int prospectId)
    {
        Navigation.NavigateTo($"/propertymanagement/prospects/{prospectId}/submit-application");
    }

    private void ViewDetails(int prospectId)
    {
        Navigation.NavigateTo($"/PropertyManagement/ProspectiveTenants/{prospectId}");
    }

    private async Task DeleteProspect(int prospectId)
    {
        // TODO: Add confirmation dialog in future sprint
        try
        {
            var orgId = await UserContext.GetOrganizationIdAsync();
            var userId = await UserContext.GetUserIdAsync();
            
            if (!string.IsNullOrEmpty(orgId) && !string.IsNullOrEmpty(userId))
            {
                await PropertyService.DeleteProspectiveTenantAsync(prospectId, orgId, userId);
                ToastService.ShowSuccess("Prospect deleted successfully");
                await LoadData();
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error deleting prospect: {ex.Message}");
        }
    }

    private string GetStatusBadgeClass(string status) => status switch
    {
        var s when s == ApplicationConstants.ProspectiveStatuses.Lead => "bg-secondary",
        var s when s == ApplicationConstants.ProspectiveStatuses.TourScheduled => "bg-info",
        var s when s == ApplicationConstants.ProspectiveStatuses.Applied => "bg-primary",
        var s when s == ApplicationConstants.ProspectiveStatuses.Screening => "bg-warning",
        var s when s == ApplicationConstants.ProspectiveStatuses.Approved => "bg-success",
        var s when s == ApplicationConstants.ProspectiveStatuses.Denied => "bg-danger",
        _ => "bg-secondary"
    };

    private string GetStatusDisplay(string status) => status switch
    {
        var s when s == ApplicationConstants.ProspectiveStatuses.TourScheduled => "Tour Scheduled",
        var s when s == ApplicationConstants.ProspectiveStatuses.ConvertedToTenant => "Converted",
        _ => status
    };

    public class ProspectViewModel
    {
        [Required(ErrorMessage = "First name is required")]
        [StringLength(100)]
        public string FirstName { get; set; } = string.Empty;

        [Required(ErrorMessage = "Last name is required")]
        [StringLength(100)]
        public string LastName { get; set; } = string.Empty;

        [Required(ErrorMessage = "Email is required")]
        [EmailAddress(ErrorMessage = "Invalid email address")]
        [StringLength(200)]
        public string Email { get; set; } = string.Empty;

        [Required(ErrorMessage = "Phone is required")]
        [Phone(ErrorMessage = "Invalid phone number")]
        [StringLength(20)]
        public string Phone { get; set; } = string.Empty;

        public DateTime? DateOfBirth { get; set; }

        [StringLength(100)]
        public string? IdentificationNumber { get; set; }

        [StringLength(2)]
        public string? IdentificationState { get; set; }

        [StringLength(100)]
        public string? Source { get; set; }

        [StringLength(2000)]
        public string? Notes { get; set; }

        public int? InterestedPropertyId { get; set; }

        public DateTime? DesiredMoveInDate { get; set; }
    }
}
