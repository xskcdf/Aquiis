@page "/PropertyManagement/Tours/Schedule/{ProspectId:guid}"

@using Aquiis.SimpleStart.Core.Entities
@using Aquiis.SimpleStart.Application.Services
@using Aquiis.SimpleStart.Shared.Services
@using Aquiis.SimpleStart.Application.Services.PdfGenerators
@using Aquiis.SimpleStart.Core.Constants
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Authorization
@attribute [OrganizationAuthorize("Owner", "Administrator", "PropertyManager")]
@inject ProspectiveTenantService ProspectiveTenantService
@inject PropertyService PropertyService
@inject TourService TourService
@inject ChecklistService ChecklistService
@inject UserContextService UserContext
@inject NavigationManager Navigation
@inject ToastService ToastService

@rendermode InteractiveServer

<PageTitle>Schedule Tour</PageTitle>

<div class="container-fluid">
    <div class="row mb-3">
        <div class="col">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/PropertyManagement/ProspectiveTenants">Prospective Tenants</a></li>
                    <li class="breadcrumb-item active">Schedule Tour</li>
                </ol>
            </nav>
            <h3>Schedule Property Tour</h3>
        </div>
    </div>

    @if (loading)
    {
        <div class="text-center p-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (prospect == null)
    {
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle"></i> Prospective tenant not found.
        </div>
    }
    else
    {
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5>Tour Details</h5>
                    </div>
                    <div class="card-body">
                        <EditForm Model="newTour" OnValidSubmit="HandleScheduleTour">
                            <DataAnnotationsValidator />
                            <ValidationSummary />

                            <div class="mb-3">
                                <label class="form-label">Prospective Tenant</label>
                                <input type="text" class="form-control" value="@prospect.FullName" disabled />
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Property *</label>
                                <InputSelect class="form-select" @bind-Value="newTour.PropertyId">
                                    <option value="0">Select property...</option>
                                    @foreach (var property in availableProperties)
                                    {
                                        <option value="@property.Id">@property.Address - $@property.MonthlyRent.ToString("N0")/mo</option>
                                    }
                                </InputSelect>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Property Tour Checklist *</label>
                                <InputSelect class="form-select" @bind-Value="newTour.ChecklistTemplateId">
                                    <option value="0">Select checklist template...</option>
                                    @foreach (var template in tourTemplates)
                                    {
                                        <option value="@template.Id">@template.Name @(template.IsSystemTemplate ? "(System)" : "(Custom)")</option>
                                    }
                                </InputSelect>
                                <div class="form-text">Select which checklist to use for this property tour</div>
                            </div>

                            <div class="row">
                                <div class="col-md-8 mb-3">
                                    <label class="form-label">Scheduled Date & Time *</label>
                                    <InputDate Type="InputDateType.DateTimeLocal" class="form-control" @bind-Value="newTour.ScheduledOn" />
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Duration (minutes) *</label>
                                    <InputNumber class="form-control" @bind-Value="newTour.DurationMinutes" />
                                </div>
                            </div>

                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary">Schedule Tour</button>
                                <button type="button" class="btn btn-secondary" @onclick="Cancel">Cancel</button>
                            </div>
                        </EditForm>
                    </div>
                </div>

                @if (upcomingTours.Any())
                {
                    <div class="card mt-3">
                        <div class="card-header">
                            <h6>Upcoming Tours for @prospect.FullName</h6>
                        </div>
                        <div class="card-body">
                            <div class="list-group">
                                @foreach (var tour in upcomingTours)
                                {
                                    <div class="list-group-item">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <h6 class="mb-1">@tour.Property?.Address</h6>
                                                <p class="mb-1">
                                                    <i class="bi bi-calendar"></i> @tour.ScheduledOn.ToString("MMM dd, yyyy")
                                                    <i class="bi bi-clock ms-2"></i> @tour.ScheduledOn.ToString("h:mm tt")
                                                    <span class="ms-2 text-muted">(@tour.DurationMinutes min)</span>
                                                </p>
                                                <small class="text-muted">Status: @tour.Status</small>
                                            </div>
                                            <span class="badge bg-info">@tour.Status</span>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>

            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h6>Prospect Information</h6>
                    </div>
                    <div class="card-body">
                        <dl>
                            <dt>Name</dt>
                            <dd>@prospect.FullName</dd>

                            <dt>Email</dt>
                            <dd><a href="mailto:@prospect.Email">@prospect.Email</a></dd>

                            <dt>Phone</dt>
                            <dd><a href="tel:@prospect.Phone">@prospect.Phone</a></dd>

                            <dt>Status</dt>
                            <dd><span class="badge bg-info">@prospect.Status</span></dd>

                            @if (prospect.InterestedProperty != null)
                            {
                                <dt>Interested In</dt>
                                <dd>@prospect.InterestedProperty.Address</dd>
                            }

                            @if (prospect.DesiredMoveInDate.HasValue)
                            {
                                <dt>Desired Move-In</dt>
                                <dd>@prospect.DesiredMoveInDate.Value.ToString("MM/dd/yyyy")</dd>
                            }

                            @if (!string.IsNullOrEmpty(prospect.Notes))
                            {
                                <dt>Notes</dt>
                                <dd>@prospect.Notes</dd>
                            }
                        </dl>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public Guid ProspectId { get; set; }

    private ProspectiveTenant? prospect;
    private List<Aquiis.SimpleStart.Core.Entities.Property> availableProperties = new();
    private List<Tour> upcomingTours = new();
    private List<ChecklistTemplate> tourTemplates = new();
    private TourViewModel newTour = new();
    private bool loading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        loading = true;
        try
        {
            var organizationId = await UserContext.GetActiveOrganizationIdAsync();
            if (organizationId.HasValue)
            {
                prospect = await ProspectiveTenantService.GetByIdAsync(ProspectId);
                
                if (prospect != null)
                {
                    // Load available properties (Available status only)
                    var allProperties = await PropertyService.GetAllAsync();
                    availableProperties = allProperties
                        .Where(p => p.Status == ApplicationConstants.PropertyStatuses.Available)
                        .ToList();

                    // Load available Property Tour templates
                    var allTemplates = await ChecklistService.GetChecklistTemplatesAsync();
                    tourTemplates = allTemplates
                        .Where(t => t.Category == "Tour" && !t.IsDeleted)
                        .OrderByDescending(t => t.IsSystemTemplate) // System templates first
                        .ThenBy(t => t.Name)
                        .ToList();

                    // Load existing tours for this prospect
                    upcomingTours = await TourService.GetByProspectiveIdAsync(ProspectId);
                    upcomingTours = upcomingTours
                        .Where(s => s.ScheduledOn >= DateTime.Now && s.Status == ApplicationConstants.TourStatuses.Scheduled)
                        .OrderBy(s => s.ScheduledOn)
                        .ToList();

                    // Initialize new tour ViewModel
                    newTour = new TourViewModel
                    {
                        ProspectiveTenantId = ProspectId,
                        PropertyId = prospect.InterestedPropertyId ?? Guid.Empty,
                        ScheduledOn = DateTime.Now.AddDays(1).Date.AddHours(10), // Default to tomorrow at 10 AM
                        DurationMinutes = 30,
                        ChecklistTemplateId = tourTemplates.FirstOrDefault(t => t.IsSystemTemplate && t.Name == "Property Tour")?.Id ?? tourTemplates.FirstOrDefault()?.Id
                    };
                }
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error loading data: {ex.Message}");
        }
        finally
        {
            loading = false;
        }
    }

    private async Task HandleScheduleTour()
    {
        try
        {
            if (newTour.PropertyId == Guid.Empty)
            {
                ToastService.ShowError("Please select a property");
                return;
            }

            if (!newTour.ChecklistTemplateId.HasValue || newTour.ChecklistTemplateId.Value == Guid.Empty)
            {
                ToastService.ShowError("Please select a checklist template");
                return;
            }

            var organizationId = await UserContext.GetActiveOrganizationIdAsync();
            var userId = await UserContext.GetUserIdAsync();

            if (!organizationId.HasValue || string.IsNullOrEmpty(userId))
            {
                ToastService.ShowError("User context not available");
                return;
            }

            // Map ViewModel to Entity
            var tour = new Tour
            {
                ProspectiveTenantId = newTour.ProspectiveTenantId,
                PropertyId = newTour.PropertyId,
                ScheduledOn = newTour.ScheduledOn,
                DurationMinutes = newTour.DurationMinutes,
                OrganizationId = organizationId.Value,
                CreatedBy = userId
            };
            
            await TourService.CreateAsync(tour, newTour.ChecklistTemplateId);
            
            ToastService.ShowSuccess("Tour scheduled successfully");
            Navigation.NavigateTo("/PropertyManagement/Tours");
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error scheduling tour: {ex.Message}");
        }
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/PropertyManagement/ProspectiveTenants");
    }

    public class TourViewModel
    {
        [Required]
        public Guid ProspectiveTenantId { get; set; }

        [Required(ErrorMessage = "Property is required")]
        public Guid PropertyId { get; set; }

        [Required(ErrorMessage = "Date and time is required")]
        public DateTime ScheduledOn { get; set; }

        [Required(ErrorMessage = "Duration is required")]
        [Range(15, 180, ErrorMessage = "Duration must be between 15 and 180 minutes")]
        public int DurationMinutes { get; set; }

        [Required(ErrorMessage = "Checklist template is required")]
        public Guid? ChecklistTemplateId { get; set; }
    }
}
