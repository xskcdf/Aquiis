@page "/propertymanagement/prospects/{ProspectId:guid}/submit-application"

@using Aquiis.SimpleStart.Core.Entities
@using Aquiis.SimpleStart.Core.Validation
@using Aquiis.SimpleStart.Application.Services
@using Aquiis.SimpleStart.Shared.Services
@using Aquiis.SimpleStart.Application.Services.PdfGenerators
@using Aquiis.SimpleStart.Application.Services.Workflows
@using Aquiis.SimpleStart.Core.Constants
@using Microsoft.AspNetCore.Authorization
@using System.ComponentModel.DataAnnotations

@inject ProspectiveTenantService ProspectiveTenantService
@inject RentalApplicationService RentalApplicationService
@inject PropertyService PropertyService
@inject OrganizationService OrganizationService
@inject ApplicationWorkflowService WorkflowService
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider
@inject UserContextService UserContext
@inject ToastService ToastService

@attribute [OrganizationAuthorize("Owner", "Administrator", "PropertyManager", "Tenant")]
@rendermode InteractiveServer

<PageTitle>Submit Rental Application</PageTitle>

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/propertymanagement">Property Management</a></li>
                    <li class="breadcrumb-item"><a href="/PropertyManagement/ProspectiveTenants">Prospects</a></li>
                    <li class="breadcrumb-item active">Submit Application</li>
                </ol>
            </nav>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (prospect == null)
    {
        <div class="alert alert-danger">
            <h4 class="alert-heading">Prospect Not Found</h4>
            <p>The prospective tenant you are trying to view does not exist or you do not have permission to access it.</p>
            <hr>
            <a href="/PropertyManagement/ProspectiveTenants" class="btn btn-primary">Return to Prospects</a>
        </div>
    }
    else if (existingApplication != null)
    {
        <div class="alert alert-warning">
            <h4 class="alert-heading">Application Already Submitted</h4>
            <p>This prospective tenant has already submitted an application for <strong>@existingApplication.Property?.Address</strong>.</p>
            <p><strong>Status:</strong> @existingApplication.Status</p>
            <p><strong>Applied On:</strong> @existingApplication.AppliedOn.ToString("MMM dd, yyyy")</p>
            <hr>
            <a href="/PropertyManagement/ProspectiveTenants/@ProspectId" class="btn btn-primary">View Prospect</a>
        </div>
    }
    else
    {
        <div class="row">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h3 class="card-title mb-0">Submit Rental Application</h3>
                    </div>
                    <div class="card-body">
                        @if (!string.IsNullOrEmpty(errorMessage))
                        {
                            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                                @errorMessage
                                <button type="button" class="btn-close" @onclick="() => errorMessage = string.Empty"></button>
                            </div>
                        }

                        <EditForm Model="applicationModel" OnValidSubmit="HandleSubmitApplication">
                            <DataAnnotationsValidator />
                            <ValidationSummary class="text-danger" />

                            <div class="mb-4">
                                <h5 class="border-bottom pb-2">Applicant Information</h5>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <strong>Name:</strong> @prospect.FullName
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Email:</strong> @prospect.Email
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Phone:</strong> @prospect.Phone
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Date of Birth:</strong> @prospect.DateOfBirth?.ToString("MMM dd, yyyy")
                                    </div>
                                </div>
                            </div>

                            <div class="mb-4">
                                <h5 class="border-bottom pb-2">Property Selection</h5>
                                <div class="mb-3">
                                    <label class="form-label">Property *</label>
                                    <InputSelect @bind-Value="applicationModel.PropertyId" @bind-Value:after="UpdateSelectedProperty" class="form-select">
                                        <option value="0">Select a property...</option>
                                        @foreach (var property in availableProperties)
                                        {
                                            <option value="@property.Id">@property.Address - @property.MonthlyRent.ToString("C")/mo</option>
                                        }
                                    </InputSelect>
                                    <ValidationMessage For="() => applicationModel.PropertyId" class="text-danger small" />
                                </div>

                                @if (selectedProperty != null)
                                {
                                    <div class="alert alert-info">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <strong>Property:</strong> @selectedProperty.Address<br />
                                                <strong>Type:</strong> @selectedProperty.PropertyType<br />
                                                <strong>Beds/Baths:</strong> @selectedProperty.Bedrooms / @selectedProperty.Bathrooms
                                            </div>
                                            <div class="col-md-6">
                                                <strong>Monthly Rent:</strong> @selectedProperty.MonthlyRent.ToString("C")<br />
                                                <strong>Sq Ft:</strong> @selectedProperty.SquareFeet<br />
                                                <strong>Status:</strong> <span class="badge bg-success">@selectedProperty.Status</span>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>

                            <div class="mb-4">
                                <h5 class="border-bottom pb-2">Current Address</h5>
                                <div class="row g-3">
                                    <div class="col-12">
                                        <label class="form-label">Street Address *</label>
                                        <InputText @bind-Value="applicationModel.CurrentAddress" class="form-control" placeholder="123 Main St" />
                                        <ValidationMessage For="() => applicationModel.CurrentAddress" class="text-danger small" />
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">City *</label>
                                        <InputText @bind-Value="applicationModel.CurrentCity" class="form-control" placeholder="Los Angeles" />
                                        <ValidationMessage For="() => applicationModel.CurrentCity" class="text-danger small" />
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">State *</label>
                                        <InputSelect @bind-Value="applicationModel.CurrentState" class="form-select">
                                            <option value="">Select state...</option>
                                            @foreach (var state in ApplicationConstants.USStateAbbreviations)
                                            {
                                                <option value="@state">@state</option>
                                            }
                                        </InputSelect>
                                        <ValidationMessage For="() => applicationModel.CurrentState" class="text-danger small" />
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Zip Code *</label>
                                        <InputText @bind-Value="applicationModel.CurrentZipCode" class="form-control" placeholder="90210" />
                                        <ValidationMessage For="() => applicationModel.CurrentZipCode" class="text-danger small" />
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Current Monthly Rent *</label>
                                        <div class="input-group">
                                            <span class="input-group-text">$</span>
                                            <InputNumber @bind-Value="applicationModel.CurrentRent" class="form-control" step="0.01" />
                                        </div>
                                        <ValidationMessage For="() => applicationModel.CurrentRent" class="text-danger small" />
                                    </div>
                                </div>
                            </div>

                            <div class="mb-4">
                                <h5 class="border-bottom pb-2">Current Landlord</h5>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Landlord Name *</label>
                                        <InputText @bind-Value="applicationModel.LandlordName" class="form-control" placeholder="John Smith" />
                                        <ValidationMessage For="() => applicationModel.LandlordName" class="text-danger small" />
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Landlord Phone *</label>
                                        <InputText @bind-Value="applicationModel.LandlordPhone" class="form-control" placeholder="(555) 123-4567" />
                                        <ValidationMessage For="() => applicationModel.LandlordPhone" class="text-danger small" />
                                    </div>
                                </div>
                            </div>

                            <div class="mb-4">
                                <h5 class="border-bottom pb-2">Employment Information</h5>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Employer Name *</label>
                                        <InputText @bind-Value="applicationModel.EmployerName" class="form-control" placeholder="ABC Company" />
                                        <ValidationMessage For="() => applicationModel.EmployerName" class="text-danger small" />
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Job Title *</label>
                                        <InputText @bind-Value="applicationModel.JobTitle" class="form-control" placeholder="Software Engineer" />
                                        <ValidationMessage For="() => applicationModel.JobTitle" class="text-danger small" />
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Monthly Income *</label>
                                        <div class="input-group">
                                            <span class="input-group-text">$</span>
                                            <InputNumber @bind-Value="applicationModel.MonthlyIncome" class="form-control" step="0.01" />
                                        </div>
                                        <ValidationMessage For="() => applicationModel.MonthlyIncome" class="text-danger small" />
                                        @if (selectedProperty != null && applicationModel.MonthlyIncome > 0)
                                        {
                                            var ratio = selectedProperty.MonthlyRent / applicationModel.MonthlyIncome;
                                            var percentOfIncome = ratio * 100;
                                            <small class="text-muted">
                                                Rent would be @percentOfIncome.ToString("F1")% of income
                                                @if (ratio <= 0.30m)
                                                {
                                                    <span class="text-success">(Good)</span>
                                                }
                                                else if (ratio <= 0.35m)
                                                {
                                                    <span class="text-warning">(Acceptable)</span>
                                                }
                                                else
                                                {
                                                    <span class="text-danger">(High)</span>
                                                }
                                            </small>
                                        }
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Employment Length (Months) *</label>
                                        <InputNumber @bind-Value="applicationModel.EmploymentLengthMonths" class="form-control" />
                                        <ValidationMessage For="() => applicationModel.EmploymentLengthMonths" class="text-danger small" />
                                    </div>
                                </div>
                            </div>

                            <div class="mb-4">
                                <h5 class="border-bottom pb-2">References</h5>
                                <div class="row g-3">
                                    <div class="col-12"><strong>Reference 1 (Required)</strong></div>
                                    <div class="col-md-4">
                                        <label class="form-label">Name *</label>
                                        <InputText @bind-Value="applicationModel.Reference1Name" class="form-control" />
                                        <ValidationMessage For="() => applicationModel.Reference1Name" class="text-danger small" />
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Phone *</label>
                                        <InputText @bind-Value="applicationModel.Reference1Phone" class="form-control" />
                                        <ValidationMessage For="() => applicationModel.Reference1Phone" class="text-danger small" />
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Relationship *</label>
                                        <InputText @bind-Value="applicationModel.Reference1Relationship" class="form-control" placeholder="Friend, Coworker, etc." />
                                        <ValidationMessage For="() => applicationModel.Reference1Relationship" class="text-danger small" />
                                    </div>

                                    <div class="col-12 mt-3"><strong>Reference 2 (Optional)</strong></div>
                                    <div class="col-md-4">
                                        <label class="form-label">Name</label>
                                        <InputText @bind-Value="applicationModel.Reference2Name" class="form-control" />
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Phone</label>
                                        <InputText @bind-Value="applicationModel.Reference2Phone" class="form-control" />
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Relationship</label>
                                        <InputText @bind-Value="applicationModel.Reference2Relationship" class="form-control" />
                                    </div>
                                </div>
                            </div>

                            @if (applicationFeeRequired)
                            {
                                <div class="alert alert-warning">
                                    <h5><i class="bi bi-credit-card me-2"></i>Application Fee</h5>
                                    <p class="mb-2"><strong>Amount Due:</strong> @applicationFee.ToString("C")</p>
                                    <p class="mb-0"><small>Application fee is non-refundable and must be paid to process your application.</small></p>
                                </div>
                            }

                            <div class="d-flex justify-content-between mt-4">
                                <button type="button" class="btn btn-secondary" @onclick="Cancel">
                                    <i class="bi bi-x-circle me-2"></i>Cancel
                                </button>
                                <button type="submit" class="btn btn-primary btn-lg">
                                    @if (isSubmitting)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                        <span>Submitting...</span>
                                    }
                                    else
                                    {
                                        <i class="bi bi-send me-2"></i>
                                        <span>Submit Application</span>
                                    }
                                </button>
                            </div>
                        </EditForm>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Application Checklist</h5>
                    </div>
                    <div class="card-body">
                        <ul class="list-unstyled">
                            <li class="mb-2">
                                <i class="bi bi-check-circle text-success me-2"></i>
                                Personal information
                            </li>
                            <li class="mb-2">
                                <i class="bi bi-check-circle text-success me-2"></i>
                                Current address
                            </li>
                            <li class="mb-2">
                                <i class="bi bi-check-circle text-success me-2"></i>
                                Employment details
                            </li>
                            <li class="mb-2">
                                <i class="bi bi-check-circle text-success me-2"></i>
                                References
                            </li>
                            @if (applicationFeeRequired)
                            {
                                <li class="mb-2">
                                    <i class="bi bi-currency-dollar text-warning me-2"></i>
                                    Application fee payment
                                </li>
                            }
                        </ul>
                    </div>
                </div>

                <div class="card mt-3">
                    <div class="card-header">
                        <h5 class="card-title mb-0">What Happens Next?</h5>
                    </div>
                    <div class="card-body">
                        <ol class="ps-3">
                            <li class="mb-2">Application submitted for review</li>
                            <li class="mb-2">Background check initiated</li>
                            <li class="mb-2">Credit check performed</li>
                            <li class="mb-2">Application reviewed (1-3 business days)</li>
                            <li class="mb-2">You'll be notified of decision</li>
                            <li class="mb-2">If approved, lease offer sent</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public Guid ProspectId { get; set; }

    private ProspectiveTenant? prospect;
    private RentalApplication? existingApplication;
    private List<Property> availableProperties = new();
    private Property? selectedProperty;
    private ApplicationSubmissionModel applicationModel = new();
    private bool isLoading = true;
    private bool isSubmitting = false;
    private bool applicationFeeRequired = false;
    private decimal applicationFee = 50.00m;
    private string errorMessage = string.Empty;
    private string userId = string.Empty;
    private Guid organizationId = Guid.Empty;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            userId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value ?? string.Empty;
            organizationId = await UserContext.GetActiveOrganizationIdAsync() ?? Guid.Empty;

            await LoadData();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading data: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadData()
    {
        // Load prospect
        prospect = await ProspectiveTenantService.GetByIdAsync(ProspectId);
        
        if (prospect == null) return;

        // Check if application already exists
        existingApplication = await RentalApplicationService.GetApplicationByProspectiveIdAsync(ProspectId);

        // Load available properties
        var allProperties = await PropertyService.GetAllAsync();
        availableProperties = allProperties.Where(p => 
            p.Status == ApplicationConstants.PropertyStatuses.Available || 
            p.Status == ApplicationConstants.PropertyStatuses.ApplicationPending).ToList();

        // Pre-select interested property if set
        if (prospect.InterestedPropertyId.HasValue)
        {
            applicationModel.PropertyId = prospect.InterestedPropertyId.Value;
            selectedProperty = availableProperties.FirstOrDefault(p => p.Id == prospect.InterestedPropertyId.Value);
        }

        // Load organization settings for application fee
        var orgSettings = await OrganizationService.GetOrganizationSettingsByOrgIdAsync(prospect.OrganizationId);
        if (orgSettings != null)
        {
            applicationFeeRequired = orgSettings.ApplicationFeeEnabled;
            applicationFee = orgSettings.DefaultApplicationFee;
        }
    }

    private void UpdateSelectedProperty()
    {
        if (applicationModel.PropertyId != Guid.Empty)
        {
            selectedProperty = availableProperties.FirstOrDefault(p => p.Id == applicationModel.PropertyId);
        }
        else
        {
            selectedProperty = null;
        }
    }

    private async Task OnPropertyChanged(ChangeEventArgs e)
    {
        if (Guid.TryParse(e.Value?.ToString(), out Guid propertyId) && propertyId != Guid.Empty)
        {
            applicationModel.PropertyId = propertyId;
            selectedProperty = availableProperties.FirstOrDefault(p => p.Id == propertyId);
        }
        else
        {
            applicationModel.PropertyId = Guid.Empty;
            selectedProperty = null;
        }
        StateHasChanged();
        await Task.CompletedTask;
    }

    private async Task HandleSubmitApplication()
    {
        Console.WriteLine("HandleSubmitApplication called");
        
        if (prospect == null || selectedProperty == null)
        {
            errorMessage = prospect == null ? "Prospect not found" : "Please select a property";
            Console.WriteLine($"Validation failed: {errorMessage}");
            return;
        }

        isSubmitting = true;
        errorMessage = string.Empty;

        try
        {
            Console.WriteLine($"Submitting application for prospect {ProspectId}, property {applicationModel.PropertyId}");
            
            // Use ApplicationWorkflowService to submit application
            var submissionModel = new Aquiis.SimpleStart.Application.Services.Workflows.ApplicationSubmissionModel
            {
                // Current Address
                CurrentAddress = applicationModel.CurrentAddress,
                CurrentCity = applicationModel.CurrentCity,
                CurrentState = applicationModel.CurrentState,
                CurrentZipCode = applicationModel.CurrentZipCode,
                CurrentRent = applicationModel.CurrentRent,
                LandlordName = applicationModel.LandlordName,
                LandlordPhone = applicationModel.LandlordPhone,
                
                // Employment
                EmployerName = applicationModel.EmployerName,
                JobTitle = applicationModel.JobTitle,
                MonthlyIncome = applicationModel.MonthlyIncome,
                EmploymentLengthMonths = applicationModel.EmploymentLengthMonths,
                
                // References
                Reference1Name = applicationModel.Reference1Name,
                Reference1Phone = applicationModel.Reference1Phone,
                Reference1Relationship = applicationModel.Reference1Relationship,
                Reference2Name = applicationModel.Reference2Name,
                Reference2Phone = applicationModel.Reference2Phone,
                Reference2Relationship = applicationModel.Reference2Relationship,
                
                // Fees
                ApplicationFee = applicationFee,
                ApplicationFeePaid = false // Will be paid separately
            };

            var result = await WorkflowService.SubmitApplicationAsync(
                ProspectId, 
                applicationModel.PropertyId, 
                submissionModel);

            Console.WriteLine($"Workflow result: Success={result.Success}, Errors={string.Join(", ", result.Errors)}");

            if (result.Success)
            {
                ToastService.ShowSuccess("Application submitted successfully! You will be notified once reviewed.");
                Navigation.NavigateTo($"/PropertyManagement/ProspectiveTenants/{ProspectId}");
            }
            else
            {
                errorMessage = string.Join(", ", result.Errors);
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error submitting application: {ex.Message}";
            Console.WriteLine($"Exception in HandleSubmitApplication: {ex}");
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private void Cancel()
    {
        Navigation.NavigateTo($"/PropertyManagement/ProspectiveTenants/{ProspectId}");
    }

    public class ApplicationSubmissionModel
    {
        [RequiredGuid(ErrorMessage = "Please select a property")]
        public Guid PropertyId { get; set; }

        [Required]
        [StringLength(200)]
        public string CurrentAddress { get; set; } = string.Empty;

        [Required]
        [StringLength(100)]
        public string CurrentCity { get; set; } = string.Empty;

        [Required]
        [StringLength(2)]
        public string CurrentState { get; set; } = string.Empty;

        [Required]
        [StringLength(10)]
        public string CurrentZipCode { get; set; } = string.Empty;

        [Required]
        [Range(0.01, double.MaxValue, ErrorMessage = "Current rent must be greater than 0")]
        public decimal CurrentRent { get; set; }

        [Required]
        [StringLength(200)]
        public string LandlordName { get; set; } = string.Empty;

        [Required]
        [StringLength(20)]
        public string LandlordPhone { get; set; } = string.Empty;

        [Required]
        [StringLength(200)]
        public string EmployerName { get; set; } = string.Empty;

        [Required]
        [StringLength(100)]
        public string JobTitle { get; set; } = string.Empty;

        [Required]
        [Range(0.01, double.MaxValue, ErrorMessage = "Monthly income must be greater than 0")]
        public decimal MonthlyIncome { get; set; }

        [Required]
        [Range(0, int.MaxValue, ErrorMessage = "Employment length cannot be negative")]
        public int EmploymentLengthMonths { get; set; }

        [Required]
        [StringLength(200)]
        public string Reference1Name { get; set; } = string.Empty;

        [Required]
        [StringLength(20)]
        public string Reference1Phone { get; set; } = string.Empty;

        [Required]
        [StringLength(100)]
        public string Reference1Relationship { get; set; } = string.Empty;

        [StringLength(200)]
        public string? Reference2Name { get; set; }

        [StringLength(20)]
        public string? Reference2Phone { get; set; }

        [StringLength(100)]
        public string? Reference2Relationship { get; set; }
    }
}
