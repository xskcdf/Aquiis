@page "/PropertyManagement/Calendar/ListView"
@using Aquiis.SimpleStart.Core.Entities
@using Aquiis.SimpleStart.Application.Services
@using Aquiis.SimpleStart.Shared.Services
@using Aquiis.SimpleStart.Application.Services.PdfGenerators
@using Aquiis.SimpleStart.Utilities
@using Aquiis.SimpleStart.Core.Constants
@using Microsoft.AspNetCore.Authorization
@attribute [OrganizationAuthorize("Owner", "Administrator", "PropertyManager")]
@inject CalendarEventService CalendarEventService
@inject CalendarSettingsService CalendarSettingsService
@inject PropertyManagementService PropertyService
@inject UserContextService UserContext
@inject NavigationManager Navigation
@inject ToastService ToastService

@rendermode InteractiveServer

<PageTitle>Calendar - List View</PageTitle>

<div class="container-fluid">
    <div class="row mb-3">
        <div class="col">
            <h1><i class="bi bi-list-ul"></i> Calendar - List View</h1>
            <p class="text-muted">All scheduled events for the next 30 days</p>
        </div>
        <div class="col-auto">
            <button class="btn btn-outline-secondary me-2" @onclick="ToggleFilters">
                <i class="bi bi-funnel"></i> Filters
            </button>
            <button class="btn btn-primary" @onclick="NavigateToCalendar">
                <i class="bi bi-calendar3"></i> Calendar View
            </button>
        </div>
    </div>

    @if (showFilters)
    {
        <div class="card mb-3">
            <div class="card-body">
                <h6 class="card-title">Event Types</h6>
                <div class="row">
                    @foreach (var eventType in CalendarEventTypes.GetAllTypes())
                    {
                        var config = CalendarEventTypes.Config[eventType];
                        <div class="col-auto mb-2">
                            <div class="form-check">
                                <input class="form-check-input" 
                                       type="checkbox" 
                                       id="@($"filter-{eventType}")"
                                       checked="@selectedEventTypes.Contains(eventType)"
                                       @onchange="@(() => ToggleEventType(eventType))">
                                <label class="form-check-label" for="@($"filter-{eventType}")">
                                    <i class="bi @config.Icon" style="color: @config.Color;"></i>
                                    @config.DisplayName
                                </label>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    }

    @if (loading)
    {
        <div class="text-center p-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else
    {
        <div class="card">
            <div class="card-body">
                @if (filteredEvents.Any())
                {
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Date/Time</th>
                                    <th>Event Type</th>
                                    <th>Title</th>
                                    <th>Description</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var evt in pagedEvents)
                                {
                                    <tr style="border-left: 4px solid @evt.Color;">
                                        <td>
                                            <div class="fw-bold">@evt.StartOn.ToString("MMM dd, yyyy")</div>
                                            <small class="text-muted">
                                                @if (evt.EndOn.HasValue)
                                                {
                                                    @($"{evt.StartOn.ToString("h:mm tt")} - {evt.EndOn.Value.ToString("h:mm tt")}")
                                                }
                                                else
                                                {
                                                    @evt.StartOn.ToString("h:mm tt")
                                                }
                                            </small>
                                        </td>
                                        <td>
                                            <i class="bi @evt.Icon" style="color: @evt.Color;"></i>
                                            <span class="badge bg-secondary ms-1">@CalendarEventTypes.GetDisplayName(evt.EventType)</span>
                                        </td>
                                        <td>@evt.Title</td>
                                        <td>
                                            <small class="text-muted">@(evt.Description ?? "-")</small>
                                        </td>
                                        <td>
                                            @if (!string.IsNullOrEmpty(evt.Status))
                                            {
                                                <span class="badge @GetEventStatusBadgeClass(evt.Status)">@evt.Status</span>
                                            }
                                            else
                                            {
                                                <span class="text-muted">-</span>
                                            }
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-primary" @onclick="() => ShowEventDetail(evt)">
                                                <i class="bi bi-eye"></i> View
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div class="text-muted">
                            Showing @((currentPage - 1) * pageSize + 1) to @Math.Min(currentPage * pageSize, filteredEvents.Count) of @filteredEvents.Count events
                        </div>
                        <nav aria-label="Page navigation">
                            <ul class="pagination mb-0">
                                <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                                    <button class="page-link" @onclick="() => ChangePage(currentPage - 1)" disabled="@(currentPage == 1)">
                                        <i class="bi bi-chevron-left"></i> Previous
                                    </button>
                                </li>
                                @for (int i = 1; i <= totalPages; i++)
                                {
                                    var pageNum = i;
                                    <li class="page-item @(currentPage == pageNum ? "active" : "")">
                                        <button class="page-link" @onclick="() => ChangePage(pageNum)">@pageNum</button>
                                    </li>
                                }
                                <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                                    <button class="page-link" @onclick="() => ChangePage(currentPage + 1)" disabled="@(currentPage == totalPages)">
                                        Next <i class="bi bi-chevron-right"></i>
                                    </button>
                                </li>
                            </ul>
                        </nav>
                    </div>
                }
                else
                {
                    <div class="text-center text-muted p-5">
                        <i class="bi bi-calendar-x" style="font-size: 3rem;"></i>
                        <p class="mt-3">No events found for the next 30 days</p>
                    </div>
                }
            </div>
        </div>
    }
</div>

<!-- Event Detail Modal -->
@if (selectedEvent != null)
{
    <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header" style="border-left: 4px solid @selectedEvent.Color;">
                    <div>
                        <h5 class="modal-title">
                            <i class="bi @(selectedEvent.Icon ?? "bi-calendar-event") me-2" style="color: @selectedEvent.Color;"></i>
                            @selectedEvent.Title
                        </h5>
                        <small class="text-muted">@CalendarEventTypes.GetDisplayName(selectedEvent.EventType)</small>
                    </div>
                    <button type="button" class="btn-close" @onclick="CloseModal"></button>
                </div>
                <div class="modal-body">
                    <!-- Event Basic Info -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <h6><i class="bi bi-clock"></i> Schedule</h6>
                            <p>
                                <strong>@selectedEvent.StartOn.ToString("MMM dd, yyyy")</strong><br/>
                                @selectedEvent.StartOn.ToString("h:mm tt")
                                @if (selectedEvent.EndOn.HasValue)
                                {
                                    <text> - @selectedEvent.EndOn.Value.ToString("h:mm tt")</text>
                                }
                                <br/>
                                <small class="text-muted">Duration: @selectedEvent.DurationMinutes minutes</small>
                            </p>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="bi bi-info-circle"></i> Status</h6>
                            <p>
                                @if (!string.IsNullOrEmpty(selectedEvent.Status))
                                {
                                    <span class="badge @GetEventStatusBadgeClass(selectedEvent.Status)">@selectedEvent.Status</span>
                                }
                                else
                                {
                                    <span class="badge bg-secondary">No Status</span>
                                }
                            </p>
                        </div>
                    </div>

                    @if (!string.IsNullOrEmpty(selectedEvent.Location))
                    {
                        <div class="row mb-3">
                            <div class="col-12">
                                <h6><i class="bi bi-geo-alt"></i> Location</h6>
                                <p>@selectedEvent.Location</p>
                            </div>
                        </div>
                    }

                    @if (!string.IsNullOrEmpty(selectedEvent.Description))
                    {
                        <div class="row mb-3">
                            <div class="col-12">
                                <h6><i class="bi bi-card-text"></i> Description</h6>
                                <p>@selectedEvent.Description</p>
                            </div>
                        </div>
                    }

                    <!-- Entity-Specific Details -->
                    @if (selectedTour != null)
                    {
                        <hr/>
                        <h6 class="text-primary"><i class="bi bi-house-door"></i> Tour Details</h6>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <strong>Prospective Tenant</strong>
                                <p>
                                    @selectedTour.ProspectiveTenant?.FullName<br/>
                                    <small class="text-muted">
                                        <i class="bi bi-envelope"></i> @selectedTour.ProspectiveTenant?.Email<br/>
                                        <i class="bi bi-telephone"></i> @selectedTour.ProspectiveTenant?.Phone
                                    </small>
                                </p>
                            </div>
                            <div class="col-md-6">
                                <strong>Property</strong>
                                <p>
                                    @selectedTour.Property?.Address<br/>
                                    <small class="text-muted">@selectedTour.Property?.City, @selectedTour.Property?.State @selectedTour.Property?.ZipCode</small>
                                </p>
                            </div>
                        </div>
                        @if (!string.IsNullOrEmpty(selectedTour.InterestLevel))
                        {
                            <div class="mt-2">
                                <strong>Interest Level:</strong>
                                <span class="badge @GetInterestBadgeClass(selectedTour.InterestLevel) ms-2">
                                    @GetInterestDisplay(selectedTour.InterestLevel)
                                </span>
                            </div>
                        }
                        @if (!string.IsNullOrEmpty(selectedTour.Feedback))
                        {
                            <div class="mt-2">
                                <strong>Feedback:</strong>
                                <p class="text-muted">@selectedTour.Feedback</p>
                            </div>
                        }
                    }

                    @if (selectedInspection != null)
                    {
                        <hr/>
                        <h6 class="text-success"><i class="bi bi-clipboard-check"></i> Inspection Details</h6>
                        
                        @if (!string.IsNullOrEmpty(selectedInspection.OverallCondition))
                        {
                            <div class="mb-3">
                                <strong>Overall Condition:</strong>
                                <span class="badge @GetInspectionStatusBadgeClass(selectedInspection.OverallCondition) ms-2">
                                    @selectedInspection.OverallCondition
                                </span>
                            </div>
                        }
                        
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <strong>Type</strong>
                                <p>@selectedInspection.InspectionType</p>
                            </div>
                            <div class="col-md-6">
                                <strong>Property</strong>
                                <p>
                                    @selectedInspection.Property?.Address<br/>
                                    <small class="text-muted">@selectedInspection.Property?.City, @selectedInspection.Property?.State</small>
                                </p>
                            </div>
                        </div>
                        @if (!string.IsNullOrEmpty(selectedInspection.InspectedBy))
                        {
                            <div class="mt-2">
                                <strong>Inspector:</strong> @selectedInspection.InspectedBy
                            </div>
                        }
                        @if (!string.IsNullOrEmpty(selectedInspection.GeneralNotes))
                        {
                            <div class="mt-2">
                                <strong>Notes:</strong>
                                <p class="text-muted">@selectedInspection.GeneralNotes</p>
                            </div>
                        }
                    }

                    @if (selectedMaintenanceRequest != null)
                    {
                        <hr/>
                        <h6 class="text-danger"><i class="bi bi-tools"></i> Maintenance Details</h6>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <strong>Type</strong>
                                <p>@selectedMaintenanceRequest.RequestType</p>
                                <strong>Priority</strong>
                                <p>
                                    <span class="badge @GetPriorityBadgeClass(selectedMaintenanceRequest.Priority)">
                                        @selectedMaintenanceRequest.Priority
                                    </span>
                                </p>
                            </div>
                            <div class="col-md-6">
                                <strong>Property</strong>
                                <p>
                                    @selectedMaintenanceRequest.Property?.Address<br/>
                                    <small class="text-muted">@selectedMaintenanceRequest.Property?.City, @selectedMaintenanceRequest.Property?.State</small>
                                </p>
                            </div>
                        </div>
                        @if (!string.IsNullOrEmpty(selectedMaintenanceRequest.AssignedTo))
                        {
                            <div class="mt-2">
                                <strong>Assigned To:</strong> @selectedMaintenanceRequest.AssignedTo
                            </div>
                        }
                        @if (!string.IsNullOrEmpty(selectedMaintenanceRequest.RequestedBy))
                        {
                            <div class="mt-2">
                                <strong>Requested By:</strong> @selectedMaintenanceRequest.RequestedBy
                                @if (!string.IsNullOrEmpty(selectedMaintenanceRequest.RequestedByPhone))
                                {
                                    <text> - <i class="bi bi-telephone"></i> @selectedMaintenanceRequest.RequestedByPhone</text>
                                }
                            </div>
                        }
                        @if (selectedMaintenanceRequest.EstimatedCost > 0)
                        {
                            <div class="mt-2">
                                <strong>Estimated Cost:</strong> @selectedMaintenanceRequest.EstimatedCost.ToString("C")
                            </div>
                        }
                    }
                </div>
                <div class="modal-footer">
                    <!-- Entity-specific actions -->
                    @if (selectedTour != null && selectedTour.Status == ApplicationConstants.TourStatuses.Scheduled)
                    {
                        <button class="btn btn-success" @onclick="() => CompleteTour(selectedTour.Id)">
                            <i class="bi bi-check-circle"></i> Complete Tour
                        </button>
                        <button class="btn btn-warning text-dark" @onclick="() => MarkTourAsNoShow(selectedTour.Id)">
                            <i class="bi bi-person-x"></i> Mark as No Show
                        </button>
                        <button class="btn btn-danger" @onclick="() => CancelTour(selectedTour.Id)">
                            <i class="bi bi-x-circle"></i> Cancel
                        </button>
                    }

                    @if (selectedMaintenanceRequest != null)
                    {
                        @if (selectedMaintenanceRequest.Status == ApplicationConstants.MaintenanceRequestStatuses.Submitted)
                        {
                            <button class="btn btn-primary" @onclick="() => StartWork(selectedMaintenanceRequest.Id)">
                                <i class="bi bi-play-circle"></i> Start Work
                            </button>
                            <button class="btn btn-danger" @onclick="() => CancelMaintenanceRequest(selectedMaintenanceRequest.Id)">
                                <i class="bi bi-x-circle"></i> Cancel Request
                            </button>
                        }
                        else if (selectedMaintenanceRequest.Status == ApplicationConstants.MaintenanceRequestStatuses.InProgress)
                        {
                            <button class="btn btn-success" @onclick="() => CompleteMaintenanceRequest(selectedMaintenanceRequest.Id)">
                                <i class="bi bi-check-circle"></i> Mark Complete
                            </button>
                            <button class="btn btn-danger" @onclick="() => CancelMaintenanceRequest(selectedMaintenanceRequest.Id)">
                                <i class="bi bi-x-circle"></i> Cancel Request
                            </button>
                        }
                    }

                    @* Show Complete Inspection button for property-based routine inspections *@
                    @if (selectedEvent != null && selectedEvent.EventType == CalendarEventTypes.Inspection && 
                         selectedEvent.SourceEntityType == "Property" && selectedEvent.PropertyId.HasValue)
                    {
                        <button class="btn btn-success" @onclick="() => CompleteRoutineInspection(selectedEvent.PropertyId.Value)">
                            <i class="bi bi-check-circle"></i> Complete Inspection
                        </button>
                    }

                    @if (selectedEvent != null && CalendarEventRouter.IsRoutable(selectedEvent))
                    {
                        <button class="btn btn-primary" @onclick="NavigateToEventDetail">
                            <i class="bi bi-box-arrow-up-right"></i> View Full Details
                        </button>
                    }

                    <button class="btn btn-secondary" @onclick="CloseModal">Close</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<CalendarEvent> allEvents = new();
    private List<CalendarEvent> filteredEvents = new();
    private List<CalendarEvent> pagedEvents = new();
    private HashSet<string> selectedEventTypes = new();
    private bool loading = true;
    private bool showFilters = false;

    // Modal state
    private CalendarEvent? selectedEvent;
    private Tour? selectedTour;
    private Inspection? selectedInspection;
    private MaintenanceRequest? selectedMaintenanceRequest;

    // Pagination
    private int currentPage = 1;
    private int pageSize = 20;
    private int totalPages => (int)Math.Ceiling(filteredEvents.Count / (double)pageSize);

    protected override async Task OnInitializedAsync()
    {
        await LoadEvents();
        
        // Initialize with all event types selected
        foreach (var eventType in CalendarEventTypes.GetAllTypes())
        {
            selectedEventTypes.Add(eventType);
        }
        
        ApplyFilters();
    }

    private async Task LoadEvents()
    {
        try
        {
            loading = true;
            
           
            // Get events for the next 30 days
            var startDate = DateTime.Today;
            var endDate = DateTime.Today.AddDays(30);
            
            allEvents = await CalendarEventService.GetEventsAsync(startDate, endDate);
            allEvents = allEvents.OrderBy(e => e.StartOn).ToList();
            
            ApplyFilters();
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error loading events: {ex.Message}");
        }
        finally
        {
            loading = false;
        }
    }

    private void ToggleEventType(string eventType)
    {
        if (selectedEventTypes.Contains(eventType))
        {
            selectedEventTypes.Remove(eventType);
        }
        else
        {
            selectedEventTypes.Add(eventType);
        }
        
        currentPage = 1; // Reset to first page when filtering
        ApplyFilters();
    }

    private void ApplyFilters()
    {
        filteredEvents = allEvents
            .Where(e => selectedEventTypes.Contains(e.EventType))
            .ToList();
        
        UpdatePagedEvents();
    }

    private void UpdatePagedEvents()
    {
        pagedEvents = filteredEvents
            .Skip((currentPage - 1) * pageSize)
            .Take(pageSize)
            .ToList();
    }

    private void ChangePage(int page)
    {
        if (page < 1 || page > totalPages)
            return;
        
        currentPage = page;
        UpdatePagedEvents();
    }

    private void ToggleFilters()
    {
        showFilters = !showFilters;
    }

    private void NavigateToCalendar()
    {
        Navigation.NavigateTo("/PropertyManagement/Calendar");
    }

    private void CompleteRoutineInspection(Guid propertyId)
    {
        // Navigate to create new inspection form with the property pre-selected
        Navigation.NavigateTo($"/PropertyManagement/Inspections/Create?propertyId={propertyId}");
    }

    private async Task ShowEventDetail(CalendarEvent calendarEvent)
    {
        // Load entity and show modal for all event types
        selectedEvent = calendarEvent;

        if (!calendarEvent.SourceEntityId.HasValue)
        {
            // Custom event without source entity - just show basic info
            return;
        }

        try
        {
            var organizationId = await UserContext.GetActiveOrganizationIdAsync();
            if (!organizationId.HasValue) return;

            switch (calendarEvent.EventType)
            {
                case CalendarEventTypes.Tour:
                    await ShowTourDetailById(calendarEvent.SourceEntityId.Value);
                    break;

                case CalendarEventTypes.Inspection:
                    // Check if this is a property-based routine inspection or an actual inspection record
                    if (calendarEvent.SourceEntityType == "Property")
                    {
                        // This is a scheduled routine inspection - no Inspection record exists yet
                        // Just show the basic calendar event info (selectedEvent is already set)
                    }
                    else
                    {
                        // This is linked to an actual Inspection record
                        await ShowInspectionDetailById(calendarEvent.SourceEntityId.Value);
                    }
                    break;

                case CalendarEventTypes.Maintenance:
                    await ShowMaintenanceRequestDetailById(calendarEvent.SourceEntityId.Value);
                    break;

                // Other event types (LeaseExpiry, RentDue, Custom) just show basic info
                default:
                    break;
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error loading event details: {ex.Message}");
        }
    }

    private async Task ShowTourDetailById(Guid tourId)
    {
        var tour = await PropertyService.GetTourByIdAsync(tourId);
        if (tour != null)
        {
            selectedTour = tour;
        }
        else
        {
            ToastService.ShowError("Tour not found");
        }
    }

    private async Task ShowInspectionDetailById(Guid inspectionId)
    {
        var inspection = await PropertyService.GetInspectionByIdAsync(inspectionId);
        if (inspection != null)
        {
            selectedInspection = inspection;
        }
        else
        {
            ToastService.ShowError("Inspection not found");
        }
    }

    private async Task ShowMaintenanceRequestDetailById(Guid maintenanceId)
    {
        var maintenanceRequest = await PropertyService.GetMaintenanceRequestByIdAsync(maintenanceId);
        if (maintenanceRequest != null)
        {
            selectedMaintenanceRequest = maintenanceRequest;
        }
        else
        {
            ToastService.ShowError("Maintenance request not found");
        }
    }

    private void CloseModal()
    {
        selectedEvent = null;
        selectedTour = null;
        selectedInspection = null;
        selectedMaintenanceRequest = null;
    }

    private string GetInspectionStatusBadgeClass(string status) => status switch
    {
        "Good" => "bg-success",
        "Fair" => "bg-warning text-dark",
        "Poor" => "bg-danger",
        "Completed" => "bg-success",
        _ => "bg-secondary"
    };

    private void NavigateToEventDetail()
    {
        if (selectedEvent == null) return;

        // For tours, navigate to checklist if available
        if (selectedEvent.SourceEntityType == nameof(Tour) && selectedTour != null)
        {
            if (selectedTour.ChecklistId.HasValue)
            {
                Navigation.NavigateTo($"/PropertyManagement/Checklists/View/{selectedTour.ChecklistId.Value}");
            }
            else
            {
                ToastService.ShowWarning("No checklist found for this tour");
            }
            return;
        }

        // For other event types, use the router
        if (CalendarEventRouter.IsRoutable(selectedEvent))
        {
            var route = CalendarEventRouter.GetRouteForEvent(selectedEvent);
            if (!string.IsNullOrEmpty(route))
            {
                Navigation.NavigateTo(route);
            }
        }
    }

    private async Task CompleteTour(Guid tourId)
    {
        try
        {
            var organizationId = await UserContext.GetActiveOrganizationIdAsync();
            if (organizationId.HasValue)
            {
                var tour = await PropertyService.GetTourByIdAsync(tourId);
                if (tour != null)
                {
                    CloseModal();
                    if (tour.ChecklistId.HasValue)
                    {
                        Navigation.NavigateTo($"/PropertyManagement/Checklists/View/{tour.ChecklistId.Value}");
                    }
                    else
                    {
                        ToastService.ShowWarning("No property tour checklist found for this tour");
                    }
                }
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error completing tour: {ex.Message}");
        }
    }

    private async Task CancelTour(Guid tourId)
    {
        try
        {
            var organizationId = await UserContext.GetActiveOrganizationIdAsync();
            var userId = await UserContext.GetUserIdAsync();
            
            if (organizationId.HasValue && !string.IsNullOrEmpty(userId))
            {
                await PropertyService.CancelTourAsync(tourId);
                ToastService.ShowSuccess("Tour cancelled successfully");
                CloseModal();
                await LoadEvents();
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error cancelling tour: {ex.Message}");
        }
    }

    private async Task MarkTourAsNoShow(Guid tourId)
    {
        try
        {
            var organizationId = await UserContext.GetActiveOrganizationIdAsync();
            var userId = await UserContext.GetUserIdAsync();
            
            if (organizationId.HasValue && !string.IsNullOrEmpty(userId))
            {
                await PropertyService.MarkTourAsNoShowAsync(tourId);
                ToastService.ShowSuccess("Tour marked as No Show");
                CloseModal();
                await LoadEvents();
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error marking tour as no show: {ex.Message}");
        }
    }

    private async Task StartWork(Guid maintenanceRequestId)
    {
        try
        {
            var request = await PropertyService.GetMaintenanceRequestByIdAsync(maintenanceRequestId);
            if (request != null)
            {
                request.Status = ApplicationConstants.MaintenanceRequestStatuses.InProgress;
                
                await PropertyService.UpdateMaintenanceRequestAsync(request);
                ToastService.ShowSuccess("Work started on maintenance request");
                
                await ShowMaintenanceRequestDetailById(maintenanceRequestId);
                await LoadEvents();
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error starting work: {ex.Message}");
        }
    }

    private async Task CompleteMaintenanceRequest(Guid maintenanceRequestId)
    {
        try
        {
            var organizationId = await UserContext.GetActiveOrganizationIdAsync();
            var userId = await UserContext.GetUserIdAsync();
            
            if (organizationId.HasValue && !string.IsNullOrEmpty(userId))
            {
                var request = await PropertyService.GetMaintenanceRequestByIdAsync(maintenanceRequestId);
                if (request != null)
                {
                    request.Status = ApplicationConstants.MaintenanceRequestStatuses.Completed;
                    
                    await PropertyService.UpdateMaintenanceRequestAsync(request);
                    ToastService.ShowSuccess("Maintenance request marked as complete");
                    
                    await ShowMaintenanceRequestDetailById(maintenanceRequestId);
                    await LoadEvents();
                }
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error completing request: {ex.Message}");
        }
    }

    private async Task CancelMaintenanceRequest(Guid maintenanceRequestId)
    {
        try
        {
            var organizationId = await UserContext.GetActiveOrganizationIdAsync();
            var userId = await UserContext.GetUserIdAsync();
            
            if (organizationId.HasValue && !string.IsNullOrEmpty(userId))
            {
                var request = await PropertyService.GetMaintenanceRequestByIdAsync(maintenanceRequestId);
                if (request != null)
                {
                    request.Status = ApplicationConstants.MaintenanceRequestStatuses.Cancelled;
                    
                    await PropertyService.UpdateMaintenanceRequestAsync(request);
                    ToastService.ShowSuccess("Maintenance request cancelled");
                    CloseModal();
                    await LoadEvents();
                }
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error cancelling request: {ex.Message}");
        }
    }

    private string GetInterestBadgeClass(string? level) => level switch
    {
        var l when l == ApplicationConstants.TourInterestLevels.VeryInterested => "bg-success",
        var l when l == ApplicationConstants.TourInterestLevels.Interested => "bg-primary",
        var l when l == ApplicationConstants.TourInterestLevels.Neutral => "bg-secondary",
        var l when l == ApplicationConstants.TourInterestLevels.NotInterested => "bg-danger",
        _ => "bg-secondary"
    };

    private string GetInterestDisplay(string? level) => level switch
    {
        var l when l == ApplicationConstants.TourInterestLevels.VeryInterested => "Very Interested",
        var l when l == ApplicationConstants.TourInterestLevels.Interested => "Interested",
        var l when l == ApplicationConstants.TourInterestLevels.Neutral => "Neutral",
        var l when l == ApplicationConstants.TourInterestLevels.NotInterested => "Not Interested",
        _ => "Unknown"
    };

    private string GetPriorityBadgeClass(string priority) => priority switch
    {
        "High" => "bg-danger",
        "Medium" => "bg-warning text-dark",
        "Low" => "bg-info",
        _ => "bg-secondary"
    };

    private string GetEventStatusBadgeClass(string status) => status switch
    {
        "Scheduled" => "bg-info",
        "Completed" => "bg-success",
        "Cancelled" => "bg-danger",
        "NoShow" => "bg-warning text-dark",
        "In Progress" => "bg-primary",
        "Pending" => "bg-warning text-dark",
        "Overdue" => "bg-danger",
        _ => "bg-secondary"
    };
}
