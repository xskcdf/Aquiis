@page "/property-management/security-deposits/calculate-dividends/{PoolId:guid}"
@using Aquiis.SimpleStart.Core.Entities
@using Aquiis.SimpleStart.Application.Services
@using Aquiis.SimpleStart.Shared.Services
@using Aquiis.SimpleStart.Application.Services.PdfGenerators
@using Aquiis.SimpleStart.Core.Constants
@using Microsoft.AspNetCore.Authorization
@inject SecurityDepositService SecurityDepositService
@inject NavigationManager NavigationManager
@inject ToastService ToastService
@rendermode InteractiveServer
@attribute [OrganizationAuthorize("Owner", "Administrator", "PropertyManager")]


<PageTitle>Calculate Dividends - @(pool?.Year ?? 0)</PageTitle>

<div class="container-fluid">
    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (pool == null)
    {
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle"></i>
            Investment pool not found.
        </div>
    }
    else
    {
        <div class="row mb-4">
            <div class="col">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item">
                            <a href="/property-management/security-deposits/investment-pools">Investment Pools</a>
                        </li>
                        <li class="breadcrumb-item">
                            <a href="/property-management/security-deposits/investment-pool/@PoolId">@pool.Year</a>
                        </li>
                        <li class="breadcrumb-item active">Calculate Dividends</li>
                    </ol>
                </nav>
                <h1 class="h3">Calculate Dividends for @pool.Year</h1>
                <p class="text-muted">Review and confirm dividend calculations for all active leases</p>
            </div>
        </div>

        @if (pool.Status != ApplicationConstants.InvestmentPoolStatuses.Open)
        {
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle"></i>
                <strong>Dividends Already Calculated</strong>
                <p class="mb-0 mt-2">Dividends for this pool have already been calculated. View the details on the pool details page.</p>
            </div>
        }
        else if (!pool.HasEarnings)
        {
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i>
                <strong>No Dividends to Distribute</strong>
                <p class="mb-0 mt-2">
                    @if (pool.HasLosses)
                    {
                        <text>This pool had losses of @pool.AbsorbedLosses.ToString("C2"), which are absorbed by the organization. No dividends will be distributed.</text>
                    }
                    else
                    {
                        <text>This pool had no earnings. No dividends will be distributed.</text>
                    }
                </p>
            </div>
        }
        else
        {
            <!-- Summary -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card border-info">
                        <div class="card-body">
                            <h6 class="card-subtitle mb-2 text-muted">Total Earnings</h6>
                            <h4 class="card-title mb-0 text-success">@pool.TotalEarnings.ToString("C2")</h4>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-warning">
                        <div class="card-body">
                            <h6 class="card-subtitle mb-2 text-muted">Organization Share</h6>
                            <h4 class="card-title mb-0 text-info">@pool.OrganizationShare.ToString("C2")</h4>
                            <small class="text-muted">@((pool.OrganizationSharePercentage * 100).ToString("F0"))%</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-success">
                        <div class="card-body">
                            <h6 class="card-subtitle mb-2 text-muted">Tenant Share Total</h6>
                            <h4 class="card-title mb-0 text-success">@pool.TenantShareTotal.ToString("C2")</h4>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-primary">
                        <div class="card-body">
                            <h6 class="card-subtitle mb-2 text-muted">Active Leases</h6>
                            <h4 class="card-title mb-0">@pool.ActiveLeaseCount</h4>
                            <small class="text-muted">@pool.DividendPerLease.ToString("C2") each</small>
                        </div>
                    </div>
                </div>
            </div>

            @if (calculationPreview.Any())
            {
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-calculator"></i> Dividend Calculation Preview
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Tenant</th>
                                        <th>Lease ID</th>
                                        <th>Lease Period</th>
                                        <th class="text-center">Months in Pool</th>
                                        <th class="text-end">Base Dividend</th>
                                        <th class="text-center">Proration</th>
                                        <th class="text-end">Final Dividend</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var calc in calculationPreview.OrderByDescending(c => c.FinalDividend))
                                    {
                                        <tr>
                                            <td><strong>Tenant #@calc.TenantId</strong></td>
                                            <td>Lease #@calc.LeaseId</td>
                                            <td>
                                                <small>
                                                    @calc.LeaseStartDate.ToString("MMM d, yyyy")<br/>
                                                    to @(calc.LeaseEndDate?.ToString("MMM d, yyyy") ?? "Present")
                                                </small>
                                            </td>
                                            <td class="text-center">
                                                <span class="badge bg-info">@calc.MonthsInPool</span>
                                            </td>
                                            <td class="text-end">@calc.BaseDividend.ToString("C2")</td>
                                            <td class="text-center">
                                                @if (calc.ProrationFactor < 1.0m)
                                                {
                                                    <span class="badge bg-warning text-dark">
                                                        @((calc.ProrationFactor * 100).ToString("F0"))%
                                                    </span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-success">100%</span>
                                                }
                                            </td>
                                            <td class="text-end">
                                                <strong class="text-success">@calc.FinalDividend.ToString("C2")</strong>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                                <tfoot class="table-light">
                                    <tr>
                                        <td colspan="6"><strong>Total Dividends to Distribute:</strong></td>
                                        <td class="text-end">
                                            <strong class="text-success fs-5">@calculationPreview.Sum(c => c.FinalDividend).ToString("C2")</strong>
                                        </td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Confirm Dividend Calculation</h5>
                        <p class="text-muted">
                            Review the dividend calculations above. Once confirmed, dividends will be created for each tenant 
                            and tenants can choose to receive their dividend as a lease credit or check.
                        </p>

                        <div class="alert alert-info">
                            <h6><i class="bi bi-info-circle"></i> What happens next?</h6>
                            <ul class="mb-0">
                                <li>Dividend records will be created for all @calculationPreview.Count active leases</li>
                                <li>Tenants will be notified to choose their dividend payment method</li>
                                <li>You can process dividend payments from the pool details page</li>
                                <li>The pool status will change to "Calculated"</li>
                            </ul>
                        </div>

                        <div class="d-flex justify-content-between mt-4">
                            <button type="button" class="btn btn-outline-secondary" @onclick="Cancel">
                                <i class="bi bi-x-circle"></i> Cancel
                            </button>
                            <button type="button" class="btn btn-success btn-lg" @onclick="ConfirmCalculation" disabled="@isCalculating">
                                @if (isCalculating)
                                {
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                }
                                else
                                {
                                    <i class="bi bi-check-circle"></i>
                                }
                                Confirm & Calculate Dividends
                            </button>
                        </div>
                    </div>
                </div>
            }
            else
            {
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>No Active Leases Found</strong>
                    <p class="mb-0 mt-2">There are no active leases in the pool for @pool.Year. Cannot calculate dividends.</p>
                </div>
            }
        }
    }
</div>

@code {
    [Parameter]
    public Guid PoolId { get; set; }

    private SecurityDepositInvestmentPool? pool;
    private List<DividendCalculation> calculationPreview = new();
    private bool isLoading = true;
    private bool isCalculating = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadPoolAndPreview();
    }

    private async Task LoadPoolAndPreview()
    {
        isLoading = true;
        try
        {
            pool = await SecurityDepositService.GetInvestmentPoolByIdAsync(PoolId);
            
            if (pool != null && pool.HasEarnings && pool.Status == ApplicationConstants.InvestmentPoolStatuses.Open)
            {
                // Get all security deposits in the pool for this year
                var deposits = await SecurityDepositService.GetSecurityDepositsInPoolAsync(pool.Year);
                
                foreach (var deposit in deposits)
                {
                    // Calculate proration based on months in pool
                    var leaseStart = deposit.PoolEntryDate ?? deposit.DateReceived;
                    var yearStart = new DateTime(pool.Year, 1, 1);
                    var yearEnd = new DateTime(pool.Year, 12, 31);
                    
                    var effectiveStart = leaseStart > yearStart ? leaseStart : yearStart;
                    var effectiveEnd = deposit.PoolExitDate.HasValue && deposit.PoolExitDate.Value < yearEnd 
                        ? deposit.PoolExitDate.Value 
                        : yearEnd;
                    
                    var monthsInPool = ((effectiveEnd.Year - effectiveStart.Year) * 12 + effectiveEnd.Month - effectiveStart.Month + 1);
                    var prorationFactor = monthsInPool / 12.0m;
                    
                    calculationPreview.Add(new DividendCalculation
                    {
                        TenantId = deposit.TenantId,
                        LeaseId = deposit.LeaseId,
                        LeaseStartDate = leaseStart,
                        LeaseEndDate = deposit.PoolExitDate,
                        MonthsInPool = monthsInPool,
                        BaseDividend = pool.DividendPerLease,
                        ProrationFactor = prorationFactor,
                        FinalDividend = pool.DividendPerLease * prorationFactor
                    });
                }
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Failed to load dividend preview: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task ConfirmCalculation()
    {
        isCalculating = true;
        try
        {
            await SecurityDepositService.CalculateDividendsAsync(pool!.Year);
            
            ToastService.ShowSuccess($"Dividends calculated for {pool.Year}. Tenants can now choose their payment method.");
            NavigationManager.NavigateTo($"/property-management/security-deposits/investment-pool/{PoolId}");
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Failed to calculate dividends: {ex.Message}");
        }
        finally
        {
            isCalculating = false;
        }
    }

    private void Cancel()
    {
        NavigationManager.NavigateTo($"/property-management/security-deposits/investment-pool/{PoolId}");
    }

    private class DividendCalculation
    {
        public Guid TenantId { get; set; }
        public Guid LeaseId { get; set; }
        public DateTime LeaseStartDate { get; set; }
        public DateTime? LeaseEndDate { get; set; }
        public int MonthsInPool { get; set; }
        public decimal BaseDividend { get; set; }
        public decimal ProrationFactor { get; set; }
        public decimal FinalDividend { get; set; }
    }
}
