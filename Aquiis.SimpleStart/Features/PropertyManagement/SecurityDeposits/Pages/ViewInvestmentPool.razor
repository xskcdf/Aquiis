@page "/property-management/security-deposits/investment-pool/{PoolId:int}"
@using Aquiis.SimpleStart.Core.Entities
@using Aquiis.SimpleStart.Application.Services
@using Aquiis.SimpleStart.Shared.Services
@using Aquiis.SimpleStart.Application.Services.PdfGenerators
@using Aquiis.SimpleStart.Core.Constants
@using Microsoft.AspNetCore.Authorization
@inject SecurityDepositService SecurityDepositService
@inject NavigationManager NavigationManager
@inject ToastService ToastService
@rendermode InteractiveServer

@attribute [OrganizationAuthorize("Owner", "Administrator", "PropertyManager")]


<PageTitle>Investment Pool Details - @(pool?.Year ?? 0)</PageTitle>

<div class="container-fluid">
    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (pool == null)
    {
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle"></i>
            Investment pool not found.
        </div>
    }
    else
    {
        <div class="row mb-4">
            <div class="col">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item">
                            <a href="/property-management/security-deposits/investment-pools">Investment Pools</a>
                        </li>
                        <li class="breadcrumb-item active">@pool.Year</li>
                    </ol>
                </nav>
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="h3">@pool.Year Investment Pool</h1>
                        <p class="text-muted">Detailed performance and dividend information</p>
                    </div>
                    <div>
                        @if (pool.Status == ApplicationConstants.InvestmentPoolStatuses.Open)
                        {
                            <button class="btn btn-success" @onclick="NavigateToCalculateDividends">
                                <i class="bi bi-calculator"></i> Calculate Dividends
                            </button>
                        }
                        else if (pool.Status == ApplicationConstants.InvestmentPoolStatuses.Calculated)
                        {
                            <span class="badge bg-warning text-dark fs-6">Dividends Calculated - Ready to Distribute</span>
                        }
                        else if (pool.Status == ApplicationConstants.InvestmentPoolStatuses.Distributed)
                        {
                            <span class="badge bg-success fs-6">Dividends Distributed</span>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card border-primary">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-2 text-muted">Starting Balance</h6>
                        <h3 class="card-title mb-0">@pool.StartingBalance.ToString("C2")</h3>
                        <small class="text-muted">@pool.ActiveLeaseCount active leases</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-info">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-2 text-muted">Total Earnings</h6>
                        <h3 class="card-title mb-0">
                            @if (pool.HasEarnings)
                            {
                                <span class="text-success">@pool.TotalEarnings.ToString("C2")</span>
                            }
                            else if (pool.HasLosses)
                            {
                                <span class="text-danger">@pool.TotalEarnings.ToString("C2")</span>
                            }
                            else
                            {
                                <span>$0.00</span>
                            }
                        </h3>
                        <small class="text-muted">
                            @if (pool.ReturnRate >= 0)
                            {
                                <span class="text-success">@((pool.ReturnRate * 100).ToString("F2"))% return</span>
                            }
                            else
                            {
                                <span class="text-danger">@((pool.ReturnRate * 100).ToString("F2"))% loss</span>
                            }
                        </small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-warning">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-2 text-muted">Organization Share</h6>
                        <h3 class="card-title mb-0 text-info">@pool.OrganizationShare.ToString("C2")</h3>
                        <small class="text-muted">@((pool.OrganizationSharePercentage * 100).ToString("F0"))% of earnings</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-success">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-2 text-muted">Tenant Share Total</h6>
                        <h3 class="card-title mb-0 text-success">@pool.TenantShareTotal.ToString("C2")</h3>
                        <small class="text-muted">
                            @if (pool.DividendPerLease > 0)
                            {
                                <span>@pool.DividendPerLease.ToString("C2") per lease</span>
                            }
                            else
                            {
                                <span>No dividends</span>
                            }
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Performance Details -->
        <div class="row mb-4">
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Performance Summary</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-sm">
                            <tbody>
                                <tr>
                                    <th>Year:</th>
                                    <td>@pool.Year</td>
                                </tr>
                                <tr>
                                    <th>Starting Balance:</th>
                                    <td>@pool.StartingBalance.ToString("C2")</td>
                                </tr>
                                <tr>
                                    <th>Ending Balance:</th>
                                    <td>@pool.EndingBalance.ToString("C2")</td>
                                </tr>
                                <tr>
                                    <th>Total Earnings:</th>
                                    <td>
                                        @if (pool.HasEarnings)
                                        {
                                            <span class="text-success fw-bold">+@pool.TotalEarnings.ToString("C2")</span>
                                        }
                                        else if (pool.HasLosses)
                                        {
                                            <span class="text-danger fw-bold">@pool.TotalEarnings.ToString("C2")</span>
                                        }
                                        else
                                        {
                                            <span>$0.00</span>
                                        }
                                    </td>
                                </tr>
                                <tr>
                                    <th>Return Rate:</th>
                                    <td>
                                        @if (pool.ReturnRate >= 0)
                                        {
                                            <span class="text-success fw-bold">@((pool.ReturnRate * 100).ToString("F2"))%</span>
                                        }
                                        else
                                        {
                                            <span class="text-danger fw-bold">@((pool.ReturnRate * 100).ToString("F2"))%</span>
                                        }
                                    </td>
                                </tr>
                                <tr>
                                    <th>Active Leases:</th>
                                    <td><span class="badge bg-info">@pool.ActiveLeaseCount</span></td>
                                </tr>
                            </tbody>
                        </table>

                        @if (!string.IsNullOrEmpty(pool.Notes))
                        {
                            <hr />
                            <h6>Notes:</h6>
                            <p class="text-muted">@pool.Notes</p>
                        }
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Distribution Details</h5>
                    </div>
                    <div class="card-body">
                        @if (pool.HasEarnings)
                        {
                            <table class="table table-sm">
                                <tbody>
                                    <tr>
                                        <th>Organization Share %:</th>
                                        <td>@((pool.OrganizationSharePercentage * 100).ToString("F0"))%</td>
                                    </tr>
                                    <tr>
                                        <th>Organization Amount:</th>
                                        <td class="text-info fw-bold">@pool.OrganizationShare.ToString("C2")</td>
                                    </tr>
                                    <tr>
                                        <th>Tenant Share Total:</th>
                                        <td class="text-success fw-bold">@pool.TenantShareTotal.ToString("C2")</td>
                                    </tr>
                                    <tr>
                                        <th>Dividend Per Lease:</th>
                                        <td class="text-success fw-bold">@pool.DividendPerLease.ToString("C2")</td>
                                    </tr>
                                    @if (pool.DividendsCalculatedOn.HasValue)
                                    {
                                        <tr>
                                            <th>Calculated On:</th>
                                            <td>@pool.DividendsCalculatedOn.Value.ToString("MMM d, yyyy")</td>
                                        </tr>
                                    }
                                    @if (pool.DividendsDistributedOn.HasValue)
                                    {
                                        <tr>
                                            <th>Distributed On:</th>
                                            <td>@pool.DividendsDistributedOn.Value.ToString("MMM d, yyyy")</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        }
                        else if (pool.HasLosses)
                        {
                            <div class="alert alert-warning mb-0">
                                <h6><i class="bi bi-exclamation-triangle"></i> Loss Absorbed by Organization</h6>
                                <p class="mb-2">Investment losses of <strong>@pool.AbsorbedLosses.ToString("C2")</strong> were absorbed by the organization.</p>
                                <p class="mb-0">No dividends were distributed to tenants, and all security deposits remain unchanged.</p>
                            </div>
                        }
                        else
                        {
                            <div class="alert alert-info mb-0">
                                <p class="mb-0">No earnings or losses for this period.</p>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Dividends List -->
        @if (dividends.Any())
        {
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Dividend Distributions (@dividends.Count)</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Tenant</th>
                                    <th>Lease ID</th>
                                    <th class="text-end">Base Dividend</th>
                                    <th class="text-center">Proration</th>
                                    <th class="text-end">Final Amount</th>
                                    <th class="text-center">Payment Method</th>
                                    <th class="text-center">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var dividend in dividends.OrderByDescending(d => d.DividendAmount))
                                {
                                    <tr>
                                        <td>
                                            <strong>Tenant #@dividend.TenantId</strong>
                                        </td>
                                        <td>Lease #@dividend.LeaseId</td>
                                        <td class="text-end">@dividend.BaseDividendAmount.ToString("C2")</td>
                                        <td class="text-center">
                                            @if (dividend.ProrationFactor < 1.0m)
                                            {
                                                <span class="badge bg-warning text-dark">
                                                    @((dividend.ProrationFactor * 100).ToString("F0"))%
                                                </span>
                                                <br />
                                                <small class="text-muted">@dividend.MonthsInPool mo</small>
                                            }
                                            else
                                            {
                                                <span class="badge bg-success">100%</span>
                                                <br />
                                                <small class="text-muted">Full year</small>
                                            }
                                        </td>
                                        <td class="text-end">
                                            <strong class="text-success">@dividend.DividendAmount.ToString("C2")</strong>
                                        </td>
                                        <td class="text-center">
                                            @if (dividend.PaymentMethod == ApplicationConstants.DividendPaymentMethods.Pending)
                                            {
                                                <span class="badge bg-secondary">Pending Choice</span>
                                            }
                                            else if (dividend.PaymentMethod == ApplicationConstants.DividendPaymentMethods.LeaseCredit)
                                            {
                                                <span class="badge bg-primary">Lease Credit</span>
                                            }
                                            else if (dividend.PaymentMethod == ApplicationConstants.DividendPaymentMethods.Check)
                                            {
                                                <span class="badge bg-info">Check</span>
                                            }
                                        </td>
                                        <td class="text-center">
                                            @if (dividend.Status == ApplicationConstants.DividendStatuses.Pending)
                                            {
                                                <span class="badge bg-warning text-dark">Pending</span>
                                            }
                                            else if (dividend.Status == ApplicationConstants.DividendStatuses.ChoiceMade)
                                            {
                                                <span class="badge bg-info">Choice Made</span>
                                            }
                                            else if (dividend.Status == ApplicationConstants.DividendStatuses.Applied)
                                            {
                                                <span class="badge bg-success">Applied</span>
                                            }
                                            else if (dividend.Status == ApplicationConstants.DividendStatuses.Paid)
                                            {
                                                <span class="badge bg-success">Paid</span>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                            <tfoot class="table-light">
                                <tr>
                                    <td colspan="4"><strong>Total Dividends:</strong></td>
                                    <td class="text-end"><strong class="text-success">@dividends.Sum(d => d.DividendAmount).ToString("C2")</strong></td>
                                    <td colspan="2"></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        }
        else if (pool.HasEarnings)
        {
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i>
                <strong>Dividends Not Yet Calculated</strong>
                <p class="mb-0 mt-2">Click "Calculate Dividends" to generate dividend distributions for all active leases.</p>
            </div>
        }
    }
</div>

@code {
    [Parameter]
    public int PoolId { get; set; }

    private SecurityDepositInvestmentPool? pool;
    private List<SecurityDepositDividend> dividends = new();
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadPoolDetails();
    }

    private async Task LoadPoolDetails()
    {
        isLoading = true;
        try
        {
            pool = await SecurityDepositService.GetInvestmentPoolByIdAsync(PoolId);
            
            if (pool != null)
            {
                dividends = await SecurityDepositService.GetDividendsByYearAsync(pool.Year);
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Failed to load pool details: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void NavigateToCalculateDividends()
    {
        NavigationManager.NavigateTo($"/property-management/security-deposits/calculate-dividends/{PoolId}");
    }
}
