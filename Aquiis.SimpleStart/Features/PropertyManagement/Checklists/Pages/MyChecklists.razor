@page "/propertymanagement/checklists/mychecklists"

@using Aquiis.SimpleStart.Core.Entities
@using Aquiis.SimpleStart.Core.Constants
@using Aquiis.SimpleStart.Application.Services
@using Aquiis.SimpleStart.Shared.Services
@using Aquiis.SimpleStart.Application.Services.PdfGenerators
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components
@inject ChecklistService ChecklistService
@inject UserContextService UserContext
@inject NavigationManager NavigationManager
@attribute [OrganizationAuthorize("Owner", "Administrator", "PropertyManager")]

@rendermode InteractiveServer

<PageTitle>My Checklists</PageTitle>

<div class="container-fluid">
    <div class="row mb-3">
        <div class="col-md-6">
            <h1><i class="bi bi-list-task"></i> My Checklists</h1>
            <p class="text-muted">Manage your created checklists</p>
        </div>
        <div class="col-md-6 text-end">
            <div class="btn-group">
                <button class="btn btn-primary" @onclick="CreateNewChecklist">
                    <i class="bi bi-plus-circle"></i> New Checklist
                </button>
                <button class="btn btn-outline-secondary" @onclick="NavigateToTemplates">
                    <i class="bi bi-card-checklist"></i> Manage Templates
                </button>
            </div>
        </div>
    </div>

    @if (errorMessage != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @errorMessage
            <button type="button" class="btn-close" @onclick="@(() => errorMessage = null)"></button>
        </div>
    }

    @if (successMessage != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @successMessage
            <button type="button" class="btn-close" @onclick="@(() => successMessage = null)"></button>
        </div>
    }

    <!-- Delete Confirmation Modal -->
    @if (showDeleteConfirmation && checklistToDelete != null)
    {
        <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="bi bi-exclamation-triangle text-warning"></i> Confirm Delete</h5>
                        <button type="button" class="btn-close" @onclick="CloseDeleteConfirmation"></button>
                    </div>
                    <div class="modal-body">
                        @if (checklistToDelete.Status == ApplicationConstants.ChecklistStatuses.Completed)
                        {
                            <p>This checklist is completed. Are you sure you want to archive it?</p>
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i> 
                                The checklist "@checklistToDelete.Name" will be hidden from the main list but can still be accessed directly via its URL.
                            </div>
                        }
                        else
                        {
                            <p>Are you sure you want to delete this checklist?</p>
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle"></i> 
                                The checklist "@checklistToDelete.Name" will be permanently removed.
                            </div>
                        }
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CloseDeleteConfirmation">Cancel</button>
                        <button type="button" class="btn btn-danger" @onclick="DeleteChecklist" disabled="@isDeleting">
                            @if (isDeleting)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                            }
                            @(checklistToDelete.Status == ApplicationConstants.ChecklistStatuses.Completed ? "Archive" : "Delete")
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }

    @if (checklists == null)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (!checklists.Any())
    {
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> No checklists found. Click "New Checklist" to create one from a template.
        </div>
    }
    else
    {
        <!-- Filter -->
        <div class="row mb-3">
            <div class="col-md-4">
                <input type="text" class="form-control" placeholder="Search checklists..." @bind="searchText" @bind:event="oninput" />
            </div>
            <div class="col-md-3">
                <select class="form-select" @bind="filterStatus">
                    <option value="">All Statuses</option>
                    @foreach (var status in ApplicationConstants.ChecklistStatuses.AllChecklistStatuses)
                    {
                        <option value="@status">@status</option>
                    }
                </select>
            </div>
            <div class="col-md-3">
                <select class="form-select" @bind="filterType">
                    <option value="">All Types</option>
                    @foreach (var type in ApplicationConstants.ChecklistTypes.AllChecklistTypes)
                    {
                        <option value="@type">@type</option>
                    }
                </select>
            </div>
        </div>

        <!-- Checklists Table -->
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Type</th>
                                <th>Property</th>
                                <th>Status</th>
                                <th>Progress</th>
                                <th>Created</th>
                                <th class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var checklist in FilteredChecklists)
                            {
                                <tr>
                                    <td>
                                        <strong>@checklist.Name</strong>
                                    </td>
                                    <td>
                                        <span class="badge bg-info">@checklist.ChecklistType</span>
                                    </td>
                                    <td>
                                        @if (checklist.Property != null)
                                        {
                                            <span>@checklist.Property.Address</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">Not assigned</span>
                                        }
                                    </td>
                                    <td>
                                        <span class="badge @GetStatusBadgeClass(checklist.Status)">@checklist.Status</span>
                                    </td>
                                    <td>
                                        @if (checklist.Items != null && checklist.Items.Any())
                                        {
                                            var total = checklist.Items.Count;
                                            var completed = checklist.Items.Count(i => i.IsChecked);
                                            var percent = total > 0 ? (int)((completed * 100.0) / total) : 0;
                                            <div class="progress" style="width: 100px;">
                                                <div class="progress-bar @(percent == 100 ? "bg-success" : "")" 
                                                     role="progressbar" 
                                                     style="width: @percent%" 
                                                     aria-valuenow="@percent" 
                                                     aria-valuemin="0" 
                                                     aria-valuemax="100">
                                                    @percent%
                                                </div>
                                            </div>
                                        }
                                        else
                                        {
                                            <span class="text-muted">-</span>
                                        }
                                    </td>
                                    <td>
                                        <small>@checklist.CreatedOn.ToString("MM/dd/yyyy")</small>
                                    </td>
                                    <td class="text-end">
                                        <div class="btn-group btn-group-sm">
                                            @if (checklist.Status == ApplicationConstants.ChecklistStatuses.Completed)
                                            {
                                                <button class="btn btn-outline-primary" @onclick="@(() => ViewChecklist(checklist.Id))" title="View">
                                                    <i class="bi bi-eye"></i>
                                                </button>
                                            }
                                            else
                                            {
                                                <button class="btn btn-outline-primary" @onclick="@(() => EditChecklist(checklist.Id))" title="Edit">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                            }
                                            <button class="btn btn-outline-danger" @onclick="@(() => ShowDeleteConfirmation(checklist))" title="Delete">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private List<Checklist>? checklists;
    private string? errorMessage;
    private string? successMessage;
    private string searchText = "";
    private string filterStatus = "";
    private string filterType = "";
    private bool showDeleteConfirmation = false;
    private bool isDeleting = false;
    private Checklist? checklistToDelete = null;

    private IEnumerable<Checklist> FilteredChecklists
    {
        get
        {
            if (checklists == null) return Enumerable.Empty<Checklist>();

            var filtered = checklists.AsEnumerable();

            if (!string.IsNullOrWhiteSpace(searchText))
            {
                filtered = filtered.Where(c =>
                    c.Name.Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
                    (c.Property?.Address?.Contains(searchText, StringComparison.OrdinalIgnoreCase) ?? false));
            }

            if (!string.IsNullOrWhiteSpace(filterStatus))
            {
                filtered = filtered.Where(c => c.Status == filterStatus);
            }

            if (!string.IsNullOrWhiteSpace(filterType))
            {
                filtered = filtered.Where(c => c.ChecklistType == filterType);
            }

            return filtered;
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadChecklists();
    }

    private async Task LoadChecklists()
    {
        try
        {
            checklists = await ChecklistService.GetChecklistsAsync(includeArchived: false);
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading checklists: {ex.Message}";
        }
    }

    private string GetStatusBadgeClass(string status)
    {
        return status switch
        {
            var s when s == ApplicationConstants.ChecklistStatuses.Completed => "bg-success",
            var s when s == ApplicationConstants.ChecklistStatuses.InProgress => "bg-warning text-dark",
            var s when s == ApplicationConstants.ChecklistStatuses.Draft => "bg-secondary",
            _ => "bg-secondary"
        };
    }

    private void CreateNewChecklist()
    {
        NavigationManager.NavigateTo("/propertymanagement/checklists/create");
    }

    private void EditChecklist(Guid checklistId)
    {
        NavigationManager.NavigateTo($"/propertymanagement/checklists/complete/{checklistId}");
    }

    private void ViewChecklist(Guid checklistId)
    {
        NavigationManager.NavigateTo($"/propertymanagement/checklists/view/{checklistId}");
    }

    private void ShowDeleteConfirmation(Checklist checklist)
    {
        checklistToDelete = checklist;
        showDeleteConfirmation = true;
        errorMessage = null;
        successMessage = null;
    }

    private void CloseDeleteConfirmation()
    {
        showDeleteConfirmation = false;
        checklistToDelete = null;
    }

    private async Task DeleteChecklist()
    {
        if (checklistToDelete == null) return;

        try
        {
            isDeleting = true;
            errorMessage = null;

            // If completed, use soft delete (archive)
            if (checklistToDelete.Status == ApplicationConstants.ChecklistStatuses.Completed)
            {
                await ChecklistService.ArchiveChecklistAsync(checklistToDelete.Id);
                successMessage = $"Checklist '{checklistToDelete.Name}' has been archived.";
            }
            else
            {
                // If not completed, use hard delete
                await ChecklistService.DeleteChecklistAsync(checklistToDelete.Id);
                successMessage = $"Checklist '{checklistToDelete.Name}' has been deleted.";
            }

            // Reload the list
            await LoadChecklists();

            CloseDeleteConfirmation();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error deleting checklist: {ex.Message}";
        }
        finally
        {
            isDeleting = false;
        }
    }

    private void NavigateToTemplates()
    {
        NavigationManager.NavigateTo("/propertymanagement/checklists/templates");
    }
}
