@page "/propertymanagement/checklists/templates"

@using Aquiis.SimpleStart.Core.Entities
@using Aquiis.SimpleStart.Application.Services
@using Aquiis.SimpleStart.Shared.Services
@using Aquiis.SimpleStart.Application.Services.PdfGenerators
@using Aquiis.SimpleStart.Core.Constants
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components
@inject ChecklistService ChecklistService
@inject NavigationManager NavigationManager
@inject UserContextService UserContext
@attribute [OrganizationAuthorize("Owner", "Administrator", "PropertyManager")]

@rendermode InteractiveServer

<PageTitle>Checklist Templates</PageTitle>

<div class="container-fluid">
    <div class="row mb-3">
        <div class="col-md-6">
            <h3><i class="bi bi-card-checklist"></i> Checklist Templates</h3>
        </div>
        <div class="col-md-6 text-end">
            <button class="btn btn-primary" @onclick="NavigateToCreateChecklist">
                <i class="bi bi-plus-circle"></i> Create Checklist from Template
            </button>
        </div>
    </div>

    @if (errorMessage != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @errorMessage
            <button type="button" class="btn-close" @onclick="@(() => errorMessage = null)"></button>
        </div>
    }

    @if (successMessage != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @successMessage
            <button type="button" class="btn-close" @onclick="@(() => successMessage = null)"></button>
        </div>
    }

    <!-- Delete Confirmation Modal -->
    @if (showDeleteConfirmation && templateToDelete != null)
    {
        <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="bi bi-exclamation-triangle text-warning"></i> Confirm Delete</h5>
                        <button type="button" class="btn-close" @onclick="CloseDeleteConfirmation"></button>
                    </div>
                    <div class="modal-body">
                        <p>Are you sure you want to delete this template?</p>
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> 
                            The template "@templateToDelete.Name" will no longer appear in the template selection list.
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CloseDeleteConfirmation">Cancel</button>
                        <button type="button" class="btn btn-warning" @onclick="DeleteTemplate" disabled="@isDeleting">
                            @if (isDeleting)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                            }
                            Delete Template
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }

    @if (templates == null)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (!templates.Any())
    {
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> No templates found.
        </div>
    }
    else
    {
        <!-- Templates Cards -->
        <div class="row">
            @foreach (var template in templates)
            {
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card h-100 @(template.IsSystemTemplate ? "border-primary" : "")">
                        <div class="card-header @(template.IsSystemTemplate ? "bg-primary text-white" : "bg-light")">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    @if (template.IsSystemTemplate)
                                    {
                                        <i class="bi bi-shield-check"></i>
                                    }
                                    @template.Name
                                </h5>
                                @if (template.IsSystemTemplate)
                                {
                                    <span class="badge bg-light text-primary">System</span>
                                }
                                else
                                {
                                    <span class="badge bg-secondary">Custom</span>
                                }
                            </div>
                        </div>
                        <div class="card-body">
                            <p class="card-text text-muted small">@(template.Description ?? "No description provided")</p>
                            
                            <div class="mb-2">
                                <strong>Category:</strong> 
                                <span class="badge bg-info">@template.Category</span>
                            </div>
                            
                            <div class="mb-2">
                                <strong>Items:</strong> @(template.Items?.Count ?? 0)
                            </div>

                            @if (template.Items != null && template.Items.Any())
                            {
                                var requiredCount = template.Items.Count(i => i.IsRequired);
                                var valueCount = template.Items.Count(i => i.RequiresValue);
                                
                                @if (requiredCount > 0)
                                {
                                    <div class="text-muted small">
                                        <i class="bi bi-exclamation-circle"></i> @requiredCount required
                                    </div>
                                }
                                @if (valueCount > 0)
                                {
                                    <div class="text-muted small">
                                        <i class="bi bi-input-cursor-text"></i> @valueCount need values
                                    </div>
                                }
                            }
                        </div>
                        <div class="card-footer bg-transparent">
                            <div class="d-flex gap-2">
                                @if (!template.IsSystemTemplate)
                                {
                                    <button class="btn btn-sm btn-primary flex-fill" 
                                            @onclick="@(() => NavigateToEditTemplate(template.Id))">
                                        <i class="bi bi-pencil"></i> Edit
                                    </button>
                                    <button class="btn btn-sm btn-outline-primary" 
                                            @onclick="@(() => CopyTemplate(template))"
                                            disabled="@isCopying">
                                        @if (isCopying)
                                        {
                                            <span class="spinner-border spinner-border-sm me-1"></span>
                                        }
                                        else
                                        {
                                            <i class="bi bi-copy"></i> <text>Copy</text>
                                        }
                                    </button>
                                    <button class="btn btn-sm btn-danger" 
                                            @onclick="@(() => ShowDeleteConfirmation(template))">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                }
                                else
                                {
                                    @if (isAdmin)
                                    {
                                        <button class="btn btn-sm btn-primary flex-fill" 
                                                @onclick="@(() => NavigateToEditTemplate(template.Id))">
                                            <i class="bi bi-pencil"></i> Edit
                                        </button>
                                    }
                                    <button class="btn btn-sm btn-outline-primary" 
                                            @onclick="@(() => CopyTemplate(template))"
                                            disabled="@isCopying">
                                        @if (isCopying)
                                        {
                                            <span class="spinner-border spinner-border-sm me-1"></span>
                                        }
                                        else
                                        {
                                            <i class="bi bi-copy"></i> <text>Copy</text>
                                        }
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary" 
                                            @onclick="@(() => NavigateToCreateWithTemplate(template.Id))">
                                        <i class="bi bi-plus-circle"></i> Use
                                    </button>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    private List<ChecklistTemplate>? templates;
    private string? errorMessage;
    private string? successMessage;
    private bool showDeleteConfirmation = false;
    private bool isDeleting = false;
    private bool isCopying = false;
    private bool isAdmin = false;
    private ChecklistTemplate? templateToDelete = null;

    protected override async Task OnInitializedAsync()
    {
        isAdmin = await UserContext.IsInRoleAsync(ApplicationConstants.DefaultAdminRole);
        await LoadTemplates();
    }

    private async Task LoadTemplates()
    {
        try
        {
            templates = await ChecklistService.GetChecklistTemplatesAsync();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading templates: {ex.Message}";
        }
    }

    private void NavigateToCreateChecklist()
    {
        NavigationManager.NavigateTo("/propertymanagement/checklists/create");
    }

    private void NavigateToCreateWithTemplate(Guid templateId)
    {
        NavigationManager.NavigateTo($"/propertymanagement/checklists/create?templateId={templateId}");
    }

    private void NavigateToEditTemplate(Guid templateId)
    {
        NavigationManager.NavigateTo($"/propertymanagement/checklists/templates/edit/{templateId}");
    }

    private async Task CopyTemplate(ChecklistTemplate sourceTemplate)
    {
        try
        {
            isCopying = true;
            errorMessage = null;

            // Create a new template with a copy of the source
            var newTemplate = new ChecklistTemplate
            {
                Name = $"{sourceTemplate.Name} (Copy)",
                Description = sourceTemplate.Description,
                Category = sourceTemplate.Category,
                IsSystemTemplate = false
            };

            var savedTemplate = await ChecklistService.AddChecklistTemplateAsync(newTemplate);

            // Copy all items from source template
            if (sourceTemplate.Items != null)
            {
                foreach (var sourceItem in sourceTemplate.Items)
                {
                    var newItem = new ChecklistTemplateItem
                    {
                        ChecklistTemplateId = savedTemplate.Id,
                        ItemText = sourceItem.ItemText,
                        ItemOrder = sourceItem.ItemOrder,
                        CategorySection = sourceItem.CategorySection,
                        SectionOrder = sourceItem.SectionOrder,
                        IsRequired = sourceItem.IsRequired,
                        RequiresValue = sourceItem.RequiresValue,
                        AllowsNotes = sourceItem.AllowsNotes
                    };

                    await ChecklistService.AddChecklistTemplateItemAsync(newItem);
                }
            }

            successMessage = $"Template '{sourceTemplate.Name}' copied successfully!";
            
            // Reload the templates list to show the new copy
            await LoadTemplates();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error copying template: {ex.Message}";
        }
        finally
        {
            isCopying = false;
        }
    }

    private void ShowDeleteConfirmation(ChecklistTemplate template)
    {
        templateToDelete = template;
        showDeleteConfirmation = true;
        errorMessage = null;
        successMessage = null;
    }

    private void CloseDeleteConfirmation()
    {
        showDeleteConfirmation = false;
        templateToDelete = null;
    }

    private async Task DeleteTemplate()
    {
        if (templateToDelete == null) return;

        try
        {
            isDeleting = true;
            errorMessage = null;

            await ChecklistService.DeleteChecklistTemplateAsync(templateToDelete.Id);

            successMessage = $"Template '{templateToDelete.Name}' has been deleted.";
            
            // Reload the list
            await LoadTemplates();
            
            CloseDeleteConfirmation();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error deleting template: {ex.Message}";
        }
        finally
        {
            isDeleting = false;
        }
    }
}
