@page "/propertymanagement/properties/create"
@using Aquiis.SimpleStart.Core.Constants
@using Aquiis.SimpleStart.Core.Entities
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Forms
@using System.ComponentModel.DataAnnotations
@inject NavigationManager Navigation
@inject PropertyManagementService PropertyManagementService
@inject UserContextService UserContextService

@rendermode InteractiveServer

@attribute [OrganizationAuthorize("Owner", "Administrator", "PropertyManager")]

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title mb-0">Add New Property</h3>
            </div>
            <div class="card-body">
                <EditForm Model="propertyModel" OnValidSubmit="SaveProperty" FormName="create-property">
                    <DataAnnotationsValidator />
                    
                    @if (!string.IsNullOrEmpty(errorMessage))
                    {
                        <div class="alert alert-danger" role="alert">
                            @errorMessage
                        </div>
                    }

                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label class="form-label">Address *</label>
                            <InputText @bind-Value="propertyModel.Address" class="form-control" placeholder="Enter property address" />
                            <ValidationMessage For="() => propertyModel.Address" class="text-danger" />
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label class="form-label">Unit Number</label>
                            <InputText @bind-Value="propertyModel.UnitNumber" class="form-control" placeholder="e.g., Apt 2B, Unit 101" />
                            <ValidationMessage For="() => propertyModel.UnitNumber" class="text-danger" />
                        </div>
                        @* <div class="col-md-4 mb-3">
                            <label class="form-label" for="@propertyModel.ZipCode">Postal Code</label>
                            <InputText @bind-Value="propertyModel.ZipCode" class="form-control" placeholder="#####-####" />
                            <ValidationMessage For="() => propertyModel.ZipCode" class="text-danger" />
                        </div> *@
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">City</label>
                            <InputText @bind-Value="propertyModel.City" class="form-control" placeholder="City" />
                            <ValidationMessage For="() => propertyModel.City" class="text-danger" />
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">State</label>
                            <InputSelect @bind-Value="propertyModel.State" class="form-select">
                                <option value="">Select State</option>
                                @foreach (var state in States.StatesArray())
                                {
                                    <option value="@state.Abbreviation">@state.Name</option>
                                }
                            </InputSelect>
                            <ValidationMessage For="() => propertyModel.State" class="text-danger" />
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label" for="@propertyModel.ZipCode">Postal Code</label>
                            <InputText @bind-Value="propertyModel.ZipCode" class="form-control" placeholder="#####-####" />
                            <ValidationMessage For="() => propertyModel.ZipCode" class="text-danger" />
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Property Type *</label>
                            <InputSelect @bind-Value="propertyModel.PropertyType" class="form-select">
                                <option value="">Select property type</option>
                                <option value="House">House</option>
                                <option value="Apartment">Apartment</option>
                                <option value="Condo">Condo</option>
                                <option value="Townhouse">Townhouse</option>
                                <option value="Duplex">Duplex</option>
                                <option value="Commercial">Commercial</option>
                                <option value="Other">Other</option>
                            </InputSelect>
                            <ValidationMessage For="() => propertyModel.PropertyType" class="text-danger" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Monthly Rent *</label>
                            <InputNumber @bind-Value="propertyModel.MonthlyRent" class="form-control" placeholder="0.00" />
                            <ValidationMessage For="() => propertyModel.MonthlyRent" class="text-danger" />
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Status *</label>
                            <InputSelect @bind-Value="propertyModel.Status" class="form-select">
                                <option value="@ApplicationConstants.PropertyStatuses.Available">Available</option>
                                <option value="@ApplicationConstants.PropertyStatuses.ApplicationPending">Application Pending</option>
                                <option value="@ApplicationConstants.PropertyStatuses.LeasePending">Lease Pending</option>
                                <option value="@ApplicationConstants.PropertyStatuses.Occupied">Occupied</option>
                                <option value="@ApplicationConstants.PropertyStatuses.UnderRenovation">Under Renovation</option>
                                <option value="@ApplicationConstants.PropertyStatuses.OffMarket">Off Market</option>
                            </InputSelect>
                            <ValidationMessage For="() => propertyModel.Status" class="text-danger" />
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Bedrooms</label>
                            <InputNumber @bind-Value="propertyModel.Bedrooms" class="form-control" />
                            <ValidationMessage For="() => propertyModel.Bedrooms" class="text-danger" />
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Bathrooms</label>
                            <InputNumber @bind-Value="propertyModel.Bathrooms" class="form-control" />
                            <ValidationMessage For="() => propertyModel.Bathrooms" class="text-danger" />
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Square Feet</label>
                            <InputNumber @bind-Value="propertyModel.SquareFeet" class="form-control" />
                            <ValidationMessage For="() => propertyModel.SquareFeet" class="text-danger" />
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label class="form-label">Description</label>
                            <InputTextArea @bind-Value="propertyModel.Description" class="form-control" rows="4" placeholder="Property description and features" />
                            <ValidationMessage For="() => propertyModel.Description" class="text-danger" />
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <div class="form-check">
                                <InputCheckbox @bind-Value="propertyModel.IsAvailable" class="form-check-input" />
                                <label class="form-check-label">
                                    Property is available for rent
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary" disabled="@isSubmitting">
                            @if (isSubmitting)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                            }
                            Create Property
                        </button>
                        <button type="button" class="btn btn-secondary" @onclick="Cancel">Cancel</button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
</div>

@code {
    private PropertyModel propertyModel = new();
     private bool isSubmitting = false;
    private string errorMessage = string.Empty;

    [CascadingParameter]
    private Task<AuthenticationState> AuthenticationStateTask { get; set; } = default!;

    private async Task SaveProperty()
    {
        isSubmitting = true;
        errorMessage = string.Empty;

        var userId = await UserContextService.GetUserIdAsync();
        var organizationId = await UserContextService.GetOrganizationIdAsync();

        if(string.IsNullOrEmpty(organizationId) || string.IsNullOrEmpty(userId))
        {
            throw new UnauthorizedAccessException("User is not authorized to perform this action.");
        }

        var property = new Property
        {
            OrganizationId = organizationId,
            Address = propertyModel.Address,
            UnitNumber = propertyModel.UnitNumber,
            City = propertyModel.City,
            State = propertyModel.State,
            ZipCode = propertyModel.ZipCode,
            PropertyType = propertyModel.PropertyType,
            MonthlyRent = propertyModel.MonthlyRent,
            Bedrooms = propertyModel.Bedrooms,
            Bathrooms = propertyModel.Bathrooms,
            SquareFeet = propertyModel.SquareFeet,
            Description = propertyModel.Description,
            Status = propertyModel.Status,
            IsAvailable = propertyModel.IsAvailable,
        };

        // Save the property using a service or API call
        await PropertyManagementService.AddPropertyAsync(property);

        isSubmitting = false;
        // Redirect to the properties list page after successful addition
        Navigation.NavigateTo("/propertymanagement/properties");
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/propertymanagement/properties");
    }


    public class PropertyModel
    {
        [Required(ErrorMessage = "Address is required")]
        [StringLength(200, ErrorMessage = "Address cannot exceed 200 characters")]
        public string Address { get; set; } = string.Empty;

        [StringLength(50, ErrorMessage = "Unit number cannot exceed 50 characters")]
        public string? UnitNumber { get; set; }

        [StringLength(100, ErrorMessage = "City cannot exceed 100 characters")]
        public string City { get; set; } = string.Empty;

        [StringLength(50, ErrorMessage = "State cannot exceed 50 characters")]
        public string State { get; set; } = string.Empty;

        [StringLength(10, ErrorMessage = "Zip Code cannot exceed 10 characters")]
        [DataType(DataType.PostalCode)]
        [RegularExpression(@"^\d{5}(-\d{4})?$", ErrorMessage = "Invalid Zip Code format.")]
        [MaxLength(10, ErrorMessage = "Zip Code cannot exceed 10 characters.")]
        [Display(Name = "Postal Code", Description = "Postal Code of the property",
            Prompt = "e.g., 12345 or 12345-6789", ShortName = "ZIP")]
        public string ZipCode { get; set; } = string.Empty;

        [Required(ErrorMessage = "Property type is required")]
        [StringLength(50, ErrorMessage = "Property type cannot exceed 50 characters")]
        public string PropertyType { get; set; } = string.Empty;

        [Required(ErrorMessage = "Monthly rent is required")]
        [Range(0.01, double.MaxValue, ErrorMessage = "Monthly rent must be greater than 0")]
        public decimal MonthlyRent { get; set; }

        [Range(0, int.MaxValue, ErrorMessage = "Bedrooms cannot be negative")]
        public int Bedrooms { get; set; }

        [Range(0.0, double.MaxValue, ErrorMessage = "Bathrooms cannot be negative")]
        public decimal Bathrooms { get; set; }

        [Range(0, int.MaxValue, ErrorMessage = "Square feet cannot be negative")]
        public int SquareFeet { get; set; }

        [StringLength(1000, ErrorMessage = "Description cannot exceed 1000 characters")]
        public string Description { get; set; } = string.Empty;

        [Required(ErrorMessage = "Status is required")]
        [StringLength(50, ErrorMessage = "Status cannot exceed 50 characters")]
        public string Status { get; set; } = ApplicationConstants.PropertyStatuses.Available;

        public bool IsAvailable { get; set; } = true;
    }
}