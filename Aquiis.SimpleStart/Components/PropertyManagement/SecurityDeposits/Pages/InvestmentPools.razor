@page "/property-management/security-deposits/investment-pools"
@using Aquiis.SimpleStart.Core.Entities
@using Aquiis.SimpleStart.Application.Services
@using Aquiis.SimpleStart.Shared.Services
@using Aquiis.SimpleStart.Application.Services.PdfGenerators
@using Aquiis.SimpleStart.Core.Entities
@using Aquiis.SimpleStart.Core.Constants
@using Microsoft.AspNetCore.Authorization
@inject SecurityDepositService SecurityDepositService
@inject NavigationManager NavigationManager
@inject ToastService ToastService
@rendermode InteractiveServer
@attribute [Authorize]

<PageTitle>Investment Pools - Security Deposits</PageTitle>

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h1 class="h3">Security Deposit Investment Pools</h1>
            <p class="text-muted">Manage annual investment performance and dividend distributions</p>
        </div>
        <div class="col-auto">
            <button class="btn btn-primary" @onclick="CreateNewPool">
                <i class="bi bi-plus-circle"></i> Record Performance
            </button>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2 text-muted">Loading investment pools...</p>
        </div>
    }
    else if (investmentPools == null || !investmentPools.Any())
    {
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i>
            <strong>No Investment Pools Found</strong>
            <p class="mb-0 mt-2">No annual investment performance has been recorded yet. Click "Record Performance" to add the first year's investment results.</p>
        </div>
    }
    else
    {
        <div class="card">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Year</th>
                                <th class="text-end">Starting Balance</th>
                                <th class="text-end">Deposits</th>
                                <th class="text-end">Withdrawals</th>
                                <th class="text-end">Current Balance</th>
                                <th class="text-end">Total Earnings</th>
                                <th class="text-end">Return Rate</th>
                                <th class="text-end">Organization Share</th>
                                <th class="text-end">Tenant Share</th>
                                <th class="text-center">Active Leases</th>
                                <th class="text-center">Status</th>
                                <th class="text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var pool in investmentPools.OrderByDescending(p => p.Year))
                            {
                                var poolStats = GetPoolStats(pool.Year);
                                <tr>
                                    <td>
                                        <strong>@pool.Year</strong>
                                    </td>
                                    <td class="text-end">
                                        @pool.StartingBalance.ToString("C2")
                                    </td>
                                    <td class="text-end text-success">
                                        <i class="bi bi-plus-circle"></i>
                                        @poolStats.Deposits.ToString("C2")
                                    </td>
                                    <td class="text-end text-danger">
                                        <i class="bi bi-dash-circle"></i>
                                        @poolStats.Withdrawals.ToString("C2")
                                    </td>
                                    <td class="text-end">
                                        <strong>@poolStats.CurrentBalance.ToString("C2")</strong>
                                    </td>
                                    <td class="text-end">
                                        @if (pool.HasEarnings)
                                        {
                                            <span class="text-success">
                                                <i class="bi bi-arrow-up"></i>
                                                @pool.TotalEarnings.ToString("C2")
                                            </span>
                                        }
                                        else if (pool.HasLosses)
                                        {
                                            <span class="text-danger">
                                                <i class="bi bi-arrow-down"></i>
                                                @pool.TotalEarnings.ToString("C2")
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">$0.00</span>
                                        }
                                    </td>
                                    <td class="text-end">
                                        @if (pool.ReturnRate >= 0)
                                        {
                                            <span class="text-success">@((pool.ReturnRate * 100).ToString("F2"))%</span>
                                        }
                                        else
                                        {
                                            <span class="text-danger">@((pool.ReturnRate * 100).ToString("F2"))%</span>
                                        }
                                    </td>
                                    <td class="text-end">
                                        @pool.OrganizationShare.ToString("C2")
                                        <small class="text-muted">(@((pool.OrganizationSharePercentage * 100).ToString("F0"))%)</small>
                                    </td>
                                    <td class="text-end">
                                        @pool.TenantShareTotal.ToString("C2")
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-info">@pool.ActiveLeaseCount</span>
                                    </td>
                                    <td class="text-center">
                                        @if (pool.Status == ApplicationConstants.InvestmentPoolStatuses.Open)
                                        {
                                            <span class="badge bg-primary">Open</span>
                                        }
                                        else if (pool.Status == ApplicationConstants.InvestmentPoolStatuses.Calculated)
                                        {
                                            <span class="badge bg-warning text-dark">Calculated</span>
                                        }
                                        else if (pool.Status == ApplicationConstants.InvestmentPoolStatuses.Distributed)
                                        {
                                            <span class="badge bg-success">Distributed</span>
                                        }
                                        else if (pool.Status == ApplicationConstants.InvestmentPoolStatuses.Closed)
                                        {
                                            <span class="badge bg-secondary">Closed</span>
                                        }
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-primary" 
                                                    @onclick="() => ViewPoolDetails(pool.Id)"
                                                    title="View Details">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                            @if (pool.Status == ApplicationConstants.InvestmentPoolStatuses.Open)
                                            {
                                                <button class="btn btn-outline-success" 
                                                        @onclick="() => CalculateDividends(pool.Id)"
                                                        title="Calculate Dividends">
                                                    <i class="bi bi-calculator"></i>
                                                </button>
                                            }
                                            @if (pool.Status != ApplicationConstants.InvestmentPoolStatuses.Closed)
                                            {
                                                <button class="btn btn-outline-secondary" 
                                                        @onclick="() => ClosePool(pool.Id, pool.Year)"
                                                        title="Close Pool">
                                                    <i class="bi bi-lock"></i>
                                                </button>
                                            }
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                        <tfoot class="table-light">
                            <tr>
                                <td><strong>Totals</strong></td>
                                <td class="text-end"><strong>@investmentPools.Sum(p => p.StartingBalance).ToString("C2")</strong></td>
                                <td class="text-end"><strong>@allPoolStats.Sum(s => s.Deposits).ToString("C2")</strong></td>
                                <td class="text-end"><strong>@allPoolStats.Sum(s => s.Withdrawals).ToString("C2")</strong></td>
                                <td class="text-end"><strong>@allPoolStats.Sum(s => s.CurrentBalance).ToString("C2")</strong></td>
                                <td class="text-end">
                                    @if (investmentPools.Sum(p => p.TotalEarnings) >= 0)
                                    {
                                        <strong class="text-success">@investmentPools.Sum(p => p.TotalEarnings).ToString("C2")</strong>
                                    }
                                    else
                                    {
                                        <strong class="text-danger">@investmentPools.Sum(p => p.TotalEarnings).ToString("C2")</strong>
                                    }
                                </td>
                                <td class="text-end">
                                    @{
                                        var avgReturn = investmentPools.Any() ? investmentPools.Average(p => p.ReturnRate) : 0;
                                    }
                                    <strong>@((avgReturn * 100).ToString("F2"))%</strong>
                                    <small class="text-muted">(avg)</small>
                                </td>
                                <td class="text-end"><strong>@investmentPools.Sum(p => p.OrganizationShare).ToString("C2")</strong></td>
                                <td class="text-end"><strong>@investmentPools.Sum(p => p.TenantShareTotal).ToString("C2")</strong></td>
                                <td class="text-center"><strong>@investmentPools.Sum(p => p.ActiveLeaseCount)</strong></td>
                                <td colspan="2"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        @if (investmentPools.Any())
        {
            <div class="row mt-4">
                <div class="col-md-4">
                    <div class="card border-primary">
                        <div class="card-body">
                            <h6 class="card-subtitle mb-2 text-muted">Total Investment Pool Value</h6>
                            <h3 class="card-title mb-0">@investmentPools.Sum(p => p.EndingBalance).ToString("C2")</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card border-success">
                        <div class="card-body">
                            <h6 class="card-subtitle mb-2 text-muted">Total Dividends Distributed</h6>
                            <h3 class="card-title mb-0 text-success">@investmentPools.Sum(p => p.TenantShareTotal).ToString("C2")</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card border-info">
                        <div class="card-body">
                            <h6 class="card-subtitle mb-2 text-muted">Organization Revenue</h6>
                            <h3 class="card-title mb-0 text-info">@investmentPools.Sum(p => p.OrganizationShare).ToString("C2")</h3>
                        </div>
                    </div>
                </div>
            </div>
        }
    }
</div>

@code {
    private List<SecurityDepositInvestmentPool> investmentPools = new();
    private List<SecurityDeposit> allDeposits = new();
    private List<PoolStats> allPoolStats = new();
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadInvestmentPools();
    }

    private async Task LoadInvestmentPools()
    {
        isLoading = true;
        try
        {
            investmentPools = await SecurityDepositService.GetInvestmentPoolsAsync();
            allDeposits = await SecurityDepositService.GetSecurityDepositsAsync();
            
            // Calculate stats for each pool year
            allPoolStats = investmentPools.Select(p => GetPoolStats(p.Year)).ToList();
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Failed to load investment pools: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private PoolStats GetPoolStats(int year)
    {
        var yearStart = new DateTime(year, 1, 1);
        var yearEnd = new DateTime(year, 12, 31, 23, 59, 59);

        // Get the pool to access its starting balance
        var pool = investmentPools.FirstOrDefault(p => p.Year == year);
        var startingBalance = pool?.StartingBalance ?? 0;

        // Deposits added during the year
        var deposits = allDeposits
            .Where(d => d.PoolEntryDate.HasValue && 
                       d.PoolEntryDate.Value >= yearStart &&
                       d.PoolEntryDate.Value <= yearEnd)
            .Sum(d => d.Amount);

        // Deposits removed during the year
        var withdrawals = allDeposits
            .Where(d => d.PoolExitDate.HasValue && 
                       d.PoolExitDate.Value >= yearStart &&
                       d.PoolExitDate.Value <= yearEnd)
            .Sum(d => d.Amount);

        // Current balance = Starting + Deposits - Withdrawals
        var currentBalance = startingBalance + deposits - withdrawals;

        return new PoolStats
        {
            Deposits = deposits,
            Withdrawals = withdrawals,
            CurrentBalance = currentBalance
        };
    }

    private void CreateNewPool()
    {
        NavigationManager.NavigateTo("/property-management/security-deposits/record-performance");
    }

    private void ViewPoolDetails(int poolId)
    {
        NavigationManager.NavigateTo($"/property-management/security-deposits/investment-pool/{poolId}");
    }

    private void CalculateDividends(int poolId)
    {
        NavigationManager.NavigateTo($"/property-management/security-deposits/calculate-dividends/{poolId}");
    }

    private async Task ClosePool(int poolId, int year)
    {
        try
        {
            await SecurityDepositService.CloseInvestmentPoolAsync(poolId, "system");
            ToastService.ShowSuccess($"Investment pool for {year} has been closed");
            await LoadInvestmentPools();
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Failed to close pool: {ex.Message}");
        }
    }

    private class PoolStats
    {
        public decimal Deposits { get; set; }
        public decimal Withdrawals { get; set; }
        public decimal CurrentBalance { get; set; }
    }
}
