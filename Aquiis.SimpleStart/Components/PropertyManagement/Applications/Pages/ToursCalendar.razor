@page "/PropertyManagement/Tours/Calendar"
@using Aquiis.SimpleStart.Models
@using Aquiis.SimpleStart.Services
@using Aquiis.SimpleStart.Components.Administration.Application
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = "SuperAdministrator,Administrator,PropertyManager")]
@inject RentalApplicationService ApplicationService
@inject UserContextService UserContext
@inject NavigationManager Navigation
@inject ToastService ToastService

@rendermode InteractiveServer

<PageTitle>Tour Calendar</PageTitle>

<div class="container-fluid">
    <div class="row mb-3">
        <div class="col">
            <h3><i class="bi bi-calendar3"></i> Tour Calendar</h3>
            <p class="text-muted">View and manage scheduled property tours</p>
        </div>
        <div class="col-auto">
            <div class="btn-group me-2">
                <button class="btn btn-outline-secondary" @onclick="NavigateToListView">
                    <i class="bi bi-list-ul"></i> List View
                </button>
            </div>
            <div class="btn-group me-2">
                <button class="btn btn-outline-secondary @(viewMode == "day" ? "active" : "")" @onclick='() => ChangeView("day")'>
                    <i class="bi bi-calendar-day"></i> Day
                </button>
                <button class="btn btn-outline-secondary @(viewMode == "week" ? "active" : "")" @onclick='() => ChangeView("week")'>
                    <i class="bi bi-calendar-week"></i> Week
                </button>
                <button class="btn btn-outline-secondary @(viewMode == "month" ? "active" : "")" @onclick='() => ChangeView("month")'>
                    <i class="bi bi-calendar-month"></i> Month
                </button>
            </div>
            <button class="btn btn-primary" @onclick="NavigateToProspects">
                <i class="bi bi-plus-circle"></i> Schedule Tour
            </button>
        </div>
    </div>

    @if (loading)
    {
        <div class="text-center p-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else
    {
        <!-- Navigation Controls -->
        <div class="card mb-3">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <button class="btn btn-outline-primary" @onclick="NavigatePrevious">
                        <i class="bi bi-chevron-left"></i> Previous
                    </button>
                    
                    <h4 class="mb-0">@GetDateRangeTitle()</h4>
                    
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-secondary" @onclick="NavigateToday">
                            Today
                        </button>
                        <button class="btn btn-outline-primary" @onclick="NavigateNext">
                            Next <i class="bi bi-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Calendar View -->
        @if (viewMode == "day")
        {
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">@currentDate.ToString("dddd, MMMM dd, yyyy")</h5>
                </div>
                <div class="card-body">
                    @RenderDayView()
                </div>
            </div>
        }
        else if (viewMode == "week")
        {
            @RenderWeekView()
        }
        else if (viewMode == "month")
        {
            @RenderMonthView()
        }
    }
</div>

<!-- Tour Detail Modal -->
@if (selectedTour != null)
{
    <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Tour Details</h5>
                    <button type="button" class="btn-close" @onclick="CloseModal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Prospective Tenant</h6>
                            <p>
                                <strong>@selectedTour.ProspectiveTenant?.FullName</strong><br/>
                                <i class="bi bi-envelope"></i> @selectedTour.ProspectiveTenant?.Email<br/>
                                <i class="bi bi-telephone"></i> @selectedTour.ProspectiveTenant?.Phone
                            </p>
                        </div>
                        <div class="col-md-6">
                            <h6>Property</h6>
                            <p>
                                <strong>@selectedTour.Property?.Address</strong><br/>
                                @selectedTour.Property?.City, @selectedTour.Property?.State @selectedTour.Property?.ZipCode
                            </p>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <h6>Scheduled</h6>
                            <p>
                                <i class="bi bi-calendar"></i> @selectedTour.ScheduledOn.ToString("MMM dd, yyyy")<br/>
                                <i class="bi bi-clock"></i> @selectedTour.ScheduledOn.ToString("h:mm tt") - @selectedTour.ScheduledOn.AddMinutes(selectedTour.DurationMinutes).ToString("h:mm tt")<br/>
                                <small class="text-muted">Duration: @selectedTour.DurationMinutes minutes</small>
                            </p>
                        </div>
                        <div class="col-md-6">
                            <h6>Status</h6>
                            <p>
                                <span class="badge @GetStatusBadgeClass(selectedTour.Status)">@selectedTour.Status</span>
                                @if (selectedTour.Checklist != null)
                                {
                                    <br/>
                                    <span class="badge @GetChecklistStatusBadgeClass(selectedTour.Checklist.Status) mt-1">
                                        <i class="bi bi-list-check"></i> Checklist: @selectedTour.Checklist.Status
                                    </span>
                                }
                            </p>
                        </div>
                    </div>
                    @if (!string.IsNullOrEmpty(selectedTour.InterestLevel))
                    {
                        <div class="row mt-3">
                            <div class="col-12">
                                <h6>Interest Level</h6>
                                <span class="badge @GetInterestBadgeClass(selectedTour.InterestLevel)">
                                    @GetInterestDisplay(selectedTour.InterestLevel)
                                </span>
                            </div>
                        </div>
                    }
                    @if (!string.IsNullOrEmpty(selectedTour.Feedback))
                    {
                        <div class="row mt-3">
                            <div class="col-12">
                                <h6>Feedback</h6>
                                <p>@selectedTour.Feedback</p>
                            </div>
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    @if (selectedTour.Status == ApplicationConstants.TourStatuses.Scheduled)
                    {
                        <button class="btn btn-success" @onclick="() => MarkCompleted(selectedTour.Id)">
                            <i class="bi bi-check-circle"></i> Complete Tour
                        </button>
                        <button class="btn btn-danger" @onclick="() => CancelTour(selectedTour.Id)">
                            <i class="bi bi-x-circle"></i> Cancel Tour
                        </button>
                    }
                    <button class="btn btn-secondary" @onclick="CloseModal">Close</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<Tour> allTours = new();
    private Tour? selectedTour;
    private bool loading = true;
    private string viewMode = "week"; // day, week, month
    private DateTime currentDate = DateTime.Today;

    protected override async Task OnInitializedAsync()
    {
        await LoadTours();
    }

    private async Task LoadTours()
    {
        loading = true;
        try
        {
            var orgId = await UserContext.GetOrganizationIdAsync();
            if (!string.IsNullOrEmpty(orgId))
            {
                allTours = await ApplicationService.GetAllToursAsync(orgId);
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error loading tours: {ex.Message}");
        }
        finally
        {
            loading = false;
        }
    }

    private void ChangeView(string mode)
    {
        viewMode = mode;
    }

    private void NavigatePrevious()
    {
        currentDate = viewMode switch
        {
            "day" => currentDate.AddDays(-1),
            "week" => currentDate.AddDays(-7),
            "month" => currentDate.AddMonths(-1),
            _ => currentDate
        };
    }

    private void NavigateNext()
    {
        currentDate = viewMode switch
        {
            "day" => currentDate.AddDays(1),
            "week" => currentDate.AddDays(7),
            "month" => currentDate.AddMonths(1),
            _ => currentDate
        };
    }

    private void NavigateToday()
    {
        currentDate = DateTime.Today;
    }

    private string GetDateRangeTitle()
    {
        return viewMode switch
        {
            "day" => currentDate.ToString("dddd, MMMM dd, yyyy"),
            "week" => $"{GetWeekStart().ToString("MMM dd")} - {GetWeekEnd().ToString("MMM dd, yyyy")}",
            "month" => currentDate.ToString("MMMM yyyy"),
            _ => ""
        };
    }

    private DateTime GetWeekStart()
    {
        var diff = (7 + (currentDate.DayOfWeek - DayOfWeek.Sunday)) % 7;
        return currentDate.AddDays(-1 * diff).Date;
    }

    private DateTime GetWeekEnd()
    {
        return GetWeekStart().AddDays(6);
    }

    private RenderFragment RenderDayView() => builder =>
    {
        var dayTours = allTours
            .Where(t => t.ScheduledOn.Date == currentDate.Date)
            .OrderBy(t => t.ScheduledOn)
            .ToList();

        if (!dayTours.Any())
        {
            builder.OpenElement(0, "div");
            builder.AddAttribute(1, "class", "text-center text-muted p-4");
            builder.OpenElement(2, "i");
            builder.AddAttribute(3, "class", "bi bi-calendar-x");
            builder.AddAttribute(4, "style", "font-size: 3rem;");
            builder.CloseElement();
            builder.OpenElement(5, "p");
            builder.AddAttribute(6, "class", "mt-2");
            builder.AddContent(7, "No tours scheduled for this day");
            builder.CloseElement();
            builder.CloseElement();
        }
        else
        {
            builder.OpenElement(10, "div");
            builder.AddAttribute(11, "class", "list-group");
            
            foreach (var tour in dayTours)
            {
                builder.OpenElement(20, "div");
                builder.AddAttribute(21, "class", "list-group-item list-group-item-action");
                builder.AddAttribute(22, "onclick", EventCallback.Factory.Create(this, () => ShowTourDetail(tour)));
                builder.AddAttribute(23, "style", "cursor: pointer;");
                
                builder.OpenElement(30, "div");
                builder.AddAttribute(31, "class", "d-flex justify-content-between align-items-start");
                
                builder.OpenElement(40, "div");
                builder.OpenElement(41, "h6");
                builder.AddAttribute(42, "class", "mb-1");
                builder.OpenElement(43, "i");
                builder.AddAttribute(44, "class", "bi bi-clock");
                builder.CloseElement();
                builder.AddContent(45, $" {tour.ScheduledOn.ToString("h:mm tt")} - {tour.ScheduledOn.AddMinutes(tour.DurationMinutes).ToString("h:mm tt")}");
                builder.CloseElement();
                
                builder.OpenElement(50, "p");
                builder.AddAttribute(51, "class", "mb-1");
                builder.AddContent(52, $"{tour.ProspectiveTenant?.FullName} â†’ {tour.Property?.Address}");
                builder.CloseElement();
                
                builder.OpenElement(60, "small");
                builder.AddAttribute(61, "class", "text-muted");
                builder.AddContent(62, $"{tour.DurationMinutes} minutes");
                builder.CloseElement();
                builder.CloseElement();
                
                builder.OpenElement(70, "div");
                builder.OpenElement(71, "span");
                builder.AddAttribute(72, "class", $"badge {GetStatusBadgeClass(tour.Status)}");
                builder.AddContent(73, tour.Status);
                builder.CloseElement();
                builder.CloseElement();
                
                builder.CloseElement();
                builder.CloseElement();
            }
            
            builder.CloseElement();
        }
    };

    private RenderFragment RenderWeekView() => builder =>
    {
        var weekStart = GetWeekStart();
        var weekEnd = GetWeekEnd();
        
        builder.OpenElement(0, "div");
        builder.AddAttribute(1, "class", "card");
        builder.OpenElement(2, "div");
        builder.AddAttribute(3, "class", "card-body p-0");
        
        builder.OpenElement(10, "div");
        builder.AddAttribute(11, "class", "table-responsive");
        builder.OpenElement(12, "table");
        builder.AddAttribute(13, "class", "table table-bordered mb-0");
        
        // Header
        builder.OpenElement(20, "thead");
        builder.OpenElement(21, "tr");
        
        for (int i = 0; i < 7; i++)
        {
            var date = weekStart.AddDays(i);
            var isToday = date.Date == DateTime.Today;
            
            builder.OpenElement(30 + i, "th");
            builder.AddAttribute(31 + i, "class", isToday ? "bg-primary text-white text-center" : "text-center");
            builder.AddAttribute(32 + i, "style", "width: 14.28%;");
            builder.OpenElement(40 + i, "div");
            builder.AddContent(41 + i, date.ToString("ddd"));
            builder.CloseElement();
            builder.OpenElement(50 + i, "div");
            builder.AddAttribute(51 + i, "class", "fs-5");
            builder.AddContent(52 + i, date.Day.ToString());
            builder.CloseElement();
            builder.CloseElement();
        }
        
        builder.CloseElement();
        builder.CloseElement();
        
        // Body
        builder.OpenElement(100, "tbody");
        builder.OpenElement(101, "tr");
        
        for (int i = 0; i < 7; i++)
        {
            var date = weekStart.AddDays(i);
            var dayTours = allTours
                .Where(t => t.ScheduledOn.Date == date.Date)
                .OrderBy(t => t.ScheduledOn)
                .ToList();
            
            builder.OpenElement(110 + i, "td");
            builder.AddAttribute(111 + i, "class", "align-top");
            builder.AddAttribute(112 + i, "style", "min-height: 300px; vertical-align: top;");
            
            if (dayTours.Any())
            {
                builder.OpenElement(120 + i, "div");
                builder.AddAttribute(121 + i, "class", "d-flex flex-column gap-1");
                
                foreach (var tour in dayTours)
                {
                    var index = 130 + (i * 100) + dayTours.IndexOf(tour);
                    builder.OpenElement(index, "div");
                    builder.AddAttribute(index + 1, "class", $"card border-start border-4 {GetBorderColorClass(tour.Status)} mb-1");
                    builder.AddAttribute(index + 2, "onclick", EventCallback.Factory.Create(this, () => ShowTourDetail(tour)));
                    builder.AddAttribute(index + 3, "style", "cursor: pointer;");
                    
                    builder.OpenElement(index + 10, "div");
                    builder.AddAttribute(index + 11, "class", "card-body p-2");
                    
                    builder.OpenElement(index + 20, "small");
                    builder.AddAttribute(index + 21, "class", "fw-bold d-block");
                    builder.AddContent(index + 22, tour.ScheduledOn.ToString("h:mm tt"));
                    builder.CloseElement();
                    
                    builder.OpenElement(index + 30, "small");
                    builder.AddAttribute(index + 31, "class", "d-block text-truncate");
                    builder.AddContent(index + 32, tour.ProspectiveTenant?.FullName);
                    builder.CloseElement();
                    
                    builder.OpenElement(index + 40, "small");
                    builder.AddAttribute(index + 41, "class", "d-block text-truncate text-muted");
                    builder.AddContent(index + 42, tour.Property?.Address);
                    builder.CloseElement();
                    
                    builder.CloseElement();
                    builder.CloseElement();
                }
                
                builder.CloseElement();
            }
            
            builder.CloseElement();
        }
        
        builder.CloseElement();
        builder.CloseElement();
        
        builder.CloseElement();
        builder.CloseElement();
        builder.CloseElement();
        builder.CloseElement();
    };

    private RenderFragment RenderMonthView() => builder =>
    {
        var firstDayOfMonth = new DateTime(currentDate.Year, currentDate.Month, 1);
        var lastDayOfMonth = firstDayOfMonth.AddMonths(1).AddDays(-1);
        var firstDayOfWeek = (int)firstDayOfMonth.DayOfWeek;
        var daysInMonth = DateTime.DaysInMonth(currentDate.Year, currentDate.Month);
        
        var startDate = firstDayOfMonth.AddDays(-firstDayOfWeek);
        
        builder.OpenElement(0, "div");
        builder.AddAttribute(1, "class", "card");
        builder.OpenElement(2, "div");
        builder.AddAttribute(3, "class", "card-body p-0");
        
        builder.OpenElement(10, "div");
        builder.AddAttribute(11, "class", "table-responsive");
        builder.OpenElement(12, "table");
        builder.AddAttribute(13, "class", "table table-bordered mb-0");
        
        // Header - Days of week
        builder.OpenElement(20, "thead");
        builder.OpenElement(21, "tr");
        var daysOfWeek = new[] { "Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat" };
        foreach (var day in daysOfWeek)
        {
            builder.OpenElement(30, "th");
            builder.AddAttribute(31, "class", "text-center");
            builder.AddContent(32, day);
            builder.CloseElement();
        }
        builder.CloseElement();
        builder.CloseElement();
        
        // Body - Weeks and days
        builder.OpenElement(100, "tbody");
        
        var currentWeekDate = startDate;
        for (int week = 0; week < 6; week++)
        {
            builder.OpenElement(110 + week, "tr");
            
            for (int day = 0; day < 7; day++)
            {
                var date = currentWeekDate;
                var isCurrentMonth = date.Month == currentDate.Month;
                var isToday = date.Date == DateTime.Today;
                var dayTours = allTours.Where(t => t.ScheduledOn.Date == date.Date).OrderBy(t => t.ScheduledOn).ToList();
                
                var cellIndex = 200 + (week * 10) + day;
                builder.OpenElement(cellIndex, "td");
                builder.AddAttribute(cellIndex + 1, "class", isCurrentMonth ? "align-top" : "align-top bg-light text-muted");
                builder.AddAttribute(cellIndex + 2, "style", "min-height: 100px; width: 14.28%;");
                
                builder.OpenElement(cellIndex + 10, "div");
                builder.AddAttribute(cellIndex + 11, "class", isToday ? "badge bg-primary rounded-circle mb-1" : "fw-bold mb-1");
                builder.AddContent(cellIndex + 12, date.Day.ToString());
                builder.CloseElement();
                
                if (dayTours.Any())
                {
                    builder.OpenElement(cellIndex + 20, "div");
                    builder.AddAttribute(cellIndex + 21, "class", "d-flex flex-column gap-1");
                    
                    foreach (var tour in dayTours.Take(3))
                    {
                        var tourIndex = cellIndex + 30 + dayTours.IndexOf(tour);
                        builder.OpenElement(tourIndex, "div");
                        builder.AddAttribute(tourIndex + 1, "class", $"badge {GetStatusBadgeClass(tour.Status)} text-start text-truncate");
                        builder.AddAttribute(tourIndex + 2, "onclick", EventCallback.Factory.Create(this, () => ShowTourDetail(tour)));
                        builder.AddAttribute(tourIndex + 3, "style", "cursor: pointer; font-size: 0.7rem;");
                        builder.AddContent(tourIndex + 4, $"{tour.ScheduledOn.ToString("h:mm tt")} - {tour.ProspectiveTenant?.FullName}");
                        builder.CloseElement();
                    }
                    
                    if (dayTours.Count > 3)
                    {
                        builder.OpenElement(cellIndex + 80, "small");
                        builder.AddAttribute(cellIndex + 81, "class", "text-muted");
                        builder.AddContent(cellIndex + 82, $"+{dayTours.Count - 3} more");
                        builder.CloseElement();
                    }
                    
                    builder.CloseElement();
                }
                
                builder.CloseElement();
                currentWeekDate = currentWeekDate.AddDays(1);
            }
            
            builder.CloseElement();
        }
        
        builder.CloseElement();
        builder.CloseElement();
        builder.CloseElement();
        builder.CloseElement();
        builder.CloseElement();
    };

    private void ShowTourDetail(Tour tour)
    {
        selectedTour = tour;
    }

    private void CloseModal()
    {
        selectedTour = null;
    }

    private async Task MarkCompleted(int tourId)
    {
        try
        {
            var orgId = await UserContext.GetOrganizationIdAsync();
            if (!string.IsNullOrEmpty(orgId))
            {
                var tour = await ApplicationService.GetTourByIdAsync(tourId, orgId);
                if (tour != null)
                {
                    CloseModal();
                    if (tour.ChecklistId.HasValue)
                    {
                        Navigation.NavigateTo($"/PropertyManagement/Checklists/View/{tour.ChecklistId.Value}");
                    }
                    else
                    {
                        ToastService.ShowWarning("No property tour checklist found for this tour");
                    }
                }
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error completing tour: {ex.Message}");
        }
    }

    private async Task CancelTour(int tourId)
    {
        try
        {
            var orgId = await UserContext.GetOrganizationIdAsync();
            var userId = await UserContext.GetUserIdAsync();
            
            if (!string.IsNullOrEmpty(orgId) && !string.IsNullOrEmpty(userId))
            {
                await ApplicationService.CancelTourAsync(tourId, orgId, userId);
                ToastService.ShowSuccess("Tour cancelled successfully");
                CloseModal();
                await LoadTours();
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error cancelling tour: {ex.Message}");
        }
    }

    private void NavigateToProspects()
    {
        Navigation.NavigateTo("/PropertyManagement/ProspectiveTenants");
    }

    private void NavigateToListView()
    {
        Navigation.NavigateTo("/PropertyManagement/Tours");
    }

    private string GetStatusBadgeClass(string status) => status switch
    {
        var s when s == ApplicationConstants.TourStatuses.Scheduled => "bg-info",
        var s when s == ApplicationConstants.TourStatuses.Completed => "bg-success",
        var s when s == ApplicationConstants.TourStatuses.Cancelled => "bg-danger",
        var s when s == ApplicationConstants.TourStatuses.NoShow => "bg-warning text-dark",
        _ => "bg-secondary"
    };

    private string GetBorderColorClass(string status) => status switch
    {
        var s when s == ApplicationConstants.TourStatuses.Scheduled => "border-info",
        var s when s == ApplicationConstants.TourStatuses.Completed => "border-success",
        var s when s == ApplicationConstants.TourStatuses.Cancelled => "border-danger",
        var s when s == ApplicationConstants.TourStatuses.NoShow => "border-warning",
        _ => "border-secondary"
    };

    private string GetChecklistStatusBadgeClass(string status) => status switch
    {
        var s when s == ApplicationConstants.ChecklistStatuses.Draft => "bg-secondary",
        var s when s == ApplicationConstants.ChecklistStatuses.InProgress => "bg-warning text-dark",
        var s when s == ApplicationConstants.ChecklistStatuses.Completed => "bg-success",
        _ => "bg-secondary"
    };

    private string GetInterestBadgeClass(string? level) => level switch
    {
        var l when l == ApplicationConstants.TourInterestLevels.VeryInterested => "bg-success",
        var l when l == ApplicationConstants.TourInterestLevels.Interested => "bg-primary",
        var l when l == ApplicationConstants.TourInterestLevels.Neutral => "bg-secondary",
        var l when l == ApplicationConstants.TourInterestLevels.NotInterested => "bg-danger",
        _ => "bg-secondary"
    };

    private string GetInterestDisplay(string? level) => level switch
    {
        var l when l == ApplicationConstants.TourInterestLevels.VeryInterested => "Very Interested",
        var l when l == ApplicationConstants.TourInterestLevels.Interested => "Interested",
        var l when l == ApplicationConstants.TourInterestLevels.Neutral => "Neutral",
        var l when l == ApplicationConstants.TourInterestLevels.NotInterested => "Not Interested",
        _ => "Unknown"
    };
}
