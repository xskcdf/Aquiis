@page "/propertymanagement/checklists/complete/{ChecklistId:int}"
@page "/propertymanagement/checklists/complete/new"

@using Aquiis.SimpleStart.Components.PropertyManagement.Checklists
@using Aquiis.SimpleStart.Components.PropertyManagement
@using Aquiis.SimpleStart.Components.PropertyManagement.Properties
@using Aquiis.SimpleStart.Components.PropertyManagement.Leases
@using Aquiis.SimpleStart.Components.Administration.Application
@using Aquiis.SimpleStart.Models
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components

@inject ChecklistService ChecklistService
@inject PropertyManagementService PropertyManagementService
@inject UserContextService UserContext
@inject NavigationManager NavigationManager
@attribute [Authorize(Roles = "PropertyManager, Administrator")]
@rendermode InteractiveServer

<PageTitle>Complete Checklist</PageTitle>

@if (checklist == null)
{
    <div class="text-center">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}
else
{
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="bi bi-list-check"></i> Complete Checklist</h1>
        <div class="btn-group">
            <button class="btn btn-outline-secondary" @onclick="Cancel">
                <i class="bi bi-x"></i> Cancel
            </button>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(successMessage))
    {
        <div class="alert alert-success alert-dismissible fade show">
            @successMessage
            <button type="button" class="btn-close" @onclick="() => successMessage = null"></button>
        </div>
    }

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show">
            @errorMessage
            <button type="button" class="btn-close" @onclick="() => errorMessage = null"></button>
        </div>
    }

    <div class="row">
        <div class="col-md-8">
            <EditForm Model="@checklist" OnValidSubmit="@SaveProgress">
                <DataAnnotationsValidator />

                <!-- Property/Lease Selection (if not set) -->
                @if (!checklist.PropertyId.HasValue)
                {
                    <div class="card mb-3 border-warning">
                        <div class="card-header bg-warning text-dark">
                            <h5 class="mb-0"><i class="bi bi-exclamation-triangle"></i> Property and Lease Required</h5>
                        </div>
                        <div class="card-body">
                            <p>This checklist must be assigned to a property before it can be completed.</p>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Property <span class="text-danger">*</span></label>
                                    <select class="form-select" @bind="selectedPropertyId" @bind:after="OnPropertyChanged">
                                        <option value="0">Select a property...</option>
                                        @foreach (var property in properties)
                                        {
                                            <option value="@property.Id">@property.Address</option>
                                        }
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Lease @(requiresLease ? "*" : "(Optional)")</label>
                                    <select class="form-select" @bind="selectedLeaseId" disabled="@(!leases.Any())">
                                        <option value="0">@(leases.Any() ? "Select a lease..." : "No active leases")</option>
                                        @foreach (var lease in leases)
                                        {
                                            <option value="@lease.Id">@lease.Tenant?.FullName - @lease.StartDate.ToString("MM/dd/yyyy")</option>
                                        }
                                    </select>
                                    @if (requiresLease && selectedLeaseId == 0)
                                    {
                                        <small class="text-danger">This checklist type requires a lease selection</small>
                                    }
                                </div>
                            </div>
                            <button type="button" class="btn btn-primary" @onclick="AssignPropertyAndLease" disabled="@(selectedPropertyId == 0 || (requiresLease && selectedLeaseId == 0))">
                                <i class="bi bi-check"></i> Assign and Continue
                            </button>
                        </div>
                    </div>
                }
                else
                {
                    <!-- Property Information -->
                    <div class="card mb-3">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0"><i class="bi bi-building"></i> Property Information</h5>
                        </div>
                        <div class="card-body">
                            @if (checklist.Property != null)
                            {
                                <p class="mb-1"><strong>@checklist.Property.Address</strong></p>
                                <p class="text-muted mb-0">@checklist.Property.City, @checklist.Property.State @checklist.Property.ZipCode</p>
                            }
                            @if (checklist.Lease != null)
                            {
                                <hr />
                                <p class="mb-0"><strong>Lease:</strong> @(checklist.Lease.Tenant?.FirstName ?? "Unknown") @(checklist.Lease.Tenant?.LastName ?? "") (Starts: @checklist.Lease.StartDate.ToString("MM/dd/yyyy"))</p>
                            }
                        </div>
                    </div>
                }

                    <!-- Checklist Details -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-info-circle"></i> Checklist Details</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-2">
                                    <strong>Name:</strong>
                                    <p>@checklist.Name</p>
                                </div>
                                <div class="col-md-6 mb-2">
                                    <strong>Type:</strong>
                                    <p><span class="badge bg-info">@checklist.ChecklistType</span></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Checklist Items Grouped by Section -->
                    @if (checklist.Items != null && checklist.Items.Any())
                {
                    var groupedItems = checklist.Items
                        .OrderBy(i => i.SectionOrder)
                        .ThenBy(i => i.ItemOrder)
                        .GroupBy(i => i.CategorySection ?? "General");
                    
                    @foreach (var group in groupedItems)
                    {
                        <div class="card mb-3">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="bi bi-folder"></i> @group.Key</h5>
                                <button type="button" class="btn btn-sm btn-outline-primary" 
                                        @onclick="@(() => CheckAllInSection(group.Key))">
                                    <i class="bi bi-check-all"></i> Check All
                                </button>
                            </div>
                            <div class="card-body">
                                @foreach (var item in group)
                                {
                                    <div class="border-bottom pb-3 mb-3">
                                        <div class="row align-items-start">
                                            <div class="col-md-5">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" 
                                                           checked="@item.IsChecked" 
                                                           @onchange="@((e) => ToggleItemChecked(item, (bool)e.Value!))"
                                                           id="item_@item.Id" />
                                                    <label class="form-check-label" for="item_@item.Id">
                                                        <strong>@item.ItemText</strong>
                                                    </label>
                                                </div>
                                                @if (item.RequiresValue || RequiresValueByKeyword(item.ItemText))
                                                {
                                                    <div class="mt-2">
                                                        @if (IsInterestLevelItem(item.ItemText))
                                                        {
                                                            <div class="btn-group d-flex" role="group">
                                                                @foreach (var level in ApplicationConstants.TourInterestLevels.AllTourInterestLevels)
                                                                {
                                                                    <input type="radio" 
                                                                           class="btn-check" 
                                                                           name="interest_@item.Id" 
                                                                           id="interest_@(item.Id)_@level" 
                                                                           value="@level"
                                                                           checked="@(item.Value == level)"
                                                                           @onchange="@(() => { item.Value = level; OnItemChanged(item); })" />
                                                                    <label class="btn btn-outline-primary btn-sm" for="interest_@(item.Id)_@level">
                                                                        @GetInterestLevelDisplay(level)
                                                                    </label>
                                                                }
                                                            </div>
                                                        }
                                                        else
                                                        {
                                                            <input type="text" class="form-control form-control-sm" 
                                                                   @bind="item.Value" 
                                                                   @bind:after="@(() => OnItemChanged(item))"
                                                                   placeholder="@GetValuePlaceholder(item.ItemText)"
                                                                   required />
                                                        }
                                                    </div>
                                                }
                                            </div>
                                            @* <div class="col-md-7">
                                                <label class="form-label small mb-1">Notes @(item.RequiresValue ? "(optional)" : "")</label>
                                                <textarea class="form-control form-control-sm" 
                                                          rows="2" 
                                                          @bind="item.Notes" 
                                                          @bind:after="@(() => OnItemChanged(item))"
                                                          placeholder="@(item.RequiresValue ? "Additional details..." : "Optional notes...")"></textarea>
                                            </div> *@
                                        </div>
                                        @if (!string.IsNullOrEmpty(item.PhotoUrl))
                                        {
                                            <div class="mt-2">
                                                <img src="@item.PhotoUrl" alt="Item photo" class="img-thumbnail" style="max-width: 200px;" />
                                            </div>
                                        }
                                    </div>
                                }
                            </div>
                        </div>
                    }
                    }

                    <!-- General Notes -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-sticky"></i> General Notes</h5>
                        </div>
                        <div class="card-body">
                            <label class="form-label">Overall Comments</label>
                            <textarea class="form-control" 
                                      rows="4" 
                                      @bind="checklist.GeneralNotes" 
                                      @bind:after="@(() => StateHasChanged())"
                                      placeholder="Add any general observations, summary notes, or overall comments about the checklist..."></textarea>
                            <small class="text-muted">
                                <i class="bi bi-info-circle"></i> Use this section for overall comments. Individual item notes can be added above.
                            </small>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <button type="submit" class="btn btn-primary" disabled="@isSaving">
                                    @if (isSaving)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2"></span>
                                    }
                                    <i class="bi bi-save"></i> Save Progress
                                </button>
                                <button type="button" class="btn btn-success" @onclick="MarkAsComplete" disabled="@isSaving">
                                    @if (isSaving)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2"></span>
                                    }
                                    <i class="bi bi-check-circle"></i> Mark as Complete
                                </button>
                            </div>
                        </div>
                    </div>
                }
            </EditForm>
        </div>

        <!-- Sidebar -->
        <div class="col-md-4">
            <div class="card sticky-top" style="top: 1rem;">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-graph-up"></i> Progress</h5>
                </div>
                <div class="card-body">
                    @if (checklist.Items != null && checklist.Items.Any())
                    {
                        var totalItems = checklist.Items.Count;
                        var checkedItems = checklist.Items.Count(i => i.IsChecked);
                        var itemsWithValues = checklist.Items.Count(i => !string.IsNullOrEmpty(i.Value));
                        var itemsWithNotes = checklist.Items.Count(i => !string.IsNullOrEmpty(i.Notes));
                        var progressPercent = totalItems > 0 ? (int)((checkedItems * 100.0) / totalItems) : 0;

                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span>Checked Items</span>
                                <span><strong>@checkedItems / @totalItems</strong></span>
                            </div>
                            <div class="progress">
                                <div class="progress-bar" role="progressbar" style="width: @progressPercent%" 
                                     aria-valuenow="@progressPercent" aria-valuemin="0" aria-valuemax="100">
                                    @progressPercent%
                                </div>
                            </div>
                        </div>

                        <hr />

                        <div class="mb-2">
                            <i class="bi bi-check-circle text-success"></i> Checked: <strong>@checkedItems</strong>
                        </div>
                        <div class="mb-2">
                            <i class="bi bi-circle text-muted"></i> Unchecked: <strong>@(totalItems - checkedItems)</strong>
                        </div>
                        <div class="mb-2">
                            <i class="bi bi-input-cursor-text text-primary"></i> With Values: <strong>@itemsWithValues</strong>
                        </div>
                        <div class="mb-2">
                            <i class="bi bi-sticky text-info"></i> With Notes: <strong>@itemsWithNotes</strong>
                        </div>

                        <hr />

                        <div class="alert alert-info mb-0">
                            <small>
                                <i class="bi bi-info-circle"></i>
                                Check items as you complete them. Add values (readings, amounts) and notes as needed.
                            </small>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public int ChecklistId { get; set; }

    [SupplyParameterFromQuery(Name = "templateId")]
    public int? TemplateId { get; set; }

    private Checklist? checklist;
    private ChecklistTemplate? template;
    private bool isNewChecklist = false;
    private List<Property> properties = new();
    private List<Lease> leases = new();
    private List<ChecklistItem> checklistItems = new();
    private int selectedPropertyId = 0;
    private int selectedLeaseId = 0;
    private bool requiresLease = false;
    private string? successMessage;
    private string? errorMessage;
    private bool isSaving = false;
    private Dictionary<int, ChecklistItem> modifiedItems = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadProperties();
        
        if (TemplateId.HasValue && TemplateId.Value > 0)
        {
            // New checklist from template
            await LoadTemplateForNewChecklist();
        }
        else if (ChecklistId > 0)
        {
            // Existing checklist
            await LoadChecklist();
        }
    }

    private async Task LoadTemplateForNewChecklist()
    {
        try
        {
            template = await ChecklistService.GetChecklistTemplateByIdAsync(TemplateId!.Value);
            
            if (template == null)
            {
                errorMessage = "Template not found.";
                return;
            }

            isNewChecklist = true;
            var organizationId = await UserContext.GetOrganizationIdAsync();
            var userId = await UserContext.GetUserIdAsync();

            // Create a temporary checklist object (not saved to DB yet)
            checklist = new Checklist
            {
                Name = template.Name,
                ChecklistType = template.Category,
                ChecklistTemplateId = template.Id,
                Status = ApplicationConstants.ChecklistStatuses.Draft,
                OrganizationId = organizationId!,
                CreatedBy = userId!,
                CreatedOn = DateTime.UtcNow
            };

            // Copy template items to working list
            checklistItems = template.Items.Select(ti => new ChecklistItem
            {
                ItemText = ti.ItemText,
                ItemOrder = ti.ItemOrder,
                CategorySection = ti.CategorySection,
                SectionOrder = ti.SectionOrder,
                RequiresValue = ti.RequiresValue,
                IsChecked = false,
                OrganizationId = organizationId!
            }).ToList();

            // Set Items collection for display
            checklist.Items = checklistItems;

            requiresLease = checklist.ChecklistType == ApplicationConstants.ChecklistTypes.MoveIn ||
                           checklist.ChecklistType == ApplicationConstants.ChecklistTypes.MoveOut;
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading template: {ex.Message}";
        }
    }

    private async Task LoadProperties()
    {
        try
        {
            properties = await PropertyManagementService.GetPropertiesAsync();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading properties: {ex.Message}";
        }
    }

    private async Task LoadChecklist()
    {
        try
        {
            checklist = await ChecklistService.GetChecklistByIdAsync(ChecklistId);
            
            if (checklist == null)
            {
                errorMessage = "Checklist not found.";
                return;
            }

            // Check if this type requires a lease
            requiresLease = checklist.ChecklistType == ApplicationConstants.ChecklistTypes.MoveIn ||
                           checklist.ChecklistType == ApplicationConstants.ChecklistTypes.MoveOut;

            // If checklist is already completed, redirect to view page
            if (checklist.Status == ApplicationConstants.ChecklistStatuses.Completed)
            {
                NavigationManager.NavigateTo($"/propertymanagement/checklists/view/{ChecklistId}");
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading checklist: {ex.Message}";
        }
    }

    private async Task OnPropertyChanged()
    {
        if (selectedPropertyId > 0)
        {
            leases = await PropertyManagementService.GetActiveLeasesByPropertyIdAsync(selectedPropertyId);
        }
        else
        {
            leases.Clear();
            selectedLeaseId = 0;
        }
    }

    private async Task AssignPropertyAndLease()
    {
        if (checklist == null) return;

        try
        {
            isSaving = true;
            errorMessage = null;

            checklist.PropertyId = selectedPropertyId;
            checklist.LeaseId = selectedLeaseId > 0 ? selectedLeaseId : null;

            await ChecklistService.UpdateChecklistAsync(checklist);
            await LoadChecklist(); // Reload to get navigation properties
            
            successMessage = "Property and lease assigned successfully.";
        }
        catch (Exception ex)
        {
            errorMessage = $"Error assigning property: {ex.Message}";
        }
        finally
        {
            isSaving = false;
        }
    }

    private void ToggleItemChecked(ChecklistItem item, bool isChecked)
    {
        item.IsChecked = isChecked;
        OnItemChanged(item);
    }

    private void OnItemChanged(ChecklistItem item)
    {
        if (!modifiedItems.ContainsKey(item.Id))
        {
            modifiedItems[item.Id] = item;
        }
    }

    private void CheckAllInSection(string? sectionName)
    {
        if (checklist?.Items == null) return;

        var itemsInSection = checklist.Items
            .Where(i => (i.CategorySection ?? "General") == (sectionName ?? "General"))
            .ToList();

        foreach (var item in itemsInSection)
        {
            item.IsChecked = true;
            OnItemChanged(item);
        }

        StateHasChanged();
    }

    private bool RequiresValueByKeyword(string itemText)
    {
        var lowerText = itemText.ToLower();
        return lowerText.Contains("meter reading") ||
               lowerText.Contains("reading recorded") ||
               lowerText.Contains("deposit") ||
               lowerText.Contains("amount") ||
               lowerText.Contains("forwarding address") ||
               lowerText.Contains("address obtained");
    }

    private bool IsInterestLevelItem(string itemText)
    {
        var lowerText = itemText.ToLower();
        return lowerText.Contains("interest level");
    }

    private string GetInterestLevelDisplay(string level)
    {
        return level switch
        {
            var l when l == ApplicationConstants.TourInterestLevels.VeryInterested => "Very Interested",
            var l when l == ApplicationConstants.TourInterestLevels.NotInterested => "Not Interested",
            _ => level
        };
    }

    private string GetValuePlaceholder(string itemText)
    {
        var lowerText = itemText.ToLower();
        if (lowerText.Contains("electric") || lowerText.Contains("electricity"))
            return "e.g., 12345 kWh";
        if (lowerText.Contains("gas"))
            return "e.g., 5678 CCF";
        if (lowerText.Contains("water"))
            return "e.g., 9012 gal";
        if (lowerText.Contains("deposit"))
            return "e.g., $1500";
        if (lowerText.Contains("address"))
            return "e.g., 123 Main St, City, ST 12345";
        return "Enter value";
    }

    private async Task SaveProgress()
    {
        if (checklist == null) return;

        isSaving = true;
        errorMessage = null;
        successMessage = null;

        try
        {
            // If this is a new checklist, create it first
            if (isNewChecklist)
            {
                // Create the checklist
                var savedChecklist = await ChecklistService.AddChecklistAsync(checklist);
                
                // Add the items
                foreach (var item in checklistItems)
                {
                    item.ChecklistId = savedChecklist.Id;
                    await ChecklistService.AddChecklistItemAsync(item);
                }

                // Update local reference and flag
                ChecklistId = savedChecklist.Id;
                isNewChecklist = false;
                
                // Reload to get full entity with navigation properties
                await LoadChecklist();
                
                successMessage = "Checklist created and saved successfully.";
            }
            else
            {
                // Update checklist status if it's still draft
                if (checklist.Status == ApplicationConstants.ChecklistStatuses.Draft)
                {
                    checklist.Status = ApplicationConstants.ChecklistStatuses.InProgress;
                    await ChecklistService.UpdateChecklistAsync(checklist);
                }

                // Save all modified items
                foreach (var item in modifiedItems.Values)
                {
                    await ChecklistService.UpdateChecklistItemAsync(item);
                }

                modifiedItems.Clear();
                successMessage = "Progress saved successfully.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error saving progress: {ex.Message}";
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task MarkAsComplete()
    {
        if (checklist == null) return;

        isSaving = true;
        errorMessage = null;
        successMessage = null;

        try
        {
            // If this is a new checklist, create it first
            if (isNewChecklist)
            {
                // Create the checklist
                var savedChecklist = await ChecklistService.AddChecklistAsync(checklist);
                
                // Add the items
                foreach (var item in checklistItems)
                {
                    item.ChecklistId = savedChecklist.Id;
                    await ChecklistService.AddChecklistItemAsync(item);
                }

                ChecklistId = savedChecklist.Id;
                isNewChecklist = false;
            }
            else
            {
                // Save any pending changes first
                foreach (var item in modifiedItems.Values)
                {
                    await ChecklistService.UpdateChecklistItemAsync(item);
                }
                modifiedItems.Clear();
            }

            // Complete the checklist
            await ChecklistService.CompleteChecklistAsync(ChecklistId);

            successMessage = "Checklist completed successfully.";
            
            // Redirect to view page after a short delay
            await Task.Delay(1500);
            NavigationManager.NavigateTo($"/propertymanagement/checklists/view/{ChecklistId}");
        }
        catch (Exception ex)
        {
            errorMessage = $"Error completing checklist: {ex.Message}";
            isSaving = false;
        }
    }

    private void Cancel()
    {
        NavigationManager.NavigateTo("/propertymanagement/checklists");
    }
}
