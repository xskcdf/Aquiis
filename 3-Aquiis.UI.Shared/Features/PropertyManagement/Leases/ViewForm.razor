@using Aquiis.Core.Entities
@using Aquiis.Core.Validation
@using Aquiis.Application.Services
@using Aquiis.Application.Services.Workflows
@using Aquiis.Application.Services.PdfGenerators
@using Aquiis.UI.Shared.Components.Entities.Leases
@using Microsoft.AspNetCore.Components.Authorization
@using System.ComponentModel.DataAnnotations
@inject NavigationManager Navigation
@inject LeaseService LeaseService
@inject InvoiceService InvoiceService
@inject DocumentService DocumentService
@inject LeaseWorkflowService LeaseWorkflowService
@inject LeaseRenewalPdfGenerator RenewalPdfGenerator
@inject OrganizationService OrganizationService
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer

@if (lease == null)
{
    <div class="text-center">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}
else if (!isAuthorized)
{
    <div class="alert alert-danger">
        <h4>Access Denied</h4>
        <p>You don't have permission to view this lease.</p>
        <a href="/propertymanagement/leases" class="btn btn-primary">Back to Leases</a>
    </div>
}
else
{
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Lease Details</h1>
        <div class="btn-group">
            <button class="btn btn-primary" @onclick="EditLease">
                <i class="bi bi-pencil"></i> Edit
            </button>
            <button class="btn btn-secondary" @onclick="BackToProperty">
                <i class="bi bi-arrow-left"></i> Back to Property
            </button>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Lease Information</h5>
                    <span class="badge @GetStatusBadgeClass(lease.Status)">
                        @lease.Status
                    </span>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <strong>Property:</strong>
                            <p>@lease.Property?.Address</p>
                            <small class="text-muted">@lease.Property?.City, @lease.Property?.State</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>Tenant:</strong>
                            @if (lease.Tenant != null)
                            {
                                <p>@lease.Tenant.FullName</p>
                                <small class="text-muted">@lease.Tenant.Email</small>
                            }
                            else
                            {
                                <p class="text-warning"><i class="bi bi-hourglass-split"></i> Lease Offer - Awaiting Acceptance</p>
                                <small class="text-muted">Tenant will be assigned upon acceptance</small>
                            }
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <strong>Start Date:</strong>
                            <p>@lease.StartDate.ToString("MMMM dd, yyyy")</p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>End Date:</strong>
                            <p>@lease.EndDate.ToString("MMMM dd, yyyy")</p>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <strong>Monthly Rent:</strong>
                            <p class="text-success fw-bold">@lease.MonthlyRent.ToString("C")</p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>Security Deposit:</strong>
                            <p>@lease.SecurityDeposit.ToString("C")</p>
                        </div>
                    </div>

                    @if (!string.IsNullOrEmpty(lease.Terms))
                    {
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <strong>Lease Terms:</strong>
                                <p>@lease.Terms</p>
                            </div>
                        </div>
                    }

                    @if (!string.IsNullOrEmpty(lease.Notes))
                    {
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <strong>Notes:</strong>
                                <p>@lease.Notes</p>
                            </div>
                        </div>
                    }

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <strong>Created:</strong>
                            <p>@lease.CreatedOn.ToString("MMMM dd, yyyy")</p>
                        </div>
                        @if (lease.LastModifiedOn.HasValue)
                        {
                            <div class="col-md-6 mb-3">
                                <strong>Last Modified:</strong>
                                <p>@lease.LastModifiedOn.Value.ToString("MMMM dd, yyyy")</p>
                            </div>
                        }
                    </div>

                    @if (lease.IsActive)
                    {
                        <div class="row">
                            <div class="col-md-12">
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle"></i>
                                    <strong>Active Lease:</strong> This lease is currently active with @lease.DaysRemaining days remaining.
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>

        <div class="col-md-4">
            @if (lease.IsExpiringSoon)
            {
                <div class="card border-warning mb-3">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">
                            <i class="bi bi-exclamation-triangle-fill"></i> Renewal Alert
                        </h5>
                    </div>
                    <div class="card-body">
                        <p class="mb-2">
                            <strong>Expires in:</strong> 
                            <span class="text-danger fw-bold">@lease.DaysRemaining days</span>
                        </p>
                        <p class="mb-2">
                            <strong>End Date:</strong> @lease.EndDate.ToString("MMM dd, yyyy")
                        </p>
                        
                        @if (!string.IsNullOrEmpty(lease.RenewalStatus))
                        {
                            <p class="mb-2">
                                <strong>Status:</strong> 
                                <span class="badge bg-@GetRenewalStatusBadgeClass(lease.RenewalStatus)">
                                    @lease.RenewalStatus
                                </span>
                            </p>
                        }

                        @if (lease.ProposedRenewalRent.HasValue)
                        {
                            <p class="mb-2">
                                <strong>Proposed Rent:</strong> @lease.ProposedRenewalRent.Value.ToString("C")
                                @if (lease.ProposedRenewalRent != lease.MonthlyRent)
                                {
                                    var increase = lease.ProposedRenewalRent.Value - lease.MonthlyRent;
                                    var percentage = (increase / lease.MonthlyRent) * 100;
                                    <small class="text-muted">
                                        (@(increase > 0 ? "+" : "")@increase.ToString("C"), @percentage.ToString("F1")%)
                                    </small>
                                }
                            </p>
                        }

                        @if (lease.RenewalNotificationSentOn.HasValue)
                        {
                            <small class="text-muted d-block mb-2">
                                Notification sent: @lease.RenewalNotificationSentOn.Value.ToString("MMM dd, yyyy")
                            </small>
                        }

                        @if (!string.IsNullOrEmpty(lease.RenewalNotes))
                        {
                            <hr/>
                            <small>
                                <strong>Notes:</strong><br/>
                                @lease.RenewalNotes
                            </small>
                        }

                        <div class="d-grid gap-2 mt-3">
                            @if (lease.RenewalStatus == "Pending" || string.IsNullOrEmpty(lease.RenewalStatus))
                            {
                                <button class="btn btn-success btn-sm" @onclick="() => ShowRenewalOfferModal()">
                                    <i class="bi bi-envelope-check"></i> Send Renewal Offer
                                </button>
                                <button class="btn btn-outline-primary btn-sm" @onclick="GenerateRenewalOfferPdf" disabled="@isGeneratingPdf">
                                    @if (isGeneratingPdf)
                                    {
                                        <span class="spinner-border spinner-border-sm me-1"></span>
                                    }
                                    else
                                    {
                                        <i class="bi bi-file-pdf"></i>
                                    }
                                    Generate Offer Letter
                                </button>
                            }
                            @if (lease.RenewalStatus == "Offered")
                            {
                                <button class="btn btn-outline-success btn-sm" @onclick="() => MarkRenewalAccepted()">
                                    <i class="bi bi-check-circle"></i> Mark as Accepted
                                </button>
                                <button class="btn btn-outline-danger btn-sm" @onclick="() => MarkRenewalDeclined()">
                                    <i class="bi bi-x-circle"></i> Mark as Declined
                                </button>
                                <button class="btn btn-outline-primary btn-sm" @onclick="GenerateRenewalOfferPdf" disabled="@isGeneratingPdf">
                                    @if (isGeneratingPdf)
                                    {
                                        <span class="spinner-border spinner-border-sm me-1"></span>
                                    }
                                    else
                                    {
                                        <i class="bi bi-file-pdf"></i>
                                    }
                                    Generate Offer Letter
                                </button>
                            }
                        </div>
                    </div>
                </div>
            }
            
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary" @onclick="EditLease">
                            <i class="bi bi-pencil"></i> Edit Lease
                        </button>
                        <button class="btn btn-outline-success" @onclick="CreateInvoice">
                            <i class="bi bi-receipt"></i> Create Invoice
                        </button>
                        <button class="btn btn-outline-info" @onclick="ViewInvoices">
                            <i class="bi bi-list-check"></i> View Invoices
                        </button>
                        <button class="btn btn-outline-secondary" @onclick="ViewDocuments">
                            <i class="bi bi-folder"></i> View Documents
                        </button>
                        @if (lease.DocumentId == null)
                        {
                            <button class="btn btn-outline-warning" @onclick="GenerateLeaseDocument" disabled="@isGenerating">
                                @if (isGenerating)
                                {
                                    <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                    <span>Generating...</span>
                                }
                                else
                                {
                                    <i class="bi bi-file-pdf"></i>
                                    <span> Generate PDF</span>
                                }
                            </button>
                        }
                        else
                        {
                            <button class="btn btn-primary" @onclick="ViewDocument">
                                <i class="bi bi-eye"></i> View PDF
                            </button>
                            <button class="btn btn-outline-primary" @onclick="DownloadDocument">
                                <i class="bi bi-download"></i> Download PDF
                            </button>
                        }
                    </div>
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-header">
                    <h5 class="mb-0">Lease Summary</h5>
                </div>
                <div class="card-body">
                    <p><strong>Duration:</strong> @((lease.EndDate - lease.StartDate).Days) days</p>
                    <p><strong>Total Rent:</strong> @((lease.MonthlyRent * 12).ToString("C"))/year</p>
                    @if (lease.IsActive)
                    {
                        <p><strong>Days Remaining:</strong> @lease.DaysRemaining</p>
                    }
                    @if (recentInvoices.Any())
                    {
                        <hr />
                        <small class="text-muted">
                            <strong>Recent Invoices:</strong><br />
                            @foreach (var invoice in recentInvoices.Take(3))
                            {
                                <span class="badge @(invoice.Status == "Paid" ? "bg-success" : "bg-warning") me-1">
                                    @invoice.InvoiceNumber
                                </span>
                            }
                        </small>
                    }
                </div>
            </div>

            @* Lease Lifecycle Management Card *@
            @if (lease.Status == "Active" || lease.Status == "MonthToMonth" || lease.Status == "NoticeGiven")
            {
                <div class="card mt-3 border-warning">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0"><i class="bi bi-exclamation-triangle"></i> Lease Management</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            @if (lease.Status == "Active" || lease.Status == "MonthToMonth")
                            {
                                <button class="btn btn-outline-warning" @onclick="() => showTerminationNoticeModal = true">
                                    <i class="bi bi-calendar-x"></i> Record Termination Notice
                                </button>
                                <button class="btn btn-outline-danger" @onclick="() => showEarlyTerminationModal = true">
                                    <i class="bi bi-x-octagon"></i> Early Termination
                                </button>
                                <button class="btn btn-outline-secondary" @onclick="() => showConvertMTMModal = true">
                                    <i class="bi bi-arrow-repeat"></i> Convert to Month-to-Month
                                </button>
                            }
                            @if (lease.Status == "NoticeGiven")
                            {
                                <div class="alert alert-info mb-2">
                                    <small>
                                        <strong>Notice Given:</strong> @lease.TerminationNoticedOn?.ToString("MMM dd, yyyy")<br/>
                                        <strong>Expected Move-Out:</strong> @lease.ExpectedMoveOutDate?.ToString("MMM dd, yyyy")
                                    </small>
                                </div>
                                <button class="btn btn-primary" @onclick="() => showMoveOutModal = true">
                                    <i class="bi bi-box-seam"></i> Complete Move-Out
                                </button>
                                <button class="btn btn-outline-danger" @onclick="() => showEarlyTerminationModal = true">
                                    <i class="bi bi-x-octagon"></i> Early Termination
                                </button>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
    <div class="row">
        <div class="col-md-8 mt-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Notes</h5>
                </div>
                <div class="card-body">
                    @* NotesTimeline removed - product-specific component *@
                    <p class="text-muted">Notes feature is product-specific and will be rendered by the product wrapper.</p>
                </div>
            </div>
        </div>
    </div>
    @* Renewal Offer Modal *@
    @if (showRenewalModal && lease != null)
    {
        <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Send Renewal Offer</h5>
                        <button type="button" class="btn-close" @onclick="() => showRenewalModal = false"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Current Rent</label>
                            <input type="text" class="form-control" value="@lease.MonthlyRent.ToString("C")" disabled />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Proposed Renewal Rent</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" @bind="proposedRent" step="0.01" />
                            </div>
                            @if (proposedRent != lease.MonthlyRent)
                            {
                                var increase = proposedRent - lease.MonthlyRent;
                                var percentage = (increase / lease.MonthlyRent) * 100;
                                <small class="text-muted">
                                    Change: @(increase > 0 ? "+" : "")@increase.ToString("C") (@percentage.ToString("F1")%)
                                </small>
                            }
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Notes (Optional)</label>
                            <textarea class="form-control" rows="3" @bind="renewalNotes" 
                                      placeholder="Add any notes about the renewal offer..."></textarea>
                        </div>
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i>
                            <small>
                                This will mark the lease as "Offered" and record the proposed rent. 
                                An email notification will be sent to the tenant (when email service is configured).
                            </small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="() => showRenewalModal = false">
                            Cancel
                        </button>
                        <button type="button" class="btn btn-primary" @onclick="SendRenewalOffer">
                            Send Offer
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }

    @* Termination Notice Modal *@
    @if (showTerminationNoticeModal && lease != null)
    {
        <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-warning text-dark">
                        <h5 class="modal-title"><i class="bi bi-calendar-x"></i> Record Termination Notice</h5>
                        <button type="button" class="btn-close" @onclick="() => showTerminationNoticeModal = false"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Notice Type <span class="text-danger">*</span></label>
                            <select class="form-select" @bind="terminationNoticeType">
                                <option value="">Select type...</option>
                                <option value="Tenant">Tenant Notice (Tenant initiated)</option>
                                <option value="Landlord">Landlord Notice (Property manager initiated)</option>
                                <option value="Mutual">Mutual Agreement</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Notice Date <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" @bind="terminationNoticeDate" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Expected Move-Out Date <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" @bind="terminationExpectedMoveOutDate" />
                            <small class="text-muted">Must be in the future</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Reason <span class="text-danger">*</span></label>
                            <textarea class="form-control" rows="3" @bind="terminationReason"
                                      placeholder="Provide the reason for termination..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="() => showTerminationNoticeModal = false">
                            Cancel
                        </button>
                        <button type="button" class="btn btn-warning" @onclick="RecordTerminationNotice" 
                                disabled="@(string.IsNullOrWhiteSpace(terminationNoticeType) || string.IsNullOrWhiteSpace(terminationReason) || isSubmitting)">
                            @if (isSubmitting)
                            {
                                <span class="spinner-border spinner-border-sm me-1"></span>
                            }
                            Record Notice
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }

    @* Early Termination Modal *@
    @if (showEarlyTerminationModal && lease != null)
    {
        <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title"><i class="bi bi-x-octagon"></i> Early Termination</h5>
                        <button type="button" class="btn-close btn-close-white" @onclick="() => showEarlyTerminationModal = false"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-danger">
                            <strong>Warning:</strong> This action will immediately terminate the lease and cannot be undone.
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Termination Type <span class="text-danger">*</span></label>
                            <select class="form-select" @bind="earlyTerminationType">
                                <option value="">Select type...</option>
                                <option value="Eviction">Eviction</option>
                                <option value="Breach">Lease Breach</option>
                                <option value="Mutual">Mutual Agreement</option>
                                <option value="Emergency">Emergency</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Effective Date <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" @bind="earlyTerminationDate" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Reason <span class="text-danger">*</span></label>
                            <textarea class="form-control" rows="3" @bind="earlyTerminationReason"
                                      placeholder="Provide detailed reason for early termination..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="() => showEarlyTerminationModal = false">
                            Cancel
                        </button>
                        <button type="button" class="btn btn-danger" @onclick="EarlyTerminateLease"
                                disabled="@(string.IsNullOrWhiteSpace(earlyTerminationType) || string.IsNullOrWhiteSpace(earlyTerminationReason) || isSubmitting)">
                            @if (isSubmitting)
                            {
                                <span class="spinner-border spinner-border-sm me-1"></span>
                            }
                            Terminate Lease
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }

    @* Move-Out Completion Modal *@
    @if (showMoveOutModal && lease != null)
    {
        <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title"><i class="bi bi-box-seam"></i> Complete Move-Out</h5>
                        <button type="button" class="btn-close btn-close-white" @onclick="() => showMoveOutModal = false"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Actual Move-Out Date <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" @bind="actualMoveOutDate" />
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" @bind="moveOutFinalInspection" id="finalInspection" />
                                <label class="form-check-label" for="finalInspection">
                                    Final inspection completed
                                </label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" @bind="moveOutKeysReturned" id="keysReturned" />
                                <label class="form-check-label" for="keysReturned">
                                    Keys returned
                                </label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Notes (Optional)</label>
                            <textarea class="form-control" rows="3" @bind="moveOutNotes"
                                      placeholder="Any notes about the move-out condition..."></textarea>
                        </div>
                        <div class="alert alert-info">
                            <small>
                                <i class="bi bi-info-circle"></i> This will:
                                <ul class="mb-0 mt-1">
                                    <li>Mark the lease as Terminated</li>
                                    <li>Update property status to Available</li>
                                    <li>Update tenant active status</li>
                                </ul>
                            </small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="() => showMoveOutModal = false">
                            Cancel
                        </button>
                        <button type="button" class="btn btn-primary" @onclick="CompleteMoveOut" disabled="@isSubmitting">
                            @if (isSubmitting)
                            {
                                <span class="spinner-border spinner-border-sm me-1"></span>
                            }
                            Complete Move-Out
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }

    @* Convert to Month-to-Month Modal *@
    @if (showConvertMTMModal && lease != null)
    {
        <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="bi bi-arrow-repeat"></i> Convert to Month-to-Month</h5>
                        <button type="button" class="btn-close" @onclick="() => showConvertMTMModal = false"></button>
                    </div>
                    <div class="modal-body">
                        <p>This will convert the lease to a month-to-month arrangement.</p>
                        <div class="mb-3">
                            <label class="form-label">Current Monthly Rent</label>
                            <input type="text" class="form-control" value="@lease.MonthlyRent.ToString("C")" disabled />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">New Monthly Rent (Optional)</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" @bind="mtmNewRent" step="0.01" placeholder="Leave empty to keep current rent" />
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="() => showConvertMTMModal = false">
                            Cancel
                        </button>
                        <button type="button" class="btn btn-primary" @onclick="ConvertToMonthToMonth" disabled="@isSubmitting">
                            @if (isSubmitting)
                            {
                                <span class="spinner-border spinner-border-sm me-1"></span>
                            }
                            Convert
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }
}

@code {
    [Parameter] public Guid LeaseId { get; set; }

    [Parameter]
    [SupplyParameterFromQuery]
    public Guid? PropertyId { get; set; }
    [Parameter]
    [SupplyParameterFromQuery]
    public Guid? TenantId { get; set; }

    private Lease? lease;
    private List<Invoice> recentInvoices = new();
    private bool isAuthorized = true;
    private bool isGenerating = false;
    private bool isGeneratingPdf = false;
    private bool isSubmitting = false;
    private bool showRenewalModal = false;
    private decimal proposedRent = 0;
    private string renewalNotes = "";
    private Document? document = null;

    // Termination Notice state
    private bool showTerminationNoticeModal = false;
    private string terminationNoticeType = "";
    private DateTime terminationNoticeDate = DateTime.Today;
    private DateTime terminationExpectedMoveOutDate = DateTime.Today.AddDays(30);
    private string terminationReason = "";

    // Early Termination state
    private bool showEarlyTerminationModal = false;
    private string earlyTerminationType = "";
    private DateTime earlyTerminationDate = DateTime.Today;
    private string earlyTerminationReason = "";

    // Move-Out state
    private bool showMoveOutModal = false;
    private DateTime actualMoveOutDate = DateTime.Today;
    private bool moveOutFinalInspection = false;
    private bool moveOutKeysReturned = false;
    private string moveOutNotes = "";

    // Month-to-Month conversion state
    private bool showConvertMTMModal = false;
    private decimal? mtmNewRent = null;

    [CascadingParameter]
    private Task<AuthenticationState> AuthenticationStateTask { get; set; } = default!;

    private LeaseModel leaseModel = new();
    private Property? selectedProperty;
    private List<Property> availableProperties = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadLease();

         // If PropertyId is provided in query string, pre-select it
        if (PropertyId.HasValue)
        {
            leaseModel.PropertyId = PropertyId.Value;
            await OnPropertyChanged();
        }
        
        // If TenantId is provided in query string, pre-select it
        if (TenantId.HasValue)
        {
            leaseModel.TenantId = TenantId.Value;
        }
    }

    private async Task LoadLease()
    {
        var authState = await AuthenticationStateTask;
        var userId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

        if (string.IsNullOrEmpty(userId))
        {
            isAuthorized = false;
            return;
        }

        lease = await LeaseService.GetByIdAsync(LeaseId);

        if (lease == null)
        {
            isAuthorized = false;
            return;
        }

        var invoices = await InvoiceService.GetInvoicesByLeaseIdAsync(LeaseId);
        recentInvoices = invoices
            .OrderByDescending(i => i.DueOn)
            .Take(5)
            .ToList();

        // Load the document if it exists
        if (lease.DocumentId != null)
        {
            document = await DocumentService.GetByIdAsync(lease.DocumentId.Value);
        }
    }

    private string GetStatusBadgeClass(string status)
    {
        return status switch
        {
            "Active" => "bg-success",
            "Pending" => "bg-warning",
            "Expired" => "bg-secondary",
            "Terminated" => "bg-danger",
            _ => "bg-secondary"
        };
    }

    private string GetRenewalStatusBadgeClass(string status)
    {
        return status switch
        {
            "Pending" => "secondary",
            "Offered" => "info",
            "Accepted" => "success",
            "Declined" => "danger",
            "Expired" => "dark",
            _ => "secondary"
        };
    }

    private void ShowRenewalOfferModal()
    {
        proposedRent = lease?.MonthlyRent ?? 0;
        renewalNotes = "";
        showRenewalModal = true;
    }

    private async Task SendRenewalOffer()
    {
        if (lease == null) return;

        try
        {
            // Update lease with renewal offer details
            lease.RenewalStatus = "Offered";
            lease.ProposedRenewalRent = proposedRent;
            lease.RenewalOfferedOn = DateTime.UtcNow;
            lease.RenewalNotes = renewalNotes;

            await LeaseService.UpdateAsync(lease);
            
            // TODO: Send email notification to tenant
            
            showRenewalModal = false;
            await LoadLease();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            // Error handling: Could be logged or passed to parent component
            throw ex;
        }
    }

    private async Task GenerateRenewalOfferPdf()
    {
        if (lease == null) return;

        try
        {
            isGeneratingPdf = true;
            StateHasChanged();

            // Ensure proposed rent is set
            if (!lease.ProposedRenewalRent.HasValue)
            {
                lease.ProposedRenewalRent = lease.MonthlyRent;
            }

            // Generate renewal offer PDF
            var pdfBytes = RenewalPdfGenerator.GenerateRenewalOfferLetter(lease, lease.Property, lease.Tenant!);
            var fileName = $"Lease_Renewal_Offer_{lease.Property?.Address?.Replace(" ", "_")}_{DateTime.Now:yyyyMMdd_HHmmss}.pdf";

            // Save PDF to Documents table
            var document = new Document
            {
                PropertyId = lease.PropertyId,
                TenantId = lease.TenantId,
                LeaseId = lease.Id,
                FileName = fileName,
                FileType = "application/pdf",
                FileSize = pdfBytes.Length,
                FileData = pdfBytes,
                FileExtension = ".pdf",
                ContentType = "application/pdf",
                DocumentType = "Lease Renewal Offer",
                Description = $"Renewal offer letter for {lease.Property?.Address}. Proposed rent: {lease.ProposedRenewalRent:C}"
            };

            await DocumentService.CreateAsync(document);
            
            // PDF generated successfully
        }
        catch (Exception ex)
        {
            // Error handling: Could be logged or passed to parent component
            throw ex;
        }
        finally
        {
            isGeneratingPdf = false;
            StateHasChanged();
        }
    }

    private async Task MarkRenewalAccepted()
    {
        if (lease == null) return;

        try
        {
            // Create renewal model with proposed terms
            var renewalModel = new LeaseRenewalModel
            {
                NewStartDate = DateTime.Today,
                NewEndDate = DateTime.Today.AddYears(1),
                NewMonthlyRent = lease.ProposedRenewalRent ?? lease.MonthlyRent,
                UpdatedSecurityDeposit = lease.SecurityDeposit,
                NewTerms = lease.Terms
            };

            var result = await LeaseWorkflowService.RenewLeaseAsync(LeaseId, renewalModel);

            if (result.Success && result.Data != null)
            {
                await LoadLease();
                StateHasChanged();

                // Renewal accepted successfully
            }
            else
            {
                // Validation errors: Could be displayed in UI
            }
        }
        catch (Exception ex)
        {
            // Error handling: Could be logged or passed to parent component
            throw ex;
        }
    }

    private async Task MarkRenewalDeclined()
    {
        if (lease == null) return;

        try
        {
            lease.RenewalStatus = "Declined";
            lease.RenewalResponseOn = DateTime.UtcNow;
            await LeaseService.UpdateAsync(lease);
            await LoadLease();
            StateHasChanged();

            // Renewal offer marked as declined
        }
        catch (Exception ex)
        {
            // Error handling: Could be logged or passed to parent component
            throw ex;
        }
    }

    #region Lease Workflow Methods

    private async Task RecordTerminationNotice()
    {
        if (lease == null || string.IsNullOrWhiteSpace(terminationNoticeType) || string.IsNullOrWhiteSpace(terminationReason)) 
            return;

        isSubmitting = true;
        StateHasChanged();

        try
        {
            var result = await LeaseWorkflowService.RecordTerminationNoticeAsync(
                LeaseId,
                terminationNoticeDate,
                terminationExpectedMoveOutDate,
                terminationNoticeType,
                terminationReason);

            if (result.Success)
            {
                showTerminationNoticeModal = false;
                ResetTerminationNoticeForm();
                await LoadLease();
            }
            else
            {
                // Validation errors: Could be displayed in UI
            }
        }
        catch (Exception ex)
        {
            // Error handling: Could be logged or passed to parent component
            throw ex;
        }
        finally
        {
            isSubmitting = false;
            StateHasChanged();
        }
    }

    private async Task EarlyTerminateLease()
    {
        if (lease == null || string.IsNullOrWhiteSpace(earlyTerminationType) || string.IsNullOrWhiteSpace(earlyTerminationReason))
            return;

        isSubmitting = true;
        StateHasChanged();

        try
        {
            var result = await LeaseWorkflowService.EarlyTerminateAsync(
                LeaseId,
                earlyTerminationType,
                earlyTerminationReason,
                earlyTerminationDate);

            if (result.Success)
            {
                showEarlyTerminationModal = false;
                ResetEarlyTerminationForm();
                await LoadLease();
            }
            else
            {
                // Validation errors: Could be displayed in UI
            }
        }
        catch (Exception ex)
        {
            // Error handling: Could be logged or passed to parent component
            throw ex;
        }
        finally
        {
            isSubmitting = false;
            StateHasChanged();
        }
    }

    private async Task CompleteMoveOut()
    {
        if (lease == null) return;

        isSubmitting = true;
        StateHasChanged();

        try
        {
            var moveOutModel = new MoveOutModel
            {
                FinalInspectionCompleted = moveOutFinalInspection,
                KeysReturned = moveOutKeysReturned,
                Notes = moveOutNotes
            };

            var result = await LeaseWorkflowService.CompleteMoveOutAsync(
                LeaseId,
                actualMoveOutDate,
                moveOutModel);

            if (result.Success)
            {
                showMoveOutModal = false;
                ResetMoveOutForm();
                await LoadLease();
            }
            else
            {
                // Validation errors: Could be displayed in UI
            }
        }
        catch (Exception ex)
        {
            // Error handling: Could be logged or passed to parent component
            throw ex;
        }
        finally
        {
            isSubmitting = false;
            StateHasChanged();
        }
    }

    private async Task ConvertToMonthToMonth()
    {
        if (lease == null) return;

        isSubmitting = true;
        StateHasChanged();

        try
        {
            var result = await LeaseWorkflowService.ConvertToMonthToMonthAsync(
                LeaseId,
                mtmNewRent);

            if (result.Success)
            {
                showConvertMTMModal = false;
                mtmNewRent = null;
                await LoadLease();
            }
            else
            {
                // Validation errors: Could be displayed in UI
            }
        }
        catch (Exception ex)
        {
            // Error handling: Could be logged or passed to parent component
            throw ex;
        }
        finally
        {
            isSubmitting = false;
            StateHasChanged();
        }
    }

    private void ResetTerminationNoticeForm()
    {
        terminationNoticeType = "";
        terminationNoticeDate = DateTime.Today;
        terminationExpectedMoveOutDate = DateTime.Today.AddDays(30);
        terminationReason = "";
    }

    private void ResetEarlyTerminationForm()
    {
        earlyTerminationType = "";
        earlyTerminationDate = DateTime.Today;
        earlyTerminationReason = "";
    }

    private void ResetMoveOutForm()
    {
        actualMoveOutDate = DateTime.Today;
        moveOutFinalInspection = false;
        moveOutKeysReturned = false;
        moveOutNotes = "";
    }

    #endregion

    private async Task OnPropertyChanged()
    {
        if (leaseModel.PropertyId != Guid.Empty)
        {
            selectedProperty = availableProperties.FirstOrDefault(p => p.Id == leaseModel.PropertyId);
            if (selectedProperty != null)
            {
                // Get organization settings for security deposit calculation
                var settings = await OrganizationService.GetOrganizationSettingsAsync();
                var depositMultiplier = settings?.AutoCalculateSecurityDeposit == true 
                    ? settings.SecurityDepositMultiplier 
                    : 1.0m;

                leaseModel.MonthlyRent = selectedProperty.MonthlyRent;
                leaseModel.SecurityDeposit = selectedProperty.MonthlyRent * depositMultiplier;
            }
        }
        else
        {
            selectedProperty = null;
        }
        StateHasChanged();
    }

    private void EditLease()
    {
        Navigation.NavigateTo($"/propertymanagement/leases/{LeaseId}/edit");
    }

    private void BackToProperty()
    {
        Navigation.NavigateTo($"/propertymanagement/properties/{lease?.PropertyId}");
    }

    private void CreateInvoice()
    {
        Navigation.NavigateTo($"/propertymanagement/invoices/create?leaseId={LeaseId}");
    }

    private void ViewInvoices()
    {
        Navigation.NavigateTo($"/propertymanagement/invoices?leaseId={LeaseId}");
    }

    private void ViewDocuments()
    {
        Navigation.NavigateTo($"/propertymanagement/leases/{LeaseId}/documents");
    }

    private async Task ViewDocument()
    {
        if (document != null)
        {
            var base64Data = Convert.ToBase64String(document.FileData);
            await JSRuntime.InvokeVoidAsync("viewFile", base64Data, document.FileType);
        }
    }

    private async Task DownloadDocument()
    {
        if (document != null)
        {
            var fileName = document.FileName;
            var fileData = document.FileData;
            var mimeType = document.FileType;

            await JSRuntime.InvokeVoidAsync("downloadFile", fileName, Convert.ToBase64String(fileData), mimeType);
        }
    }

    private async Task GenerateLeaseDocument()
    {
        isGenerating = true;
        StateHasChanged();

        try
        {
            // Generate the PDF
            byte[] pdfBytes = await LeasePdfGenerator.GenerateLeasePdf(lease!);

            // Create the document entity
            var document = new Document
            {
                FileName = $"Lease_{lease!.Property?.Address?.Replace(" ", "_")}_{DateTime.Now:yyyyMMdd}.pdf",
                FileExtension = ".pdf",
                FileData = pdfBytes,
                FileSize = pdfBytes.Length,
                FileType = "application/pdf",
                DocumentType = "Lease Agreement",
                Description = "Auto-generated lease agreement",
                LeaseId = lease.Id,
                PropertyId = lease.PropertyId,
                TenantId = lease.TenantId,
            };

            // Save to database
            await DocumentService.CreateAsync(document);

            // Update lease with DocumentId
            lease.DocumentId = document.Id;
            
            await LeaseService.UpdateAsync(lease);

            // Reload lease and document
            await LoadLease();
            StateHasChanged();

            await JSRuntime.InvokeVoidAsync("alert", "Lease document generated successfully!");
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error generating lease document: {ex.Message}");
        }
        finally
        {
            isGenerating = false;
            StateHasChanged();
        }
    }

    public class LeaseModel
    {
        [RequiredGuid(ErrorMessage = "Property is required")]
        public Guid PropertyId { get; set; }

        [RequiredGuid(ErrorMessage = "Tenant is required")]
        public Guid TenantId { get; set; }

        [Required(ErrorMessage = "Start date is required")]
        public DateTime StartDate { get; set; } = DateTime.Today;

        [Required(ErrorMessage = "End date is required")]
        public DateTime EndDate { get; set; } = DateTime.Today.AddYears(1);

        [Required(ErrorMessage = "Monthly rent is required")]
        [Range(0.01, double.MaxValue, ErrorMessage = "Monthly rent must be greater than 0")]
        public decimal MonthlyRent { get; set; }

        [Range(0, double.MaxValue, ErrorMessage = "Security deposit cannot be negative")]
        public decimal SecurityDeposit { get; set; }

        [Required(ErrorMessage = "Status is required")]
        [StringLength(50)]
        public string Status { get; set; } = "Active";

        [StringLength(1000, ErrorMessage = "Terms cannot exceed 1000 characters")]
        public string Terms { get; set; } = string.Empty;

        [StringLength(500, ErrorMessage = "Notes cannot exceed 500 characters")]
        public string Notes { get; set; } = string.Empty;
    }
}