@using Aquiis.Core.Constants
@inject NotificationService NotificationService
@inject NavigationManager NavigationManager
@namespace Aquiis.UI.Shared.Components.Notifications

<div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1>
                <i class="bi bi-inbox-fill"></i> Notification Center
            </h1>
            <p class="text-muted">
                Here you can manage your notifications.
            </p>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-primary" @onclick="GoToPreferences">
                <i class="bi bi-gear-fill"></i> Preferences
            </button>
            <button class="btn btn-secondary" @onclick="BackToDashboard">
                <i class="bi bi-arrow-left"></i> Back to Dashboard
            </button>
        </div>
</div>

<!-- Search and Filters -->
<div class="card mb-3">
    <div class="card-body">
        <div class="row g-3">
            <!-- Search -->
            <div class="col-md-4">
                <div class="input-group">
                    <span class="input-group-text">
                        <i class="bi bi-search"></i>
                    </span>
                    <input type="text" class="form-control" placeholder="Search notifications..." 
                           @bind="searchText" @bind:event="oninput" @bind:after="ApplyFilters" />
                    @if (!string.IsNullOrEmpty(searchText))
                    {
                        <button class="btn btn-outline-secondary" @onclick="ClearSearch">
                            <i class="bi bi-x-lg"></i>
                        </button>
                    }
                </div>
            </div>
            
            <!-- Category Filter -->
            <div class="col-md-2">
                <select class="form-select" @bind="filterCategory" @bind:after="ApplyFilters">
                    <option value="">All Categories</option>
                    <option value="@NotificationConstants.Categories.Application">Application</option>
                    <option value="@NotificationConstants.Categories.Document">Document</option>
                    <option value="@NotificationConstants.Categories.Inspection">Inspection</option>
                    <option value="@NotificationConstants.Categories.Lease">Lease</option>
                    <option value="@NotificationConstants.Categories.Maintenance">Maintenance</option>
                    <option value="@NotificationConstants.Categories.Message">Message</option>
                    <option value="@NotificationConstants.Categories.Note">Note</option>
                    <option value="@NotificationConstants.Categories.Payment">Payment</option>
                    <option value="@NotificationConstants.Categories.Property">Property</option>
                    <option value="@NotificationConstants.Categories.Report">Report</option>
                    <option value="@NotificationConstants.Categories.Security">Security</option>
                    <option value="@NotificationConstants.Categories.System">System</option>
                </select>
            </div>
            
            <!-- Type Filter -->
            <div class="col-md-2">
                <select class="form-select" @bind="filterType" @bind:after="ApplyFilters">
                    <option value="">All Types</option>
                    <option value="@NotificationConstants.Types.Error">Error</option>
                    <option value="@NotificationConstants.Types.Info">Info</option>
                    <option value="@NotificationConstants.Types.Success">Success</option>
                    <option value="@NotificationConstants.Types.Warning">Warning</option>
                </select>
            </div>
            
            <!-- Status Filter -->
            <div class="col-md-2">
                <select class="form-select" @bind="filterStatus" @bind:after="ApplyFilters">
                    <option value="">All Status</option>
                    <option value="unread">Unread</option>
                    <option value="read">Read</option>
                </select>
            </div>
            
            <!-- Mark All as Read -->
            <div class="col-md-2">
                <button class="btn btn-success w-100" @onclick="MarkAllAsRead" 
                        disabled="@(!notifications.Any(n => !n.IsRead))">
                    <i class="bi bi-check-all"></i> Mark All Read
                </button>
            </div>
        </div>
        
        @if (HasActiveFilters())
        {
            <div class="mt-2">
                <button class="btn btn-sm btn-outline-secondary" @onclick="ClearAllFilters">
                    <i class="bi bi-x-circle"></i> Clear All Filters
                </button>
                <span class="ms-2 text-muted">
                    Showing @filteredNotifications.Count of @notifications.Count notifications
                </span>
            </div>
        }
    </div>
</div>

<div class="notification-list">
    <!-- Table View -->
    <div class="card">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0" style="table-layout: fixed;">
                    <colgroup>
                        <col style="width: 20%;">  <!-- Title -->
                        <col style="width: 15%;">  <!-- Category -->
                        <col style="width: 35%;">  <!-- Message -->
                        <col style="width: 15%;">  <!-- Date -->
                        <col style="width: 15%;">  <!-- Actions -->
                    </colgroup>
                    <thead>
                        <tr>
                            <th @onclick="() => SortTable(nameof(Notification.Title))" style="cursor: pointer;">
                                Title
                                @if (sortColumn == nameof(Notification.Title))
                                {
                                    <i class="bi bi-@(sortAscending ? "arrow-up" : "arrow-down")"></i>
                                }
                            </th>
                            <th @onclick="() => SortTable(nameof(Notification.Category))" style="cursor: pointer;">
                                Category
                                @if (sortColumn == nameof(Notification.Category))
                                {
                                    <i class="bi bi-@(sortAscending ? "arrow-up" : "arrow-down")"></i>
                                }
                            </th>
                            <th @onclick="() => SortTable(nameof(Notification.Message))" style="cursor: pointer;">
                                Message
                                @if (sortColumn == nameof(Notification.Message))
                                {
                                    <i class="bi bi-@(sortAscending ? "arrow-up" : "arrow-down")"></i>
                                }
                            </th>
                            <th class="text-end" @onclick="() => SortTable(nameof(Notification.CreatedOn))" style="cursor: pointer;">
                                Date
                                @if (sortColumn == nameof(Notification.CreatedOn))
                                {
                                    <i class="bi bi-@(sortAscending ? "arrow-up" : "arrow-down")"></i>
                                }
                            </th>
                            <th class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var notification in pagedNotifications)
                        {
                            <tr id="notification-@notification.Id" @key="notification.Id">
                                @if(!notification.IsRead){
                                <td style="cursor: pointer;" @onclick="() => OpenMessageModal(notification.Id)">
                                    <strong>@notification.Title</strong>
                                </td>
                                } else {
                                    <td style="cursor: pointer;" @onclick="() => OpenMessageModal(notification.Id)">
                                        @notification.Title
                                    </td>
                                }
                                <td>@notification.Category</td>
                                <td>@notification.Message</td>
                                <td class="text-end">@notification.CreatedOn.ToString("g")</td>
                                <td class="text-center">
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary" @onclick="() => ViewNotification(notification.Id)" title="View">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                        <button class="@((notification.IsRead) ? "btn btn-outline-secondary" : "btn btn-outline-success")" @onclick="() => ToggleReadStatus(notification.Id)" title="Mark as Read">
                                            <i class="@((notification.IsRead) ? "bi bi-envelope-open" : "bi bi-envelope")"></i>
                                        </button>
                                        <button class="btn btn-outline-danger" @onclick="() => DeleteNotification(notification.Id)" title="Delete">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
        @if (totalPages > 1)
            {
                <div class="card-footer">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <span class="text-muted">Showing @((currentPage - 1) * pageSize + 1) to @Math.Min(currentPage * pageSize, totalRecords) of @totalRecords properties</span>
                        </div>
                        <nav>
                            <ul class="pagination mb-0">
                                <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                                    <button class="page-link" @onclick="FirstPage" disabled="@(currentPage == 1)">
                                        <i class="bi bi-chevron-double-left"></i>
                                    </button>
                                </li>
                                <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                                    <button class="page-link" @onclick="PreviousPage" disabled="@(currentPage == 1)">
                                        <i class="bi bi-chevron-left"></i>
                                    </button>
                                </li>
                                @for (int i = Math.Max(1, currentPage - 2); i <= Math.Min(totalPages, currentPage + 2); i++)
                                {
                                    var pageNumber = i;
                                    <li class="page-item @(currentPage == pageNumber ? "active" : "")">
                                        <button class="page-link" @onclick="() => GoToPage(pageNumber)">@pageNumber</button>
                                    </li>
                                }
                                <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                                    <button class="page-link" @onclick="NextPage" disabled="@(currentPage == totalPages)">
                                        <i class="bi bi-chevron-right"></i>
                                    </button>
                                </li>
                                <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                                    <button class="page-link" @onclick="LastPage" disabled="@(currentPage == totalPages)">
                                        <i class="bi bi-chevron-double-right"></i>
                                    </button>
                                </li>
                            </ul>
                        </nav>
                        <div>
                            <select class="form-select form-select-sm" style="width: auto;" @bind="pageSize" @bind:after="UpdatePagination">
                                <option value="10">10 per page</option>
                                <option value="25">25 per page</option>
                                <option value="50">50 per page</option>
                                <option value="100">100 per page</option>
                            </select>
                        </div>
                    </div>
                </div>
            }
    </div>
</div>

@* Message Detail Modal *@
@if (showMessageModal && selectedNotification != null)
{
    <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-envelope-open"></i> @selectedNotification.Title
                    </h5>
                    <button type="button" class="btn-close" @onclick="CloseMessageModal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <span class="badge bg-@GetCategoryBadgeColor(selectedNotification.Category)">
                                    @selectedNotification.Category
                                </span>
                                <span class="badge bg-@GetTypeBadgeColor(selectedNotification.Type) ms-1">
                                    @selectedNotification.Type
                                </span>
                            </div>
                            <small class="text-muted">
                                <i class="bi bi-clock"></i> @selectedNotification.CreatedOn.ToString("g")
                            </small>
                        </div>
                    </div>

                    <div class="alert alert-light">
                        <p class="mb-0">@selectedNotification.Message</p>
                    </div>

                    @if (selectedNotification.RelatedEntityId.HasValue)
                    {
                        <div class="mb-3">
                            <small class="text-muted">
                                <i class="bi bi-link-45deg"></i>
                                Related: @selectedNotification.RelatedEntityType
                            </small>
                        </div>
                    }

                    <div class="mb-3">
                        <h6>Delivery Status</h6>
                        <div class="row g-2">
                            <div class="col-md-4">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-app-indicator @(selectedNotification.SendInApp ? "text-success" : "text-muted") me-2"></i>
                                    <span>In-App</span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-envelope @(selectedNotification.EmailSent ? "text-success" : "text-muted") me-2"></i>
                                    <span>Email @(selectedNotification.EmailSent ? "✓" : "")</span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-phone @(selectedNotification.SMSSent ? "text-success" : "text-muted") me-2"></i>
                                    <span>SMS @(selectedNotification.SMSSent ? "✓" : "")</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    @* TODO: Add Reply/Forward when SenderId is added to Notification entity
                    @if (!string.IsNullOrEmpty(selectedNotification.SenderId))
                    {
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i>
                            <strong>From:</strong> [User Name]
                        </div>
                    }
                    *@
                </div>
                <div class="modal-footer">
                    @* TODO: Enable when SenderId is added
                    @if (!string.IsNullOrEmpty(selectedNotification.SenderId))
                    {
                        <button class="btn btn-primary" @onclick="ReplyToMessage">
                            <i class="bi bi-reply"></i> Reply
                        </button>
                        <button class="btn btn-secondary" @onclick="ForwardMessage">
                            <i class="bi bi-forward"></i> Forward
                        </button>
                    }
                    *@
                    @if (selectedNotification.RelatedEntityId.HasValue)
                    {
                        <button class="btn btn-info" @onclick="ViewRelatedEntity">
                            <i class="bi bi-box-arrow-up-right"></i> View Details
                        </button>
                    }
                    <button class="btn btn-danger" @onclick="DeleteCurrentNotification">
                        <i class="bi bi-trash"></i> Delete
                    </button>
                    <button class="btn btn-secondary" @onclick="CloseMessageModal">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public Func<string?, Guid, string>? GetEntityRoute { get; set; }
    
    private List<Notification> notifications = new List<Notification>();
    private List<Notification> filteredNotifications = new List<Notification>();
    private List<Notification> sortedNotifications = new List<Notification>();
    private List<Notification> pagedNotifications = new List<Notification>();
    
    private Notification? selectedNotification;
    private bool showMessageModal = false;
    
    private string sortColumn = nameof(Notification.CreatedOn);
    private bool sortAscending = false;

    // Filter and search properties
    private string searchText = "";
    private string filterCategory = "";
    private string filterType = "";
    private string filterStatus = "";

    private int currentPage = 1;
    private int pageSize = 25;
    private int totalPages = 1;
    private int totalRecords = 0;

    protected override async Task OnInitializedAsync()
    {
        await LoadNotificationsAsync();
    }

    private async Task LoadNotificationsAsync()
    {
        notifications = await NotificationService.GetUnreadNotificationsAsync();
        filteredNotifications = notifications;
        SortAndPaginateNotifications();
    }

    private void SortTable(string column)
    {
        if (sortColumn == column)
        {
            sortAscending = !sortAscending;
        }
        else
        {
            sortColumn = column;
            sortAscending = true;
        }
        SortAndPaginateNotifications();
    }

    private void ApplyFilters()
    {
        filteredNotifications = notifications.Where(n =>
        {
            // Search filter
            if (!string.IsNullOrEmpty(searchText))
            {
                var search = searchText.ToLower();
                if (!n.Title.ToLower().Contains(search) && 
                    !n.Message.ToLower().Contains(search))
                {
                    return false;
                }
            }

            // Category filter
            if (!string.IsNullOrEmpty(filterCategory) && n.Category != filterCategory)
            {
                return false;
            }

            // Type filter
            if (!string.IsNullOrEmpty(filterType) && n.Type != filterType)
            {
                return false;
            }

            // Status filter
            if (!string.IsNullOrEmpty(filterStatus))
            {
                if (filterStatus == "read" && !n.IsRead)
                    return false;
                if (filterStatus == "unread" && n.IsRead)
                    return false;
            }

            return true;
        }).ToList();

        currentPage = 1;
        SortAndPaginateNotifications();
    }

    private void ClearSearch()
    {
        searchText = "";
        ApplyFilters();
    }

    private void ClearAllFilters()
    {
        searchText = "";
        filterCategory = "";
        filterType = "";
        filterStatus = "";
        ApplyFilters();
    }

    private bool HasActiveFilters()
    {
        return !string.IsNullOrEmpty(searchText) || 
               !string.IsNullOrEmpty(filterCategory) || 
               !string.IsNullOrEmpty(filterType) || 
               !string.IsNullOrEmpty(filterStatus);
    }

    private async Task MarkAllAsRead()
    {
        foreach (var notification in notifications.Where(n => !n.IsRead))
        {
            notification.IsRead = true;
            notification.ReadOn = DateTime.UtcNow;
        }
        await Task.CompletedTask;
        SortAndPaginateNotifications();
    }

    private void SortAndPaginateNotifications()
    {
        // Use filtered notifications if filters are active
        var sourceList = HasActiveFilters() ? filteredNotifications : notifications;
        
        // Sort
        sortedNotifications = sortColumn switch
        {
            nameof(Notification.Title) => sortAscending
                ? sourceList.OrderBy(n => n.Title).ToList()
                : sourceList.OrderByDescending(n => n.Title).ToList(),
            nameof(Notification.Category) => sortAscending
                ? sourceList.OrderBy(n => n.Category).ToList()
                : sourceList.OrderByDescending(n => n.Category).ToList(),
            nameof(Notification.Message) => sortAscending
                ? sourceList.OrderBy(n => n.Message).ToList()
                : sourceList.OrderByDescending(n => n.Message).ToList(),
            nameof(Notification.CreatedOn) => sortAscending
                ? sourceList.OrderBy(n => n.CreatedOn).ToList()
                : sourceList.OrderByDescending(n => n.CreatedOn).ToList(),
            _ => sourceList.OrderByDescending(n => n.CreatedOn).ToList()
        };

        // Paginate
        totalRecords = sortedNotifications.Count;
        totalPages = (int)Math.Ceiling(totalRecords / (double)pageSize);
        currentPage = Math.Max(1, Math.Min(currentPage, totalPages));
        
        pagedNotifications = sortedNotifications
            .Skip((currentPage - 1) * pageSize)
            .Take(pageSize)
            .ToList();
    }

    private void UpdatePagination()
    {
        currentPage = 1;
        SortAndPaginateNotifications();
    }

    private void FirstPage() => GoToPage(1);
    private void LastPage() => GoToPage(totalPages);
    private void NextPage() => GoToPage(currentPage + 1);
    private void PreviousPage() => GoToPage(currentPage - 1);
    
    private void GoToPage(int page)
    {
        currentPage = Math.Max(1, Math.Min(page, totalPages));
        SortAndPaginateNotifications();
    }

    private void ViewNotification(Guid id){
        var notification = notifications.FirstOrDefault(n => n.Id == id);
        if (notification != null)
        {
            // Implement the logic to view the notification details
        }
    }

    private void ToggleReadStatus(Guid id){
        var notification = notifications.FirstOrDefault(n => n.Id == id);
        if (notification != null)
        {
            notification.IsRead = !notification.IsRead;
            SortAndPaginateNotifications();
        }
    }

    private void DeleteNotification(Guid id)
    {
        var notification = notifications.FirstOrDefault(n => n.Id == id);
        if (notification != null)
        {
            notifications.Remove(notification);
            SortAndPaginateNotifications();
        }
    }

    private void BackToDashboard()
    {
        NavigationManager.NavigateTo("/");
    }

    private void GoToPreferences()
    {
        NavigationManager.NavigateTo("/notifications/preferences");
    }

    // Modal Methods
    private void OpenMessageModal(Guid id)
    {
        selectedNotification = notifications.FirstOrDefault(n => n.Id == id);
        if (selectedNotification != null)
        {
            // Mark as read when opened
            if (!selectedNotification.IsRead)
            {
                selectedNotification.IsRead = true;
                selectedNotification.ReadOn = DateTime.UtcNow;
            }
            showMessageModal = true;
        }
    }

    private void CloseMessageModal()
    {
        showMessageModal = false;
        selectedNotification = null;
        SortAndPaginateNotifications();
    }

    private void DeleteCurrentNotification()
    {
        if (selectedNotification != null)
        {
            notifications.Remove(selectedNotification);
            CloseMessageModal();
        }
    }

    private void ViewRelatedEntity()
    {
        if (selectedNotification?.RelatedEntityId.HasValue == true && GetEntityRoute != null)
        {
            var route = GetEntityRoute(
                selectedNotification.RelatedEntityType,
                selectedNotification.RelatedEntityId.Value);
            NavigationManager.NavigateTo(route);
        }
    }

    // TODO: Implement when SenderId is added to Notification entity
    // private void ReplyToMessage()
    // {
    //     // Create new notification to sender
    // }

    // TODO: Implement when SenderId is added to Notification entity  
    // private void ForwardMessage()
    // {
    //     // Show user selection modal, then send to selected users
    // }

    // Helper methods for badge colors
    private string GetCategoryBadgeColor(string category) => category switch
    {
        "Lease" => "primary",
        "Payment" => "success",
        "Maintenance" => "warning",
        "Application" => "info",
        "Security" => "danger",
        _ => "secondary"
    };

    private string GetTypeBadgeColor(string type) => type switch
    {
        "Info" => "info",
        "Warning" => "warning",
        "Error" => "danger",
        "Success" => "success",
        _ => "secondary"
    };
}