@using Aquiis.Application.Services
@using Microsoft.JSInterop
@using PreferencesEntity = Aquiis.Core.Entities.NotificationPreferences
@inject NotificationService NotificationService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@namespace Aquiis.UI.Shared.Components.Notifications

<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">
                <i class="bi bi-gear-fill me-2"></i>Notification Preferences
            </h2>
            <p class="text-muted mb-0">Configure how you receive notifications</p>
        </div>
        <button class="btn btn-secondary" @onclick="Cancel">
            <i class="bi bi-x-lg me-1"></i>Cancel
        </button>
    </div>

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (preferences != null)
    {
        <EditForm Model="@preferences" OnValidSubmit="SavePreferences" FormName="notificationPreferencesForm">
            <DataAnnotationsValidator />

            <!-- In-App Notifications -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-app-indicator me-2"></i>In-App Notifications
                    </h5>
                </div>
                <div class="card-body">
                    <div class="form-check form-switch mb-3">
                        <InputCheckbox class="form-check-input" id="enableInApp" @bind-Value="preferences.EnableInAppNotifications" />
                        <label class="form-check-label" for="enableInApp">
                            <strong>Enable in-app notifications</strong>
                            <small class="d-block text-muted">Show notifications in the notification bell</small>
                        </label>
                    </div>
                    <div class="alert alert-info mb-0">
                        <i class="bi bi-info-circle me-2"></i>
                        In-app notifications appear in the notification bell at the top of the page. They are always stored in your notification history.
                    </div>
                </div>
            </div>

            <!-- Email Notifications -->
            <div class="card mb-4 opacity-75">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-envelope-fill me-2"></i>Email Notifications
                    </h5>
                    <span class="badge bg-warning text-dark">
                        <i class="bi bi-clock-history me-1"></i>Coming Soon
                    </span>
                </div>
                <div class="card-body">
                    <div class="alert alert-warning mb-3">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Email notifications are coming soon!</strong> This feature requires email service integration and will be enabled in a future release.
                    </div>
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="enableEmail" disabled />
                        <label class="form-check-label text-muted" for="enableEmail">
                            <strong>Enable email notifications</strong>
                            <small class="d-block">Receive notifications via email (Coming Soon)</small>
                        </label>
                    </div>
                </div>
            </div>

            <!-- SMS Notifications -->
            <div class="card mb-4 opacity-75">
                <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-phone-fill me-2"></i>SMS Notifications
                    </h5>
                    <span class="badge bg-warning text-dark">
                        <i class="bi bi-clock-history me-1"></i>Coming Soon
                    </span>
                </div>
                <div class="card-body">
                    <div class="alert alert-warning mb-3">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>SMS notifications are coming soon!</strong> This feature requires SMS service integration and will be enabled in a future release.
                    </div>
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="enableSMS" disabled />
                        <label class="form-check-label text-muted" for="enableSMS">
                            <strong>Enable SMS notifications</strong>
                            <small class="d-block">Receive urgent notifications via text message (Coming Soon)</small>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Digest Preferences -->
            <div class="card mb-4 opacity-75">
                <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-newspaper me-2"></i>Digest Preferences
                    </h5>
                    <span class="badge bg-warning text-dark">
                        <i class="bi bi-clock-history me-1"></i>Coming Soon
                    </span>
                </div>
                <div class="card-body">
                    <div class="alert alert-warning">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Digest notifications are coming soon!</strong> This feature requires email service integration and will be enabled in a future release.
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <h6 class="mb-3">Daily Digest</h6>
                            <div class="form-check form-switch mb-3">
                                <input type="checkbox" class="form-check-input" id="enableDaily" disabled />
                                <label class="form-check-label" for="enableDaily">
                                    <strong>Enable daily digest</strong>
                                    <small class="d-block text-muted">Receive a summary of notifications once per day (Coming Soon)</small>
                                </label>
                            </div>
                        </div>

                        <div class="col-md-6 mb-4">
                            <h6 class="mb-3">Weekly Digest</h6>
                            <div class="form-check form-switch mb-3">
                                <input type="checkbox" class="form-check-input" id="enableWeekly" disabled />
                                <label class="form-check-label" for="enableWeekly">
                                    <strong>Enable weekly digest</strong>
                                    <small class="d-block text-muted">Receive a summary of notifications once per week (Coming Soon)</small>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <button type="button" class="btn btn-outline-secondary" @onclick="ResetToDefaults">
                            <i class="bi bi-arrow-clockwise me-1"></i>Reset to Defaults
                        </button>
                        <div>
                            <button type="button" class="btn btn-secondary me-2" @onclick="Cancel">
                                Cancel
                            </button>
                            <button type="submit" class="btn btn-primary" disabled="@isSaving">
                                @if (isSaving)
                                {
                                    <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                                }
                                else
                                {
                                    <i class="bi bi-check-lg me-1"></i>
                                }
                                Save Preferences
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </EditForm>
    }
</div>

@code {
    [Parameter, EditorRequired] public dynamic ToastService { get; set; } = default!;
    
    private PreferencesEntity? preferences { get; set; }
    
    private bool isLoading = true;
    private bool isSaving = false;

    // Helper property for time binding (InputDate doesn't bind TimeSpan directly)
    private DateTime DailyDigestTimeValue
    {
        get => DateTime.Today.Add(preferences?.DailyDigestTime ?? new TimeSpan(9, 0, 0));
        set => preferences!.DailyDigestTime = value.TimeOfDay;
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            preferences = await NotificationService.GetUserPreferencesAsync();
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Failed to load preferences: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task SavePreferences()
    {
        if (preferences == null) return;

        isSaving = true;
        StateHasChanged();
        
        try
        {
            Console.WriteLine($"Saving preferences - EnableInApp: {preferences.EnableInAppNotifications}, EnableEmail: {preferences.EnableEmailNotifications}");
            await NotificationService.UpdateUserPreferencesAsync(preferences);
            Console.WriteLine("Preferences saved successfully");
            ToastService.ShowSuccess("Notification preferences saved successfully!");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving preferences: {ex.Message}");
            ToastService.ShowError($"Failed to save preferences: {ex.Message}");
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }

    private async Task ResetToDefaults()
    {
        if (preferences == null) return;

        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to reset all preferences to defaults? This cannot be undone.");
        if (!confirmed) return;

        // Reset to defaults
        preferences.EnableInAppNotifications = true;
        preferences.EnableEmailNotifications = true;
        preferences.EnableSMSNotifications = false;
        preferences.EmailLeaseExpiring = true;
        preferences.EmailPaymentDue = true;
        preferences.EmailPaymentReceived = true;
        preferences.EmailApplicationStatusChange = true;
        preferences.EmailMaintenanceUpdate = true;
        preferences.EmailInspectionScheduled = true;
        preferences.SMSPaymentDue = false;
        preferences.SMSMaintenanceEmergency = true;
        preferences.SMSLeaseExpiringUrgent = false;
        preferences.EnableDailyDigest = false;
        preferences.DailyDigestTime = new TimeSpan(9, 0, 0);
        preferences.EnableWeeklyDigest = false;
        preferences.WeeklyDigestDay = DayOfWeek.Monday;

        await SavePreferences();
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/notifications");
    }
}
