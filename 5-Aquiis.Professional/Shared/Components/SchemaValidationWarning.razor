@using Aquiis.Application.Services
@using Aquiis.Professional.Shared.Services
@using Aquiis.Application.Services.PdfGenerators
@inject SchemaValidationService SchemaService
@inject NavigationManager Navigation
@rendermode InteractiveServer

@if (showWarning && !isValid)
{
    <div class="alert alert-danger alert-dismissible fade show mb-4" role="alert">
        <h5 class="alert-heading">
            <i class="bi bi-exclamation-triangle-fill"></i> Database Schema Version Mismatch!
        </h5>
        <p class="mb-2">@validationMessage</p>
        @if (!string.IsNullOrEmpty(databaseVersion))
        {
            <p class="mb-2">
                <strong>Database Version:</strong> @databaseVersion<br/>
                <strong>Expected Version:</strong> @expectedVersion
            </p>
        }
        <hr/>
        <p class="mb-0">
            <strong>Recommended Actions:</strong>
        </p>
        <ul class="mb-2">
            <li>Update the application to match the database version, or</li>
            <li>Restore a backup compatible with the current application version</li>
            <li><a href="/administration/application/database" class="alert-link">Go to Database Backup & Recovery</a></li>
        </ul>
        <button type="button" class="btn-close" @onclick="() => showWarning = false" aria-label="Close"></button>
    </div>
}

@code {
    [Parameter]
    public string ExpectedVersion { get; set; } = "1.0.0";

    private bool isValid = true;
    private bool showWarning = true;
    private string validationMessage = string.Empty;
    private string? databaseVersion;
    private string expectedVersion = "1.0.0";

    protected override async Task OnInitializedAsync()
    {
        await ValidateSchema();
    }

    private async Task ValidateSchema()
    {
        try
        {
            var (valid, message, dbVersion) = await SchemaService.ValidateSchemaVersionAsync();
            isValid = valid;
            validationMessage = message;
            databaseVersion = dbVersion;
            expectedVersion = ExpectedVersion;
        }
        catch (Exception ex)
        {
            isValid = false;
            validationMessage = $"Error validating schema: {ex.Message}";
        }
    }
}
