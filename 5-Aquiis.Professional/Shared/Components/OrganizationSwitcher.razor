@using Aquiis.Core.Entities
@using Aquiis.Application.Services
@using Aquiis.Core.Constants
@inject OrganizationService OrganizationService
@inject UserContextService UserContext
@inject NavigationManager Navigation
@implements IDisposable

@if (isLoading)
{
    <div class="org-switcher-skeleton">
        <span class="spinner-border spinner-border-sm" role="status"></span>
    </div>
}
else if (accessibleOrganizations.Count > 0)
{
    <div class="dropdown org-switcher">
        <button class="btn btn-outline-secondary dropdown-toggle" type="button" @onclick="ToggleDropdown">
            <i class="bi bi-building me-2"></i>
            <span class="org-name">@(currentOrg?.DisplayName ?? currentOrg?.Name ?? "No Organization")</span>
            @if (!string.IsNullOrEmpty(currentRole))
            {
                <span class="badge @GetRoleBadgeClass(currentRole) ms-2">@currentRole</span>
            }
        </button>
        <ul class="dropdown-menu dropdown-menu-end @(isDropdownOpen ? "show" : "")" @onclick:stopPropagation="true">
            <li class="dropdown-header">Switch Organization</li>
            @foreach (var orgAssignment in accessibleOrganizations)
            {
                <li>
                    <a class="dropdown-item @(orgAssignment.Organization.Id == currentOrg?.Id ? "active" : "")" 
                       @onclick="async () => await SwitchOrganizationAsync(orgAssignment.Organization.Id)"
                       style="cursor: pointer;">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="fw-semibold">@orgAssignment.Organization.Name</div>
                                @if (!string.IsNullOrEmpty(orgAssignment.Organization.DisplayName) && orgAssignment.Organization.DisplayName != orgAssignment.Organization.Name)
                                {
                                    <small class="text-muted">@orgAssignment.Organization.DisplayName</small>
                                }
                            </div>
                            <span class="badge @GetRoleBadgeClass(orgAssignment.Role) ms-2">@orgAssignment.Role</span>
                        </div>
                        @if (orgAssignment.Organization.Id == currentOrg?.Id)
                        {
                            <small class="text-success"><i class="bi bi-check-circle-fill"></i> Active</small>
                        }
                    </a>
                </li>
            }
            
            @if (isAccountOwner)
            {
                <li><hr class="dropdown-divider"></li>
                <li>
                    <a class="dropdown-item" href="/administration/organizations/create">
                        <i class="bi bi-plus-circle me-2"></i>Create New Organization
                    </a>
                </li>
            }
            
            <li><hr class="dropdown-divider"></li>
            <li>
                <a class="dropdown-item" href="/administration/organizations">
                    <i class="bi bi-gear me-2"></i>Manage Organizations
                </a>
            </li>
        </ul>
    </div>
}

@code {
    private List<UserOrganization> accessibleOrganizations = new();
    private Organization? currentOrg;
    private string? currentRole;
    private bool isAccountOwner;
    private bool isLoading = true;
    private bool isDropdownOpen = false;

    protected override async Task OnInitializedAsync()
    {
        // Subscribe to location changes
        Navigation.LocationChanged += OnLocationChanged;
        await LoadOrganizationContextAsync();
    }

    private async void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        // Refresh the user context cache first to get the latest organization
        await UserContext.RefreshAsync();
        
        // Then refresh the organization context when navigation occurs
        await LoadOrganizationContextAsync();
        await InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        Navigation.LocationChanged -= OnLocationChanged;
    }

    private void ToggleDropdown()
    {
        isDropdownOpen = !isDropdownOpen;
    }

    private async Task LoadOrganizationContextAsync()
    {
        try
        {
            isLoading = true;
            
            var userId = await UserContext.GetUserIdAsync();
            if (string.IsNullOrEmpty(userId))
            {
                throw new InvalidOperationException("Cannot load organizations: User ID is not available in context.");
            }

            // Get all organizations user has access to
            accessibleOrganizations = await OrganizationService.GetActiveUserAssignmentsAsync();
            
            // Only try to get active organization if user has access to organizations
            if (accessibleOrganizations.Any())
            {
                // Get current active organization
                try
                {
                    currentOrg = await UserContext.GetActiveOrganizationAsync();
                    
                    // Get current role in active organization
                    currentRole = await UserContext.GetCurrentOrganizationRoleAsync();
                }
                catch (InvalidOperationException)
                {
                    // User doesn't have an active organization yet (e.g., just registered)
                    // This is OK - the switcher will just show no organization
                    currentOrg = null;
                    currentRole = null;
                }
            }
            
            // Check if user is account owner
            isAccountOwner = await UserContext.IsAccountOwnerAsync();
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task SwitchOrganizationAsync(Guid organizationId)
    {
        isDropdownOpen = false; // Close dropdown
        
        try
        {
            // Don't switch if already on this organization
            if (currentOrg?.Id == organizationId)
            {
                return;
            }

            var success = await UserContext.SwitchOrganizationAsync(organizationId);
            
            if (success)
            {
                // Reload the page to refresh all data with new organization context
                Navigation.NavigateTo(Navigation.Uri, forceLoad: true);
            }
        }
        catch (Exception)
        {
            // Error handling - could show toast notification here
            // For now, silently fail and stay on current org
        }
    }

    private string GetRoleBadgeClass(string role)
    {
        return role switch
        {
            ApplicationConstants.OrganizationRoles.Owner => "bg-primary",
            ApplicationConstants.OrganizationRoles.Administrator => "bg-info",
            ApplicationConstants.OrganizationRoles.PropertyManager => "bg-success",
            ApplicationConstants.OrganizationRoles.User => "bg-secondary",
            _ => "bg-secondary"
        };
    }
}
