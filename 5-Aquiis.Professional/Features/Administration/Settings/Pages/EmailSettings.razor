@page "/administration/settings/email"
@using Aquiis.Application.Services
@using SocketIOClient.Messages
@using System.ComponentModel.DataAnnotations
@inject EmailSettingsService EmailSettingsService
@inject EmailService EmailService
@inject ToastService ToastService
@inject IJSRuntime JSRuntime

@inject NavigationManager Navigation

@inject UserContextService _userContext

@rendermode InteractiveServer

<PageTitle>Email Settings - Aquiis</PageTitle>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1>
                <i class="bi bi-inbox-fill"></i> Email Configuration
            </h1>
            <p class="text-muted">
                Configure SendGrid integration for automated email notifications
            </p>
        </div>
        <button class="btn btn-secondary" @onclick="BackToDashboard">
            <i class="bi bi-arrow-left"></i> Back to Dashboard
        </button>
    </div>

    @if (settings == null)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (!settings.IsEmailEnabled)
    {
        <div class="row mt-4">
            <div class="col-lg-8">
                <div class="alert alert-info">
                    <h4><i class="bi bi-info-circle"></i> Email Integration Not Configured</h4>
                    <p>Enable automated email notifications by connecting your SendGrid account.</p>

                    <h5 class="mt-4">Why Use SendGrid?</h5>
                    <ul>
                        <li><strong>Free tier:</strong> 100 emails per day forever (perfect for getting started)</li>
                        <li><strong>Reliable delivery:</strong> Industry-leading email infrastructure</li>
                        <li><strong>Analytics:</strong> Track opens, clicks, and bounces</li>
                        <li><strong>Your account:</strong> You manage billing and usage directly</li>
                    </ul>

                    <h5 class="mt-4">Setup Steps:</h5>
                    <ol class="mb-4">
                        <li>
                            <a href="https://signup.sendgrid.com/" target="_blank" rel="noopener" class="alert-link">
                                Create a free SendGrid account <i class="bi bi-box-arrow-up-right"></i>
                            </a>
                        </li>
                        <li>Generate an API key with <strong>"Mail Send"</strong> permissions</li>
                        <li>Click the button below to configure your API key</li>
                    </ol>

                    <button class="btn btn-primary btn-lg" @onclick="() => showConfigModal = true">
                        <i class="bi bi-envelope-plus"></i> Configure SendGrid
                    </button>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="bi bi-question-circle"></i> Need Help?</h5>
                    </div>
                    <div class="card-body">
                        <h6>Common Questions</h6>
                        <p class="small mb-2">
                            <strong>Do I need a paid account?</strong><br>
                            No! The free tier (100 emails/day) is usually sufficient.
                        </p>
                        <p class="small mb-2">
                            <strong>What happens without email?</strong><br>
                            The app works fine. Notifications appear in-app only.
                        </p>
                        <p class="small mb-2">
                            <strong>Is my API key secure?</strong><br>
                            Yes, it's encrypted and never shared.
                        </p>
                        <hr>
                        <a href="https://docs.sendgrid.com/ui/account-and-settings/api-keys"
                           target="_blank"
                           class="btn btn-sm btn-outline-secondary">
                            <i class="bi bi-book"></i> API Key Guide
                        </a>
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="row mt-4">
            <div class="col-lg-8">
                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <i class="bi bi-check-circle"></i> Email Integration Active
                    </div>
                    <div class="card-body">
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <h6>Configuration</h6>
                                <p class="mb-1">
                                    <strong>From Email:</strong><br>
                                    <code>@settings.FromEmail</code>
                                </p>
                                <p class="mb-1">
                                    <strong>From Name:</strong><br>
                                    @settings.FromName
                                </p>
                                <p class="mb-1 text-muted small">
                                    <i class="bi bi-check-circle-fill text-success"></i>
                                    Verified @settings.LastVerifiedOn?.ToString("g")
                                </p>
                            </div>
                            <div class="col-md-6">
                                @if (stats != null && stats.IsConfigured)
                                {
                                    <h6>Usage Statistics</h6>
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between mb-1">
                                            <span><strong>Today:</strong></span>
                                            <span>@stats.EmailsSentToday / @stats.DailyLimit</span>
                                        </div>
                                        <div class="progress" style="height: 20px;">
                                            <div class="progress-bar @GetProgressBarClass(stats.DailyPercentUsed)"
                                                 role="progressbar"
                                                 style="width: @(stats.DailyPercentUsed)%">
                                                @(stats.DailyPercentUsed)%
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between mb-1">
                                            <span><strong>This Month:</strong></span>
                                            <span>@stats.EmailsSentThisMonth / @stats.MonthlyLimit</span>
                                        </div>
                                        <div class="progress" style="height: 20px;">
                                            <div class="progress-bar @GetProgressBarClass(stats.MonthlyPercentUsed)"
                                                 role="progressbar"
                                                 style="width: @(stats.MonthlyPercentUsed)%">
                                                @(stats.MonthlyPercentUsed)%
                                            </div>
                                        </div>
                                    </div>
                                    <p class="mb-0 text-muted small">
                                        <i class="bi bi-calendar-check"></i>
                                        Plan: <strong>@stats.PlanType</strong>
                                        @if (stats.LastEmailSentOn.HasValue)
                                        {
                                            <br><i class="bi bi-clock-history"></i> <text>Last sent:</text> @stats.LastEmailSentOn?.ToString("g")
                                        }
                                    </p>
                                }
                            </div>
                        </div>

                        @if (!string.IsNullOrEmpty(settings.LastError))
                        {
                            <div class="alert alert-warning mb-3">
                                <i class="bi bi-exclamation-triangle"></i>
                                <strong>Recent Error:</strong> @settings.LastError
                                <br>
                                <small class="text-muted">Try updating your API key or contact SendGrid support</small>
                            </div>
                        }

                        <div class="btn-group" role="group">
                            <button class="btn btn-primary" @onclick="() => showConfigModal = true">
                                <i class="bi bi-key"></i> Update API Key
                            </button>
                            <button class="btn btn-info" @onclick="SendTestEmail">
                                <i class="bi bi-envelope-check"></i> Send Test Email
                            </button>
                            <button class="btn btn-secondary" @onclick="RefreshStats" disabled="@isRefreshing">
                                <i class="bi bi-arrow-clockwise @(isRefreshing ? "spin" : "")"></i>
                                Refresh Stats
                            </button>
                            <button class="btn btn-warning" @onclick="DisableEmail">
                                <i class="bi bi-x-circle"></i> Disable Email
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-graph-up"></i> Email Activity
                    </div>
                    <div class="card-body">
                        <p class="text-muted">
                            View detailed email statistics in your
                            <a href="https://app.sendgrid.com/statistics" target="_blank" rel="noopener">
                                SendGrid Dashboard <i class="bi bi-box-arrow-up-right"></i>
                            </a>
                        </p>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="bi bi-lightbulb"></i> Tips</h5>
                    </div>
                    <div class="card-body">
                        <h6>Optimize Email Usage</h6>
                        <ul class="small mb-3">
                            <li>Enable daily/weekly digest mode to batch notifications</li>
                            <li>Let users configure their notification preferences</li>
                            <li>Monitor your usage to avoid hitting limits</li>
                            <li>Consider upgrading if you consistently hit daily limits</li>
                        </ul>

                        <h6>SendGrid Features</h6>
                        <ul class="small mb-0">
                            <li><strong>Templates:</strong> Create branded email templates</li>
                            <li><strong>Analytics:</strong> Track opens and clicks</li>
                            <li><strong>Webhooks:</strong> Get delivery notifications</li>
                            <li><strong>Lists:</strong> Manage recipient groups</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    }

@* Configuration Modal *@
@if (showConfigModal)
{
    <div class="modal show d-block" tabindex="-1" style="background: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-envelope-gear"></i> Configure SendGrid
                    </h5>
                    <button type="button" class="btn-close" @onclick="CloseModal"></button>
                </div>
                <EditForm Model="configModel" OnValidSubmit="SaveConfiguration">
                    <DataAnnotationsValidator />
                    <div class="modal-body">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i>
                            <strong>Security Note:</strong> Your API key is encrypted and securely stored.
                            It's never transmitted or visible after saving.
                        </div>

                        <div class="mb-3">
                            <label class="form-label">
                                SendGrid API Key *
                                <a href="https://app.sendgrid.com/settings/api_keys"
                                   target="_blank"
                                   rel="noopener"
                                   class="small ms-2">
                                    <i class="bi bi-box-arrow-up-right"></i> Get API Key
                                </a>
                            </label>
                            <InputText @bind-Value="configModel.ApiKey"
                                       class="form-control"
                                       type="password"
                                       placeholder="SG.xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" />
                            <ValidationMessage For="@(() => configModel.ApiKey)" />
                            <small class="form-text text-muted">
                                Create a new API key with <strong>Mail Send</strong> permissions
                            </small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">From Email Address *</label>
                            <InputText @bind-Value="configModel.FromEmail"
                                       class="form-control"
                                       placeholder="noreply@yourdomain.com" />
                            <ValidationMessage For="@(() => configModel.FromEmail)" />
                            <small class="form-text text-muted">
                                Use an email address from a domain you own. Verify sender in SendGrid first.
                            </small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">From Name *</label>
                            <InputText @bind-Value="configModel.FromName"
                                       class="form-control"
                                       placeholder="Your Property Management Company" />
                            <ValidationMessage For="@(() => configModel.FromName)" />
                            <small class="form-text text-muted">
                                This name appears in recipients' inboxes
                            </small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CloseModal">
                            Cancel
                        </button>
                        <button type="submit" class="btn btn-primary" disabled="@isSaving">
                            @if (isSaving)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                            }
                            <i class="bi bi-save"></i> Save Configuration
                        </button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
}

@code {
    private OrganizationEmailSettings? settings;
    private EmailStats? stats;
    private bool showConfigModal;
    private bool isSaving;
    private bool isRefreshing;
    private ConfigurationModel configModel = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadSettings();
    }

    private async Task LoadSettings()
    {
        settings = await EmailSettingsService.GetOrCreateSettingsAsync();
        // TODO Phase 2.5: Uncomment when GetSendGridStatsAsync is implemented
        if (settings.IsEmailEnabled)
        {
             stats = await EmailService.GetEmailStatsAsync();
        }
    }

    private async Task SaveConfiguration()
    {
        isSaving = true;

        var result = await EmailSettingsService.UpdateSendGridConfigAsync(
            configModel.ApiKey!,
            configModel.FromEmail!,
            configModel.FromName!);

        if (result.Success)
        {
            ToastService.ShowSuccess(result.Message);
            showConfigModal = false;
            configModel = new(); // Clear sensitive data
            await LoadSettings();
        }
        else
        {
            ToastService.ShowError(result.Message);
        }

        isSaving = false;
    }

    private async Task SendTestEmail()
    {
        var userEmail = await _userContext.GetUserEmailAsync();
        var testEmail = await JSRuntime.InvokeAsync<string?>("prompt",
            "Enter email address to send test email:",
            userEmail ?? settings?.FromEmail ?? "");

        if (!string.IsNullOrEmpty(testEmail))
        {
            var result = await EmailSettingsService.TestEmailConfigurationAsync(testEmail);
            if (result.Success)
                ToastService.ShowSuccess(result.Message);
            else
                ToastService.ShowError(result.Message);
        }
    }

    private async Task DisableEmail()
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm",
            "Are you sure you want to disable email notifications?\n\n" +
            "Notifications will only appear in-app until you re-enable email.");

        if (confirmed)
        {
            var result = await EmailSettingsService.DisableEmailAsync();
            ToastService.ShowInfo(result.Message);
            await LoadSettings();
        }
    }

    private async Task RefreshStats()
    {
        isRefreshing = true;
        await LoadSettings();
        isRefreshing = false;
        ToastService.ShowSuccess("Statistics refreshed");
    }

    private void CloseModal()
    {
        showConfigModal = false;
        configModel = new(); // Clear sensitive data
    }

    private string GetProgressBarClass(int percent)
    {
        return percent switch
        {
            ( < 50) => "bg-success",
            ( < 75) => "bg-info",
            ( < 90) => "bg-warning",
            _ => "bg-danger"
        };
    }

    private void BackToDashboard()
    {
        Navigation.NavigateTo("/administration/dashboard");
    }

    public class ConfigurationModel
    {
        [Required(ErrorMessage = "SendGrid API key is required")]
        [StringLength(100, MinimumLength = 32, ErrorMessage = "API key must be at least 32 characters")]
        public string? ApiKey { get; set; }

        [Required(ErrorMessage = "From email address is required")]
        [EmailAddress(ErrorMessage = "Invalid email address")]
        public string? FromEmail { get; set; }

        [Required(ErrorMessage = "From name is required")]
        [StringLength(200, MinimumLength = 2, ErrorMessage = "From name must be 2-200 characters")]
        public string? FromName { get; set; }
    }
}

<style>
    .spin {
        animation: spin 1s linear infinite;
    }

    @@keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
</style>