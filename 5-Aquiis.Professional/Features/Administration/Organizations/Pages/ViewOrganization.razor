@page "/administration/organizations/view/{Id:guid}"

@using Aquiis.Core.Entities
@using Aquiis.Application.Services
@using Aquiis.Infrastructure.Data
@using Aquiis.Professional.Shared.Services
@using Aquiis.Professional.Shared.Components.Account
@using Aquiis.Core.Constants
@using Aquiis.UI.Shared.Features.Organizations
@using Aquiis.UI.Shared.Components.Entities.Organizations
@using Aquiis.UI.Shared.Components.Entities.OrganizationUsers
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore

@inject OrganizationService OrganizationService
@inject UserContextService UserContext
@inject ApplicationDbContext DbContext
@inject NavigationManager Navigation
@inject ToastService ToastService

@attribute [OrganizationAuthorize("Owner", "Administrator")]
@rendermode InteractiveServer

<PageTitle>View Organization - Administration</PageTitle>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="bi bi-building"></i> Organization Details</h1>
        <div class="btn-group">
            @if (isOwner)
            {
                <button class="btn btn-primary" @onclick="NavigateToEdit">
                    <i class="bi bi-pencil"></i> Edit
                </button>
            }
            <button class="btn btn-outline-secondary" @onclick="Cancel">
                <i class="bi bi-arrow-left"></i> Back to Organizations
            </button>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (organization == null)
    {
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle"></i> Organization not found or you don't have permission to view it.
        </div>
    }
    else
    {
        <OrganizationDetails 
            OrganizationViewModel="@organizationViewModel"
            CurrentUserRole="@currentUserRole"
            CurrentUserViewModel="@currentUserViewModel"
            IsOwner="@isOwner"
            IsAdministrator="@isAdministrator"
            IsCurrentOrganization="@isCurrentOrganization"
            OnManageUsers="NavigateToManageUsers" />
    }
</div>

@code {
    [Parameter]
    public Guid Id { get; set; } = Guid.Empty;

    private bool isLoading = true;
    private Organization? organization;
    private string currentUserRole = string.Empty;
    private bool isOwner = false;
    private bool isAdministrator = false;

    private bool isCurrentOrganization = false;

    public OrganizationViewModel organizationViewModel = new();
    public OrganizationUserViewModel currentUserViewModel = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadOrganization();
    }

    private async Task LoadOrganization()
    {
        isLoading = true;
        try
        {
            var userId = await UserContext.GetUserIdAsync();
            var currentOrganizationId = await UserContext.GetActiveOrganizationIdAsync();
            if (string.IsNullOrEmpty(userId))
            {
                return;
            }

            // if the organization being viewed is the current organization
            // allow user management for Owner/Administrator roles
            isCurrentOrganization = Id == currentOrganizationId;

            // Check if user has access to this organization
            var canAccess = await OrganizationService.CanAccessOrganizationAsync(userId, Id);
            if (!canAccess)
            {
                organization = null;
                return;
            }

            organization = await OrganizationService.GetOrganizationByIdAsync(Id);
            if (organization != null)
            {
                // Single-context query using UserProfile - no cross-context joins needed!
                organizationViewModel.OrganizationUsers = await (
                    from ou in DbContext.OrganizationUsers
                    join profile in DbContext.UserProfiles on ou.UserId equals profile.UserId
                    join grantedByProfile in DbContext.UserProfiles on ou.GrantedBy equals grantedByProfile.UserId into grantedByJoin
                    from grantedByProfile in grantedByJoin.DefaultIfEmpty()
                    where ou.OrganizationId == Id && ou.IsActive && !ou.IsDeleted
                    select new OrganizationUserViewModel
                    {
                        Id = ou.Id,
                        OrganizationId = ou.OrganizationId,
                        UserId = ou.UserId,
                        Role = ou.Role,
                        IsActive = ou.IsActive,
                        GrantedOn = ou.GrantedOn,
                        GrantedBy = ou.GrantedBy,
                        GrantedByEmail = grantedByProfile != null ? grantedByProfile.Email : "System",
                        Email = profile.Email,
                        FirstName = profile.FirstName,
                        LastName = profile.LastName,
                        PhoneNumber = profile.PhoneNumber
                    }
                ).ToListAsync();

                // Find owner from the list
                var owner = organizationViewModel.OrganizationUsers
                    .FirstOrDefault(u => u.Role == ApplicationConstants.OrganizationRoles.Owner);

                // Get current user's role
                var currentUserOrg = organizationViewModel.OrganizationUsers.FirstOrDefault(u => u.UserId == userId);
                currentUserRole = currentUserOrg?.Role ?? "Unknown";
                isOwner = currentUserRole == ApplicationConstants.OrganizationRoles.Owner;
                isAdministrator = currentUserRole == ApplicationConstants.OrganizationRoles.Administrator;

                organizationViewModel.Organization = organization;
                organizationViewModel.OrganizationOwner = owner;
                
                // Get current user's profile from UserProfile table
                var currentUserProfile = await DbContext.UserProfiles
                    .FirstOrDefaultAsync(up => up.UserId == userId);
                
                if (currentUserProfile != null)
                {
                    currentUserViewModel = new OrganizationUserViewModel
                    {
                        UserId = userId,
                        Email = currentUserProfile.Email,
                        FirstName = currentUserProfile.FirstName,
                        LastName = currentUserProfile.LastName,
                        PhoneNumber = currentUserProfile.PhoneNumber,
                        Role = currentUserRole,
                        IsActive = currentUserOrg?.IsActive ?? false,
                        GrantedOn = currentUserOrg?.GrantedOn ?? DateTime.UtcNow
                    };
                }
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error loading organization: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }



    private void NavigateToEdit()
    {
        Navigation.NavigateTo($"/administration/organizations/edit/{Id}");
    }

    private void NavigateToManageUsers()
    {
        Navigation.NavigateTo($"/administration/organizations/{Id}/users");
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/administration/organizations");
    }
}
