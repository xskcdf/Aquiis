@page "/administration/organizations/{Id:guid}/users"

@using Aquiis.Core.Entities
@using Aquiis.Application.Services
@using Aquiis.Professional.Shared.Services
@using Aquiis.Professional.Shared.Components.Account
@using Aquiis.Core.Constants
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore

@inject OrganizationService OrganizationService
@inject UserContextService UserContext
@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager Navigation
@inject ToastService ToastService
@inject IJSRuntime JSRuntime

@attribute [OrganizationAuthorize("Owner", "Administrator")]
@rendermode InteractiveServer

<PageTitle>Manage Organization Users - Administration</PageTitle>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1><i class="bi bi-people"></i> Manage Users</h1>
            @if (organization != null)
            {
                <p class="text-muted mb-0">@organization.Name</p>
            }
        </div>
        <button class="btn btn-outline-secondary" @onclick="Cancel">
            <i class="bi bi-arrow-left"></i> Back to Organization
        </button>
    </div>

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (organization == null)
    {
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle"></i> Organization not found or you don't have permission to manage users.
        </div>
    }
    else
    {
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Users with Access</h5>
                        <button class="btn btn-sm btn-primary" @onclick="ShowAddUserModal">
                            <i class="bi bi-person-plus"></i> Add User
                        </button>
                    </div>
                    <div class="card-body p-0">
                        @if (!organizationUsers.Any())
                        {
                            <div class="p-4 text-center text-muted">
                                No users assigned to this organization yet.
                            </div>
                        }
                        else
                        {
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead>
                                        <tr>
                                            <th>User</th>
                                            <th>Role</th>
                                            <th>Granted By</th>
                                            <th>Granted On</th>
                                            <th>Status</th>
                                            <th class="text-end">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var userOrg in organizationUsers)
                                        {
                                            <tr>
                                                <td>
                                                    <strong>@GetUserEmail(userOrg.UserId)</strong>
                                                </td>
                                                <td>
                                                    @if (userOrg.Role == ApplicationConstants.OrganizationRoles.Owner && userOrg.UserId == organization.OwnerId)
                                                    {
                                                        <span class="badge @GetRoleBadgeClass(userOrg.Role)">
                                                            @userOrg.Role
                                                        </span>
                                                    }
                                                    else
                                                    {
                                                        <select class="form-select form-select-sm" value="@userOrg.Role" @onchange="(e) => ChangeUserRole(userOrg, e.Value?.ToString() ?? userOrg.Role)">
                                                            @foreach (var role in ApplicationConstants.OrganizationRoles.AllRoles)
                                                            {
                                                                <option value="@role">@role</option>
                                                            }
                                                        </select>
                                                    }
                                                </td>
                                                <td>@GetUserEmail(userOrg.GrantedBy)</td>
                                                <td>@userOrg.GrantedOn.ToString("MMM dd, yyyy")</td>
                                                <td>
                                                    @if (userOrg.IsActive && userOrg.RevokedOn == null)
                                                    {
                                                        <span class="badge bg-success">Active</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge bg-danger">Revoked</span>
                                                    }
                                                </td>
                                                <td class="text-end">
                                                    @if (userOrg.UserId != organization.OwnerId && userOrg.IsActive)
                                                    {
                                                        <button class="btn btn-sm btn-outline-danger" @onclick="() => RevokeUserAccess(userOrg)" title="Revoke Access">
                                                            <i class="bi bi-x-circle"></i> Revoke
                                                        </button>
                                                    }
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="bi bi-info-circle"></i> Information</h6>
                    </div>
                    <div class="card-body">
                        <p><strong>Organization Roles:</strong></p>
                        <ul class="small">
                            <li><span class="badge bg-primary">Owner</span> - Full control, cannot be changed or revoked</li>
                            <li><span class="badge bg-info">Administrator</span> - Delegated admin access</li>
                            <li><span class="badge bg-success">PropertyManager</span> - Property operations only</li>
                            <li><span class="badge bg-secondary">User</span> - Limited/view-only access</li>
                        </ul>
                        <hr />
                        <p class="small mb-0"><strong>Note:</strong> The organization owner cannot be changed or have their access revoked. To transfer ownership, contact support.</p>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<!-- Add User Modal -->
@if (showAddUserModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add User to Organization</h5>
                    <button type="button" class="btn-close" @onclick="HideAddUserModal"></button>
                </div>
                <div class="modal-body">
                    @if (!string.IsNullOrEmpty(addUserError))
                    {
                        <div class="alert alert-danger">@addUserError</div>
                    }

                    <div class="mb-3">
                        <label for="userSelect" class="form-label">Select User</label>
                        <select id="userSelect" class="form-select" @bind="selectedUserId">
                            <option value="">-- Select User --</option>
                            @foreach (var user in availableUsers)
                            {
                                <option value="@user.Id">@user.Email</option>
                            }
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="roleSelect" class="form-label">Assign Role</label>
                        <select id="roleSelect" class="form-select" @bind="selectedRole">
                            @foreach (var role in ApplicationConstants.OrganizationRoles.AllRoles)
                            {
                                @if (role != ApplicationConstants.OrganizationRoles.Owner)
                                {
                                    <option value="@role">@role</option>
                                }
                            }
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <div>
                        <button type="button" class="btn btn-outline-primary" @onclick="AddApplicationUser">
                            <i class="bi bi-people-plus"></i> Add Application User
                        </button>
                    </div>
                    <button type="button" class="btn btn-secondary" @onclick="HideAddUserModal">Cancel</button>
                    <button type="button" class="btn btn-primary" @onclick="AddUser" disabled="@string.IsNullOrEmpty(selectedUserId)">
                        <i class="bi bi-person-plus"></i> Add User
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public Guid Id { get; set; } = Guid.Empty;

    private bool isLoading = true;
    private Organization? organization;
    private List<UserOrganization> organizationUsers = new();
    private Dictionary<string, string> userEmails = new();
    private bool showAddUserModal = false;
    private List<ApplicationUser> availableUsers = new();
    private string selectedUserId = string.Empty;
    private string selectedRole = ApplicationConstants.OrganizationRoles.User;
    private string addUserError = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadOrganization();
    }

    private async Task LoadOrganization()
    {
        isLoading = true;
        try
        {
            string? userId = await UserContext.GetUserIdAsync();
            if (string.IsNullOrEmpty(userId))
            {
                return;
            }

            // Check if user can manage this organization (Owner or Administrator)
            var userRole = await OrganizationService.GetUserRoleForOrganizationAsync(userId, Id);
            if (userRole != ApplicationConstants.OrganizationRoles.Owner && 
                userRole != ApplicationConstants.OrganizationRoles.Administrator)
            {
                organization = null;
                return;
            }

            organization = await OrganizationService.GetOrganizationByIdAsync(Id);
            if (organization != null)
            {
                await LoadOrganizationUsers();
                await LoadAvailableUsers();
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error loading organization: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadOrganizationUsers()
    {
        if (organization == null) return;

        organizationUsers = await OrganizationService.GetOrganizationUsersAsync(Id);

        // Load user emails
        foreach (var userOrg in organizationUsers)
        {
            var user = await UserManager.FindByIdAsync(userOrg.UserId);
            if (user != null)
            {
                userEmails[userOrg.UserId] = user.Email ?? "Unknown";
            }

            var grantedByUser = await UserManager.FindByIdAsync(userOrg.GrantedBy);
            if (grantedByUser != null)
            {
                userEmails[userOrg.GrantedBy] = grantedByUser.Email ?? "Unknown";
            }
        }
    }

    private async Task LoadAvailableUsers()
    {
        if (organization == null) return;

        // Get all users who are NOT already assigned to this organization
        var allUsers = await UserManager.Users.ToListAsync();
        var nonSystemUsers = allUsers.Where(u => u.Id != ApplicationConstants.SystemUser.Id).ToList();
        var assignedUserIds = organizationUsers.Select(u => u.UserId).ToHashSet();
        
        availableUsers = nonSystemUsers.Where(u => !assignedUserIds.Contains(u.Id)).ToList();
    }

    private string GetUserEmail(string userId)
    {
        return userEmails.ContainsKey(userId) ? userEmails[userId] : "Unknown";
    }

    private string GetRoleBadgeClass(string role)
    {
        return role switch
        {
            ApplicationConstants.OrganizationRoles.Owner => "bg-primary",
            ApplicationConstants.OrganizationRoles.Administrator => "bg-info",
            ApplicationConstants.OrganizationRoles.PropertyManager => "bg-success",
            ApplicationConstants.OrganizationRoles.User => "bg-secondary",
            _ => "bg-secondary"
        };
    }

    private async Task ChangeUserRole(UserOrganization userOrg, string newRole)
    {
        try
        {
            if (newRole == userOrg.Role) return;

            var currentUserId = await UserContext.GetUserIdAsync();
            if (string.IsNullOrEmpty(currentUserId))
            {
                ToastService.ShowError("User not found");
                return;
            }

            var success = await OrganizationService.UpdateUserRoleAsync(userOrg.UserId, Id, newRole, currentUserId);
            
            if (success)
            {
                ToastService.ShowSuccess($"User role updated to {newRole}");
                await LoadOrganizationUsers();
            }
            else
            {
                ToastService.ShowError("Failed to update user role");
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error updating role: {ex.Message}");
        }
    }

    private async Task RevokeUserAccess(UserOrganization userOrg)
    {
        if (!await JSRuntime.InvokeAsync<bool>("confirm", $"Are you sure you want to revoke {GetUserEmail(userOrg.UserId)}'s access to this organization?"))
        {
            return;
        }

        try
        {
            var currentUserId = await UserContext.GetUserIdAsync();
            if (string.IsNullOrEmpty(currentUserId))
            {
                ToastService.ShowError("User not found");
                return;
            }

            var success = await OrganizationService.RevokeOrganizationAccessAsync(userOrg.UserId, Id, currentUserId);
            
            if (success)
            {
                ToastService.ShowSuccess("User access revoked");
                await LoadOrganizationUsers();
            }
            else
            {
                ToastService.ShowError("Failed to revoke user access");
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error revoking access: {ex.Message}");
        }
    }

    private void ShowAddUserModal()
    {
        addUserError = string.Empty;
        selectedUserId = string.Empty;
        selectedRole = ApplicationConstants.OrganizationRoles.User;
        showAddUserModal = true;
    }

    private void HideAddUserModal()
    {
        showAddUserModal = false;
    }

    private void AddApplicationUser()
    {
        Navigation.NavigateTo("/administration/users/create?returnUrl=" + Uri.EscapeDataString($"/administration/organizations/{Id}/users"));
    }
    private async Task AddUser()
    {
        addUserError = string.Empty;

        if (string.IsNullOrEmpty(selectedUserId))
        {
            addUserError = "Please select a user";
            return;
        }

        try
        {
            var currentUserId = await UserContext.GetUserIdAsync();
            if (string.IsNullOrEmpty(currentUserId))
            {
                addUserError = "Current user not found";
                return;
            }

            var success = await OrganizationService.GrantOrganizationAccessAsync(
                selectedUserId,
                Id,
                selectedRole,
                currentUserId
            );

            if (success)
            {
                ToastService.ShowSuccess($"User added with {selectedRole} role");
                showAddUserModal = false;
                await LoadOrganizationUsers();
                await LoadAvailableUsers();
            }
            else
            {
                addUserError = "Failed to grant organization access";
            }
        }
        catch (Exception ex)
        {
            addUserError = $"Error adding user: {ex.Message}";
        }
    }

    private void Cancel()
    {
        Navigation.NavigateTo($"/administration/organizations/view/{Id}");
    }
}
