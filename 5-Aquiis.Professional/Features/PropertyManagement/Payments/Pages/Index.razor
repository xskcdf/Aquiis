@page "/propertymanagement/payments"
@using Aquiis.Professional.Features.PropertyManagement
@using Aquiis.Core.Entities
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Components.Forms
@inject NavigationManager Navigation
@inject PaymentService PaymentService
@inject IJSRuntime JSRuntime

@attribute [OrganizationAuthorize("Owner", "Administrator", "PropertyManager")]
@rendermode InteractiveServer

<PageTitle>Payments - Property Management</PageTitle>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><span class="bi bi-cash-coin" aria-hidden="true"></span> Payments</h1>
    <button class="btn btn-primary" @onclick="CreatePayment">
        <i class="bi bi-plus-lg"></i> Record Payment
    </button>
</div>

@if (payments == null)
{
    <div class="text-center">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}
else if (!payments.Any())
{
    <div class="alert alert-info">
        <h4>No Payments Found</h4>
        <p>Get started by recording your first payment.</p>
        <button class="btn btn-primary" @onclick="CreatePayment">Record First Payment</button>
    </div>
}
else
{
    <div class="row mb-3">
        <div class="col-md-3">
            <div class="input-group">
                <span class="input-group-text"><i class="bi bi-search"></i></span>
                <input type="text" class="form-control" placeholder="Search payments..." @bind="searchTerm" @onkeyup="FilterPayments" />
            </div>
        </div>
        <div class="col-md-3">
            <select class="form-select" @bind="selectedMethod" @bind:after="FilterPayments">
                <option value="">All Payment Methods</option>
                <option value="Cash">Cash</option>
                <option value="Check">Check</option>
                <option value="Credit Card">Credit Card</option>
                <option value="Debit Card">Debit Card</option>
                <option value="Bank Transfer">Bank Transfer</option>
                <option value="Online Payment">Online Payment</option>
                <option value="Other">Other</option>
            </select>
        </div>
        <div class="col-md-3">
            <div class="form-check form-switch pt-2">
                <input class="form-check-input" type="checkbox" id="groupByInvoice" @bind="groupByInvoice" @bind:after="FilterPayments">
                <label class="form-check-label" for="groupByInvoice">
                    Group by Invoice
                </label>
            </div>
        </div>
        <div class="col-md-3">
            <button class="btn btn-outline-secondary" @onclick="ClearFilters">
                <i class="bi bi-x-circle"></i> Clear Filters
            </button>
        </div>
    </div>

    <div class="row mb-3">
        <div class="col-md-3">
            <div class="card text-white bg-success">
                <div class="card-body">
                    <h6>Total Payments</h6>
                    <h4>@paymentsCount</h4>
                    <small>@totalAmount.ToString("C")</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-primary">
                <div class="card-body">
                    <h6>This Month</h6>
                    <h4>@thisMonthCount</h4>
                    <small>@thisMonthAmount.ToString("C")</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-info">
                <div class="card-body">
                    <h6>This Year</h6>
                    <h4>@thisYearCount</h4>
                    <small>@thisYearAmount.ToString("C")</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-warning">
                <div class="card-body">
                    <h6>Average Payment</h6>
                    <h4>@averageAmount.ToString("C")</h4>
                    <small>Per transaction</small>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            @if (groupByInvoice)
            {
                @foreach (var invoiceGroup in groupedPayments)
                {
                    var invoice = invoiceGroup.First().Invoice;
                    var invoiceTotal = invoiceGroup.Sum(p => p.Amount);
                    var isExpanded = expandedInvoices.Contains(invoiceGroup.Key);
                    
                    <div class="card mb-3">
                        <div class="card-header" style="cursor: pointer;" @onclick="() => ToggleInvoiceGroup(invoiceGroup.Key)">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="bi @(isExpanded ? "bi-chevron-down" : "bi-chevron-right")"></i>
                                    <strong>Invoice: @invoice?.InvoiceNumber</strong>
                                    <span class="ms-3 text-muted">@invoice?.Lease?.Property?.Address</span>
                                    <span class="ms-2 text-muted">â€¢ @invoice?.Lease?.Tenant?.FullName</span>
                                </div>
                                <div>
                                    <span class="badge bg-secondary me-2">@invoiceGroup.Count() payment(s)</span>
                                    <strong class="text-success">@invoiceTotal.ToString("C")</strong>
                                </div>
                            </div>
                        </div>
                        @if (isExpanded)
                        {
                            <div class="card-body p-0">
                                <table class="table table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Payment Date</th>
                                            <th>Amount</th>
                                            <th>Payment Method</th>
                                            <th>Notes</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var payment in invoiceGroup)
                                        {
                                            <tr @onclick="() => ViewPayment(payment.Id)" style="cursor: pointer;">
                                                <td>@payment.PaidOn.ToString("MMM dd, yyyy")</td>
                                                <td><strong class="text-success">@payment.Amount.ToString("C")</strong></td>
                                                <td><span class="badge bg-secondary">@payment.PaymentMethod</span></td>
                                                <td>@(string.IsNullOrEmpty(payment.Notes) ? "-" : payment.Notes)</td>
                                                <td @onclick:stopPropagation="true">
                                                    <div class="btn-group" role="group">
                                                        <button class="btn btn-sm btn-outline-primary" @onclick="() => ViewPayment(payment.Id)" title="View">
                                                            <i class="bi bi-eye"></i>
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-secondary" @onclick="() => EditPayment(payment.Id)" title="Edit">
                                                            <i class="bi bi-pencil"></i>
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-danger" @onclick="() => DeletePayment(payment)" title="Delete">
                                                            <i class="bi bi-trash"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                    </div>
                }
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>
                                    <button class="btn btn-link p-0 text-decoration-none text-dark fw-bold" @onclick="() => SortBy(nameof(Payment.PaidOn))">
                                        Payment Date
                                        @if (sortColumn == nameof(Payment.PaidOn))
                                        {
                                            <i class="bi @(sortAscending ? "bi-caret-up" : "bi-caret-down")"></i>
                                        }
                                    </button>
                                </th>
                                <th>Invoice #</th>
                                <th>Property</th>
                                <th>Tenant</th>
                                <th>
                                    <button class="btn btn-link p-0 text-decoration-none text-dark fw-bold" @onclick="() => SortBy(nameof(Payment.Amount))">
                                        Amount
                                        @if (sortColumn == nameof(Payment.Amount))
                                        {
                                            <i class="bi @(sortAscending ? "bi-caret-up" : "bi-caret-down")"></i>
                                        }
                                    </button>
                                </th>
                                <th>Payment Method</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var payment in pagedPayments)
                            {
                                <tr @onclick="() => ViewPayment(payment.Id)" style="cursor: pointer;">
                                    <td>@payment.PaidOn.ToString("MMM dd, yyyy")</td>
                                    <td>
                                        <a href="/propertymanagement/invoices/view/@payment.InvoiceId" @onclick:stopPropagation="true">
                                            @payment.Invoice?.InvoiceNumber
                                        </a>
                                    </td>
                                    <td>@payment.Invoice?.Lease?.Property?.Address</td>
                                    <td>@payment.Invoice?.Lease?.Tenant?.FullName</td>
                                    <td><strong class="text-success">@payment.Amount.ToString("C")</strong></td>
                                    <td>
                                        <span class="badge bg-secondary">@payment.PaymentMethod</span>
                                    </td>
                                    <td @onclick:stopPropagation="true">
                                        <div class="btn-group" role="group">
                                            <button class="btn btn-sm btn-outline-primary" @onclick="() => ViewPayment(payment.Id)" title="View">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-secondary" @onclick="() => EditPayment(payment.Id)" title="Edit">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger" @onclick="() => DeletePayment(payment)" title="Delete">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }

            @if (totalPages > 1 && !groupByInvoice)
            {
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <div>
                        <select class="form-select form-select-sm" @bind="pageSize" @bind:after="UpdatePagination">
                            <option value="10">10 per page</option>
                            <option value="20">20 per page</option>
                            <option value="50">50 per page</option>
                            <option value="100">100 per page</option>
                        </select>
                    </div>
                    <div class="text-muted">
                        Showing @((currentPage - 1) * pageSize + 1) to @Math.Min(currentPage * pageSize, totalRecords) of @totalRecords payments
                    </div>
                    <nav>
                        <ul class="pagination pagination-sm mb-0">
                            <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                                <button class="page-link" @onclick="FirstPage" disabled="@(currentPage == 1)">
                                    <i class="bi bi-chevron-double-left"></i>
                                </button>
                            </li>
                            <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                                <button class="page-link" @onclick="PreviousPage" disabled="@(currentPage == 1)">
                                    <i class="bi bi-chevron-left"></i>
                                </button>
                            </li>
                            @for (int i = Math.Max(1, currentPage - 2); i <= Math.Min(totalPages, currentPage + 2); i++)
                            {
                                var pageNum = i;
                                <li class="page-item @(currentPage == pageNum ? "active" : "")">
                                    <button class="page-link" @onclick="() => GoToPage(pageNum)">@pageNum</button>
                                </li>
                            }
                            <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                                <button class="page-link" @onclick="NextPage" disabled="@(currentPage == totalPages)">
                                    <i class="bi bi-chevron-right"></i>
                                </button>
                            </li>
                            <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                                <button class="page-link" @onclick="LastPage" disabled="@(currentPage == totalPages)">
                                    <i class="bi bi-chevron-double-right"></i>
                                </button>
                            </li>
                        </ul>
                    </nav>
                </div>
            }
        </div>
    </div>
}

@code {
    private List<Payment>? payments;
    private List<Payment> filteredPayments = new();
    private List<Payment> pagedPayments = new();
    private IEnumerable<IGrouping<Guid, Payment>> groupedPayments = Enumerable.Empty<IGrouping<Guid, Payment>>();
    private HashSet<Guid> expandedInvoices = new();
    private string searchTerm = string.Empty;
    private string selectedMethod = string.Empty;
    private string sortColumn = nameof(Payment.PaidOn);
    private bool sortAscending = false;
    private bool groupByInvoice = true;
    
    private int paymentsCount = 0;
    private int thisMonthCount = 0;
    private int thisYearCount = 0;
    private decimal totalAmount = 0;
    private decimal thisMonthAmount = 0;
    private decimal thisYearAmount = 0;
    private decimal averageAmount = 0;
    
    private int currentPage = 1;
    private int pageSize = 20;
    private int totalPages = 1;
    private int totalRecords = 0;

    [CascadingParameter]
    private Task<AuthenticationState> AuthenticationStateTask { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        await LoadPayments();
    }

    private async Task LoadPayments()
    {
        var authState = await AuthenticationStateTask;
        var userId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

        if (!string.IsNullOrEmpty(userId))
        {
            payments = await PaymentService.GetAllAsync();
            FilterPayments();
            UpdateStatistics();
        }
    }

    private void FilterPayments()
    {
        if (payments == null) return;

        filteredPayments = payments.Where(p =>
        {
            bool matchesSearch = string.IsNullOrWhiteSpace(searchTerm) ||
                (p.Invoice?.InvoiceNumber?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false) ||
                (p.Invoice?.Lease?.Property?.Address?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false) ||
                (p.Invoice?.Lease?.Tenant?.FullName?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false) ||
                p.PaymentMethod.Contains(searchTerm, StringComparison.OrdinalIgnoreCase);

            bool matchesMethod = string.IsNullOrWhiteSpace(selectedMethod) ||
                p.PaymentMethod.Equals(selectedMethod, StringComparison.OrdinalIgnoreCase);

            return matchesSearch && matchesMethod;
        }).ToList();

        SortPayments();
        
        if (groupByInvoice)
        {
            groupedPayments = filteredPayments
                .GroupBy(p => p.InvoiceId)
                .OrderByDescending(g => g.Max(p => p.PaidOn))
                .ToList();
        }
        else
        {
            UpdatePagination();
        }
    }

    private void ToggleInvoiceGroup(Guid invoiceId)
    {
        if (expandedInvoices.Contains(invoiceId))
        {
            expandedInvoices.Remove(invoiceId);
        }
        else
        {
            expandedInvoices.Add(invoiceId);
        }
    }

    private void SortBy(string column)
    {
        if (sortColumn == column)
        {
            sortAscending = !sortAscending;
        }
        else
        {
            sortColumn = column;
            sortAscending = true;
        }
        SortPayments();
        UpdatePagination();
    }

    private void SortPayments()
    {
        filteredPayments = sortColumn switch
        {
            nameof(Payment.PaidOn) => sortAscending
                ? filteredPayments.OrderBy(p => p.PaidOn).ToList()
                : filteredPayments.OrderByDescending(p => p.PaidOn).ToList(),
            nameof(Payment.Amount) => sortAscending
                ? filteredPayments.OrderBy(p => p.Amount).ToList()
                : filteredPayments.OrderByDescending(p => p.Amount).ToList(),
            _ => filteredPayments.OrderByDescending(p => p.PaidOn).ToList()
        };
    }

    private void UpdateStatistics()
    {
        if (payments == null) return;

        var now = DateTime.Now;
        var firstDayOfMonth = new DateTime(now.Year, now.Month, 1);
        var firstDayOfYear = new DateTime(now.Year, 1, 1);

        paymentsCount = payments.Count;
        thisMonthCount = payments.Count(p => p.PaidOn >= firstDayOfMonth);
        thisYearCount = payments.Count(p => p.PaidOn >= firstDayOfYear);
        
        totalAmount = payments.Sum(p => p.Amount);
        thisMonthAmount = payments.Where(p => p.PaidOn >= firstDayOfMonth).Sum(p => p.Amount);
        thisYearAmount = payments.Where(p => p.PaidOn >= firstDayOfYear).Sum(p => p.Amount);
        averageAmount = paymentsCount > 0 ? totalAmount / paymentsCount : 0;
    }

    private void UpdatePagination()
    {
        totalRecords = filteredPayments.Count;
        totalPages = (int)Math.Ceiling(totalRecords / (double)pageSize);
        currentPage = Math.Min(currentPage, Math.Max(1, totalPages));
        
        pagedPayments = filteredPayments
            .Skip((currentPage - 1) * pageSize)
            .Take(pageSize)
            .ToList();
    }

    private void ClearFilters()
    {
        searchTerm = string.Empty;
        selectedMethod = string.Empty;
        groupByInvoice = false;
        FilterPayments();
    }

    private void FirstPage() => GoToPage(1);
    private void LastPage() => GoToPage(totalPages);
    private void NextPage() => GoToPage(currentPage + 1);
    private void PreviousPage() => GoToPage(currentPage - 1);
    
    private void GoToPage(int page)
    {
        currentPage = Math.Max(1, Math.Min(page, totalPages));
        UpdatePagination();
    }

    private void CreatePayment()
    {
        Navigation.NavigateTo("/propertymanagement/payments/create");
    }

    private void ViewPayment(Guid id)
    {
        Navigation.NavigateTo($"/propertymanagement/payments/{id}");
    }

    private void EditPayment(Guid id)
    {
        Navigation.NavigateTo($"/propertymanagement/payments/{id}/edit");
    }

    private async Task DeletePayment(Payment payment)
    {
        if (await JSRuntime.InvokeAsync<bool>("confirm", $"Are you sure you want to delete this payment of {payment.Amount:C}?"))
        {
            await PaymentService.DeleteAsync(payment.Id);
            await LoadPayments();
        }
    }
}
