@page "/propertymanagement/invoices/edit/{Id:guid}"

@using Aquiis.Professional.Features.PropertyManagement
@using Aquiis.Core.Entities
@using Aquiis.Core.Validation
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Components.Forms
@using System.ComponentModel.DataAnnotations
@inject NavigationManager NavigationManager
@inject InvoiceService InvoiceService
@inject LeaseService LeaseService

@attribute [OrganizationAuthorize("Owner", "Administrator", "PropertyManager")]
@rendermode InteractiveServer

<PageTitle>Edit Invoice - Property Management</PageTitle>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="bi bi-receipt"></i> Edit Invoice</h1>
    <button class="btn btn-outline-secondary" @onclick="Cancel">
        <i class="bi bi-x-lg"></i> Cancel
    </button>
</div>

@if (errorMessage != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @errorMessage
        <button type="button" class="btn-close" @onclick="() => errorMessage = null"></button>
    </div>
}

@if (successMessage != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @successMessage
        <button type="button" class="btn-close" @onclick="() => successMessage = null"></button>
    </div>
}

@if (invoice == null)
{
    <div class="text-center">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}
else
{
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Invoice Information</h5>
                </div>
                <div class="card-body">
                    <EditForm Model="invoiceModel" OnValidSubmit="UpdateInvoice">
                        <DataAnnotationsValidator />
                        <ValidationSummary class="text-danger" />

                        <div class="mb-3">
                            <label class="form-label">Invoice Number</label>
                            <InputText @bind-Value="invoiceModel.InvoiceNumber" class="form-control" readonly />
                            <ValidationMessage For="() => invoiceModel.InvoiceNumber" class="text-danger" />
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Invoice Date <span class="text-danger">*</span></label>
                                <InputDate @bind-Value="invoiceModel.InvoicedOn" class="form-control" />
                                <ValidationMessage For="() => invoiceModel.InvoicedOn" class="text-danger" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Due Date <span class="text-danger">*</span></label>
                                <InputDate @bind-Value="invoiceModel.DueOn" class="form-control" />
                                <ValidationMessage For="() => invoiceModel.DueOn" class="text-danger" />
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Lease</label>
                            <InputSelect @bind-Value="invoiceModel.LeaseId" class="form-select" disabled>
                                @if (leases != null)
                                {
                                    @foreach (var lease in leases)
                                    {
                                        <option value="@lease.Id">
                                            @lease.Property?.Address - @lease.Tenant?.FullName (@lease.MonthlyRent.ToString("C")/month)
                                        </option>
                                    }
                                }
                            </InputSelect>
                            <small class="text-muted">Lease cannot be changed after invoice creation</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Description <span class="text-danger">*</span></label>
                            <InputText @bind-Value="invoiceModel.Description" class="form-control" />
                            <ValidationMessage For="() => invoiceModel.Description" class="text-danger" />
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Amount <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <InputNumber @bind-Value="invoiceModel.Amount" class="form-control" step="0.01" />
                                </div>
                                <ValidationMessage For="() => invoiceModel.Amount" class="text-danger" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Status</label>
                                <InputSelect @bind-Value="invoiceModel.Status" class="form-select">
                                    <option value="Pending">Pending</option>
                                    <option value="Paid">Paid</option>
                                    <option value="Overdue">Overdue</option>
                                    <option value="Cancelled">Cancelled</option>
                                </InputSelect>
                                <ValidationMessage For="() => invoiceModel.Status" class="text-danger" />
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Paid Amount</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <InputNumber @bind-Value="invoiceModel.AmountPaid" class="form-control" step="0.01" />
                                </div>
                                <ValidationMessage For="() => invoiceModel.AmountPaid" class="text-danger" />
                                <small class="text-muted">Balance Due: @((invoiceModel.Amount - invoiceModel.AmountPaid).ToString("C"))</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Paid Date</label>
                                <InputDate @bind-Value="invoiceModel.PaidOn" class="form-control" />
                                <ValidationMessage For="() => invoiceModel.PaidOn" class="text-danger" />
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Notes</label>
                            <InputTextArea @bind-Value="invoiceModel.Notes" class="form-control" rows="3" />
                            <ValidationMessage For="() => invoiceModel.Notes" class="text-danger" />
                        </div>

                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary" disabled="@isSubmitting">
                                @if (isSubmitting)
                                {
                                    <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                }
                                <i class="bi bi-check-lg"></i> Save Changes
                            </button>
                            <button type="button" class="btn btn-outline-primary" @onclick="ViewInvoice">View Invoice</button>
                            <button type="button" class="btn btn-outline-secondary" @onclick="Cancel">Cancel</button>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="mb-0">Invoice Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary" @onclick="ViewInvoice">
                            <i class="bi bi-eye"></i> View Invoice
                        </button>
                        @if (invoice.Status != "Paid" && invoice.BalanceDue > 0)
                        {
                            <button class="btn btn-outline-success" @onclick="RecordPayment">
                                <i class="bi bi-cash"></i> Record Payment
                            </button>
                        }
                        <button class="btn btn-outline-info" @onclick="ViewLease">
                            <i class="bi bi-file-text"></i> View Lease
                        </button>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Invoice Summary</h5>
                </div>
                <div class="card-body">
                    <div class="mb-2">
                        <small class="text-muted">Status</small>
                        <div>
                            <span class="badge @GetStatusBadgeClass(invoice.Status)">@invoice.Status</span>
                        </div>
                    </div>
                    <div class="mb-2">
                        <small class="text-muted">Invoice Amount</small>
                        <div class="fw-bold">@invoice.Amount.ToString("C")</div>
                    </div>
                    <div class="mb-2">
                        <small class="text-muted">Paid Amount</small>
                        <div class="text-success">@invoice.AmountPaid.ToString("C")</div>
                    </div>
                    <div class="mb-2">
                        <small class="text-muted">Balance Due</small>
                        <div class="fw-bold @(invoice.BalanceDue > 0 ? "text-danger" : "text-success")">
                            @invoice.BalanceDue.ToString("C")
                        </div>
                    </div>
                    @if (invoice.IsOverdue)
                    {
                        <div class="alert alert-danger mb-0 mt-2">
                            <small>
                                <i class="bi bi-exclamation-triangle"></i>
                                @invoice.DaysOverdue days overdue
                            </small>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public Guid Id { get; set; }

    private Invoice? invoice;
    private InvoiceModel invoiceModel = new InvoiceModel();
    private List<Lease>? leases;
    private string? errorMessage;
    private string? successMessage;
    private bool isSubmitting = false;

    [CascadingParameter]
    private Task<AuthenticationState> AuthenticationStateTask { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        await LoadInvoice();
        await LoadLeases();
    }

    private async Task LoadInvoice()
    {
        invoice = await InvoiceService.GetByIdAsync(Id);
        
        if (invoice != null)
        {
            invoiceModel = new InvoiceModel
            {
                LeaseId = invoice.LeaseId,
                InvoiceNumber = invoice.InvoiceNumber,
                InvoicedOn = invoice.InvoicedOn,
                DueOn = invoice.DueOn,
                Amount = invoice.Amount,
                Description = invoice.Description,
                Status = invoice.Status,
                AmountPaid = invoice.AmountPaid,
                PaidOn = invoice.PaidOn,
                Notes = invoice.Notes
            };
        }
    }

    private async Task LoadLeases()
    {
        var authState = await AuthenticationStateTask;
        var userId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

        if (!string.IsNullOrEmpty(userId))
        {
            leases = await LeaseService.GetAllAsync();
        }
    }

    private async Task UpdateInvoice()
    {
        try
        {
            isSubmitting = true;
            errorMessage = null;
            successMessage = null;

            var authState = await AuthenticationStateTask;
            var userId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

            if (string.IsNullOrEmpty(userId))
            {
                errorMessage = "User not authenticated.";
                return;
            }

            if (invoice == null)
            {
                errorMessage = "Invoice not found.";
                return;
            }

            invoice.InvoicedOn = invoiceModel.InvoicedOn;
            invoice.DueOn = invoiceModel.DueOn;
            invoice.Amount = invoiceModel.Amount;
            invoice.Description = invoiceModel.Description;
            invoice.Status = invoiceModel.Status;
            invoice.AmountPaid = invoiceModel.AmountPaid;
            invoice.PaidOn = invoiceModel.PaidOn;
            invoice.Notes = invoiceModel.Notes ?? string.Empty;

            await InvoiceService.UpdateAsync(invoice);

            successMessage = "Invoice updated successfully!";
        }
        catch (Exception ex)
        {
            errorMessage = $"Error updating invoice: {ex.Message}";
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private string GetStatusBadgeClass(string status)
    {
        return status switch
        {
            "Paid" => "bg-success",
            "Pending" => "bg-warning",
            "Overdue" => "bg-danger",
            "Cancelled" => "bg-secondary",
            _ => "bg-info"
        };
    }

    private void ViewInvoice()
    {
        NavigationManager.NavigateTo($"/propertymanagement/invoices/{Id}");
    }

    private void ViewLease()
    {
        if (invoice?.LeaseId != null)
        {
            NavigationManager.NavigateTo($"/propertymanagement/leases/{invoice.LeaseId}");
        }
    }

    private void RecordPayment()
    {
        NavigationManager.NavigateTo($"/propertymanagement/payments/create?invoiceId={Id}");
    }

    private void Cancel()
    {
        NavigationManager.NavigateTo("/propertymanagement/invoices");
    }

    public class InvoiceModel
    {
        [RequiredGuid(ErrorMessage = "Lease is required")]
        public Guid LeaseId { get; set; }

        [Required(ErrorMessage = "Invoice number is required")]
        [StringLength(50, ErrorMessage = "Invoice number cannot exceed 50 characters")]
        public string InvoiceNumber { get; set; } = string.Empty;

        [Required(ErrorMessage = "Invoice date is required")]
        public DateTime InvoicedOn { get; set; }

        [Required(ErrorMessage = "Due date is required")]
        public DateTime DueOn { get; set; }

        [Required(ErrorMessage = "Amount is required")]
        [Range(0.01, double.MaxValue, ErrorMessage = "Amount must be greater than 0")]
        public decimal Amount { get; set; }

        [Required(ErrorMessage = "Description is required")]
        [StringLength(100, ErrorMessage = "Description cannot exceed 100 characters")]
        public string Description { get; set; } = string.Empty;

        [Required]
        [StringLength(50)]
        public string Status { get; set; } = "Pending";

        [Range(0, double.MaxValue, ErrorMessage = "Paid amount cannot be negative")]
        public decimal AmountPaid { get; set; }

        public DateTime? PaidOn { get; set; }

        [StringLength(500, ErrorMessage = "Notes cannot exceed 500 characters")]
        public string? Notes { get; set; }
    }
}
