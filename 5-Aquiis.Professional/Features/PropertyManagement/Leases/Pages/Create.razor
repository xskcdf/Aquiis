@page "/propertymanagement/leases/create"

@using Aquiis.Core.Entities
@using Aquiis.Core.Constants
@using Aquiis.Core.Validation
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Authorization
@using System.ComponentModel.DataAnnotations

@inject NavigationManager Navigation
@inject OrganizationService OrganizationService
@inject LeaseService LeaseService
@inject PropertyService PropertyService
@inject TenantService TenantService

@inject AuthenticationStateProvider AuthenticationStateProvider

@attribute [OrganizationAuthorize("Owner", "Administrator", "PropertyManager")]
@rendermode InteractiveServer

<PageTitle>Create Lease</PageTitle>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title mb-0">Create New Lease</h3>
            </div>
            <div class="card-body">
                <EditForm Model="leaseModel" OnValidSubmit="HandleValidSubmit" FormName="create-lease">
                    <DataAnnotationsValidator />
                    <ValidationSummary class="text-danger mb-3" />
                    
                    @if (!string.IsNullOrEmpty(errorMessage))
                    {
                        <div class="alert alert-danger" role="alert">
                            @errorMessage
                        </div>
                    }

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Property *</label>
                            <InputSelect @bind-Value="leaseModel.PropertyId" class="form-select" @onchange="@(async () => await OnPropertyChanged())">
                                <option value="">Select a property</option>
                                @foreach (var property in availableProperties)
                                {
                                    <option value="@property.Id">@property.Address (@property.City)</option>
                                }
                            </InputSelect>
                            <ValidationMessage For="() => leaseModel.PropertyId" class="text-danger" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Tenant *</label>
                            <InputSelect @bind-Value="leaseModel.TenantId" class="form-select">
                                <option value="">Select a tenant</option>
                                @foreach (var tenant in userTenants)
                                {
                                    <option value="@tenant.Id">@tenant.FullName (@tenant.Email)</option>
                                }
                            </InputSelect>
                            <ValidationMessage For="() => leaseModel.TenantId" class="text-danger" />
                        </div>
                    </div>

                    @if (selectedProperty != null)
                    {
                        <div class="alert alert-info">
                            <strong>Selected Property:</strong> @selectedProperty.Address<br />
                            <strong>Monthly Rent:</strong> @selectedProperty.MonthlyRent.ToString("C")
                        </div>
                    }

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Start Date *</label>
                            <InputDate @bind-Value="leaseModel.StartDate" class="form-control" />
                            <ValidationMessage For="() => leaseModel.StartDate" class="text-danger" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">End Date *</label>
                            <InputDate @bind-Value="leaseModel.EndDate" class="form-control" />
                            <ValidationMessage For="() => leaseModel.EndDate" class="text-danger" />
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Monthly Rent *</label>
                            <InputNumber @bind-Value="leaseModel.MonthlyRent" class="form-control" placeholder="0.00" />
                            <ValidationMessage For="() => leaseModel.MonthlyRent" class="text-danger" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Security Deposit</label>
                            <InputNumber @bind-Value="leaseModel.SecurityDeposit" class="form-control" placeholder="0.00" />
                            <ValidationMessage For="() => leaseModel.SecurityDeposit" class="text-danger" />
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Status</label>
                            <InputSelect @bind-Value="leaseModel.Status" class="form-select">
                                @foreach (var status in ApplicationConstants.LeaseStatuses.AllLeaseStatuses)
                                {
                                    <option value="@status">@status</option>
                                }
                            </InputSelect>
                            <ValidationMessage For="() => leaseModel.Status" class="text-danger" />
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label class="form-label">Lease Terms</label>
                            <InputTextArea @bind-Value="leaseModel.Terms" class="form-control" rows="4" placeholder="Enter lease terms and conditions" />
                            <ValidationMessage For="() => leaseModel.Terms" class="text-danger" />
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label class="form-label">Notes</label>
                            <InputTextArea @bind-Value="leaseModel.Notes" class="form-control" rows="3" placeholder="Additional notes" />
                            <ValidationMessage For="() => leaseModel.Notes" class="text-danger" />
                        </div>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary" disabled="@isSubmitting">
                            @if (isSubmitting)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                            }
                            Create Lease
                        </button>
                        <button type="button" class="btn btn-secondary" @onclick="Cancel">Cancel</button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary" @onclick="CreateTenant">
                        <i class="bi bi-person-plus"></i> Add New Tenant
                    </button>
                </div>
            </div>
        </div>

        @if (selectedProperty != null)
        {
            <div class="card mt-3">
                <div class="card-header">
                    <h5 class="mb-0">Property Details</h5>
                </div>
                <div class="card-body">
                    <p><strong>Address:</strong> @selectedProperty.Address</p>
                    <p><strong>Type:</strong> @selectedProperty.PropertyType</p>
                    <p><strong>Bedrooms:</strong> @selectedProperty.Bedrooms</p>
                    <p><strong>Bathrooms:</strong> @selectedProperty.Bathrooms</p>
                    <p><strong>Square Feet:</strong> @selectedProperty.SquareFeet.ToString("N0")</p>
                </div>
            </div>
        }
    </div>
</div>

@code {
    [Parameter]
    [SupplyParameterFromQuery]
    public Guid? PropertyId { get; set; }

    [Parameter]
    [SupplyParameterFromQuery]
    public Guid? TenantId { get; set; }

    private LeaseModel leaseModel = new();
    private List<Property> availableProperties = new();
    private List<Tenant> userTenants = new();
    private Property? selectedProperty;
    private bool isSubmitting = false;
    private string errorMessage = string.Empty;

        [CascadingParameter]
    private Task<AuthenticationState> AuthenticationStateTask { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
        
        // If PropertyId is provided in query string, pre-select it
        if (PropertyId.HasValue)
        {
            leaseModel.PropertyId = PropertyId.Value;
            await OnPropertyChanged();
        }
        
        // If TenantId is provided in query string, pre-select it
        if (TenantId.HasValue)
        {
            leaseModel.TenantId = TenantId.Value;
        }
    }

    private async Task LoadData()
    {
        var authState = await AuthenticationStateTask;
        var userId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

        if (string.IsNullOrEmpty(userId))
            return;

        // Load available properties (only available ones)
        List<Property>? allProperties = await PropertyService.GetAllAsync();

        availableProperties = allProperties
            .Where(p => p.IsAvailable)
            .ToList() ?? new List<Property>();

        // Load user's tenants
        userTenants = await TenantService.GetAllAsync();
        userTenants = userTenants
            .Where(t => t.IsActive)
            .ToList();

        // Set default values
        leaseModel.StartDate = DateTime.Today;
        leaseModel.EndDate = DateTime.Today.AddYears(1);
        leaseModel.Status = ApplicationConstants.LeaseStatuses.Active;
    }

    private async Task OnPropertyChanged()
    {
        if (leaseModel.PropertyId != Guid.Empty)
        {
            selectedProperty = availableProperties.FirstOrDefault(p => p.Id == leaseModel.PropertyId);
            if (selectedProperty != null)
            {
                // Get organization settings for security deposit calculation
                var settings = await OrganizationService.GetOrganizationSettingsAsync();
                var depositMultiplier = settings?.AutoCalculateSecurityDeposit == true 
                    ? settings.SecurityDepositMultiplier 
                    : 1.0m;

                leaseModel.PropertyAddress = selectedProperty.Address;
                leaseModel.MonthlyRent = selectedProperty.MonthlyRent;
                leaseModel.SecurityDeposit = selectedProperty.MonthlyRent * depositMultiplier;
            }
        }
        else
        {
            selectedProperty = null;
        }
        StateHasChanged();
    }

    private async Task HandleValidSubmit()
    {
        try
        {
            isSubmitting = true;
            errorMessage = string.Empty;

            var authState = await AuthenticationStateTask;
            var userId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

            if (string.IsNullOrEmpty(userId))
            {
                errorMessage = "User not authenticated.";
                return;
            }

            // Verify property and tenant belong to user
            var property = await PropertyService.GetByIdAsync(leaseModel.PropertyId);
            var tenant = await TenantService.GetByIdAsync(leaseModel.TenantId);

            if (property == null)
            {
                errorMessage = $"Property with ID {leaseModel.PropertyId} not found or access denied.";
                return;
            }

            if (tenant == null)
            {
                errorMessage = $"Tenant with ID {leaseModel.TenantId} not found or access denied.";
                return;
            }

            var lease = new Lease
            {
                
                PropertyId = leaseModel.PropertyId,
                TenantId = leaseModel.TenantId,
                StartDate = leaseModel.StartDate,
                EndDate = leaseModel.EndDate,
                MonthlyRent = leaseModel.MonthlyRent,
                SecurityDeposit = leaseModel.SecurityDeposit,
                Status = leaseModel.Status,
                Terms = leaseModel.Terms,
                Notes = leaseModel.Notes
            };

            await LeaseService.CreateAsync(lease);

            // Mark property as unavailable if lease is active
            if (leaseModel.Status == ApplicationConstants.LeaseStatuses.Active)
            {
                property.IsAvailable = false;
            }

            await PropertyService.UpdateAsync(property);

            Navigation.NavigateTo("/propertymanagement/leases");
        }
        catch (Exception ex)
        {
            errorMessage = $"Error creating lease: {ex.Message}";
            if (ex.InnerException != null)
            {
                errorMessage += $" Inner Exception: {ex.InnerException.Message}";
            }
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private void CreateTenant()
    {
        Navigation.NavigateTo("/propertymanagement/tenants/create");
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/propertymanagement/leases");
    }

    public class LeaseModel
    {
        [RequiredGuid(ErrorMessage = "Property is required")]
        public Guid PropertyId { get; set; }

        public string PropertyAddress { get; set; } = string.Empty;

        [RequiredGuid(ErrorMessage = "Tenant is required")]
        public Guid TenantId { get; set; }

        [Required(ErrorMessage = "Start date is required")]
        public DateTime StartDate { get; set; } = DateTime.Today;

        [Required(ErrorMessage = "End date is required")]
        public DateTime EndDate { get; set; } = DateTime.Today.AddYears(1);

        [Required(ErrorMessage = "Monthly rent is required")]
        [Range(0.01, double.MaxValue, ErrorMessage = "Monthly rent must be greater than 0")]
        public decimal MonthlyRent { get; set; }

        [Range(0, double.MaxValue, ErrorMessage = "Security deposit cannot be negative")]
        public decimal SecurityDeposit { get; set; }

        [Required(ErrorMessage = "Status is required")]
        [StringLength(50)]
        public string Status { get; set; } = ApplicationConstants.LeaseStatuses.Active;

        [StringLength(1000, ErrorMessage = "Terms cannot exceed 1000 characters")]
        public string Terms { get; set; } = string.Empty;

        [StringLength(500, ErrorMessage = "Notes cannot exceed 500 characters")]
        public string Notes { get; set; } = string.Empty;
    }
}