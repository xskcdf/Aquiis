@* Pure Blazor modal - no JavaScript required, works in Electron *@
@if (isVisible)
{
    <div class="modal fade show" style="display: block;" tabindex="-1" aria-modal="true" role="dialog">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@Title</h5>
                    <button type="button" class="btn-close" @onclick="HandleCancel" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                @if (!string.IsNullOrEmpty(Message))
                {
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> @Message
                    </div>
                }

                @if (!string.IsNullOrEmpty(validationError))
                {
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i> @validationError
                    </div>
                }

                <div class="mb-3">
                    <label for="modal-password" class="form-label">
                        @(RequireConfirmation ? "Password" : "Enter Password")
                    </label>
                    <div class="input-group">
                        <input type="@(showPassword ? "text" : "password")" 
                               class="form-control" 
                               id="modal-password"
                               @bind="password" 
                               @bind:event="oninput"
                               @onkeydown="HandleKeyDown"
                               placeholder="Enter password (minimum 12 characters)"
                               autocomplete="off" 
                               autofocus />
                        <button class="btn btn-outline-secondary" type="button" @onclick="TogglePasswordVisibility" tabindex="-1">
                            <i class="bi bi-eye@(showPassword ? "-slash" : "")"></i>
                        </button>
                    </div>
                    @if (!string.IsNullOrEmpty(password) && password.Length < MinPasswordLength)
                    {
                        <small class="text-warning">
                            <i class="bi bi-exclamation-circle"></i> Password must be at least @MinPasswordLength characters
                        </small>
                    }
                </div>

                @if (RequireConfirmation)
                {
                    <div class="mb-3">
                        <label for="modal-confirm" class="form-label">Confirm Password</label>
                        <div class="input-group">
                            <input type="@(showConfirmPassword ? "text" : "password")" 
                                   class="form-control" 
                                   id="modal-confirm"
                                   @bind="confirmPassword" 
                                   @bind:event="oninput"
                                   @onkeydown="HandleKeyDown"
                                   placeholder="Re-enter password"
                                   autocomplete="off" />
                            <button class="btn btn-outline-secondary" type="button" @onclick="ToggleConfirmPasswordVisibility" tabindex="-1">
                                <i class="bi bi-eye@(showConfirmPassword ? "-slash" : "")"></i>
                            </button>
                        </div>
                        @if (!string.IsNullOrEmpty(confirmPassword) && password != confirmPassword)
                        {
                            <small class="text-danger">
                                <i class="bi bi-x-circle"></i> Passwords do not match
                            </small>
                        }
                    </div>
                }

                @if (ShowSecurityNote)
                {
                    <div class="alert alert-warning mt-3">
                        <i class="bi bi-shield-exclamation"></i>
                        <strong>Security Note:</strong> Choose a strong password you will remember. 
                        If you lose this password, your data cannot be recovered.
                    </div>
                }
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" @onclick="HandleCancel">Cancel</button>
                <button type="button" class="btn btn-primary" @onclick="HandleSubmit" disabled="@(!IsValid())">
                    @(RequireConfirmation ? "Confirm" : "Submit")
                </button>
            </div>
        </div>
    </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

@code {
    private string? password;
    private string? confirmPassword;
    private bool showPassword = false;
    private bool showConfirmPassword = false;
    private string? validationError;
    private bool isVisible = false;
    private TaskCompletionSource<string?>? taskCompletionSource;
    
    [Parameter] public int MinPasswordLength { get; set; } = 12;
    [Parameter] public bool ShowSecurityNote { get; set; } = true;
    
    // Properties set when showing modal
    private string Title { get; set; } = "Enter Password";
    private string? Message { get; set; }
    private bool RequireConfirmation { get; set; }

    /// <summary>
    /// Shows the password modal and waits for user input
    /// </summary>
    /// <param name="title">Modal title</param>
    /// <param name="message">Optional message to display</param>
    /// <param name="requireConfirmation">If true, requires password confirmation</param>
    /// <returns>The entered password, or null if cancelled</returns>
    public async Task<string?> ShowAsync(string title, string? message = null, bool requireConfirmation = false)
    {
        // Reset state
        Title = title;
        Message = message;
        RequireConfirmation = requireConfirmation;
        password = null;
        confirmPassword = null;
        showPassword = false;
        showConfirmPassword = false;
        validationError = null;
        
        taskCompletionSource = new TaskCompletionSource<string?>();
        
        // Show modal using Blazor state
        isVisible = true;
        StateHasChanged();
        
        // Wait for user to submit or cancel
        return await taskCompletionSource.Task;
    }

    private bool IsValid()
    {
        if (string.IsNullOrWhiteSpace(password))
            return false;
            
        if (password.Length < MinPasswordLength)
            return false;
            
        if (RequireConfirmation && password != confirmPassword)
            return false;
            
        return true;
    }

    private void TogglePasswordVisibility()
    {
        showPassword = !showPassword;
    }

    private void ToggleConfirmPasswordVisibility()
    {
        showConfirmPassword = !showConfirmPassword;
    }

    private void HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && IsValid())
        {
            _ = HandleSubmit();
        }
        else if (e.Key == "Escape")
        {
            _ = HandleCancel();
        }
    }

    private async Task HandleSubmit()
    {
        validationError = null;
        
        if (string.IsNullOrWhiteSpace(password))
        {
            validationError = "Password is required";
            return;
        }
        
        if (password.Length < MinPasswordLength)
        {
            validationError = $"Password must be at least {MinPasswordLength} characters";
            return;
        }
        
        if (RequireConfirmation && password != confirmPassword)
        {
            validationError = "Passwords do not match";
            return;
        }
        
        // Hide modal
        isVisible = false;
        StateHasChanged();
        
        // Small delay to allow modal to close smoothly
        await Task.Delay(100);
        
        // Return password
        taskCompletionSource?.SetResult(password);
    }

    private async Task HandleCancel()
    {
        // Hide modal
        isVisible = false;
        StateHasChanged();
        
        // Small delay to allow modal to close smoothly
        await Task.Delay(100);
        
        // Return null (cancelled)
        taskCompletionSource?.SetResult(null);
    }
}
