@page "/administration/organizations/{Id:guid}"

@using Aquiis.Core.Entities
@using Aquiis.Application.Services
@using Aquiis.Application.Services.Workflows
@using Aquiis.Infrastructure.Data
@using Aquiis.SimpleStart.Shared.Services
@using Aquiis.SimpleStart.Shared.Components.Account
@using Aquiis.Core.Constants
@using Aquiis.UI.Shared.Features.Organizations
@using Aquiis.UI.Shared.Components.Entities.OrganizationUsers
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore

@inject OrganizationService OrganizationService
@inject ApplicationDbContext DbContext
@inject UserContextService UserContext
@inject NavigationManager Navigation
@inject ToastService ToastService
@inject SampleDataWorkflowService SampleDataWorkflowService

@attribute [OrganizationAuthorize("Owner", "Administrator")]
@rendermode InteractiveServer

<PageTitle>View Organization - Administration</PageTitle>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="bi bi-building"></i> Organization Details</h1>
    </div>

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (organization == null)
    {
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle"></i> Organization not found or you don't have permission to view it.
        </div>
    }
    else
    {
        <OrganizationDetails 
            OrganizationViewModel="@organizationViewModel"
            CurrentUserRole="@currentUserRole"
            CurrentUserViewModel="@currentUserViewModel"
            IsOwner="@isOwner"
            IsAdministrator="@isAdministrator"
            IsCurrentOrganization="@isCurrentOrganization"
            IsGeneratingSample="@isGeneratingSample"
            IsRemovingSample="@isRemovingSample"
            HasSampleData="@hasSampleData"
            SampleDataSummary="@sampleDataSummary"
            OnManageUsers="NavigateToManageUsers" 
            OnEdit="NavigateToEdit"
            OnGenerateSampleData="GenerateSampleData"
            OnRemoveSampleData="RemoveSampleData" />
    }
</div>

@code {
    [Parameter]
    public Guid Id { get; set; } = Guid.Empty;

    private bool isLoading = true;
    private Organization? organization;
    public List<OrganizationUser> organizationUsers = new();
    private string ownerEmail = string.Empty;
    private string currentUserRole = string.Empty;
    private bool isOwner = false;
    private bool isAdministrator = false;
    private bool isGeneratingSample = false;
    private bool isRemovingSample = false;
    private bool hasSampleData = false;
    private SampleDataSummary? sampleDataSummary;

    private bool isCurrentOrganization = false;

    public OrganizationViewModel organizationViewModel = new();

    public OrganizationUserViewModel currentUserViewModel = new();


    protected override async Task OnInitializedAsync()
    {
        await LoadOrganization();
    }


    private async Task LoadOrganization()
    {
        isLoading = true;
        try
        {
            var userId = await UserContext.GetUserIdAsync();
            var currentOrganizationId = await UserContext.GetActiveOrganizationIdAsync();
            if (string.IsNullOrEmpty(userId))
            {
                return;
            }

            // if the organization being viewed is the current organization
            // allow user management for Owner/Administrator roles
            isCurrentOrganization = Id == currentOrganizationId;

            // Check if user has access to this organization
            var canAccess = await OrganizationService.CanAccessOrganizationAsync(userId, Id);
            if (!canAccess)
            {
                organization = null;
                return;
            }

            organization = await OrganizationService.GetOrganizationByIdAsync(Id);
            if (organization != null)
            {
                // Single-context query using UserProfile - no cross-context joins needed!
                organizationViewModel.OrganizationUsers = await (
                    from ou in DbContext.OrganizationUsers
                    join profile in DbContext.UserProfiles on ou.UserId equals profile.UserId
                    join grantedByProfile in DbContext.UserProfiles on ou.GrantedBy equals grantedByProfile.UserId into grantedByJoin
                    from grantedByProfile in grantedByJoin.DefaultIfEmpty()
                    where ou.OrganizationId == Id && ou.IsActive && !ou.IsDeleted
                    select new OrganizationUserViewModel
                    {
                        Id = ou.Id,
                        OrganizationId = ou.OrganizationId,
                        UserId = ou.UserId,
                        Role = ou.Role,
                        IsActive = ou.IsActive,
                        GrantedOn = ou.GrantedOn,
                        GrantedBy = ou.GrantedBy,
                        GrantedByEmail = grantedByProfile != null ? grantedByProfile.Email : "System",
                        Email = profile.Email,
                        FirstName = profile.FirstName,
                        LastName = profile.LastName,
                        PhoneNumber = profile.PhoneNumber
                    }
                ).ToListAsync();

                // Find owner from the list
                var owner = organizationViewModel.OrganizationUsers
                    .FirstOrDefault(u => u.Role == ApplicationConstants.OrganizationRoles.Owner);

                // Get current user's role
                var currentUserOrg = organizationViewModel.OrganizationUsers.FirstOrDefault(u => u.UserId == userId);
                currentUserRole = currentUserOrg?.Role ?? "Unknown";
                isOwner = currentUserRole == ApplicationConstants.OrganizationRoles.Owner;
                isAdministrator = currentUserRole == ApplicationConstants.OrganizationRoles.Administrator;

                organizationViewModel.Organization = organization;
                organizationViewModel.OrganizationOwner = owner;
                
                // Get current user's profile from UserProfile table
                var currentUserProfile = await DbContext.UserProfiles
                    .FirstOrDefaultAsync(up => up.UserId == userId);
                
                if (currentUserProfile != null)
                {
                    currentUserViewModel = new OrganizationUserViewModel
                    {
                        Email = currentUserProfile.Email,
                        UserId = userId,
                        Role = currentUserRole, // Add the role from currentUserOrg
                        FirstName = currentUserProfile.FirstName,
                        LastName = currentUserProfile.LastName,
                        PhoneNumber = currentUserProfile.PhoneNumber
                    };
                }
                
                // Check for sample data presence
                hasSampleData = await SampleDataWorkflowService.HasSampleDataAsync();
                if (hasSampleData)
                {
                    sampleDataSummary = await SampleDataWorkflowService.GetSampleDataSummaryAsync();
                }
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error loading organization: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private string GetRoleBadgeClass(string role)
    {
        return role switch
        {
            ApplicationConstants.OrganizationRoles.Owner => "bg-primary",
            ApplicationConstants.OrganizationRoles.Administrator => "bg-info",
            ApplicationConstants.OrganizationRoles.PropertyManager => "bg-success",
            ApplicationConstants.OrganizationRoles.User => "bg-secondary",
            _ => "bg-secondary"
        };
    }

    private void NavigateToEdit()
    {
        Navigation.NavigateTo($"/administration/organizations/{Id}/edit");
    }

    private void NavigateToManageUsers()
    {
        Navigation.NavigateTo($"/administration/organizations/{Id}/users");
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/administration/organizations");
    }

    private async Task GenerateSampleData()
    {
        if (!await ConfirmSampleDataGeneration())
            return;

        isGeneratingSample = true;
        StateHasChanged();

        try
        {
            var result = await SampleDataWorkflowService.GenerateSampleDataAsync();
            
            if (result.Success)
            {
                ToastService.ShowSuccess($"Sample data created successfully! {result.Message}");
                
                // Refresh sample data detection
                hasSampleData = true;
                sampleDataSummary = await SampleDataWorkflowService.GetSampleDataSummaryAsync();
                
                await Task.Delay(1000);
                // Force reload the page to ensure all components refresh (including NotificationBell)
                Navigation.NavigateTo($"/administration/organizations/{Id}", forceLoad: true);
            }
            else
            {
                ToastService.ShowError($"Failed to generate sample data: {result.Message}");
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error generating sample data: {ex.Message}");
        }
        finally
        {
            isGeneratingSample = false;
            StateHasChanged();
        }
    }

    private async Task<bool> ConfirmSampleDataGeneration()
    {
        // Simple confirmation - in production you might want a modal dialog
        return true; // For now, proceed without confirmation
        // TODO: Add confirmation modal in future enhancement
    }

    private async Task RemoveSampleData()
    {
        if (!await ConfirmSampleDataRemoval())
            return;

        isRemovingSample = true;
        StateHasChanged();

        try
        {
            var result = await SampleDataWorkflowService.RemoveSampleDataAsync();
            
            if (result.Success)
            {
                ToastService.ShowSuccess($"Sample data removed successfully! {result.Message}");
                
                // Refresh sample data detection
                hasSampleData = false;
                sampleDataSummary = null;
                
                await Task.Delay(1000); // Brief delay to show success message
                // Reload the page to reflect changes
                Navigation.NavigateTo($"/administration/organizations/{Id}", forceLoad: true);
            }
            else
            {
                ToastService.ShowError($"Failed to remove sample data: {result.Message}");
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error removing sample data: {ex.Message}");
        }
        finally
        {
            isRemovingSample = false;
            StateHasChanged();
        }
    }

    private async Task<bool> ConfirmSampleDataRemoval()
    {
        // Simple confirmation - in production you might want a modal dialog
        return true; // For now, proceed without confirmation
        // TODO: Add confirmation modal: "Are you sure? This will delete all sample data."
    }
}
