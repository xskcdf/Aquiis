@page "/administration/organizations/{Id:guid}/edit"

@using Aquiis.Core.Entities
@using Aquiis.Application.Services
@using Aquiis.SimpleStart.Shared.Services
@using Aquiis.Core.Constants
@using Microsoft.AspNetCore.Authorization
@using System.ComponentModel.DataAnnotations

@inject OrganizationService OrganizationService
@inject UserContextService UserContext
@inject NavigationManager Navigation
@inject ToastService ToastService

@attribute [OrganizationAuthorize("Owner")]
@rendermode InteractiveServer

<PageTitle>Edit Organization - Administration</PageTitle>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="bi bi-building"></i> Edit Organization</h1>
        <button class="btn btn-outline-secondary" @onclick="Cancel">
            <i class="bi bi-arrow-left"></i> Back to Organization
        </button>
    </div>

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (organization == null)
    {
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle"></i> Organization not found or you don't have permission to edit it.
        </div>
    }
    else
    {
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Organization Details</h5>
                    </div>
                    <div class="card-body">
                        <EditForm Model="@model" OnValidSubmit="HandleSubmit">
                            <DataAnnotationsValidator />
                            <ValidationSummary class="text-danger" />

                            @if (!string.IsNullOrEmpty(errorMessage))
                            {
                                <div class="alert alert-danger" role="alert">
                                    <i class="bi bi-exclamation-triangle"></i> @errorMessage
                                </div>
                            }

                            @if (!string.IsNullOrEmpty(successMessage))
                            {
                                <div class="alert alert-success" role="alert">
                                    <i class="bi bi-check-circle"></i> @successMessage
                                </div>
                            }

                            <div class="mb-3">
                                <label for="name" class="form-label">Organization Name <span class="text-danger">*</span></label>
                                <InputText id="name" class="form-control" @bind-Value="model.Name" placeholder="e.g., California Properties LLC" />
                                <ValidationMessage For="@(() => model.Name)" />
                                <small class="form-text text-muted">Official legal name of the organization</small>
                            </div>

                            <div class="mb-3">
                                <label for="displayName" class="form-label">Display Name</label>
                                <InputText id="displayName" class="form-control" @bind-Value="model.DisplayName" placeholder="e.g., CA Props" />
                                <ValidationMessage For="@(() => model.DisplayName)" />
                                <small class="form-text text-muted">Short name for UI display (optional)</small>
                            </div>

                            <div class="mb-3">
                                <label for="state" class="form-label">State</label>
                                <InputSelect id="state" class="form-select" @bind-Value="model.State">
                                    <option value="">-- Select State --</option>
                                    @foreach (var state in GetUsStates())
                                    {
                                        <option value="@state.Code">@state.Name (@state.Code)</option>
                                    }
                                </InputSelect>
                                <ValidationMessage For="@(() => model.State)" />
                                <small class="form-text text-muted">Primary state where organization operates</small>
                            </div>

                            <div class="mb-3 form-check">
                                <InputCheckbox id="isActive" class="form-check-input" @bind-Value="model.IsActive" />
                                <label class="form-check-label" for="isActive">
                                    Organization is active
                                </label>
                                <small class="form-text text-muted d-block">Inactive organizations cannot be accessed by users</small>
                            </div>

                            <div class="d-flex justify-content-end gap-2">
                                <button type="button" class="btn btn-outline-secondary" @onclick="Cancel">
                                    Cancel
                                </button>
                                <button type="submit" class="btn btn-primary" disabled="@isSubmitting">
                                    @if (isSubmitting)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                    }
                                    <i class="bi bi-check-circle"></i> Save Changes
                                </button>
                            </div>
                        </EditForm>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="bi bi-info-circle"></i> Organization Info</h6>
                    </div>
                    <div class="card-body">
                        <dl class="row mb-0">
                            <dt class="col-sm-5">Created On:</dt>
                            <dd class="col-sm-7">@organization.CreatedOn.ToShortDateString()</dd>

                            <dt class="col-sm-5">Created By:</dt>
                            <dd class="col-sm-7">@organization.CreatedBy</dd>

                            @if (organization.LastModifiedOn.HasValue)
                            {
                                <dt class="col-sm-5">Last Modified:</dt>
                                <dd class="col-sm-7">@organization.LastModifiedOn.Value.ToShortDateString()</dd>

                                <dt class="col-sm-5">Modified By:</dt>
                                <dd class="col-sm-7">@(organization.LastModifiedBy ?? "-")</dd>
                            }
                        </dl>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public Guid Id { get; set; } = Guid.Empty;

    private bool isLoading = true;
    private bool isSubmitting = false;
    private Organization? organization;
    private EditOrganizationModel model = new();
    private string errorMessage = string.Empty;
    private string successMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadOrganization();
    }

    private async Task LoadOrganization()
    {
        isLoading = true;
        try
        {
            var userId = await UserContext.GetUserIdAsync();
            if (string.IsNullOrEmpty(userId))
            {
                errorMessage = "User not found. Please log in again.";
                return;
            }

            // Check if user is owner of this organization
            var isOwner = await OrganizationService.IsOwnerAsync(userId, Id);
            if (!isOwner)
            {
                organization = null;
                return;
            }

            organization = await OrganizationService.GetOrganizationByIdAsync(Id);
            if (organization != null)
            {
                model = new EditOrganizationModel
                {
                    Name = organization.Name,
                    DisplayName = organization.DisplayName,
                    State = organization.State,
                    IsActive = organization.IsActive
                };
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading organization: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task HandleSubmit()
    {
        isSubmitting = true;
        errorMessage = string.Empty;
        successMessage = string.Empty;

        try
        {
            if (organization == null)
            {
                errorMessage = "Organization not found.";
                return;
            }

            var userId = await UserContext.GetUserIdAsync();
            if (string.IsNullOrEmpty(userId))
            {
                errorMessage = "User not found. Please log in again.";
                return;
            }

            // Update organization properties
            organization.Name = model.Name!;
            organization.DisplayName = model.DisplayName;
            organization.State = model.State;
            organization.IsActive = model.IsActive;

            var success = await OrganizationService.UpdateOrganizationAsync(organization);

            if (success)
            {
                successMessage = "Organization updated successfully!";
                ToastService.ShowSuccess(successMessage);
            }
            else
            {
                errorMessage = "Failed to update organization. Please try again.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error updating organization: {ex.Message}";
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private void Cancel()
    {
        Navigation.NavigateTo($"/administration/organizations/{Id}");
    }

    private List<(string Code, string Name)> GetUsStates()
    {
        return new List<(string, string)>
        {
            ("AL", "Alabama"), ("AK", "Alaska"), ("AZ", "Arizona"), ("AR", "Arkansas"),
            ("CA", "California"), ("CO", "Colorado"), ("CT", "Connecticut"), ("DE", "Delaware"),
            ("FL", "Florida"), ("GA", "Georgia"), ("HI", "Hawaii"), ("ID", "Idaho"),
            ("IL", "Illinois"), ("IN", "Indiana"), ("IA", "Iowa"), ("KS", "Kansas"),
            ("KY", "Kentucky"), ("LA", "Louisiana"), ("ME", "Maine"), ("MD", "Maryland"),
            ("MA", "Massachusetts"), ("MI", "Michigan"), ("MN", "Minnesota"), ("MS", "Mississippi"),
            ("MO", "Missouri"), ("MT", "Montana"), ("NE", "Nebraska"), ("NV", "Nevada"),
            ("NH", "New Hampshire"), ("NJ", "New Jersey"), ("NM", "New Mexico"), ("NY", "New York"),
            ("NC", "North Carolina"), ("ND", "North Dakota"), ("OH", "Ohio"), ("OK", "Oklahoma"),
            ("OR", "Oregon"), ("PA", "Pennsylvania"), ("RI", "Rhode Island"), ("SC", "South Carolina"),
            ("SD", "South Dakota"), ("TN", "Tennessee"), ("TX", "Texas"), ("UT", "Utah"),
            ("VT", "Vermont"), ("VA", "Virginia"), ("WA", "Washington"), ("WV", "West Virginia"),
            ("WI", "Wisconsin"), ("WY", "Wyoming")
        };
    }

    public class EditOrganizationModel
    {
        [Required(ErrorMessage = "Organization name is required")]
        [StringLength(200, ErrorMessage = "Organization name cannot exceed 200 characters")]
        public string? Name { get; set; }

        [StringLength(200, ErrorMessage = "Display name cannot exceed 200 characters")]
        public string? DisplayName { get; set; }

        [StringLength(2, ErrorMessage = "State code must be 2 characters")]
        public string? State { get; set; }

        public bool IsActive { get; set; } = true;
    }
}
