@page "/administration/settings/database"
@using Aquiis.Application.Services
@using Aquiis.SimpleStart.Shared.Services
@using Aquiis.Application.Services.PdfGenerators
@using Aquiis.Core.Constants
@using Aquiis.Core.Interfaces
@using Aquiis.Core.Interfaces.Services
@using Aquiis.Infrastructure.Services
@using Microsoft.AspNetCore.Authorization
@using Microsoft.Extensions.Options
@using ElectronNET.API
@inject DatabaseBackupService BackupService
@inject IPathService PathService
@inject NavigationManager Navigation
@inject SchemaValidationService SchemaService
@inject IOptions<ApplicationSettings> AppSettings
@inject IJSRuntime JSRuntime
@inject IHostApplicationLifetime AppLifetime
@inject IDatabaseService DatabaseService
@inject DatabaseEncryptionService EncryptionService
@inject PasswordDerivationService PasswordDerivation
@inject UserContextService UserContext
@attribute [OrganizationAuthorize("Owner", "Administrator")]
@rendermode InteractiveServer

@namespace Aquiis.SimpleStart.Features.Administration.Settings.Pages

<PageTitle>Database Settings</PageTitle>

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <div class="d-flex align-items-center gap-3 mb-2">
                <h1 class="mb-0"><i class="bi bi-database-fill-gear"></i> Database Settings</h1>
                <div class="text-muted">
                    <i class="bi bi-shield-check"></i> Admin Only
                </div>
            </div>
            <p class="text-muted mb-0">Manage database backups and recover from corruption</p>
        </div>
        <div class="col-auto">
            <button class="btn btn-outline-secondary" @onclick="BackToDashboard">
                <i class="bi bi-arrow-left"></i> Back to Application Settings
            </button>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(successMessage))
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle-fill"></i> @successMessage
            <button type="button" class="btn-close" @onclick="() => successMessage = null"></button>
        </div>
    }

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle-fill"></i> @errorMessage
            <button type="button" class="btn-close" @onclick="() => errorMessage = null"></button>
        </div>
    }

    <!-- Database Encryption -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="bi bi-shield-lock-fill"></i> Database Encryption</h5>
                </div>
                <div class="card-body">
                    <div class="form-check form-switch mb-3">
                        <input type="checkbox" 
                               class="form-check-input" 
                               id="encryptionEnabled"
                               checked="@isEncryptionEnabled"
                               @onchange="@ToggleEncryption" />
                        <label class="form-check-label" for="encryptionEnabled">
                            <strong>Enable Database Encryption</strong>
                        </label>
                    </div>
                    
                    @if (isEncryptionEnabled)
                    {
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle-fill"></i> 
                            <strong>Encryption Active</strong> - Database is encrypted at rest
                        </div>
                        
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-outline-primary" @onclick="ChangeEncryptionPassword" disabled="@isChangingPassword">
                                @if (isChangingPassword)
                                {
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                }
                                else
                                {
                                    <i class="bi bi-key me-2"></i>
                                }
                                Change Password
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" @onclick="ExportUnencryptedBackup" disabled="@isExporting">
                                @if (isExporting)
                                {
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                }
                                else
                                {
                                    <i class="bi bi-file-earmark-arrow-down me-2"></i>
                                }
                                Export Unencrypted Backup
                            </button>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle-fill"></i> 
                            <strong>Encryption Disabled</strong> - Database is stored in plaintext
                        </div>
                        <p class="text-muted small mb-0">
                            <i class="bi bi-info-circle me-1"></i>
                            <strong>What happens when you enable encryption:</strong>
                        </p>
                        <ul class="text-muted small mb-0">
                            <li>You'll create a master password to encrypt the database</li>
                            <li>Password is cached in your system keychain for convenience</li>
                            <li>Database remains portable - use the same password on any device</li>
                            <li>A backup will be created before encryption begins</li>
                        </ul>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Database Health Status -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-heart-pulse"></i> Database Health</h5>
                </div>
                <div class="card-body">
                    @if (isCheckingHealth)
                    {
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Checking health...</span>
                            </div>
                            <p class="mt-2">Checking database health...</p>
                        </div>
                    }
                    else if (healthCheckResult != null)
                    {
                        <div class="d-flex align-items-center mb-3">
                            @if (healthCheckResult.Value.IsHealthy)
                            {
                                <i class="bi bi-check-circle-fill text-success fs-1 me-3"></i>
                                <div>
                                    <h5 class="mb-0 text-success">Healthy</h5>
                                    <p class="text-muted mb-0">@healthCheckResult.Value.Message</p>
                                </div>
                            }
                            else
                            {
                                <i class="bi bi-exclamation-triangle-fill text-danger fs-1 me-3"></i>
                                <div>
                                    <h5 class="mb-0 text-danger">Unhealthy</h5>
                                    <p class="text-muted mb-0">@healthCheckResult.Value.Message</p>
                                </div>
                            }
                        </div>
                        <small class="text-muted">Last checked: @lastHealthCheck?.ToString("g")</small>
                    }
                    else
                    {
                        <p class="text-muted">Click "Check Health" to validate database integrity</p>
                    }
                    
                    <div class="mt-3">
                        <button class="btn btn-outline-primary" @onclick="CheckDatabaseHealth" disabled="@isCheckingHealth">
                            <i class="bi bi-heart-pulse"></i> Check Health
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-shield-check"></i> Backup Actions</h5>
                </div>
                <div class="card-body">
                    <p>Create manual backups or recover from corruption</p>
                    
                    <div class="d-grid gap-2">
                        <button class="btn btn-success" @onclick="CreateManualBackup" disabled="@isCreatingBackup">
                            @if (isCreatingBackup)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                            }
                            else
                            {
                                <i class="bi bi-save me-2"></i>
                            }
                            Create Manual Backup
                        </button>
                        
                        <button class="btn btn-info" @onclick="TriggerFileUpload" disabled="@isUploading">
                            @if (isUploading)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                            }
                            else
                            {
                                <i class="bi bi-upload me-2"></i>
                            }
                            Upload Backup File
                        </button>
                        <InputFile id="backupFileInput" OnChange="HandleFileUpload" style="display:none;" accept=".db" />
                        
                        <button class="btn btn-warning" @onclick="AttemptAutoRecovery" disabled="@isRecovering">
                            @if (isRecovering)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                            }
                            else
                            {
                                <i class="bi bi-arrow-clockwise me-2"></i>
                            }
                            Auto-Recover from Corruption
                        </button>
                        
                        <button class="btn btn-danger" @onclick="ResetDatabase" disabled="@isResetting">
                            @if (isResetting)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                            }
                            else
                            {
                                <i class="bi bi-trash me-2"></i>
                            }
                            Reset Database (Create New Blank)
                        </button>
                        
                        @if (!HybridSupport.IsElectronActive)
                        {
                            <button class="btn btn-secondary" @onclick="RestartApplication" disabled="@isRestarting">
                                @if (isRestarting)
                                {
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                }
                                else
                                {
                                    <i class="bi bi-arrow-repeat me-2"></i>
                                }
                                Restart Application
                            </button>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Backup List -->
    <div class="row">
        <div class="col">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="bi bi-folder-fill"></i> Available Backups</h5>
                </div>
                <div class="card-body">
                    @if (isLoadingBackups)
                    {
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading backups...</span>
                            </div>
                        </div>
                    }
                    else if (backups.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>File Name</th>
                                        <th>Created Date</th>
                                        <th>Size</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var backup in backups)
                                    {
                                        <tr>
                                            <td>
                                                <i class="bi bi-file-earmark-zip"></i>
                                                @backup.FileName
                                            </td>
                                            <td>@backup.CreatedDate.ToString("g")</td>
                                            <td>@backup.SizeFormatted</td>
                                            <td>
                                                <button class="btn btn-sm btn-success me-2" 
                                                        @onclick="() => DownloadBackup(backup)"
                                                        disabled="@isDownloading">
                                                    <i class="bi bi-download"></i> Download
                                                </button>
                                                <button class="btn btn-sm btn-info me-2" 
                                                        @onclick="() => PreviewDatabase(backup)">
                                                    <i class="bi bi-eye"></i> Preview
                                                </button>
                                                <button class="btn btn-sm btn-primary me-2" 
                                                        @onclick="() => RestoreBackup(backup)"
                                                        disabled="@isRestoring">
                                                    <i class="bi bi-arrow-counterclockwise"></i> Restore
                                                </button>
                                                <button class="btn btn-sm btn-danger" 
                                                        @onclick="() => DeleteBackup(backup)"
                                                        disabled="@isDeleting">
                                                    <i class="bi bi-trash"></i> Delete
                                                </button>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-4 text-muted">
                            <i class="bi bi-inbox fs-1"></i>
                            <p class="mt-2">No backup files found</p>
                        </div>
                    }
                    
                    <div class="mt-3">
                        <button class="btn btn-outline-secondary" @onclick="LoadBackups" disabled="@isLoadingBackups">
                            <i class="bi bi-arrow-clockwise"></i> Refresh List
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
        <!-- Info Box -->
        <div class="row mt-4">
            <div class="col">
                <div class="alert alert-info">
                    <h6><i class="bi bi-info-circle"></i> Important Information</h6>
                    <ul class="mb-0">
                        <li><strong>Database Encryption:</strong> Protects your data at rest using password-based encryption (Phase 2 feature)</li>
                        <li><strong>Password Portability:</strong> Your password works on any device - database remains portable</li>
                        <li><strong>Automatic Backups:</strong> Created before each migration and encryption change</li>
                        <li><strong>Health Check:</strong> Validates database integrity using SQLite's built-in PRAGMA integrity_check</li>
                        <li><strong>Auto-Recovery:</strong> Attempts to restore from the most recent valid backup</li>
                        <li><strong>Retention:</strong> Last 10 backups are kept automatically, older ones are deleted</li>
                        <li><strong>Restore:</strong> Creates a copy of the current database before restoring (saved as .corrupted)</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

@* Password input modal for Electron compatibility *@
<PasswordInputModal @ref="passwordModal" />

@code {
    private List<BackupInfo> backups = new();
    private string? successMessage;
    private string? errorMessage;
    private bool isLoadingBackups = false;
    private bool isCreatingBackup = false;
    private bool isRestoring = false;
    private bool isRecovering = false;
    private bool isCheckingHealth = false;
    private bool isDownloading = false;
    private bool isUploading = false;
    private bool isResetting = false;
    private bool isDeleting = false;
    private bool isRestarting = false;
    private (bool IsHealthy, string Message)? healthCheckResult;
    private DateTime? lastHealthCheck;
    
    // Database encryption
    private bool isEncryptionEnabled = false;
    private bool isChangingPassword = false;
    private bool isExporting = false;
    
    // Password modal reference
    private PasswordInputModal passwordModal = null!;

    private async Task ResetDatabase()
    {
        // Show confirmation dialog
        bool confirmed = await JSRuntime.InvokeAsync<bool>("confirm", 
            "WARNING: This will delete the current database and create a new blank one. All data will be lost!\n\n" +
            "A backup will be created before deletion.\n\n" +
            "Are you absolutely sure you want to continue?");
        
        if (!confirmed)
            return;
            
        try
        {
            isResetting = true;
            errorMessage = null;
            successMessage = null;
            StateHasChanged();
            
            // Create backup of current database before deletion
            var backupPath = await BackupService.CreateBackupAsync("BeforeReset");
            
            if (string.IsNullOrEmpty(backupPath))
            {
                errorMessage = "Failed to create backup before reset. Reset cancelled.";
                return;
            }
            
            // Verify backup was created successfully
            if (!File.Exists(backupPath))
            {
                errorMessage = $"Backup file not found at {backupPath}. Reset cancelled.";
                return;
            }
            
            var backupSize = new FileInfo(backupPath).Length;
            if (backupSize == 0)
            {
                errorMessage = "Backup file is empty. Reset cancelled.";
                File.Delete(backupPath); // Clean up empty backup
                return;
            }
            
            successMessage = $"Backup created successfully ({FormatFileSize(backupSize)}). Deleting database...";
            StateHasChanged();
            await Task.Delay(1000);
            
            // Get database path
            var dbPath = await PathService.GetDatabasePathAsync();
            
            if (File.Exists(dbPath))
            {
                File.Delete(dbPath);
                successMessage = "Database deleted successfully. Application will restart to create a new blank database.";
                StateHasChanged();
                
                // Wait a moment for user to see message
                await Task.Delay(2000);
                
                // Restart the application using Electron API
                if (HybridSupport.IsElectronActive)
                {
                    Electron.App.Relaunch();
                    Electron.App.Exit();
                }
                else
                {
                    Navigation.NavigateTo("/", true);
                }
            }
            else
            {
                errorMessage = "Database file not found.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error resetting database: {ex.Message}";
        }
        finally
        {
            isResetting = false;
        }
    }
    
    private async Task RestartApplication()
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", 
            "Are you sure you want to restart the application?\n\n" +
            "All users will be disconnected and the application will reload.");
        
        if (!confirmed) return;
        
        isRestarting = true;
        successMessage = "Restarting application...";
        StateHasChanged();
        
        try
        {
            await Task.Delay(1000); // Give time for the message to display
            
            // Stop the application - the host will automatically restart it
            AppLifetime.StopApplication();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error restarting application: {ex.Message}";
            isRestarting = false;
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadBackups();
        await CheckDatabaseHealth();
        await CheckEncryptionStatus();
    }

    private async Task LoadBackups()
    {
        isLoadingBackups = true;
        errorMessage = null;
        
        try
        {
            backups = await BackupService.GetAvailableBackupsAsync();
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load backups: {ex.Message}";
        }
        finally
        {
            isLoadingBackups = false;
        }
    }

    private void BackToDashboard()
    {
        Navigation.NavigateTo("/administration/settings/application");
    }

    private async Task CreateManualBackup()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("console.log", "CreateManualBackup called");
            
            isCreatingBackup = true;
            errorMessage = null;
            successMessage = null;
            StateHasChanged(); // Force UI update to show spinner
            
            await JSRuntime.InvokeVoidAsync("console.log", "About to call BackupService.CreateBackupAsync");
            
            await Task.Delay(100); // Small delay to ensure UI updates
            var backupPath = await BackupService.CreateBackupAsync("Manual");
            
            await JSRuntime.InvokeVoidAsync("console.log", $"Backup result: {backupPath ?? "null"}");
            
            if (backupPath != null)
            {
                successMessage = $"Backup created successfully: {Path.GetFileName(backupPath)}";
                await LoadBackups();
                StateHasChanged(); // Force UI update to show success message
            }
            else
            {
                errorMessage = "Failed to create backup - no path returned";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error creating backup: {ex.Message}";
            await JSRuntime.InvokeVoidAsync("console.error", $"Backup error: {ex}");
            Console.WriteLine($"Backup error: {ex}"); // Log full exception to console
        }
        finally
        {
            isCreatingBackup = false;
            StateHasChanged(); // Force UI update
        }
    }

    private async Task RestoreBackup(BackupInfo backup)
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", 
            $"Are you sure you want to restore from '{backup.FileName}'?\n\n" +
            $"This will replace your current database and the application will restart automatically.\n\n" +
            $"Current database will be saved as .beforeRestore backup.");
        
        if (!confirmed) return;

        isRestoring = true;
        errorMessage = null;
        successMessage = null;
        
        try
        {
            // Get database path (works for both Electron and web mode)
            var dbPath = await BackupService.GetDatabasePathAsync();
            var stagedRestorePath = $"{dbPath}.restore_pending";
            
            // Verify backup exists
            if (!File.Exists(backup.FilePath))
            {
                errorMessage = $"Backup file not found: {backup.FileName}";
                return;
            }
            
            // Copy backup to staged restore location
            // On next startup, Program.cs will move this into place BEFORE opening any connections
            File.Copy(backup.FilePath, stagedRestorePath, overwrite: true);
            
            successMessage = $"Restore staged successfully! Restarting application...";
            StateHasChanged();
            
            // Wait for user to see message
            await Task.Delay(1500);
            
            // Restart the application - on startup it will apply the staged restore
            if (HybridSupport.IsElectronActive)
            {
                Electron.App.Relaunch();
                Electron.App.Exit();
            }
            else
            {
                // Web mode - stop the application, which will trigger a restart by the host
                AppLifetime.StopApplication();
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error staging restore: {ex.Message}";
        }
        finally
        {
            isRestoring = false;
        }
    }

    private async Task DeleteBackup(BackupInfo backup)
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", 
            $"Are you sure you want to delete '{backup.FileName}'?\n\nThis cannot be undone.");
        
        if (!confirmed) return;

        isDeleting = true;
        errorMessage = null;
        successMessage = null;
        
        try
        {
            // Delete the backup file
            if (File.Exists(backup.FilePath))
            {
                File.Delete(backup.FilePath);
                successMessage = $"Backup '{backup.FileName}' deleted successfully.";
                
                // Refresh the backup list
                await LoadBackups();
            }
            else
            {
                errorMessage = $"Backup file not found: {backup.FileName}";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error deleting backup: {ex.Message}";
        }
        finally
        {
            isDeleting = false;
        }
    }

    private void PreviewDatabase(BackupInfo backup)
    {
        // Encode filename for URL
        var encodedFileName = Uri.EscapeDataString(backup.FileName);
        Navigation.NavigateTo($"/administration/database/preview/{encodedFileName}");
    }

    private async Task AttemptAutoRecovery()
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", 
            "This will attempt to restore from the most recent valid backup. Continue?");
        
        if (!confirmed) return;

        isRecovering = true;
        errorMessage = null;
        successMessage = null;
        
        try
        {
            var (success, message) = await BackupService.AutoRecoverFromCorruptionAsync();
            if (success)
            {
                successMessage = message;
                await CheckDatabaseHealth();
            }
            else
            {
                errorMessage = message;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Recovery error: {ex.Message}";
        }
        finally
        {
            isRecovering = false;
        }
    }

    private async Task CheckDatabaseHealth()
    {
        isCheckingHealth = true;
        errorMessage = null;
        
        try
        {
            healthCheckResult = await BackupService.ValidateDatabaseHealthAsync();
            lastHealthCheck = DateTime.Now;
        }
        catch (Exception ex)
        {
            errorMessage = $"Health check error: {ex.Message}";
        }
        finally
        {
            isCheckingHealth = false;
        }
    }

    private async Task DownloadBackup(BackupInfo backup)
    {
        isDownloading = true;
        errorMessage = null;
        
        try
        {
            // Read the backup file
            var fileBytes = await File.ReadAllBytesAsync(backup.FilePath);
            var base64 = Convert.ToBase64String(fileBytes);
            
            // Trigger download in browser
            await JSRuntime.InvokeVoidAsync("downloadFile", backup.FileName, base64, "application/x-sqlite3");
            
            successMessage = $"Backup '{backup.FileName}' downloaded successfully";
        }
        catch (Exception ex)
        {
            errorMessage = $"Error downloading backup: {ex.Message}";
        }
        finally
        {
            isDownloading = false;
        }
    }

    private async Task TriggerFileUpload()
    {
        // Call JavaScript helper function to click the hidden file input
        await JSRuntime.InvokeVoidAsync("clickElementById", "backupFileInput");
    }

    private async Task HandleFileUpload(InputFileChangeEventArgs e)
    {
        isUploading = true;
        errorMessage = null;
        successMessage = null;
        StateHasChanged();
        
        try
        {
            var file = e.File;
            
            // Validate file extension
            if (!file.Name.EndsWith(".db", StringComparison.OrdinalIgnoreCase))
            {
                errorMessage = "Invalid file type. Please upload a .db file.";
                return;
            }
            
            // Limit file size to 500MB
            if (file.Size > 500 * 1024 * 1024)
            {
                errorMessage = "File too large. Maximum size is 500MB.";
                return;
            }
            
            // Read the file
            using var stream = file.OpenReadStream(maxAllowedSize: 500 * 1024 * 1024);
            using var memoryStream = new MemoryStream();
            await stream.CopyToAsync(memoryStream);
            var fileBytes = memoryStream.ToArray();
            
            // Get database path and backup directory
            var dbPath = HybridSupport.IsElectronActive 
                ? await PathService.GetDatabasePathAsync()
                : Path.Combine(Directory.GetCurrentDirectory(), "Data/app.db");
            var backupDir = Path.Combine(Path.GetDirectoryName(dbPath)!, "Backups");
            Directory.CreateDirectory(backupDir);
            
            // Create filename with timestamp
            var timestamp = DateTime.Now.ToString("yyyyMMdd_HHmmss");
            var uploadedFileName = Path.GetFileNameWithoutExtension(file.Name);
            var backupFileName = $"Aquiis_Backup_Uploaded_{uploadedFileName}_{timestamp}.db";
            var backupPath = Path.Combine(backupDir, backupFileName);
            
            // Save the uploaded file
            await File.WriteAllBytesAsync(backupPath, fileBytes);
            
            successMessage = $"Backup '{file.Name}' uploaded successfully as '{backupFileName}'";
            await LoadBackups();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error uploading backup: {ex.Message}";
            await JSRuntime.InvokeVoidAsync("console.error", $"Upload error: {ex}");
        }
        finally
        {
            isUploading = false;
            StateHasChanged();
        }
    }
    
    private string FormatFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB" };
        double len = bytes;
        int order = 0;
        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len = len / 1024;
        }
        return $"{len:0.##} {sizes[order]}";
    }
    
    // Database Encryption Methods
    
    private async Task CheckEncryptionStatus()
    {
        try
        {
            // Load encryption status from database settings
            isEncryptionEnabled = await DatabaseService.IsDatabaseEncryptionEnabledAsync();
        }
        catch (Exception ex)
        {
            // Log to server console (not JavaScript) since this runs during prerender
            Console.WriteLine($"Error checking encryption status: {ex.Message}");
            isEncryptionEnabled = false;
        }
    }
    
    private async Task ToggleEncryption(ChangeEventArgs e)
    {
        bool enabled = (bool)e.Value!;
        
        if (enabled)
        {
            // Enable encryption - prompt for password with confirmation
            var password = await passwordModal.ShowAsync(
                "Create Master Password",
                "Create a master password for database encryption.\n\n" +
                "IMPORTANT: This password cannot be recovered if lost!\n" +
                "Minimum 12 characters required.",
                requireConfirmation: true);
            
            if (string.IsNullOrWhiteSpace(password))
            {
                errorMessage = "Encryption cancelled - no password provided.";
                isEncryptionEnabled = false; // Reset toggle to OFF
                StateHasChanged();
                return;
            }
            
            var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", 
                "⚠️ IMPORTANT WARNINGS ⚠️\n\n" +
                "• A backup will be created before encryption\n" +
                "• Application will restart after encryption\n" +
                "• You'll need this password to access the database\n" +
                "• Lost password = Lost data (no recovery possible)\n\n" +
                "Proceed with encryption?");
            
            if (!confirmed)
            {
                errorMessage = "Encryption cancelled by user.";
                isEncryptionEnabled = false; // Reset toggle to OFF
                StateHasChanged();
                return;
            }
            
            await EnableEncryption(password);
        }
        else
        {
            // Disable encryption - prompt for password to decrypt
            var password = await passwordModal.ShowAsync(
                "Decrypt Database",
                "Enter your master password to decrypt the database:",
                requireConfirmation: false);
            
            if (string.IsNullOrWhiteSpace(password))
            {
                errorMessage = "Decryption cancelled - no password provided.";
                isEncryptionEnabled = true; // Keep it enabled since decrypt was cancelled
                StateHasChanged();
                return;
            }
            
            var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", 
                "⚠️ WARNING ⚠️\n\n" +
                "This will decrypt your database and store it in plaintext.\n" +
                "A backup will be created before decryption.\n\n" +
                "Proceed with decryption?");
            
            if (!confirmed)
            {
                errorMessage = "Decryption cancelled by user.";
                isEncryptionEnabled = true; // Keep it enabled since decrypt was cancelled
                StateHasChanged();
                return;
            }
            
            await DisableEncryption(password);
        }
    }
    
    private async Task EnableEncryption(string password)
    {
        try
        {
            errorMessage = null;
            successMessage = "Creating backup before encryption...";
            StateHasChanged();
            
            // Step 1: Create backup
            var backupPath = await BackupService.CreateBackupAsync("BeforeEncryption");
            
            if (string.IsNullOrEmpty(backupPath))
            {
                errorMessage = "Failed to create backup. Encryption cancelled.";
                isEncryptionEnabled = false;
                StateHasChanged();
                return;
            }
            
            successMessage = "Encrypting database... This may take a moment.";
            StateHasChanged();
            
            // Step 2: Get database path and close connections
            var dbPath = await PathService.GetDatabasePathAsync();
            await BackupService.PrepareForFileCopyAsync();
            
            // Step 3: Copy database file
            var copyPath = $"{dbPath}.copy_to_encrypt";
            File.Copy(dbPath, copyPath, overwrite: true);
            
            // Step 4: Encrypt the copy (with raw password)
            var (success, encryptedPath, errorMsg) = 
                await EncryptionService.EncryptDatabaseAsync(copyPath, password);
            
            if (!success || encryptedPath == null)
            {
                errorMessage = $"Encryption failed: {errorMsg}";
                isEncryptionEnabled = false;
                if (File.Exists(copyPath)) File.Delete(copyPath);
                if (File.Exists($"{copyPath}-wal")) File.Delete($"{copyPath}-wal");
                if (File.Exists($"{copyPath}-shm")) File.Delete($"{copyPath}-shm");
                if (encryptedPath != null && File.Exists(encryptedPath)) File.Delete(encryptedPath);
                StateHasChanged();
                return;
            }
            
            // Step 5: Stage encrypted db for restart
            var stagedRestorePath = $"{dbPath}.restore_pending";
            File.Move(encryptedPath, stagedRestorePath, overwrite: true);
            
            // Cleanup temp copy and SQLite auxiliary files
            if (File.Exists(copyPath)) File.Delete(copyPath);
            if (File.Exists($"{copyPath}-wal")) File.Delete($"{copyPath}-wal");
            if (File.Exists($"{copyPath}-shm")) File.Delete($"{copyPath}-shm");
            
            successMessage = "✅ Database encrypted successfully! Application will restart...";
            StateHasChanged();
            await Task.Delay(2000);
            
            // Step 6: Restart - Program.cs will swap in .restore_pending
            if (HybridSupport.IsElectronActive)
            {
                Electron.App.Relaunch();
                Electron.App.Exit();
            }
            else
            {
                AppLifetime.StopApplication();
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error enabling encryption: {ex.Message}";
            isEncryptionEnabled = false;
            StateHasChanged();
        }
    }
    
    private async Task DisableEncryption(string password)
    {
        try
        {
            errorMessage = null;
            successMessage = "Creating backup before decryption...";
            StateHasChanged();
            
            // Create backup before decryption
            var backupPath = await BackupService.CreateBackupAsync("BeforeDecryption");
            
            if (string.IsNullOrEmpty(backupPath))
            {
                errorMessage = "Failed to create backup. Decryption cancelled.";
                isEncryptionEnabled = true;
                StateHasChanged();
                return;
            }
            
            successMessage = "Decrypting database copy... This may take a moment.";
            StateHasChanged();
            
            // Get database path
            var dbPath = await PathService.GetDatabasePathAsync();
            
            // CRITICAL: Close connections and prepare for file copy
            await BackupService.PrepareForFileCopyAsync();
            
            successMessage = "Copying encrypted database... This may take a moment.";
            StateHasChanged();
            
            // Create a temporary copy to decrypt (can't decrypt live database - it's locked)
            var tempCopyPath = $"{dbPath}.temp_for_decryption";
            File.Copy(dbPath, tempCopyPath, overwrite: true);
            
            try
            {
                // Decrypt the copy (not the live database) using raw password
                var (success, decryptedPath, errorMsg) = 
                    await EncryptionService.DecryptDatabaseAsync(tempCopyPath, password);
                
                if (!success || decryptedPath == null)
                {
                    errorMessage = $"Decryption failed: {errorMsg ?? "Invalid password or corrupted database"}";
                    isEncryptionEnabled = true;
                    StateHasChanged();
                    
                    // Cleanup temp files and SQLite auxiliary files
                    if (File.Exists(tempCopyPath)) File.Delete(tempCopyPath);
                    if (File.Exists($"{tempCopyPath}-wal")) File.Delete($"{tempCopyPath}-wal");
                    if (File.Exists($"{tempCopyPath}-shm")) File.Delete($"{tempCopyPath}-shm");
                    if (decryptedPath != null && File.Exists(decryptedPath)) File.Delete(decryptedPath);
                    return;
                }
                
                // Stage decrypted database for restart (same pattern as restore operations)
                var stagedRestorePath = $"{dbPath}.restore_pending";
                File.Move(decryptedPath, stagedRestorePath, overwrite: true);
                
                // Cleanup temp copy and SQLite auxiliary files
                if (File.Exists(tempCopyPath)) File.Delete(tempCopyPath);
                if (File.Exists($"{tempCopyPath}-wal")) File.Delete($"{tempCopyPath}-wal");
                if (File.Exists($"{tempCopyPath}-shm")) File.Delete($"{tempCopyPath}-shm");
                
                successMessage = "✅ Database decrypted successfully! Application will restart...";
                StateHasChanged();
                await Task.Delay(2000);
                
                // Restart the application - on startup it will swap in the decrypted database
                if (HybridSupport.IsElectronActive)
                {
                    Electron.App.Relaunch();
                    Electron.App.Exit();
                }
                else
                {
                    AppLifetime.StopApplication();
                }
            }
            catch (Exception ex)
            {
                errorMessage = $"Decryption error: {ex.Message}";
                isEncryptionEnabled = true;
                StateHasChanged();
                
                // Cleanup on error
                if (File.Exists(tempCopyPath)) File.Delete(tempCopyPath);
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error disabling encryption: {ex.Message}";
            isEncryptionEnabled = true;
            StateHasChanged();
        }
    }
    
    private async Task ChangeEncryptionPassword()
    {
        isChangingPassword = true;
        errorMessage = null;
        
        try
        {
            var currentPassword = await passwordModal.ShowAsync(
                "Current Password",
                "Enter your current master password:",
                requireConfirmation: false);
            
            if (string.IsNullOrWhiteSpace(currentPassword))
            {
                errorMessage = "Password change cancelled.";
                return;
            }
            
            var newPassword = await passwordModal.ShowAsync(
                "New Master Password",
                "Enter new master password (minimum 12 characters):",
                requireConfirmation: true);
            
            if (string.IsNullOrWhiteSpace(newPassword))
            {
                errorMessage = "Password change cancelled.";
                return;
            }
            
            // TODO: Implement password change
            // 1. Verify current password
            // 2. Re-encrypt database with new password-derived key
            // 3. Update OS keychain with new key
            // 4. Restart application
            
            errorMessage = "⚠️ Password change feature not yet implemented (Phase 2).";
        }
        catch (Exception ex)
        {
            errorMessage = $"Error changing password: {ex.Message}";
        }
        finally
        {
            isChangingPassword = false;
        }
    }
    
    private async Task ExportUnencryptedBackup()
    {
        isExporting = true;
        errorMessage = null;
        
        try
        {
            var password = await passwordModal.ShowAsync(
                "Export Unencrypted Backup",
                "Enter your master password to export unencrypted backup:",
                requireConfirmation: false);
            
            if (string.IsNullOrWhiteSpace(password))
            {
                errorMessage = "Export cancelled.";
                return;
            }
            
            var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", 
                "⚠️ SECURITY WARNING ⚠️\n\n" +
                "This will create an UNENCRYPTED backup of your database.\n" +
                "Anyone with access to this file can read all your data.\n\n" +
                "Only use this if you need to transfer data to another system.\n\n" +
                "Continue?");
            
            if (!confirmed)
            {
                errorMessage = "Export cancelled.";
                return;
            }
            
            // TODO: Implement unencrypted export
            // 1. Verify password
            // 2. Decrypt database to temporary file
            // 3. Trigger download
            // 4. Delete temporary file
            
            errorMessage = "⚠️ Unencrypted export feature not yet implemented (Phase 2).";
        }
        catch (Exception ex)
        {
            errorMessage = $"Error exporting backup: {ex.Message}";
        }
        finally
        {
            isExporting = false;
        }
    }
}
