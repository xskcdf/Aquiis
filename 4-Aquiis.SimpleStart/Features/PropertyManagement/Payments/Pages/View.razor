@page "/propertymanagement/payments/{PaymentId:guid}"

@using Aquiis.SimpleStart.Features.PropertyManagement
@using Aquiis.Core.Entities
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@inject NavigationManager Navigation
@inject PaymentService PaymentService
@inject Application.Services.DocumentService DocumentService
@inject UserContextService UserContextService
@inject IJSRuntime JSRuntime

@attribute [OrganizationAuthorize("Owner", "Administrator", "PropertyManager")]
@rendermode InteractiveServer

<PageTitle>View Payment - Property Management</PageTitle>

@if (payment == null)
{
    <div class="text-center">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}
else
{
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1><span class="bi bi-cash-coin" aria-hidden="true"></span> Payment Details</h1>
            <p class="text-muted">Payment Date: @payment.PaidOn.ToString("MMMM dd, yyyy")</p>
        </div>
        <div>
            <button class="btn btn-outline-secondary me-2" @onclick="GoBack">
                <i class="bi bi-arrow-left"></i> Back to Payments
            </button>
            <button class="btn btn-primary" @onclick="EditPayment">
                <i class="bi bi-pencil"></i> Edit
            </button>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="card-title mb-0">Payment Information</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="text-muted small">Payment Date</label>
                            <p class="fw-bold">@payment.PaidOn.ToString("MMMM dd, yyyy")</p>
                        </div>
                        <div class="col-md-6">
                            <label class="text-muted small">Amount</label>
                            <p class="fw-bold text-success fs-4">@payment.Amount.ToString("C")</p>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="text-muted small">Payment Method</label>
                            <p class="fw-bold">
                                <span class="badge bg-secondary">@payment.PaymentMethod</span>
                            </p>
                        </div>
                    </div>
                    @if (!string.IsNullOrWhiteSpace(payment.Notes))
                    {
                        <div class="row">
                            <div class="col-12">
                                <label class="text-muted small">Notes</label>
                                <p>@payment.Notes</p>
                            </div>
                        </div>
                    }
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="card-title mb-0">Invoice Information</h5>
                </div>
                <div class="card-body">
                    @if (payment.Invoice != null)
                    {
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="text-muted small">Invoice Number</label>
                                <p class="fw-bold">
                                    <a href="/propertymanagement/invoices/view/@payment.Invoice.Id">
                                        @payment.Invoice.InvoiceNumber
                                    </a>
                                </p>
                            </div>
                            <div class="col-md-6">
                                <label class="text-muted small">Invoice Status</label>
                                <p>
                                    @if (payment.Invoice.Status == "Paid")
                                    {
                                        <span class="badge bg-success">@payment.Invoice.Status</span>
                                    }
                                    else if (payment.Invoice.Status == "Partial")
                                    {
                                        <span class="badge bg-warning">Partially Paid</span>
                                    }
                                    else if (payment.Invoice.Status == "Overdue")
                                    {
                                        <span class="badge bg-danger">@payment.Invoice.Status</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-secondary">@payment.Invoice.Status</span>
                                    }
                                </p>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="text-muted small">Invoice Amount</label>
                                <p class="fw-bold">@payment.Invoice.Amount.ToString("C")</p>
                            </div>
                            <div class="col-md-4">
                                <label class="text-muted small">Total Paid</label>
                                <p class="fw-bold text-success">@payment.Invoice.AmountPaid.ToString("C")</p>
                            </div>
                            <div class="col-md-4">
                                <label class="text-muted small">Balance Due</label>
                                <p class="fw-bold @(payment.Invoice.BalanceDue > 0 ? "text-danger" : "text-success")">
                                    @payment.Invoice.BalanceDue.ToString("C")
                                </p>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="text-muted small">Invoice Date</label>
                                <p>@payment.Invoice.InvoicedOn.ToString("MMM dd, yyyy")</p>
                            </div>
                            <div class="col-md-6">
                                <label class="text-muted small">Due Date</label>
                                <p class="@(payment.Invoice.IsOverdue ? "text-danger fw-bold" : "")">
                                    @payment.Invoice.DueOn.ToString("MMM dd, yyyy")
                                    @if (payment.Invoice.IsOverdue)
                                    {
                                        <span class="badge bg-danger ms-2">@payment.Invoice.DaysOverdue days overdue</span>
                                    }
                                </p>
                            </div>
                        </div>
                        @if (!string.IsNullOrWhiteSpace(payment.Invoice.Description))
                        {
                            <div class="row">
                                <div class="col-12">
                                    <label class="text-muted small">Description</label>
                                    <p>@payment.Invoice.Description</p>
                                </div>
                            </div>
                        }
                    }
                </div>
            </div>

            @if (payment.Invoice?.Lease != null)
            {
                <div class="card mb-3">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Lease & Property Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="text-muted small">Property Address</label>
                                <p class="fw-bold">
                                    <a href="/propertymanagement/properties/view/@payment.Invoice.Lease.PropertyId">
                                        @payment.Invoice.Lease.Property?.Address
                                    </a>
                                </p>
                            </div>
                            <div class="col-md-6">
                                <label class="text-muted small">Tenant</label>
                                <p class="fw-bold">
                                    <a href="/propertymanagement/tenants/view/@payment.Invoice.Lease.TenantId">
                                        @payment.Invoice.Lease.Tenant?.FullName
                                    </a>
                                </p>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="text-muted small">Monthly Rent</label>
                                <p class="fw-bold">@payment.Invoice.Lease.MonthlyRent.ToString("C")</p>
                            </div>
                            <div class="col-md-6">
                                <label class="text-muted small">Lease Status</label>
                                <p>
                                    @if (payment.Invoice.Lease.Status == "Active")
                                    {
                                        <span class="badge bg-success">@payment.Invoice.Lease.Status</span>
                                    }
                                    else if (payment.Invoice.Lease.Status == "Expired")
                                    {
                                        <span class="badge bg-danger">@payment.Invoice.Lease.Status</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-secondary">@payment.Invoice.Lease.Status</span>
                                    }
                                </p>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <label class="text-muted small">Lease Start</label>
                                <p>@payment.Invoice.Lease.StartDate.ToString("MMM dd, yyyy")</p>
                            </div>
                            <div class="col-md-6">
                                <label class="text-muted small">Lease End</label>
                                <p>@payment.Invoice.Lease.EndDate.ToString("MMM dd, yyyy")</p>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>

        <div class="col-lg-4">
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="card-title mb-0">Quick Actions</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary" @onclick="EditPayment">
                            <i class="bi bi-pencil"></i> Edit Payment
                        </button>
                        @if (payment.DocumentId == null)
                        {
                            <button class="btn btn-outline-success" @onclick="GeneratePaymentReceipt" disabled="@isGenerating">
                                @if (isGenerating)
                                {
                                    <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                                }
                                else
                                {
                                    <i class="bi bi-file-pdf"></i>
                                }
                                Generate Receipt
                            </button>
                        }
                        else
                        {
                            <button class="btn btn-success" @onclick="ViewDocument">
                                <i class="bi bi-eye"></i> View Receipt
                            </button>
                            <button class="btn btn-outline-success" @onclick="DownloadDocument">
                                <i class="bi bi-download"></i> Download Receipt
                            </button>
                        }
                        <a href="/propertymanagement/invoices/view/@payment.InvoiceId" class="btn btn-outline-primary">
                            <i class="bi bi-receipt"></i> View Invoice
                        </a>
                        @if (payment.Invoice?.Lease != null)
                        {
                            <a href="/propertymanagement/leases/view/@payment.Invoice.LeaseId" class="btn btn-outline-secondary">
                                <i class="bi bi-file-text"></i> View Lease
                            </a>
                            <a href="/propertymanagement/properties/view/@payment.Invoice.Lease.PropertyId" class="btn btn-outline-secondary">
                                <i class="bi bi-house"></i> View Property
                            </a>
                            <a href="/propertymanagement/tenants/view/@payment.Invoice.Lease.TenantId" class="btn btn-outline-secondary">
                                <i class="bi bi-person"></i> View Tenant
                            </a>
                        }
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h6 class="card-title mb-0">Metadata</h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="text-muted small">Created</label>
                        <p class="mb-0">@payment.CreatedOn.ToString("g")</p>
                        @if (!string.IsNullOrEmpty(payment.CreatedBy))
                        {
                            <small class="text-muted">by @payment.CreatedBy</small>
                        }
                    </div>
                    @if (payment.LastModifiedOn.HasValue)
                    {
                        <div>
                            <label class="text-muted small">Last Modified</label>
                            <p class="mb-0">@payment.LastModifiedOn.Value.ToString("g")</p>
                            @if (!string.IsNullOrEmpty(payment.LastModifiedBy))
                            {
                                <small class="text-muted">by @payment.LastModifiedBy</small>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public Guid PaymentId { get; set; }

    private Payment? payment;
    private bool isGenerating = false;
    private Document? document = null;

    [CascadingParameter]
    private Task<AuthenticationState> AuthenticationStateTask { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        payment = await PaymentService.GetByIdAsync(PaymentId);
        
        if (payment == null)
        {
            Navigation.NavigateTo("/propertymanagement/payments");
        }
        else if (payment.DocumentId != null)
        {
            // Load the document if it exists
            document = await DocumentService.GetByIdAsync(payment.DocumentId.Value);
        }
    }

    private void EditPayment()
    {
        Navigation.NavigateTo($"/propertymanagement/payments/{PaymentId}/edit");
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/propertymanagement/payments");
    }

    private async Task ViewDocument()
    {
        if (document != null)
        {
            var base64Data = Convert.ToBase64String(document.FileData);
            await JSRuntime.InvokeVoidAsync("viewFile", base64Data, document.FileType);
        }
    }

    private async Task DownloadDocument()
    {
        if (document != null)
        {
            var fileName = document.FileName;
            var fileData = document.FileData;
            var mimeType = document.FileType;

            await JSRuntime.InvokeVoidAsync("downloadFile", fileName, Convert.ToBase64String(fileData), mimeType);
        }
    }

    private async Task GeneratePaymentReceipt()
    {
        isGenerating = true;
        StateHasChanged();

        try
        {
            // Generate the PDF receipt
            byte[] pdfBytes = Aquiis.Application.Services.PdfGenerators.PaymentPdfGenerator.GeneratePaymentReceipt(payment!);

            // Create the document entity
            var document = new Document
            {
                FileName = $"Receipt_{payment!.PaidOn:yyyyMMdd}_{DateTime.Now:HHmmss}.pdf",
                FileExtension = ".pdf",
                FileData = pdfBytes,
                FileSize = pdfBytes.Length,
                FileType = "application/pdf",
                ContentType = "application/pdf",
                DocumentType = "Payment Receipt",
                Description = $"Payment receipt for {payment.Amount:C} on {payment.PaidOn:MMM dd, yyyy}",
                LeaseId = payment.Invoice?.LeaseId,
                PropertyId = payment.Invoice?.Lease?.PropertyId,
                TenantId = payment.Invoice?.Lease?.TenantId,
                InvoiceId = payment.InvoiceId,
                IsDeleted = false
            };

            // Save to database
            await DocumentService.CreateAsync(document);

            // Update payment with DocumentId
            payment.DocumentId = document.Id;
           
            await PaymentService.UpdateAsync(payment);

            // Reload payment and document
            this.document = document;
            StateHasChanged();

            await JSRuntime.InvokeVoidAsync("alert", "Payment receipt generated successfully!");
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error generating payment receipt: {ex.Message}");
        }
        finally
        {
            isGenerating = false;
            StateHasChanged();
        }
    }
}
