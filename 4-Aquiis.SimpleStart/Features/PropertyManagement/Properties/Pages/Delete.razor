@page "/propertymanagement/properties/delete/{PropertyId:guid}"

@inject PropertyService PropertyService
@inject LeaseService LeaseService
@inject InspectionService InspectionService
@inject InvoiceService InvoiceService
@inject NavigationManager Navigation

@attribute [OrganizationAuthorize("Owner", "Administrator", "PropertyManager")]
@rendermode InteractiveServer

<PageTitle>Delete Property - Aquiis</PageTitle>

<div class="container-fluid">
    @if (isLoading)
    {
        <div class="text-center mt-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (property == null)
    {
        <div class="alert alert-danger mt-3">
            <i class="bi bi-exclamation-triangle-fill"></i> Property not found.
        </div>
    }
    else
    {
        <div class="row mt-3">
            <div class="col-12">
                <div class="d-flex align-items-center mb-3">
                    <button class="btn btn-outline-secondary me-3" @onclick="Cancel">
                        <i class="bi bi-arrow-left"></i> Back
                    </button>
                    <h2 class="mb-0">Delete Property</h2>
                </div>

                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">@property.Address</h5>
                        <p class="text-muted">@property.City, @property.State @property.ZipCode</p>

                        @if (hasBlockers)
                        {
                            <div class="alert alert-warning">
                                <h5><i class="bi bi-exclamation-triangle-fill"></i> Cannot Delete Property</h5>
                                <p>The following items must be resolved before this property can be deleted:</p>
                            </div>

                            @if (activeLeases.Any() || upcomingLeases.Any())
                            {
                                <div class="card mb-3">
                                    <div class="card-header bg-warning bg-opacity-10">
                                        <h6 class="mb-0"><i class="bi bi-file-earmark-text"></i> Active or Upcoming Leases (@(activeLeases.Count + upcomingLeases.Count))</h6>
                                    </div>
                                    <div class="card-body">
                                        <p class="mb-2">Terminate or decline these leases before deleting the property:</p>
                                        <ul class="list-group list-group-flush">
                                            @foreach (var lease in activeLeases)
                                            {
                                                <li class="list-group-item">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <div>
                                                            <strong>@lease.Tenant?.FullName</strong>
                                                            <br />
                                                            <small class="text-muted">
                                                                Status: <span class="badge bg-success">@lease.Status</span> | 
                                                                @lease.StartDate.ToString("MM/dd/yyyy") - @lease.EndDate.ToString("MM/dd/yyyy")
                                                            </small>
                                                        </div>
                                                        <a href="/propertymanagement/leases/@lease.Id" class="btn btn-sm btn-outline-primary">
                                                            <i class="bi bi-eye"></i> View
                                                        </a>
                                                    </div>
                                                </li>
                                            }
                                            @foreach (var lease in upcomingLeases)
                                            {
                                                <li class="list-group-item">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <div>
                                                            <strong>@lease.Tenant?.FullName</strong>
                                                            <br />
                                                            <small class="text-muted">
                                                                Status: <span class="badge bg-info">@lease.Status</span> | 
                                                                @lease.StartDate.ToString("MM/dd/yyyy") - @lease.EndDate.ToString("MM/dd/yyyy")
                                                            </small>
                                                        </div>
                                                        <a href="/propertymanagement/leases/@lease.Id" class="btn btn-sm btn-outline-primary">
                                                            <i class="bi bi-eye"></i> View
                                                        </a>
                                                    </div>
                                                </li>
                                            }
                                        </ul>
                                    </div>
                                </div>
                            }

                            @if (outstandingInspections.Any())
                            {
                                <div class="card mb-3">
                                    <div class="card-header bg-warning bg-opacity-10">
                                        <h6 class="mb-0"><i class="bi bi-clipboard-check"></i> Inspections with Action Items (@outstandingInspections.Count)</h6>
                                    </div>
                                    <div class="card-body">
                                        <p class="mb-2">Complete or resolve these action items:</p>
                                        <ul class="list-group list-group-flush">
                                            @foreach (var inspection in outstandingInspections)
                                            {
                                                <li class="list-group-item">
                                                    <div class="d-flex justify-content-between align-items-start">
                                                        <div>
                                                            <strong>@inspection.InspectionType Inspection</strong>
                                                            <br />
                                                            <small class="text-muted">
                                                                Completed: @inspection.CompletedOn.ToString("MM/dd/yyyy") | 
                                                                Condition: <span class="badge bg-secondary">@inspection.OverallCondition</span>
                                                            </small>
                                                            @if (!string.IsNullOrWhiteSpace(inspection.ActionItemsRequired))
                                                            {
                                                                <div class="mt-2">
                                                                    <strong class="text-danger">Action Items:</strong>
                                                                    <p class="mb-0 small">@inspection.ActionItemsRequired</p>
                                                                </div>
                                                            }
                                                        </div>
                                                        <a href="/propertymanagement/inspections/@inspection.Id" class="btn btn-sm btn-outline-primary">
                                                            <i class="bi bi-eye"></i> View
                                                        </a>
                                                    </div>
                                                </li>
                                            }
                                        </ul>
                                    </div>
                                </div>
                            }

                            @if (unpaidInvoices.Any())
                            {
                                <div class="card mb-3">
                                    <div class="card-header bg-warning bg-opacity-10">
                                        <h6 class="mb-0"><i class="bi bi-receipt"></i> Unpaid Invoices (@unpaidInvoices.Count)</h6>
                                    </div>
                                    <div class="card-body">
                                        <p class="mb-2">Collect payment, void, or cancel these invoices:</p>
                                        <ul class="list-group list-group-flush">
                                            @foreach (var invoice in unpaidInvoices)
                                            {
                                                <li class="list-group-item">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <div>
                                                            <strong>@invoice.InvoiceNumber</strong> - @invoice.Description
                                                            <br />
                                                            <small class="text-muted">
                                                                Status: <span class="badge @GetInvoiceStatusBadgeClass(invoice.Status)">@invoice.Status</span> | 
                                                                Amount: @invoice.Amount.ToString("C") | 
                                                                Balance: @invoice.BalanceDue.ToString("C") | 
                                                                Due: @invoice.DueOn.ToString("MM/dd/yyyy")
                                                                @if (invoice.IsOverdue)
                                                                {
                                                                    <span class="text-danger">(@invoice.DaysOverdue days overdue)</span>
                                                                }
                                                            </small>
                                                        </div>
                                                        <a href="/propertymanagement/invoices/@invoice.Id" class="btn btn-sm btn-outline-primary">
                                                            <i class="bi bi-eye"></i> View
                                                        </a>
                                                    </div>
                                                </li>
                                            }
                                        </ul>
                                    </div>
                                </div>
                            }

                            <div class="mt-3">
                                <button class="btn btn-secondary" @onclick="Cancel">
                                    <i class="bi bi-arrow-left"></i> Go Back
                                </button>
                            </div>
                        }
                        else
                        {
                            <div class="alert alert-danger">
                                <h5><i class="bi bi-exclamation-triangle-fill"></i> Confirm Deletion</h5>
                                <p>Are you sure you want to delete this property? This action cannot be undone.</p>
                                <ul class="mb-0">
                                    <li>All property information will be permanently removed</li>
                                    <li>Historical lease and inspection records will be preserved</li>
                                    <li>This action is irreversible</li>
                                </ul>
                            </div>

                            <div class="mt-3">
                                <button class="btn btn-danger me-2" @onclick="ConfirmDelete" disabled="@isDeleting">
                                    @if (isDeleting)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                    }
                                    <i class="bi bi-trash"></i> Yes, Delete Property
                                </button>
                                <button class="btn btn-secondary" @onclick="Cancel" disabled="@isDeleting">
                                    <i class="bi bi-x-circle"></i> Cancel
                                </button>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public Guid PropertyId { get; set; }

    private Property? property;
    private List<Lease> activeLeases = new();
    private List<Lease> upcomingLeases = new();
    private List<Inspection> outstandingInspections = new();
    private List<Invoice> unpaidInvoices = new();

    private bool isLoading = true;
    private bool isDeleting = false;
    private bool hasBlockers = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadPropertyAndBlockers();
    }

    private async Task LoadPropertyAndBlockers()
    {
        isLoading = true;

        try
        {
            property = await PropertyService.GetByIdAsync(PropertyId);

            if (property != null)
            {
                // Check for active/upcoming leases
                var allLeases = await LeaseService.GetAllAsync();
                var propertyLeases = allLeases.Where(l => l.PropertyId == PropertyId).ToList();

                activeLeases = propertyLeases
                    .Where(l => l.Status == ApplicationConstants.LeaseStatuses.Active)
                    .ToList();

                upcomingLeases = propertyLeases
                    .Where(l => l.StartDate > DateTime.Today &&
                                l.Status != ApplicationConstants.LeaseStatuses.Terminated &&
                                l.Status != ApplicationConstants.LeaseStatuses.Declined &&
                                l.Status != ApplicationConstants.LeaseStatuses.Expired)
                    .ToList();

                // Check for inspections with action items
                var allInspections = await InspectionService.GetAllAsync();
                outstandingInspections = allInspections
                    .Where(i => i.PropertyId == PropertyId &&
                                !string.IsNullOrWhiteSpace(i.ActionItemsRequired))
                    .ToList();

                // Check for unpaid invoices (through leases)
                var allInvoices = await InvoiceService.GetAllAsync();
                var propertyLeaseIds = propertyLeases.Select(l => l.Id).ToHashSet();
                unpaidInvoices = allInvoices
                    .Where(inv => propertyLeaseIds.Contains(inv.LeaseId) &&
                                  inv.Status != ApplicationConstants.InvoiceStatuses.Paid &&
                                  inv.Status != ApplicationConstants.InvoiceStatuses.Cancelled &&
                                  inv.Status != ApplicationConstants.InvoiceStatuses.Voided)
                    .ToList();

                hasBlockers = activeLeases.Any() || upcomingLeases.Any() || 
                              outstandingInspections.Any() || unpaidInvoices.Any();
            }
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task ConfirmDelete()
    {
        if (hasBlockers)
        {
            return; // Should not happen due to UI hiding the button
        }

        isDeleting = true;

        try
        {
            await PropertyService.DeleteAsync(PropertyId);
            Navigation.NavigateTo("/propertymanagement/properties");
        }
        catch (Exception)
        {
            // Handle error (could add error message display)
            isDeleting = false;
        }
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/propertymanagement/properties");
    }

    private string GetInvoiceStatusBadgeClass(string status)
    {
        return status switch
        {
            ApplicationConstants.InvoiceStatuses.Paid => "bg-success",
            ApplicationConstants.InvoiceStatuses.Pending => "bg-warning",
            ApplicationConstants.InvoiceStatuses.Overdue => "bg-danger",
            ApplicationConstants.InvoiceStatuses.PaidPartial => "bg-info",
            ApplicationConstants.InvoiceStatuses.Cancelled => "bg-secondary",
            ApplicationConstants.InvoiceStatuses.Voided => "bg-secondary",
            _ => "bg-secondary"
        };
    }
}
