@page "/PropertyManagement/ProspectiveTenants/{ProspectId:guid}"

@using Aquiis.Core.Entities
@using Aquiis.Application.Services
@using Aquiis.SimpleStart.Shared.Services
@using Aquiis.Application.Services.PdfGenerators
@using Aquiis.Core.Constants
@using Aquiis.Core.Utilities
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Authorization

@attribute [OrganizationAuthorize("Owner", "Administrator", "PropertyManager")]
@inject ProspectiveTenantService ProspectiveTenantService
@inject TourService TourService
@inject RentalApplicationService RentalApplicationService
@inject PropertyService PropertyService
@inject UserContextService UserContext
@inject NavigationManager Navigation
@inject ToastService ToastService

@rendermode InteractiveServer

<PageTitle>Prospect Details</PageTitle>

<div class="container-fluid">
    <div class="row mb-3">
        <div class="col">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/PropertyManagement/ProspectiveTenants">Prospective Tenants</a></li>
                    <li class="breadcrumb-item active">@(prospect?.FullName ?? "Details")</li>
                </ol>
            </nav>
        </div>
    </div>

    @if (loading)
    {
        <div class="text-center p-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (prospect == null)
    {
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle"></i> Prospective tenant not found.
        </div>
    }
    else
    {
        <div class="row">
            <div class="col-lg-8">
                <!-- Contact Information -->
                <div class="card mb-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-person-circle"></i> Contact Information
                        </h5>
                        <div>
                            <span class="badge @GetStatusBadgeClass(prospect.Status) me-2">
                                @GetStatusDisplay(prospect.Status)
                            </span>
                            @if (!isEditing)
                            {
                                <button class="btn btn-sm btn-outline-primary" @onclick="StartEdit">
                                    <i class="bi bi-pencil"></i> Edit
                                </button>
                            }
                        </div>
                    </div>
                    <div class="card-body">
                        @if (isEditing)
                        {
                            <EditForm Model="editModel" OnValidSubmit="HandleSaveEdit">
                                <DataAnnotationsValidator />
                                <ValidationSummary />

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">First Name *</label>
                                        <InputText class="form-control" @bind-Value="editModel.FirstName" />
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Last Name *</label>
                                        <InputText class="form-control" @bind-Value="editModel.LastName" />
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Email *</label>
                                        <InputText class="form-control" type="email" @bind-Value="editModel.Email" />
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Phone *</label>
                                        <InputText class="form-control" type="tel" @bind-Value="editModel.Phone" />
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">Date of Birth</label>
                                        <InputDate class="form-control" @bind-Value="editModel.DateOfBirth" />
                                    </div>
                                    <div class="col-md-5 mb-3">
                                        <label class="form-label">Identification Number</label>
                                        <InputText class="form-control" @bind-Value="editModel.IdentificationNumber" placeholder="Driver's License, State ID, etc." />
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label class="form-label">State</label>
                                        <InputSelect class="form-select" @bind-Value="editModel.IdentificationState">
                                            <option value="">Select...</option>
                                            @foreach (var state in States.StatesArray())
                                            {
                                                <option value="@state.Abbreviation">@state.Name</option>
                                            }
                                        </InputSelect>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Source</label>
                                        <InputSelect class="form-select" @bind-Value="editModel.Source">
                                            <option value="">Select source...</option>
                                            @foreach (var source in ApplicationConstants.ProspectiveSources.AllProspectiveSources)
                                            {
                                                <option value="@source">@source</option>
                                            }
                                        </InputSelect>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Interested Property</label>
                                        <InputSelect class="form-select" @bind-Value="editModel.InterestedPropertyId">
                                            <option value="">Select property...</option>
                                            @foreach (var property in availableProperties)
                                            {
                                                <option value="@property.Id">@property.Address</option>
                                            }
                                        </InputSelect>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Desired Move-In Date</label>
                                        <InputDate class="form-control" @bind-Value="editModel.DesiredMoveInDate" />
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Notes</label>
                                    <InputTextArea class="form-control" rows="3" @bind-Value="editModel.Notes" />
                                </div>

                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-check-circle"></i> Save Changes
                                    </button>
                                    <button type="button" class="btn btn-secondary" @onclick="CancelEdit">
                                        <i class="bi bi-x-circle"></i> Cancel
                                    </button>
                                </div>
                            </EditForm>
                        }
                        else
                        {
                            <div class="row">
                                <div class="col-md-6">
                                    <dl class="row">
                                        <dt class="col-sm-4">Name:</dt>
                                        <dd class="col-sm-8"><strong>@prospect.FullName</strong></dd>

                                        <dt class="col-sm-4">Email:</dt>
                                        <dd class="col-sm-8">
                                            <a href="mailto:@prospect.Email">
                                                <i class="bi bi-envelope"></i> @prospect.Email
                                            </a>
                                        </dd>

                                        <dt class="col-sm-4">Phone:</dt>
                                        <dd class="col-sm-8">
                                            <a href="tel:@prospect.Phone">
                                                <i class="bi bi-telephone"></i> @prospect.Phone
                                            </a>
                                        </dd>

                                        @if (prospect.DateOfBirth.HasValue)
                                        {
                                            <dt class="col-sm-4">Date of Birth:</dt>
                                            <dd class="col-sm-8">@prospect.DateOfBirth.Value.ToString("MMM dd, yyyy")</dd>
                                        }

                                        @if (!string.IsNullOrEmpty(prospect.IdentificationNumber))
                                        {
                                            <dt class="col-sm-4">ID Number:</dt>
                                            <dd class="col-sm-8">@prospect.IdentificationNumber @(!string.IsNullOrEmpty(prospect.IdentificationState) ? $"({prospect.IdentificationState})" : "")</dd>
                                        }
                                    </dl>
                                </div>
                                <div class="col-md-6">
                                    <dl class="row">
                                        <dt class="col-sm-5">Source:</dt>
                                        <dd class="col-sm-7">@(prospect.Source ?? "N/A")</dd>

                                        <dt class="col-sm-5">First Contact:</dt>
                                        <dd class="col-sm-7">@prospect.FirstContactedOn?.ToString("MMM dd, yyyy")</dd>

                                        @if (prospect.DesiredMoveInDate.HasValue)
                                        {
                                            <dt class="col-sm-5">Desired Move-In:</dt>
                                            <dd class="col-sm-7">@prospect.DesiredMoveInDate.Value.ToString("MMM dd, yyyy")</dd>
                                        }
                                    </dl>
                                </div>
                            </div>

                            @if (!string.IsNullOrEmpty(prospect.Notes))
                            {
                                <hr />
                                <div>
                                    <strong>Notes:</strong>
                                    <p class="mb-0 mt-2">@prospect.Notes</p>
                                </div>
                            }

                            @if (prospect.InterestedProperty != null)
                            {
                                <hr />
                                <div>
                                    <strong>Interested Property:</strong>
                                    <div class="mt-2">
                                        <i class="bi bi-house"></i> @prospect.InterestedProperty.Address<br />
                                        <small class="text-muted">
                                            @prospect.InterestedProperty.City, @prospect.InterestedProperty.State @prospect.InterestedProperty.ZipCode
                                        </small><br />
                                        <strong class="text-primary">$@prospect.InterestedProperty.MonthlyRent.ToString("N0")/month</strong>
                                    </div>
                                </div>
                            }
                        }
                    </div>
                    <div class="card-footer">
                        <div class="btn-group">
                            <button class="btn btn-primary" @onclick="ScheduleTour">
                                <i class="bi bi-calendar-plus"></i> Schedule Tour
                            </button>
                            <button class="btn btn-outline-secondary" @onclick="GoBack">
                                <i class="bi bi-arrow-left"></i> Back to List
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Tours History -->
                @if (tours.Any())
                {
                    <div class="card mb-3">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-calendar-event"></i> Tours History</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Date & Time</th>
                                            <th>Property</th>
                                            <th>Duration</th>
                                            <th>Status</th>
                                            <th>Tour Checklist</th>
                                            <th>Interest Level</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var tour in tours.OrderByDescending(s => s.ScheduledOn))
                                        {
                                            <tr>
                                                <td>
                                                    @tour.ScheduledOn.ToString("MMM dd, yyyy")<br />
                                                    <small class="text-muted">@tour.ScheduledOn.ToString("h:mm tt")</small>
                                                </td>
                                                <td>@tour.Property?.Address</td>
                                                <td>@tour.DurationMinutes min</td>
                                                <td>
                                                    <span class="badge @GetTourStatusBadgeClass(tour.Status)">
                                                        @tour.Status
                                                    </span>
                                                </td>
                                                <td>
                                                    @if (tour.Checklist != null)
                                                    {
                                                        <a href="/PropertyManagement/Checklists/View/@tour.Checklist.Id" class="text-decoration-none">
                                                            <span class="badge @GetChecklistStatusBadgeClass(tour.Checklist.Status)">
                                                                <i class="bi bi-list-check"></i> @tour.Checklist.Status
                                                            </span>
                                                        </a>
                                                    }
                                                    else
                                                    {
                                                        <span class="text-muted">N/A</span>
                                                    }
                                                </td>
                                                <td>
                                                    @if (!string.IsNullOrEmpty(tour.InterestLevel))
                                                    {
                                                        <span class="badge @GetInterestBadgeClass(tour.InterestLevel)">
                                                            @GetInterestDisplay(tour.InterestLevel)
                                                        </span>
                                                    }
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                }

                <!-- Application Information -->
                @if (application != null)
                {
                    <div class="card mb-3">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-file-earmark-text"></i> Application Status</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <dl class="row">
                                        <dt class="col-sm-5">Application Date:</dt>
                                        <dd class="col-sm-7">@application.AppliedOn.ToString("MMM dd, yyyy")</dd>

                                        <dt class="col-sm-5">Status:</dt>
                                        <dd class="col-sm-7">
                                            <span class="badge @GetApplicationStatusBadgeClass(application.Status)">
                                                @GetApplicationStatusDisplay(application.Status)
                                            </span>
                                        </dd>

                                        <dt class="col-sm-5">Monthly Income:</dt>
                                        <dd class="col-sm-7">$@application.MonthlyIncome.ToString("N2")</dd>
                                    </dl>
                                </div>
                                <div class="col-md-6">
                                    <dl class="row">
                                        <dt class="col-sm-5">Employer:</dt>
                                        <dd class="col-sm-7">@application.EmployerName</dd>

                                        <dt class="col-sm-5">Job Title:</dt>
                                        <dd class="col-sm-7">@application.JobTitle</dd>

                                        <dt class="col-sm-5">Application Fee:</dt>
                                        <dd class="col-sm-7">
                                            $@application.ApplicationFee.ToString("N2")
                                            @if (application.ApplicationFeePaid)
                                            {
                                                <span class="badge bg-success">Paid</span>
                                                @if (application.ApplicationFeePaidOn.HasValue)
                                                {
                                                    <small class="text-muted d-block">@application.ApplicationFeePaidOn.Value.ToString("MMM dd, yyyy")</small>
                                                }
                                                @if (!string.IsNullOrEmpty(application.ApplicationFeePaymentMethod))
                                                {
                                                    <small class="text-muted d-block">via @application.ApplicationFeePaymentMethod</small>
                                                }
                                            }
                                            else
                                            {
                                                <span class="badge bg-warning">Unpaid</span>
                                            }
                                        </dd>

                                        @if (application.ExpiresOn.HasValue)
                                        {
                                            <dt class="col-sm-5">Expires On:</dt>
                                            <dd class="col-sm-7">
                                                @application.ExpiresOn.Value.ToString("MMM dd, yyyy")
                                                @if (application.ExpiresOn.Value < DateTime.UtcNow && application.Status != ApplicationConstants.ApplicationStatuses.Expired)
                                                {
                                                    <span class="badge bg-danger">Expired</span>
                                                }
                                                else if (application.ExpiresOn.Value < DateTime.UtcNow.AddDays(7))
                                                {
                                                    <span class="badge bg-warning">Expires Soon</span>
                                                }
                                            </dd>
                                        }
                                    </dl>
                                </div>
                            </div>

                            @if (application.Screening != null)
                            {
                                <hr />
                                <h6>Screening Results</h6>
                                <div class="row mt-2">
                                    <div class="col-md-6">
                                        <strong>Background Check:</strong>
                                        @if (application.Screening.BackgroundCheckPassed.HasValue)
                                        {
                                            <span class="badge @(application.Screening.BackgroundCheckPassed.Value ? "bg-success" : "bg-danger")">
                                                @(application.Screening.BackgroundCheckPassed.Value ? "Passed" : "Failed")
                                            </span>
                                        }
                                        else if (application.Screening.BackgroundCheckRequested)
                                        {
                                            <span class="badge bg-warning">Pending</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary">Not Requested</span>
                                        }
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Credit Check:</strong>
                                        @if (application.Screening.CreditCheckPassed.HasValue)
                                        {
                                            <span class="badge @(application.Screening.CreditCheckPassed.Value ? "bg-success" : "bg-danger")">
                                                @(application.Screening.CreditCheckPassed.Value ? "Passed" : "Failed")
                                            </span>
                                            @if (application.Screening.CreditScore.HasValue)
                                            {
                                                <span class="ms-2">Score: @application.Screening.CreditScore</span>
                                            }
                                        }
                                        else if (application.Screening.CreditCheckRequested)
                                        {
                                            <span class="badge bg-warning">Pending</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary">Not Requested</span>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                }
            </div>

            <div class="col-lg-4">
                <!-- Quick Actions -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h5 class="mb-0">Quick Actions</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            @if (prospect.Status == ApplicationConstants.ProspectiveStatuses.Lead)
                            {
                                <button class="btn btn-primary" @onclick="ScheduleTour">
                                    <i class="bi bi-calendar-plus"></i> Schedule Tour
                                </button>
                            }
                            else if (prospect.Status == ApplicationConstants.ProspectiveStatuses.TourScheduled)
                            {
                                <button class="btn btn-primary" @onclick="ViewTours">
                                    <i class="bi bi-calendar-event"></i> View Tours
                                </button>
                            }
                            
                            @if (application == null && (prospect.Status == ApplicationConstants.ProspectiveStatuses.Lead || 
                                                          prospect.Status == ApplicationConstants.ProspectiveStatuses.TourScheduled))
                            {
                                <button class="btn btn-success" @onclick="BeginApplication">
                                    <i class="bi bi-file-earmark-text"></i> Begin Application
                                </button>
                            }
                            else if (application != null)
                            {
                                <button class="btn btn-outline-info" @onclick="ViewApplication">
                                    <i class="bi bi-eye"></i> View Application
                                </button>
                            }
                            
                            <button class="btn btn-outline-secondary" @onclick="GoBack">
                                <i class="bi bi-arrow-left"></i> Back to List
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Timeline -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Activity Timeline</h5>
                    </div>
                    <div class="card-body">
                        <div class="timeline">
                            <div class="timeline-item">
                                <div class="timeline-marker bg-primary"></div>
                                <div class="timeline-content">
                                    <small class="text-muted">@prospect.CreatedOn.ToString("MMM dd, yyyy h:mm tt")</small>
                                    <p class="mb-0">Lead created</p>
                                </div>
                            </div>

                            @foreach (var tour in tours.OrderBy(s => s.ScheduledOn))
                            {
                                <div class="timeline-item">
                                    <div class="timeline-marker @(tour.Status == ApplicationConstants.TourStatuses.Completed ? "bg-success" : "bg-info")"></div>
                                    <div class="timeline-content">
                                        <small class="text-muted">@tour.ScheduledOn.ToString("MMM dd, yyyy h:mm tt")</small>
                                        <p class="mb-0">Property tour - @tour.Property?.Address</p>
                                    </div>
                                </div>
                            }

                            @if (application != null)
                            {
                                <div class="timeline-item">
                                    <div class="timeline-marker bg-warning"></div>
                                    <div class="timeline-content">
                                        <small class="text-muted">@application.AppliedOn.ToString("MMM dd, yyyy h:mm tt")</small>
                                        <p class="mb-0">Application submitted</p>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<style>
    .timeline {
        position: relative;
        padding-left: 30px;
    }

    .timeline-item {
        position: relative;
        padding-bottom: 20px;
    }

    .timeline-item:before {
        content: '';
        position: absolute;
        left: -21px;
        top: 8px;
        bottom: -12px;
        width: 2px;
        background: #dee2e6;
    }

    .timeline-item:last-child:before {
        display: none;
    }

    .timeline-marker {
        position: absolute;
        left: -26px;
        top: 5px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        border: 2px solid white;
    }

    .timeline-content {
        font-size: 0.9rem;
    }
</style>

@code {
    [Parameter]
    public Guid ProspectId { get; set; }

    private ProspectiveTenant? prospect;
    private List<Tour> tours = new();
    private RentalApplication? application;
    private List<Aquiis.Core.Entities.Property> availableProperties = new();
    private bool loading = true;
    private bool isEditing = false;
    private ProspectEditViewModel editModel = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        loading = true;
        try
        {
            var organizationId = await UserContext.GetActiveOrganizationIdAsync();
            if (organizationId.HasValue)
            {
                prospect = await ProspectiveTenantService.GetByIdAsync(ProspectId);
                
                if (prospect != null)
                {
                    tours = await TourService.GetByProspectiveIdAsync(ProspectId);
                    application = await RentalApplicationService.GetApplicationByProspectiveIdAsync(ProspectId);
                    
                    // Load properties for edit dropdown
                    availableProperties = await PropertyService.GetAllAsync();
                }
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error loading prospect details: {ex.Message}");
        }
        finally
        {
            loading = false;
        }
    }

    private void StartEdit()
    {
        if (prospect != null)
        {
            editModel = new ProspectEditViewModel
            {
                FirstName = prospect.FirstName,
                LastName = prospect.LastName,
                Email = prospect.Email,
                Phone = prospect.Phone,
                DateOfBirth = prospect.DateOfBirth,
                IdentificationNumber = prospect.IdentificationNumber,
                IdentificationState = prospect.IdentificationState,
                Source = prospect.Source,
                Notes = prospect.Notes,
                InterestedPropertyId = prospect.InterestedPropertyId?.ToString(),
                DesiredMoveInDate = prospect.DesiredMoveInDate
            };
            isEditing = true;
        }
    }

    private void CancelEdit()
    {
        isEditing = false;
        editModel = new();
    }

    private async Task HandleSaveEdit()
    {
        if (prospect == null) return;

        try
        {
            var userId = await UserContext.GetUserIdAsync();
            
            // Update prospect with edited values
            prospect.FirstName = editModel.FirstName;
            prospect.LastName = editModel.LastName;
            prospect.Email = editModel.Email;
            prospect.Phone = editModel.Phone;
            prospect.DateOfBirth = editModel.DateOfBirth;
            prospect.IdentificationNumber = editModel.IdentificationNumber;
            prospect.IdentificationState = editModel.IdentificationState;
            prospect.Source = editModel.Source;
            prospect.Notes = editModel.Notes;
            prospect.InterestedPropertyId = Guid.TryParse(editModel.InterestedPropertyId, out var propId) && propId != Guid.Empty ? propId : null;
            prospect.DesiredMoveInDate = editModel.DesiredMoveInDate;

            await ProspectiveTenantService.UpdateAsync(prospect);
            
            ToastService.ShowSuccess("Prospect updated successfully");
            isEditing = false;
            await LoadData(); // Reload to get updated data with navigation properties
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error updating prospect: {ex.Message}");
        }
    }

    private void ScheduleTour()
    {
        Navigation.NavigateTo($"/PropertyManagement/Tours/Schedule/{ProspectId}");
    }

    private void BeginApplication()
    {
        Navigation.NavigateTo($"/propertymanagement/prospects/{ProspectId}/submit-application");
    }

    private void ViewApplication()
    {
        if (application != null)
        {
            Navigation.NavigateTo($"/propertymanagement/applications/{application.Id}/view");
        }
    }

    private void ViewTours()
    {
        Navigation.NavigateTo("/PropertyManagement/Tours");
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/PropertyManagement/ProspectiveTenants");
    }

    private string GetStatusBadgeClass(string status) => status switch
    {
        var s when s == ApplicationConstants.ProspectiveStatuses.Lead => "bg-secondary",
        var s when s == ApplicationConstants.ProspectiveStatuses.TourScheduled => "bg-info",
        var s when s == ApplicationConstants.ProspectiveStatuses.Applied => "bg-primary",
        var s when s == ApplicationConstants.ProspectiveStatuses.Screening => "bg-warning",
        var s when s == ApplicationConstants.ProspectiveStatuses.Approved => "bg-success",
        var s when s == ApplicationConstants.ProspectiveStatuses.Denied => "bg-danger",
        _ => "bg-secondary"
    };

    private string GetStatusDisplay(string status) => status switch
    {
        var s when s == ApplicationConstants.ProspectiveStatuses.TourScheduled => "Tour Scheduled",
        var s when s == ApplicationConstants.ProspectiveStatuses.ConvertedToTenant => "Converted",
        _ => status
    };

    private string GetTourStatusBadgeClass(string status) => status switch
    {
        var s when s == ApplicationConstants.TourStatuses.Scheduled => "bg-info",
        var s when s == ApplicationConstants.TourStatuses.Completed => "bg-success",
        var s when s == ApplicationConstants.TourStatuses.Cancelled => "bg-danger",
        var s when s == ApplicationConstants.TourStatuses.NoShow => "bg-warning",
        _ => "bg-secondary"
    };

    private string GetInterestBadgeClass(string? level) => level switch
    {
        var l when l == ApplicationConstants.TourInterestLevels.VeryInterested => "bg-success",
        var l when l == ApplicationConstants.TourInterestLevels.Interested => "bg-primary",
        var l when l == ApplicationConstants.TourInterestLevels.Neutral => "bg-secondary",
        var l when l == ApplicationConstants.TourInterestLevels.NotInterested => "bg-danger",
        _ => "bg-secondary"
    };

    private string GetInterestDisplay(string? level) => level switch
    {
        var l when l == ApplicationConstants.TourInterestLevels.VeryInterested => "Very Interested",
        var l when l == ApplicationConstants.TourInterestLevels.NotInterested => "Not Interested",
        _ => level ?? "N/A"
    };

    private string GetApplicationStatusBadgeClass(string status) => status switch
    {
        var s when s == ApplicationConstants.ApplicationStatuses.Submitted => "bg-info",
        var s when s == ApplicationConstants.ApplicationStatuses.UnderReview => "bg-primary",
        var s when s == ApplicationConstants.ApplicationStatuses.Screening => "bg-warning",
        var s when s == ApplicationConstants.ApplicationStatuses.Approved => "bg-success",
        var s when s == ApplicationConstants.ApplicationStatuses.Denied => "bg-danger",
        _ => "bg-secondary"
    };

    private string GetApplicationStatusDisplay(string status) => status switch
    {
        var s when s == ApplicationConstants.ApplicationStatuses.UnderReview => "Under Review",
        _ => status
    };

    private string GetChecklistStatusBadgeClass(string status) => status switch
    {
        var s when s == ApplicationConstants.ChecklistStatuses.Draft => "bg-secondary",
        var s when s == ApplicationConstants.ChecklistStatuses.InProgress => "bg-info",
        var s when s == ApplicationConstants.ChecklistStatuses.Completed => "bg-success",
        _ => "bg-secondary"
    };

    public class ProspectEditViewModel
    {
        [Required(ErrorMessage = "First name is required")]
        [StringLength(100)]
        public string FirstName { get; set; } = string.Empty;

        [Required(ErrorMessage = "Last name is required")]
        [StringLength(100)]
        public string LastName { get; set; } = string.Empty;

        [Required(ErrorMessage = "Email is required")]
        [EmailAddress(ErrorMessage = "Invalid email address")]
        [StringLength(200)]
        public string Email { get; set; } = string.Empty;

        [Required(ErrorMessage = "Phone is required")]
        [Phone(ErrorMessage = "Invalid phone number")]
        [StringLength(20)]
        public string Phone { get; set; } = string.Empty;

        public DateTime? DateOfBirth { get; set; }

        [StringLength(100)]
        public string? IdentificationNumber { get; set; }

        [StringLength(2)]
        public string? IdentificationState { get; set; }

        [StringLength(100)]
        public string? Source { get; set; }

        [StringLength(2000)]
        public string? Notes { get; set; }

        public string? InterestedPropertyId { get; set; }

        public DateTime? DesiredMoveInDate { get; set; }
    }
}
