@page "/propertymanagement/leases/{Id:guid}"
@using Aquiis.SimpleStart.Features.PropertyManagement.Documents.Pages
@using Aquiis.UI.Shared.Components.Entities.Leases

@inject LeaseService LeaseService
@inject NavigationManager Navigation

@attribute [OrganizationAuthorize("Owner", "Administrator", "PropertyManager")]
@rendermode InteractiveServer

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Lease Details</h1>
    <div class="btn-group">
        <button class="btn btn-sm btn-primary" @onclick="EditLease">
            <i class="bi bi-pencil"></i> Edit
        </button>
        <button class="btn btn-secondary" @onclick="BackToProperty">
            <i class="bi bi-arrow-left"></i> Back to Property
        </button>
    </div>
</div>

    <div class="row">
        <div class="col-md-8">
            <Aquiis.UI.Shared.Components.Entities.Leases.LeaseDetailsCard
                Lease="lease" />

            <LeaseTransactionsCard Lease="lease"
                LeaseInvoices="recentInvoices"
                OnViewInvoice="ViewInvoice"
                OnMakePayment="CreatePayment" />
        </div>
        <div class="col-md-4">
            <LeaseQuickActionsCard Lease="lease"
                OnCreateInvoice="CreateInvoice"
                OnGenerateLeaseDocument="GenerateLeaseDocument"
                OnViewDocument="ViewDocument"
                OnDownloadDocument="DownloadDocument"
                OnViewDocuments="ViewDocuments"
                OnViewInvoices="ViewInvoices"
                OnEdit="EditLease" />

            <LeaseSummaryCard Lease="lease" RecentInvoices="@recentInvoices" OnViewInvoice="ViewInvoice" />

            <LeaseLifeCycleCard Lease="lease" />

            
        </div>
    </div>
    <div class="row">
        <div class="col-md-8"></div>
        <div class="col-md-4">
        </div>
    </div>

    <div class="row">
        <div class="col-md-8"></div>
        <div class="col-md-4">
        </div>
    </div>
@* <Aquiis.UI.Shared.Features.PropertyManagement.Leases.ViewForm LeaseId="@Id" /> *@

@code {
    [Parameter]
    public Guid Id { get; set; }

    private Lease lease = new Lease();

    private List<Invoice> recentInvoices = new List<Invoice>();

    private List<Document> LeaseDocuments = new List<Document>();

    protected override async Task OnInitializedAsync()
    {
        lease = await LeaseService.GetLeaseWithRelationsAsync(Id) ?? new Lease();
        recentInvoices = lease.Invoices
                .OrderByDescending(i => i.InvoicedOn)
                .ToList();
        LeaseDocuments = lease.Documents!
                .OrderByDescending(d => d.CreatedOn)
                .ToList();
    }

    private void BackToProperty()
    {
        Navigation.NavigateTo($"/propertymanagement/properties/{lease?.PropertyId}");
    }

    private void EditLease()
    {
        Navigation.NavigateTo($"/propertymanagement/leases/{lease?.Id}/edit");
    }

    private void CreateInvoice(Guid leaseId)
    {
        Navigation.NavigateTo($"/propertymanagement/invoices/create?LeaseId={leaseId}");
    }

    private void ViewInvoice(Guid invoiceId)
    {
        Navigation.NavigateTo($"/propertymanagement/invoices/{invoiceId}");
    }

    private void GenerateLeaseDocument(Guid leaseId)
    {
        // Implement document generation logic here
    }

    private void ViewDocument(Guid leaseId)
    {
        // Implement document viewing logic here
        // Navigate to the lease document or open in viewer
        if (lease.DocumentId.HasValue)
        {
            Navigation.NavigateTo($"/propertymanagement/documents/{lease.DocumentId}");
        }
    }

    private void DownloadDocument(Guid leaseId)
    {
        // Implement document downloading logic here
        // Trigger download for the lease document
    }

    private void ViewDocuments(Guid leaseId)
    {
        Navigation.NavigateTo($"/propertymanagement/documents/?LeaseId={leaseId}");
    }

    private void ViewInvoices(Guid leaseId)
    {
        Navigation.NavigateTo($"/propertymanagement/invoices/?LeaseId={leaseId}");
    }

    private void CreatePayment(Guid invoiceId)
    {
        Navigation.NavigateTo($"/propertymanagement/payments/create?InvoiceId={invoiceId}");
    }
}