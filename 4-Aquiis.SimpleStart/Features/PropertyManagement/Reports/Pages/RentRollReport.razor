@page "/reports/rentroll"
@using Aquiis.Core.Entities
@using Aquiis.Application.Services
@using Aquiis.SimpleStart.Shared.Services
@using Aquiis.Application.Services.PdfGenerators
@using Microsoft.AspNetCore.Authorization
@attribute [OrganizationAuthorize("Owner", "Administrator", "PropertyManager")]
@inject SimpleStartFinancialReportService FinancialReportService
@inject FinancialReportPdfGenerator PdfGenerator
@inject AuthenticationStateProvider AuthenticationStateProvider

@inject UserContextService UserContextService

@inject IJSRuntime JSRuntime
@rendermode InteractiveServer

<PageTitle>Rent Roll - Aquiis</PageTitle>

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h3>Rent Roll Report</h3>
            <p class="text-muted">Current tenant and rent status across all properties</p>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-4">
            <label for="asOfDate" class="form-label">As of Date</label>
            <input type="date" class="form-control" id="asOfDate" @bind="asOfDate" />
        </div>
        <div class="col-md-2 d-flex align-items-end">
            <button class="btn btn-primary w-100" @onclick="GenerateReport">
                <i class="bi bi-file-earmark-bar-graph"></i> Generate
            </button>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Generating report...</p>
        </div>
    }
    else if (rentRollItems.Any())
    {
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Rent Roll as of @asOfDate.ToString("MMM dd, yyyy")</h5>
                <button class="btn btn btn-sm" @onclick="ExportToPdf">
                    <i class="bi bi-file-pdf"></i> Export PDF
                </button>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0">
                        <thead class="table">
                            <tr>
                                <th>Property</th>
                                <th>Address</th>
                                <th>Tenant</th>
                                <th>Lease Status</th>
                                <th>Lease Period</th>
                                <th class="text-end">Monthly Rent</th>
                                <th class="text-end">Security Deposit</th>
                                <th class="text-end">Total Paid</th>
                                <th class="text-end">Total Due</th>
                                <th class="text-end">Balance</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in rentRollItems)
                            {
                                <tr>
                                    <td>@item.PropertyName</td>
                                    <td>@item.PropertyAddress</td>
                                    <td>@item.TenantName</td>
                                    <td>
                                        <span class="badge @GetLeaseStatusClass(item.LeaseStatus)">
                                            @item.LeaseStatus
                                        </span>
                                    </td>
                                    <td>
                                        @if (item.LeaseStartDate.HasValue)
                                        {
                                            <span>@item.LeaseStartDate.Value.ToString("MM/dd/yyyy")</span>
                                        }
                                        @if (item.LeaseEndDate.HasValue)
                                        {
                                            <span> - @item.LeaseEndDate.Value.ToString("MM/dd/yyyy")</span>
                                        }
                                    </td>
                                    <td class="text-end">@item.MonthlyRent.ToString("C")</td>
                                    <td class="text-end">@item.SecurityDeposit.ToString("C")</td>
                                    <td class="text-end">@item.TotalPaid.ToString("C")</td>
                                    <td class="text-end">@item.TotalDue.ToString("C")</td>
                                    <td class="text-end">
                                        <strong class="@(item.Balance > 0 ? "text-danger" : "text-success")">
                                            @item.Balance.ToString("C")
                                        </strong>
                                    </td>
                                    <td>
                                        <span class="badge @GetPaymentStatusClass(item.PaymentStatus)">
                                            @item.PaymentStatus
                                        </span>
                                    </td>
                                </tr>
                            }
                        </tbody>
                        <tfoot class="table">
                            <tr>
                                <th colspan="5">TOTALS</th>
                                <th class="text-end">@rentRollItems.Sum(r => r.MonthlyRent).ToString("C")</th>
                                <th class="text-end">@rentRollItems.Sum(r => r.SecurityDeposit).ToString("C")</th>
                                <th class="text-end">@rentRollItems.Sum(r => r.TotalPaid).ToString("C")</th>
                                <th class="text-end">@rentRollItems.Sum(r => r.TotalDue).ToString("C")</th>
                                <th class="text-end">
                                    <strong class="@(rentRollItems.Sum(r => r.Balance) > 0 ? "text-danger" : "text-success")">
                                        @rentRollItems.Sum(r => r.Balance).ToString("C")
                                    </strong>
                                </th>
                                <th></th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body text-center">
                        <h6 class="text-muted">Total Properties</h6>
                        <h3>@rentRollItems.Select(r => r.PropertyId).Distinct().Count()</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body text-center">
                        <h6 class="text-muted">Active Leases</h6>
                        <h3>@rentRollItems.Count(r => r.LeaseStatus == "Active")</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body text-center">
                        <h6 class="text-muted">Monthly Revenue</h6>
                        <h3>@rentRollItems.Sum(r => r.MonthlyRent).ToString("C")</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body text-center">
                        <h6 class="text-muted">Outstanding Balance</h6>
                        <h3 class="@(rentRollItems.Sum(r => r.Balance) > 0 ? "text-danger" : "text-success")">
                            @rentRollItems.Sum(r => r.Balance).ToString("C")
                        </h3>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private DateTime asOfDate = DateTime.Now;
    private List<RentRollItem> rentRollItems = new();
    private bool isLoading = false;

    [CascadingParameter]
    private Task<AuthenticationState>? AuthenticationStateTask { get; set; }

    private Guid? organizationId = Guid.Empty;

    private async Task GenerateReport()
    {
        if (AuthenticationStateTask == null) return;

        isLoading = true;
        StateHasChanged();

        try
        {
            organizationId = await UserContextService.GetActiveOrganizationIdAsync();

            if (organizationId.HasValue)
            {
                rentRollItems = await FinancialReportService.GenerateRentRollAsync(organizationId.Value, asOfDate);
            }
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private string GetLeaseStatusClass(string status)
    {
        return status?.ToLower() switch
        {
            "active" => "bg-success",
            "expired" => "bg-danger",
            "pending" => "bg-warning",
            _ => "bg-secondary"
        };
    }

    private string GetPaymentStatusClass(string status)
    {
        return status?.ToLower() switch
        {
            "current" => "bg-success",
            "outstanding" => "bg-danger",
            _ => "bg-secondary"
        };
    }

    private async Task ExportToPdf()
    {
        if (!rentRollItems.Any()) return;

        try
        {
            var pdfBytes = PdfGenerator.GenerateRentRollPdf(rentRollItems, asOfDate);
            var fileName = $"RentRoll_{asOfDate:yyyyMMdd}.pdf";
            
            await JSRuntime.InvokeVoidAsync("downloadFile", fileName, Convert.ToBase64String(pdfBytes), "application/pdf");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error generating PDF: {ex.Message}");
        }
    }
}
