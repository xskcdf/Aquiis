@page "/propertymanagement/leases/view/{Id:int}"

@using Aquiis.SimpleStart.Components.PropertyManagement.Properties
@using Aquiis.SimpleStart.Components.PropertyManagement.Documents
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Web
@using Aquiis.SimpleStart.Components.PropertyManagement.Invoices
@using Aquiis.SimpleStart.Components.PropertyManagement.Leases
@using Aquiis.SimpleStart.Components.PropertyManagement
@using System.ComponentModel.DataAnnotations
@using Aquiis.SimpleStart.Services

@inject NavigationManager Navigation
@inject PropertyManagementService PropertyManagementService
@inject Services.LeaseRenewalPdfGenerator RenewalPdfGenerator
@inject ToastService ToastService
@inject IJSRuntime JSRuntime
@attribute [Authorize(Roles = "Administrator, PropertyManager")]

@rendermode InteractiveServer

@if (lease == null)
{
    <div class="text-center">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}
else if (!isAuthorized)
{
    <div class="alert alert-danger">
        <h4>Access Denied</h4>
        <p>You don't have permission to view this lease.</p>
        <a href="/propertymanagement/leases" class="btn btn-primary">Back to Leases</a>
    </div>
}
else
{
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Lease Details</h1>
        <div class="btn-group">
            <button class="btn btn-primary" @onclick="EditLease">
                <i class="bi bi-pencil"></i> Edit
            </button>
            <button class="btn btn-secondary" @onclick="BackToList">
                <i class="bi bi-arrow-left"></i> Back to List
            </button>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Lease Information</h5>
                    <span class="badge @GetStatusBadgeClass(lease.Status)">
                        @lease.Status
                    </span>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <strong>Property:</strong>
                            <p>@lease.Property?.Address</p>
                            <small class="text-muted">@lease.Property?.City, @lease.Property?.State</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>Tenant:</strong>
                            <p>@lease.Tenant?.FullName</p>
                            <small class="text-muted">@lease.Tenant?.Email</small>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <strong>Start Date:</strong>
                            <p>@lease.StartDate.ToString("MMMM dd, yyyy")</p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>End Date:</strong>
                            <p>@lease.EndDate.ToString("MMMM dd, yyyy")</p>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <strong>Monthly Rent:</strong>
                            <p class="text-success fw-bold">@lease.MonthlyRent.ToString("C")</p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>Security Deposit:</strong>
                            <p>@lease.SecurityDeposit.ToString("C")</p>
                        </div>
                    </div>

                    @if (!string.IsNullOrEmpty(lease.Terms))
                    {
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <strong>Lease Terms:</strong>
                                <p>@lease.Terms</p>
                            </div>
                        </div>
                    }

                    @if (!string.IsNullOrEmpty(lease.Notes))
                    {
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <strong>Notes:</strong>
                                <p>@lease.Notes</p>
                            </div>
                        </div>
                    }

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <strong>Created:</strong>
                            <p>@lease.CreatedOn.ToString("MMMM dd, yyyy")</p>
                        </div>
                        @if (lease.LastModifiedOn.HasValue)
                        {
                            <div class="col-md-6 mb-3">
                                <strong>Last Modified:</strong>
                                <p>@lease.LastModifiedOn.Value.ToString("MMMM dd, yyyy")</p>
                            </div>
                        }
                    </div>

                    @if (lease.IsActive)
                    {
                        <div class="row">
                            <div class="col-md-12">
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle"></i>
                                    <strong>Active Lease:</strong> This lease is currently active with @lease.DaysRemaining days remaining.
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>

        <div class="col-md-4">
            @if (lease.IsExpiringSoon)
            {
                <div class="card border-warning mb-3">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">
                            <i class="bi bi-exclamation-triangle-fill"></i> Renewal Alert
                        </h5>
                    </div>
                    <div class="card-body">
                        <p class="mb-2">
                            <strong>Expires in:</strong> 
                            <span class="text-danger fw-bold">@lease.DaysRemaining days</span>
                        </p>
                        <p class="mb-2">
                            <strong>End Date:</strong> @lease.EndDate.ToString("MMM dd, yyyy")
                        </p>
                        
                        @if (!string.IsNullOrEmpty(lease.RenewalStatus))
                        {
                            <p class="mb-2">
                                <strong>Status:</strong> 
                                <span class="badge bg-@GetRenewalStatusBadgeClass(lease.RenewalStatus)">
                                    @lease.RenewalStatus
                                </span>
                            </p>
                        }

                        @if (lease.ProposedRenewalRent.HasValue)
                        {
                            <p class="mb-2">
                                <strong>Proposed Rent:</strong> @lease.ProposedRenewalRent.Value.ToString("C")
                                @if (lease.ProposedRenewalRent != lease.MonthlyRent)
                                {
                                    var increase = lease.ProposedRenewalRent.Value - lease.MonthlyRent;
                                    var percentage = (increase / lease.MonthlyRent) * 100;
                                    <small class="text-muted">
                                        (@(increase > 0 ? "+" : "")@increase.ToString("C"), @percentage.ToString("F1")%)
                                    </small>
                                }
                            </p>
                        }

                        @if (lease.RenewalNotificationSentOn.HasValue)
                        {
                            <small class="text-muted d-block mb-2">
                                Notification sent: @lease.RenewalNotificationSentOn.Value.ToString("MMM dd, yyyy")
                            </small>
                        }

                        @if (!string.IsNullOrEmpty(lease.RenewalNotes))
                        {
                            <hr/>
                            <small>
                                <strong>Notes:</strong><br/>
                                @lease.RenewalNotes
                            </small>
                        }

                        <div class="d-grid gap-2 mt-3">
                            @if (lease.RenewalStatus == "Pending" || string.IsNullOrEmpty(lease.RenewalStatus))
                            {
                                <button class="btn btn-success btn-sm" @onclick="() => ShowRenewalOfferModal()">
                                    <i class="bi bi-envelope-check"></i> Send Renewal Offer
                                </button>
                                <button class="btn btn-outline-primary btn-sm" @onclick="GenerateRenewalOfferPdf" disabled="@isGeneratingPdf">
                                    @if (isGeneratingPdf)
                                    {
                                        <span class="spinner-border spinner-border-sm me-1"></span>
                                    }
                                    else
                                    {
                                        <i class="bi bi-file-pdf"></i>
                                    }
                                    Generate Offer Letter
                                </button>
                            }
                            @if (lease.RenewalStatus == "Offered")
                            {
                                <button class="btn btn-outline-success btn-sm" @onclick="() => MarkRenewalAccepted()">
                                    <i class="bi bi-check-circle"></i> Mark as Accepted
                                </button>
                                <button class="btn btn-outline-danger btn-sm" @onclick="() => MarkRenewalDeclined()">
                                    <i class="bi bi-x-circle"></i> Mark as Declined
                                </button>
                                <button class="btn btn-outline-primary btn-sm" @onclick="GenerateRenewalOfferPdf" disabled="@isGeneratingPdf">
                                    @if (isGeneratingPdf)
                                    {
                                        <span class="spinner-border spinner-border-sm me-1"></span>
                                    }
                                    else
                                    {
                                        <i class="bi bi-file-pdf"></i>
                                    }
                                    Generate Offer Letter
                                </button>
                            }
                        </div>
                    </div>
                </div>
            }
            
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary" @onclick="EditLease">
                            <i class="bi bi-pencil"></i> Edit Lease
                        </button>
                        <button class="btn btn-outline-success" @onclick="CreateInvoice">
                            <i class="bi bi-receipt"></i> Create Invoice
                        </button>
                        <button class="btn btn-outline-info" @onclick="ViewInvoices">
                            <i class="bi bi-list-check"></i> View Invoices
                        </button>
                        <button class="btn btn-outline-secondary" @onclick="ViewDocuments">
                            <i class="bi bi-folder"></i> View Documents
                        </button>
                        @if (lease.DocumentId == null)
                        {
                            <button class="btn btn-outline-warning" @onclick="GenerateLeaseDocument" disabled="@isGenerating">
                                @if (isGenerating)
                                {
                                    <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                    <span>Generating...</span>
                                }
                                else
                                {
                                    <i class="bi bi-file-pdf"></i>
                                    <span> Generate PDF</span>
                                }
                            </button>
                        }
                        else
                        {
                            <button class="btn btn-primary" @onclick="ViewDocument">
                                <i class="bi bi-eye"></i> View PDF
                            </button>
                            <button class="btn btn-outline-primary" @onclick="DownloadDocument">
                                <i class="bi bi-download"></i> Download PDF
                            </button>
                        }
                    </div>
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-header">
                    <h5 class="mb-0">Lease Summary</h5>
                </div>
                <div class="card-body">
                    <p><strong>Duration:</strong> @((lease.EndDate - lease.StartDate).Days) days</p>
                    <p><strong>Total Rent:</strong> @((lease.MonthlyRent * 12).ToString("C"))/year</p>
                    @if (lease.IsActive)
                    {
                        <p><strong>Days Remaining:</strong> @lease.DaysRemaining</p>
                    }
                    @if (recentInvoices.Any())
                    {
                        <hr />
                        <small class="text-muted">
                            <strong>Recent Invoices:</strong><br />
                            @foreach (var invoice in recentInvoices.Take(3))
                            {
                                <span class="badge @(invoice.Status == "Paid" ? "bg-success" : "bg-warning") me-1">
                                    @invoice.InvoiceNumber
                                </span>
                            }
                        </small>
                    }
                </div>
            </div>
        </div>
    </div>

    @* Renewal Offer Modal *@
    @if (showRenewalModal && lease != null)
    {
        <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Send Renewal Offer</h5>
                        <button type="button" class="btn-close" @onclick="() => showRenewalModal = false"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Current Rent</label>
                            <input type="text" class="form-control" value="@lease.MonthlyRent.ToString("C")" disabled />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Proposed Renewal Rent</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" @bind="proposedRent" step="0.01" />
                            </div>
                            @if (proposedRent != lease.MonthlyRent)
                            {
                                var increase = proposedRent - lease.MonthlyRent;
                                var percentage = (increase / lease.MonthlyRent) * 100;
                                <small class="text-muted">
                                    Change: @(increase > 0 ? "+" : "")@increase.ToString("C") (@percentage.ToString("F1")%)
                                </small>
                            }
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Notes (Optional)</label>
                            <textarea class="form-control" rows="3" @bind="renewalNotes" 
                                      placeholder="Add any notes about the renewal offer..."></textarea>
                        </div>
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i>
                            <small>
                                This will mark the lease as "Offered" and record the proposed rent. 
                                An email notification will be sent to the tenant (when email service is configured).
                            </small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="() => showRenewalModal = false">
                            Cancel
                        </button>
                        <button type="button" class="btn btn-primary" @onclick="SendRenewalOffer">
                            Send Offer
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }
}

@code {
    [Parameter] public int Id { get; set; }

    [Parameter]
    [SupplyParameterFromQuery]
    public int? PropertyId { get; set; }

    [Parameter]
    [SupplyParameterFromQuery]
    public int? TenantId { get; set; }

    private Lease? lease;
    private List<Invoice> recentInvoices = new();
    private bool isAuthorized = true;
    private bool isGenerating = false;
    private bool isGeneratingPdf = false;
    private bool showRenewalModal = false;
    private decimal proposedRent = 0;
    private string renewalNotes = "";
    private Document? document = null;

    [CascadingParameter]
    private Task<AuthenticationState> AuthenticationStateTask { get; set; } = default!;

    private LeaseModel leaseModel = new();
    private Property? selectedProperty;
    private List<Property> availableProperties = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadLease();

         // If PropertyId is provided in query string, pre-select it
        if (PropertyId.HasValue)
        {
            leaseModel.PropertyId = PropertyId.Value;
            OnPropertyChanged();
        }
        
        // If TenantId is provided in query string, pre-select it
        if (TenantId.HasValue)
        {
            leaseModel.TenantId = TenantId.Value;
        }
    }

    private async Task LoadLease()
    {
        var authState = await AuthenticationStateTask;
        var userId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

        if (string.IsNullOrEmpty(userId))
        {
            isAuthorized = false;
            return;
        }

        lease = await PropertyManagementService.GetLeaseByIdAsync(Id);

        if (lease == null)
        {
            isAuthorized = false;
            return;
        }

        var invoices = await PropertyManagementService.GetInvoicesByLeaseIdAsync(Id);
        recentInvoices = invoices
            .OrderByDescending(i => i.DueDate)
            .Take(5)
            .ToList();

        // Load the document if it exists
        if (lease.DocumentId != null)
        {
            document = await PropertyManagementService.GetDocumentByIdAsync(lease.DocumentId.Value);
        }
    }

    private string GetStatusBadgeClass(string status)
    {
        return status switch
        {
            "Active" => "bg-success",
            "Pending" => "bg-warning",
            "Expired" => "bg-secondary",
            "Terminated" => "bg-danger",
            _ => "bg-secondary"
        };
    }

    private string GetRenewalStatusBadgeClass(string status)
    {
        return status switch
        {
            "Pending" => "secondary",
            "Offered" => "info",
            "Accepted" => "success",
            "Declined" => "danger",
            "Expired" => "dark",
            _ => "secondary"
        };
    }

    private void ShowRenewalOfferModal()
    {
        proposedRent = lease?.MonthlyRent ?? 0;
        renewalNotes = "";
        showRenewalModal = true;
    }

    private async Task SendRenewalOffer()
    {
        if (lease == null) return;

        try
        {
            var authState = await AuthenticationStateTask;
            var userName = authState.User.Identity?.Name ?? "System";
            var userId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            if (string.IsNullOrEmpty(userId))
            {
                ToastService.ShowError("Unable to determine current user.");
                return;
            }

            // Update lease with renewal offer details
            lease.RenewalStatus = "Offered";
            lease.ProposedRenewalRent = proposedRent;
            lease.RenewalOfferedOn = DateTime.UtcNow;
            lease.RenewalNotes = renewalNotes;
            lease.LastModifiedOn = DateTime.UtcNow;
            lease.LastModifiedBy = userId;

            await PropertyManagementService.UpdateLeaseAsync(lease);
            
            // TODO: Send email notification to tenant
            
            showRenewalModal = false;
            await LoadLease();
            StateHasChanged();

            ToastService.ShowSuccess("Renewal offer sent successfully! You can now generate the offer letter PDF.");
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error sending renewal offer: {ex.Message}");
        }
    }

    private async Task GenerateRenewalOfferPdf()
    {
        if (lease == null) return;

        try
        {
            isGeneratingPdf = true;
            StateHasChanged();

            var authState = await AuthenticationStateTask;
            var userId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            var userName = authState.User.Identity?.Name ?? "System";

            if (string.IsNullOrEmpty(userId))
            {
                ToastService.ShowError("Unable to determine current user.");
                return;
            }

            // Ensure proposed rent is set
            if (!lease.ProposedRenewalRent.HasValue)
            {
                lease.ProposedRenewalRent = lease.MonthlyRent;
            }

            // Generate renewal offer PDF
            var pdfBytes = RenewalPdfGenerator.GenerateRenewalOfferLetter(lease, lease.Property, lease.Tenant);
            var fileName = $"Lease_Renewal_Offer_{lease.Property?.Address?.Replace(" ", "_")}_{DateTime.Now:yyyyMMdd_HHmmss}.pdf";

            // Save PDF to Documents table
            var document = new Document
            {
                UserId = userId,
                PropertyId = lease.PropertyId,
                TenantId = lease.TenantId,
                LeaseId = lease.Id,
                FileName = fileName,
                FileType = "application/pdf",
                FileSize = pdfBytes.Length,
                FileData = pdfBytes,
                FileExtension = ".pdf",
                ContentType = "application/pdf",
                DocumentType = "Lease Renewal Offer",
                Description = $"Renewal offer letter for {lease.Property?.Address}. Proposed rent: {lease.ProposedRenewalRent:C}",
                UploadedBy = userName,
                CreatedBy = userName,
                CreatedOn = DateTime.UtcNow
            };

            await PropertyManagementService.AddDocumentAsync(document);
            
            ToastService.ShowSuccess($"Renewal offer letter generated and saved to documents!");
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error generating PDF: {ex.Message}");
        }
        finally
        {
            isGeneratingPdf = false;
            StateHasChanged();
        }
    }

    private async Task MarkRenewalAccepted()
    {
        if (lease == null) return;

        try
        {
            var authState = await AuthenticationStateTask;
            var userName = authState.User.Identity?.Name ?? "System";
            var userId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            if (string.IsNullOrEmpty(userId))
            {
                ToastService.ShowError("Unable to determine current user.");
                return;
            }

            // Update current lease status
            lease.RenewalStatus = "Accepted";
            lease.RenewalResponseOn = DateTime.UtcNow;
            lease.Status = "Expired"; // Mark current lease as expired since it's being renewed
            lease.LastModifiedOn = DateTime.UtcNow;
            lease.LastModifiedBy = userId;

            await PropertyManagementService.UpdateLeaseAsync(lease);

            // Create new lease starting from acceptance date
            var newLeaseStartDate = DateTime.Today; // Start immediately
            var newLeaseEndDate = newLeaseStartDate.AddYears(1); // 12 months lease

            var newLease = new Lease
            {
                UserId = userId,
                PropertyId = lease.PropertyId,
                TenantId = lease.TenantId,
                StartDate = newLeaseStartDate,
                EndDate = newLeaseEndDate,
                MonthlyRent = lease.ProposedRenewalRent ?? lease.MonthlyRent,
                SecurityDeposit = lease.SecurityDeposit,
                Status = "Active",
                Terms = lease.Terms,
                Notes = $"Renewed lease from previous lease ID {lease.Id}. Renewal accepted on {DateTime.Now:MMM dd, yyyy}.",
                PreviousLeaseId = lease.Id,
                CreatedBy = userId,
                CreatedOn = DateTime.UtcNow,
                LastModifiedBy = userId,
                LastModifiedOn = DateTime.UtcNow
            };

            await PropertyManagementService.AddLeaseAsync(newLease);

            await LoadLease();
            StateHasChanged();

            ToastService.ShowSuccess($"Renewal accepted! New lease created (ID: {newLease.Id}) from {newLeaseStartDate:MMM dd, yyyy} to {newLeaseEndDate:MMM dd, yyyy}.");
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error accepting renewal: {ex.Message}");
        }
    }

    private async Task MarkRenewalDeclined()
    {
        if (lease == null) return;

        try
        {
            var authState = await AuthenticationStateTask;
            var userName = authState.User.Identity?.Name ?? "System";
            var userId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            if (string.IsNullOrEmpty(userId))
            {
                ToastService.ShowError("Unable to determine current user.");
                return;
            }
            lease.RenewalStatus = "Declined";
            lease.RenewalResponseOn = DateTime.UtcNow;
            lease.LastModifiedOn = DateTime.UtcNow;
            lease.LastModifiedBy = userId;
            await PropertyManagementService.UpdateLeaseAsync(lease);
            await LoadLease();
            StateHasChanged();

            ToastService.ShowWarning("Renewal offer marked as declined.");
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error updating renewal status: {ex.Message}");
        }
    }

    private void OnPropertyChanged()
    {
        if (leaseModel.PropertyId > 0)
        {
            selectedProperty = availableProperties.FirstOrDefault(p => p.Id == leaseModel.PropertyId);
            if (selectedProperty != null)
            {
                leaseModel.MonthlyRent = selectedProperty.MonthlyRent;
                leaseModel.SecurityDeposit = selectedProperty.MonthlyRent; // Default to one month rent
            }
        }
        else
        {
            selectedProperty = null;
        }
        StateHasChanged();
    }

    private void EditLease()
    {
        Navigation.NavigateTo($"/propertymanagement/leases/edit/{Id}");
    }

    private void BackToList()
    {
        Navigation.NavigateTo("/propertymanagement/leases");
    }

    private void CreateInvoice()
    {
        Navigation.NavigateTo($"/propertymanagement/invoices/create?leaseId={Id}");
    }

    private void ViewInvoices()
    {
        Navigation.NavigateTo($"/propertymanagement/invoices?leaseId={Id}");
    }

    private void ViewDocuments()
    {
        Navigation.NavigateTo($"/propertymanagement/leases/{Id}/documents");
    }

    private async Task ViewDocument()
    {
        if (document != null)
        {
            var base64Data = Convert.ToBase64String(document.FileData);
            await JSRuntime.InvokeVoidAsync("viewFile", base64Data, document.FileType);
        }
    }

    private async Task DownloadDocument()
    {
        if (document != null)
        {
            var fileName = document.FileName;
            var fileData = document.FileData;
            var mimeType = document.FileType;

            await JSRuntime.InvokeVoidAsync("downloadFile", fileName, Convert.ToBase64String(fileData), mimeType);
        }
    }

    private async Task GenerateLeaseDocument()
    {
        isGenerating = true;
        StateHasChanged();

        try
        {
            // Get current user info
            var authState = await AuthenticationStateTask;
            var userId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            var userName = authState.User.Identity?.Name ?? "System";

            if (string.IsNullOrEmpty(userId))
            {
                await JSRuntime.InvokeVoidAsync("alert", "Unable to determine current user.");
                return;
            }

            // Generate the PDF
            byte[] pdfBytes = Documents.LeasePdfGenerator.GenerateLeasePdf(lease!);

            // Create the document entity
            var document = new Document
            {
                UserId = userId,
                FileName = $"Lease_{lease!.Property?.Address?.Replace(" ", "_")}_{DateTime.Now:yyyyMMdd}.pdf",
                FileExtension = ".pdf",
                FileData = pdfBytes,
                FileSize = pdfBytes.Length,
                FileType = "application/pdf",
                DocumentType = "Lease Agreement",
                Description = "Auto-generated lease agreement",
                LeaseId = lease.Id,
                PropertyId = lease.PropertyId,
                TenantId = lease.TenantId,
                UploadedBy = userName,
                CreatedBy = userId,
                CreatedOn = DateTime.UtcNow,
                LastModifiedBy = userId,
                LastModifiedOn = DateTime.UtcNow,
                IsDeleted = false
            };

            // Save to database
            await PropertyManagementService.AddDocumentAsync(document);

            // Update lease with DocumentId
            lease.DocumentId = document.Id;
            lease.LastModifiedOn = DateTime.UtcNow;
            lease.LastModifiedBy = userId;
            await PropertyManagementService.UpdateLeaseAsync(lease);

            // Reload lease and document
            await LoadLease();
            StateHasChanged();

            await JSRuntime.InvokeVoidAsync("alert", "Lease document generated successfully!");
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error generating lease document: {ex.Message}");
        }
        finally
        {
            isGenerating = false;
            StateHasChanged();
        }
    }

    public class LeaseModel
    {
        [Required(ErrorMessage = "Property is required")]
        [Range(1, int.MaxValue, ErrorMessage = "Please select a property")]
        public int PropertyId { get; set; }

        [Required(ErrorMessage = "Tenant is required")]
        [Range(1, int.MaxValue, ErrorMessage = "Please select a tenant")]
        public int TenantId { get; set; }

        [Required(ErrorMessage = "Start date is required")]
        public DateTime StartDate { get; set; } = DateTime.Today;

        [Required(ErrorMessage = "End date is required")]
        public DateTime EndDate { get; set; } = DateTime.Today.AddYears(1);

        [Required(ErrorMessage = "Monthly rent is required")]
        [Range(0.01, double.MaxValue, ErrorMessage = "Monthly rent must be greater than 0")]
        public decimal MonthlyRent { get; set; }

        [Range(0, double.MaxValue, ErrorMessage = "Security deposit cannot be negative")]
        public decimal SecurityDeposit { get; set; }

        [Required(ErrorMessage = "Status is required")]
        [StringLength(50)]
        public string Status { get; set; } = "Active";

        [StringLength(1000, ErrorMessage = "Terms cannot exceed 1000 characters")]
        public string Terms { get; set; } = string.Empty;

        [StringLength(500, ErrorMessage = "Notes cannot exceed 500 characters")]
        public string Notes { get; set; } = string.Empty;
    }
}