@page "/propertymanagement/payments/edit/{PaymentId:int}"
@using Aquiis.SimpleStart.Components.PropertyManagement
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Components.Forms
@using System.ComponentModel.DataAnnotations
@inject NavigationManager Navigation
@inject PropertyManagementService PropertyManagementService

@attribute [Authorize(Roles = "PropertyManager")]
@rendermode InteractiveServer

<PageTitle>Edit Payment - Property Management</PageTitle>

@if (payment == null || paymentModel == null)
{
    <div class="text-center">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}
else
{
    <div class="row">
        <div class="col-lg-8">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1><span class="bi bi-pencil" aria-hidden="true"></span> Edit Payment</h1>
                <button class="btn btn-outline-secondary" @onclick="Cancel">
                    <i class="bi bi-x-lg"></i> Cancel
                </button>
            </div>

            <div class="card">
                <div class="card-body">
                    <EditForm Model="paymentModel" OnValidSubmit="HandleUpdatePayment" FormName="EditPayment">
                        <DataAnnotationsValidator />
                        <ValidationSummary class="text-danger" />

                        <div class="mb-3">
                            <label for="invoice" class="form-label">Invoice</label>
                            <input type="text" id="invoice" class="form-control" value="@payment.Invoice?.InvoiceNumber" disabled />
                            <small class="text-muted">Invoice cannot be changed after payment is created.</small>
                        </div>

                        <div class="mb-3">
                            <label for="paymentDate" class="form-label">Payment Date *</label>
                            <InputDate id="paymentDate" class="form-control" @bind-Value="paymentModel.PaidOn" />
                            <ValidationMessage For="() => paymentModel.PaidOn" />
                        </div>

                        <div class="mb-3">
                            <label for="amount" class="form-label">Amount *</label>
                            <InputNumber id="amount" class="form-control" @bind-Value="paymentModel.Amount" />
                            <ValidationMessage For="() => paymentModel.Amount" />
                            @if (payment.Invoice != null)
                            {
                                <small class="text-muted">
                                    Current invoice balance (before this edit): @currentInvoiceBalance.ToString("C")
                                </small>
                            }
                        </div>

                        <div class="mb-3">
                            <label for="paymentMethod" class="form-label">Payment Method *</label>
                            <InputSelect id="paymentMethod" class="form-select" @bind-Value="paymentModel.PaymentMethod">
                                <option value="">-- Select Payment Method --</option>
                                <option value="Cash">Cash</option>
                                <option value="Check">Check</option>
                                <option value="Credit Card">Credit Card</option>
                                <option value="Debit Card">Debit Card</option>
                                <option value="Bank Transfer">Bank Transfer</option>
                                <option value="Online Payment">Online Payment</option>
                                <option value="Other">Other</option>
                            </InputSelect>
                            <ValidationMessage For="() => paymentModel.PaymentMethod" />
                        </div>

                        <div class="mb-3">
                            <label for="notes" class="form-label">Notes</label>
                            <InputTextArea id="notes" class="form-control" rows="3" @bind-Value="paymentModel.Notes" />
                            <ValidationMessage For="() => paymentModel.Notes" />
                        </div>

                        <div class="d-flex justify-content-between">
                            <button type="button" class="btn btn-outline-secondary" @onclick="Cancel">Cancel</button>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-lg"></i> Save Changes
                            </button>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            @if (payment.Invoice != null)
            {
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="card-title mb-0">Invoice Information</h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="text-muted small">Invoice Number</label>
                            <p class="fw-bold">
                                <a href="/propertymanagement/invoices/view/@payment.Invoice.Id">
                                    @payment.Invoice.InvoiceNumber
                                </a>
                            </p>
                        </div>
                        <div class="mb-3">
                            <label class="text-muted small">Property</label>
                            <p>@payment.Invoice.Lease?.Property?.Address</p>
                        </div>
                        <div class="mb-3">
                            <label class="text-muted small">Tenant</label>
                            <p>@payment.Invoice.Lease?.Tenant?.FullName</p>
                        </div>
                        <hr />
                        <div class="mb-2">
                            <div class="d-flex justify-content-between">
                                <span class="text-muted">Invoice Amount:</span>
                                <span class="fw-bold">@payment.Invoice.Amount.ToString("C")</span>
                            </div>
                        </div>
                        <div class="mb-2">
                            <div class="d-flex justify-content-between">
                                <span class="text-muted">Total Paid:</span>
                                <span class="text-success">@payment.Invoice.AmountPaid.ToString("C")</span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between">
                                <span class="text-muted">Balance Due:</span>
                                <span class="fw-bold @(payment.Invoice.BalanceDue > 0 ? "text-danger" : "text-success")">
                                    @payment.Invoice.BalanceDue.ToString("C")
                                </span>
                            </div>
                        </div>
                        <div class="mb-2">
                            <div class="d-flex justify-content-between">
                                <span class="text-muted">Status:</span>
                                <span>
                                    @if (payment.Invoice.Status == "Paid")
                                    {
                                        <span class="badge bg-success">@payment.Invoice.Status</span>
                                    }
                                    else if (payment.Invoice.Status == "Partial")
                                    {
                                        <span class="badge bg-warning">Partially Paid</span>
                                    }
                                    else if (payment.Invoice.Status == "Overdue")
                                    {
                                        <span class="badge bg-danger">@payment.Invoice.Status</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-secondary">@payment.Invoice.Status</span>
                                    }
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h6 class="card-title mb-0">Current Payment</h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="text-muted small">Original Amount</label>
                            <p class="fw-bold">@payment.Amount.ToString("C")</p>
                        </div>
                        @if (paymentModel.Amount != payment.Amount)
                        {
                            <div class="mb-3">
                                <label class="text-muted small">New Amount</label>
                                <p class="fw-bold text-primary">@paymentModel.Amount.ToString("C")</p>
                            </div>
                            <div class="mb-3">
                                <label class="text-muted small">Change</label>
                                <p class="fw-bold @(amountDifference >= 0 ? "text-success" : "text-danger")">
                                    @(amountDifference >= 0 ? "+" : "")@amountDifference.ToString("C")
                                </p>
                            </div>
                            <hr />
                            <div>
                                <label class="text-muted small">New Invoice Balance</label>
                                <p class="fw-bold @(newInvoiceBalance > 0 ? "text-danger" : "text-success")">
                                    @newInvoiceBalance.ToString("C")
                                </p>
                            </div>
                            @if (newInvoiceBalance < 0)
                            {
                                <div class="alert alert-warning mt-2 mb-0">
                                    <small>Warning: Total payments exceed invoice amount.</small>
                                </div>
                            }
                            else if (newInvoiceBalance == 0)
                            {
                                <div class="alert alert-success mt-2 mb-0">
                                    <small>Invoice will be marked as Paid.</small>
                                </div>
                            }
                        }
                    </div>
                </div>
            }
        </div>
    </div>
}

@code {
    [Parameter]
    public int PaymentId { get; set; }

    private Payment? payment;
    private PaymentModel? paymentModel;

    private decimal currentInvoiceBalance => payment?.Invoice != null ? payment.Invoice.BalanceDue + payment.Amount : 0;
    private decimal amountDifference => paymentModel != null && payment != null ? paymentModel.Amount - payment.Amount : 0;
    private decimal newInvoiceBalance => currentInvoiceBalance - (paymentModel?.Amount ?? 0) + (payment?.Amount ?? 0);

    protected override async Task OnInitializedAsync()
    {
        payment = await PropertyManagementService.GetPaymentByIdAsync(PaymentId);

        if (payment == null)
        {
            Navigation.NavigateTo("/propertymanagement/payments");
            return;
        }

        paymentModel = new PaymentModel
        {
            PaidOn = payment.PaidOn,
            Amount = payment.Amount,
            PaymentMethod = payment.PaymentMethod,
            Notes = payment.Notes
        };
    }

    private async Task HandleUpdatePayment()
    {
        if (payment == null || paymentModel == null) return;

        payment.PaidOn = paymentModel.PaidOn;
        payment.Amount = paymentModel.Amount;
        payment.PaymentMethod = paymentModel.PaymentMethod;
        payment.Notes = paymentModel.Notes!;

        await PropertyManagementService.UpdatePaymentAsync(payment);
        Navigation.NavigateTo("/propertymanagement/payments");
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/propertymanagement/payments");
    }

    public class PaymentModel
    {
        [Required(ErrorMessage = "Payment date is required.")]
        public DateTime PaidOn { get; set; }

        [Required(ErrorMessage = "Amount is required.")]
        [Range(0.01, double.MaxValue, ErrorMessage = "Amount must be greater than zero.")]
        public decimal Amount { get; set; }

        [Required(ErrorMessage = "Payment method is required.")]
        public string PaymentMethod { get; set; } = string.Empty;

        [MaxLength(1000)]
        public string? Notes { get; set; }
    }
}
