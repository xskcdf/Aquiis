@page "/propertymanagement/invoices/view/{Id:int}"
@using Aquiis.SimpleStart.Components.PropertyManagement
@using Aquiis.SimpleStart.Components.PropertyManagement.Invoices
@using Aquiis.SimpleStart.Components.PropertyManagement.Documents
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Web
@inject NavigationManager NavigationManager
@inject PropertyManagementService PropertyManagementService
@inject IJSRuntime JSRuntime

@attribute [Authorize(Roles = "PropertyManager")]
@rendermode InteractiveServer

<PageTitle>View Invoice - Property Management</PageTitle>

@if (invoice == null)
{
    <div class="text-center">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}
else
{
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="bi bi-receipt"></i> Invoice Details</h1>
        <div>
            <button class="btn btn-outline-secondary" @onclick="BackToList">
                <i class="bi bi-arrow-left"></i> Back to List
            </button>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Invoice Information</h5>
                    <span class="badge @GetStatusBadgeClass(invoice.Status) fs-6">@invoice.Status</span>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="text-muted small">Invoice Number</label>
                                <div class="fw-bold fs-5">@invoice.InvoiceNumber</div>
                            </div>
                            <div class="mb-3">
                                <label class="text-muted small">Invoice Date</label>
                                <div>@invoice.InvoiceDate.ToString("MMMM dd, yyyy")</div>
                            </div>
                            <div class="mb-3">
                                <label class="text-muted small">Description</label>
                                <div>@invoice.Description</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="text-muted small">Due Date</label>
                                <div class="@(invoice.IsOverdue ? "text-danger fw-bold" : "")">
                                    @invoice.DueDate.ToString("MMMM dd, yyyy")
                                    @if (invoice.IsOverdue)
                                    {
                                        <br />
                                        <small>(@invoice.DaysOverdue days overdue)</small>
                                    }
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="text-muted small">Created Date</label>
                                <div>@invoice.CreatedOn.ToString("MMMM dd, yyyy")</div>
                            </div>
                        </div>
                    </div>

                    <hr />

                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="text-muted small">Invoice Amount</label>
                                <div class="fw-bold fs-4">@invoice.Amount.ToString("C")</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="text-muted small">Paid Amount</label>
                                <div class="fw-bold fs-4 text-success">@invoice.AmountPaid.ToString("C")</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="text-muted small">Balance Due</label>
                                <div class="fw-bold fs-4 @(invoice.BalanceDue > 0 ? "text-danger" : "text-success")">
                                    @invoice.BalanceDue.ToString("C")
                                </div>
                            </div>
                        </div>
                    </div>

                    @if (invoice.PaidOn.HasValue)
                    {
                        <div class="mb-3">
                            <label class="text-muted small">Paid Date</label>
                            <div>@invoice.PaidOn.Value.ToString("MMMM dd, yyyy")</div>
                        </div>
                    }

                    @if (!string.IsNullOrWhiteSpace(invoice.Notes))
                    {
                        <hr />
                        <div class="mb-3">
                            <label class="text-muted small">Notes</label>
                            <div class="border p-2 rounded bg-light">@invoice.Notes</div>
                        </div>
                    }
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="mb-0">Lease Information</h5>
                </div>
                <div class="card-body">
                    @if (invoice.Lease != null)
                    {
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="text-muted small">Property</label>
                                    <div>
                                        <a href="/propertymanagement/properties/view/@invoice.Lease.PropertyId" class="text-decoration-none">
                                            @invoice.Lease.Property?.Address
                                        </a>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="text-muted small">Lease Period</label>
                                    <div>
                                        @invoice.Lease.StartDate.ToString("MMM dd, yyyy") - 
                                        @invoice.Lease.EndDate.ToString("MMM dd, yyyy")
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="text-muted small">Tenant</label>
                                    <div>
                                        <a href="/propertymanagement/tenants/view/@invoice.Lease.TenantId" class="text-decoration-none">
                                            @invoice.Lease.Tenant?.FullName
                                        </a>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="text-muted small">Monthly Rent</label>
                                    <div>@invoice.Lease.MonthlyRent.ToString("C")</div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>

            @if (invoice.Payments != null && invoice.Payments.Any())
            {
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Payment History</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Amount</th>
                                        <th>Method</th>
                                        <th>Notes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var payment in invoice.Payments.OrderByDescending(p => p.PaymentDate))
                                    {
                                        <tr>
                                            <td>@payment.PaymentDate.ToString("MMM dd, yyyy")</td>
                                            <td>@payment.Amount.ToString("C")</td>
                                            <td>@payment.PaymentMethod</td>
                                            <td>@payment.Notes</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            }
        </div>

        <div class="col-md-4">
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="mb-0">Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary" @onclick="EditInvoice">
                            <i class="bi bi-pencil"></i> Edit Invoice
                        </button>
                        @if (invoice.Status != "Paid" && invoice.BalanceDue > 0)
                        {
                            <button class="btn btn-outline-success" @onclick="RecordPayment">
                                <i class="bi bi-cash"></i> Record Payment
                            </button>
                        }
                        <button class="btn btn-outline-info" @onclick="ViewLease">
                            <i class="bi bi-file-text"></i> View Lease
                        </button>
                        @if (invoice.DocumentId == null)
                        {
                            <button class="btn btn-outline-secondary" @onclick="GenerateInvoicePdf" disabled="@isGenerating">
                                @if (isGenerating)
                                {
                                    <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                                }
                                else
                                {
                                    <i class="bi bi-file-pdf"></i>
                                }
                                Generate PDF
                            </button>
                        }
                        else
                        {
                            <button class="btn btn-primary" @onclick="ViewDocument">
                                <i class="bi bi-eye"></i> View PDF
                            </button>
                            <button class="btn btn-outline-primary" @onclick="DownloadDocument">
                                <i class="bi bi-download"></i> Download PDF
                            </button>
                        }
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Metadata</h5>
                </div>
                <div class="card-body">
                    <div class="mb-2">
                        <small class="text-muted">Created By:</small>
                        <div>@(!string.IsNullOrEmpty(invoice.CreatedBy) ? invoice.CreatedBy : "System")</div>
                    </div>
                    @if (invoice.LastModifiedOn.HasValue)
                    {
                        <div class="mb-2">
                            <small class="text-muted">Last Modified:</small>
                            <div>@invoice.LastModifiedOn.Value.ToString("MMM dd, yyyy h:mm tt")</div>
                        </div>
                        <div class="mb-2">
                            <small class="text-muted">Modified By:</small>
                            <div>@(!string.IsNullOrEmpty(invoice.LastModifiedBy) ? invoice.LastModifiedBy : "System")</div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public int Id { get; set; }

    private Invoice? invoice;
    private bool isGenerating = false;
    private Document? document = null;

    [CascadingParameter]
    private Task<AuthenticationState> AuthenticationStateTask { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        await LoadInvoice();
    }

    private async Task LoadInvoice()
    {
        invoice = await PropertyManagementService.GetInvoiceByIdAsync(Id);
        
        // Load the document if it exists
        if (invoice?.DocumentId != null)
        {
            document = await PropertyManagementService.GetDocumentByIdAsync(invoice.DocumentId.Value);
        }
    }

    private string GetStatusBadgeClass(string status)
    {
        return status switch
        {
            "Paid" => "bg-success",
            "Pending" => "bg-warning",
            "Overdue" => "bg-danger",
            "Cancelled" => "bg-secondary",
            _ => "bg-info"
        };
    }

    private void BackToList()
    {
        NavigationManager.NavigateTo("/propertymanagement/invoices");
    }

    private void EditInvoice()
    {
        NavigationManager.NavigateTo($"/propertymanagement/invoices/edit/{Id}");
    }

    private void RecordPayment()
    {
        NavigationManager.NavigateTo($"/propertymanagement/payments/create?invoiceId={Id}");
    }

    private void ViewLease()
    {
        if (invoice?.LeaseId != null)
        {
            NavigationManager.NavigateTo($"/propertymanagement/leases/view/{invoice.LeaseId}");
        }
    }

    private async Task ViewDocument()
    {
        if (document != null)
        {
            var base64Data = Convert.ToBase64String(document.FileData);
            await JSRuntime.InvokeVoidAsync("viewFile", base64Data, document.FileType);
        }
    }

    private async Task DownloadDocument()
    {
        if (document != null)
        {
            var fileName = document.FileName;
            var fileData = document.FileData;
            var mimeType = document.FileType;

            await JSRuntime.InvokeVoidAsync("downloadFile", fileName, Convert.ToBase64String(fileData), mimeType);
        }
    }

    private async Task GenerateInvoicePdf()
    {
        isGenerating = true;
        StateHasChanged();

        try
        {
            // Get current user info
            var authState = await AuthenticationStateTask;
            var userId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            var userName = authState.User.Identity?.Name ?? "System";

            if (string.IsNullOrEmpty(userId))
            {
                await JSRuntime.InvokeVoidAsync("alert", "Unable to determine current user.");
                return;
            }

            // Generate the PDF
            byte[] pdfBytes = InvoicePdfGenerator.GenerateInvoicePdf(invoice!);

            // Create the document entity
            var document = new Document
            {
                UserId = userId,
                FileName = $"Invoice_{invoice!.InvoiceNumber?.Replace(" ", "_")}_{DateTime.Now:yyyyMMdd}.pdf",
                FileExtension = ".pdf",
                FileData = pdfBytes,
                FileSize = pdfBytes.Length,
                FileType = "application/pdf",
                ContentType = "application/pdf",
                DocumentType = "Invoice",
                Description = $"Invoice {invoice.InvoiceNumber}",
                LeaseId = invoice.LeaseId,
                PropertyId = invoice.Lease?.PropertyId,
                TenantId = invoice.Lease?.TenantId,
                UploadedBy = userName,
                CreatedBy = userId,
                CreatedOn = DateTime.UtcNow,
                LastModifiedBy = userId,
                LastModifiedOn = DateTime.UtcNow,
                IsDeleted = false
            };

            // Save to database
            await PropertyManagementService.AddDocumentAsync(document);

            // Update invoice with DocumentId
            invoice.DocumentId = document.Id;
            invoice.LastModifiedOn = DateTime.UtcNow;
            invoice.LastModifiedBy = userId;
            await PropertyManagementService.UpdateInvoiceAsync(invoice);

            // Reload invoice and document
            await LoadInvoice();
            StateHasChanged();

            await JSRuntime.InvokeVoidAsync("alert", "Invoice PDF generated successfully!");
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error generating invoice PDF: {ex.Message}");
        }
        finally
        {
            isGenerating = false;
            StateHasChanged();
        }
    }
}
