@page "/administration/users/manage"
@using Aquiis.SimpleStart.Services
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using Aquiis.SimpleStart.Components.Account
@inject UserManager<ApplicationUser> UserManager
@inject UserContextService UserContext
@inject RoleManager<IdentityRole> RoleManager
@inject NavigationManager Navigation
@rendermode InteractiveServer

<AuthorizeView Roles="SuperAdministrator, Administrator">
    <Authorized>
        <!-- User management UI goes here -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="bi bi-people-fill"></i> User Management</h1>
            <div class="btn-group">
                <a href="/administration/users/create" class="btn btn-primary">
                    <i class="bi bi-person-plus-fill"></i> Add User
                </a>
                <button class="btn btn-secondary" @onclick="BackToDashboard">
                    <i class="bi bi-arrow-left"></i> Back to Dashboard
                </button>
            </div>
        </div>

@if (isLoading)
{
    <div class="text-center">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}
else
{
    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-white bg-primary">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4>@totalUsers</h4>
                            <p class="card-text">Total Users</p>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-people-fill" style="font-size: 2rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-success">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4>@activeUsers</h4>
                            <p class="card-text">Active Users</p>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-check-circle" style="font-size: 2rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-info">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4>@adminUsers</h4>
                            <p class="card-text">Admin Users</p>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-shield-check" style="font-size: 2rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
             <div class="col-md-3">
            <div class="card text-white bg-warning">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4>@lockedUsers</h4>
                            <p class="card-text">Locked Accounts</p>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-lock-fill" style="font-size: 2rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="row mb-3">
        <div class="col-md-4">
            <div class="input-group">
                <span class="input-group-text"><i class="bi bi-search"></i></span>
                <input type="text" class="form-control" placeholder="Search users by name, email, or phone..." @bind="searchTerm" @onkeyup="FilterUsers" />
            </div>
        </div>
        <div class="col-md-3">
            <select class="form-select" @bind="selectedRole" @bind:after="FilterUsers">
                <option value="">All Roles</option>
                @foreach (var role in availableRoles)
                {
                    <option value="@role">@role</option>
                }
            </select>
        </div>
        <div class="col-md-3">
            <select class="form-select" @bind="selectedStatus" @bind:after="FilterUsers">
                <option value="">All Status</option>
                <option value="Active">Active</option>
                <option value="Locked">Locked Out</option>
            </select>
        </div>
        <div class="col-md-2">
            <button class="btn btn-outline-secondary" @onclick="ClearFilters">
                <i class="bi bi-x-circle"></i> Clear
            </button>
        </div>
    </div>

    <!-- Success/Error Messages -->
    @if (!string.IsNullOrEmpty(successMessage))
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @successMessage
            <button type="button" class="btn-close" @onclick="() => successMessage = null"></button>
        </div>
    }

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @errorMessage
            <button type="button" class="btn-close" @onclick="() => errorMessage = null"></button>
        </div>
    }

    <!-- Users Table -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">User Accounts (@filteredUsers.Count users)</h5>
        </div>
        <div class="card-body p-0">
            @if (filteredUsers.Any())
            {
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>User</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Role</th>
                                <th>Status</th>
                                <th>Last Login</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var userInfo in filteredUsers)
                            {
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-circle me-2">
                                                @GetUserInitials(userInfo.User.Email)
                                            </div>
                                            <div>
                                                <a href="/administration/users/view/@userInfo.User.Id" class="text-decoration-none">
                                                    <strong>@(userInfo.User.UserName ?? userInfo.User.Email)</strong>
                                                </a>
                                                @if (userInfo.User.EmailConfirmed)
                                                {
                                                    <i class="bi bi-check-circle-fill text-success ms-1" title="Email Confirmed"></i>
                                                }
                                            </div>
                                        </div>
                                    </td>
                                    <td>@userInfo.User.Email</td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(userInfo.User.PhoneNumber))
                                        {
                                            <span class="text-muted">@userInfo.User.PhoneNumber</span>
                                        }
                                        else
                                        {
                                            <small class="text-muted">Not provided</small>
                                        }
                                    </td>
                                    <td>
                                        @if (userInfo.Roles.Any())
                                        {
                                            @foreach (var role in userInfo.Roles)
                                            {
                                                <span class="badge @GetRoleBadgeClass(role) me-1">@role</span>
                                            }
                                        }
                                        else
                                        {
                                            <span class="text-muted">No Role</span>
                                        }
                                    </td>
                                    <td>
                                        @if (userInfo.IsLockedOut)
                                        {
                                            <span class="badge bg-danger">
                                                <i class="bi bi-lock"></i> Locked Out
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-success">
                                                <i class="bi bi-check-circle"></i> Active
                                            </span>
                                        }
                                    </td>
                                    <td>
                                        @if (userInfo.User.LastLoginDate.HasValue)
                                        {
                                            <div>
                                                <small class="text-muted">@userInfo.User.LastLoginDate.Value.ToString("MMM dd, yyyy")</small>
                                                <br />
                                                <small class="text-muted">@userInfo.User.LastLoginDate.Value.ToString("h:mm tt")</small>
                                            </div>
                                            @if (userInfo.User.LoginCount > 0)
                                            {
                                                <small class="badge bg-light text-dark">@userInfo.User.LoginCount logins</small>
                                            }
                                        }
                                        else
                                        {
                                            <small class="text-muted">Never</small>
                                        }
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            @if (userInfo.IsLockedOut)
                                            {
                                                <button class="btn btn-outline-success" @onclick="() => UnlockUser(userInfo.User)" title="Unlock User">
                                                    <i class="bi bi-unlock"></i>
                                                </button>
                                            }
                                            else
                                            {
                                                <button class="btn btn-outline-warning" @onclick="() => LockUser(userInfo.User)" title="Lock User">
                                                    <i class="bi bi-lock"></i>
                                                </button>
                                            }
                                            <button class="btn btn-outline-primary" @onclick="() => EditUserRoles(userInfo)" title="Edit Roles">
                                                <i class="bi bi-person-gear"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="text-center py-4">
                    <i class="bi bi-people display-1 text-muted"></i>
                    <h4 class="text-muted">No users found</h4>
                    <p class="text-muted">Try adjusting your search filters.</p>
                </div>
            }
        </div>
    </div>
}

<!-- Role Edit Modal -->
@if (showRoleModal && selectedUserForEdit != null)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Roles - @selectedUserForEdit.User.Email</h5>
                    <button type="button" class="btn-close" @onclick="CloseRoleModal"></button>
                </div>
                <div class="modal-body">
                    <EditForm Model="roleEditModel" OnValidSubmit="SaveUserRoles" Context="editFormContext">
                        <DataAnnotationsValidator />
                        
                        <div class="mb-3">
                            <label class="form-label">Select Roles</label>
                            @foreach (var role in availableRoles)
                            {
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" 
                                           @bind="roleEditModel.SelectedRoles[role]" 
                                           id="role-@role" />
                                    <label class="form-check-label" for="role-@role">
                                        @role
                                    </label>
                                </div>
                            }
                        </div>
                    </EditForm>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseRoleModal">Cancel</button>
                    <button type="button" class="btn btn-primary" @onclick="SaveUserRoles">Save Changes</button>
                </div>
            </div>
        </div>
    </div>
}

<style>
.avatar-circle {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background-color: #6c757d;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: bold;
}
</style>
    </Authorized>
    <NotAuthorized>
        <p>You are not authorized to view this page.</p>
    </NotAuthorized>
</AuthorizeView>

@code {
    private bool isLoading = true;
    private List<UserInfo> allUsers = new();
    private List<UserInfo> filteredUsers = new();
    private List<string> availableRoles = new();
    
    private string searchTerm = string.Empty;
    private string selectedRole = string.Empty;
    private string selectedStatus = string.Empty;
    
    private int totalUsers = 0;
    private int activeUsers = 0;
    private int lockedUsers = 0;
    private int adminUsers = 0;
    
    private string? successMessage;
    private string? errorMessage;
    
    // Role editing
    private bool showRoleModal = false;
    private UserInfo? selectedUserForEdit;
    private RoleEditModel roleEditModel = new();

    private string organizationId = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        // One line instead of 10+!
        organizationId = await UserContext!.GetOrganizationIdAsync() ?? string.Empty;
        await LoadData();
        isLoading = false;
    }

    private async Task LoadData()
    {
        try
        {
            // Load all users with their roles
            List<ApplicationUser>? users = await UserManager.Users.Where(u => u.OrganizationId == organizationId).ToListAsync();
            allUsers.Clear();
            
            foreach (var user in users)
            {
                var roles = await UserManager.GetRolesAsync(user);
                var isLockedOut = await UserManager.IsLockedOutAsync(user);
                
                allUsers.Add(new UserInfo
                {
                    User = (ApplicationUser)user,
                    Roles = roles.ToList(),
                    IsLockedOut = isLockedOut
                });
            }
            
            // Load available roles
            availableRoles = await RoleManager.Roles.Select(r => r.Name!).ToListAsync();
            
            // Calculate statistics
            CalculateStatistics();
            
            // Filter users
            FilterUsers();
        }
        catch (Exception ex)
        {
            errorMessage = "Error loading user data: " + ex.Message;
        }
    }

    private void BackToDashboard()
    {
        Navigation.NavigateTo("/administration/dashboard");
    }

    private void CalculateStatistics()
    {
        totalUsers = allUsers.Count;
        activeUsers = allUsers.Count(u => !u.IsLockedOut);
        lockedUsers = allUsers.Count(u => u.IsLockedOut);
        adminUsers = allUsers.Count(u => u.Roles.Contains("Admin"));
    }

    private void FilterUsers()
    {
        filteredUsers = allUsers.Where(u =>
            (string.IsNullOrEmpty(searchTerm) || 
             u.User.Email!.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
             (u.User.UserName != null && u.User.UserName.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)) ||
             (!string.IsNullOrEmpty(u.User.PhoneNumber) && u.User.PhoneNumber.Contains(searchTerm, StringComparison.OrdinalIgnoreCase))) &&
            (string.IsNullOrEmpty(selectedRole) || u.Roles.Contains(selectedRole)) &&
            (string.IsNullOrEmpty(selectedStatus) || 
             (selectedStatus == "Active" && !u.IsLockedOut) ||
             (selectedStatus == "Locked" && u.IsLockedOut))
        ).ToList();
    }

    private async Task LockUser(ApplicationUser user)
    {
        try
        {
            var result = await UserManager.SetLockoutEndDateAsync(user, DateTimeOffset.UtcNow.AddYears(100));
            if (result.Succeeded)
            {
                successMessage = $"User {user.Email} has been locked out.";
                await LoadData();
            }
            else
            {
                errorMessage = "Failed to lock user: " + string.Join(", ", result.Errors.Select(e => e.Description));
            }
        }
        catch (Exception ex)
        {
            errorMessage = "Error locking user: " + ex.Message;
        }
    }

    private async Task UnlockUser(ApplicationUser user)
    {
        try
        {
            var result = await UserManager.SetLockoutEndDateAsync(user, null);
            if (result.Succeeded)
            {
                successMessage = $"User {user.Email} has been unlocked.";
                await LoadData();
            }
            else
            {
                errorMessage = "Failed to unlock user: " + string.Join(", ", result.Errors.Select(e => e.Description));
            }
        }
        catch (Exception ex)
        {
            errorMessage = "Error unlocking user: " + ex.Message;
        }
    }

    private void EditUserRoles(UserInfo userInfo)
    {
        selectedUserForEdit = userInfo;
        roleEditModel = new RoleEditModel();
        
        // Initialize role selections
        foreach (var role in availableRoles)
        {
            roleEditModel.SelectedRoles[role] = userInfo.Roles.Contains(role);
        }
        
        showRoleModal = true;
    }

    private async Task SaveUserRoles()
    {
        if (selectedUserForEdit == null) return;

        try
        {
            var user = selectedUserForEdit.User;
            var currentRoles = await UserManager.GetRolesAsync(user);
            var selectedRoles = roleEditModel.SelectedRoles.Where(kvp => kvp.Value).Select(kvp => kvp.Key).ToList();

            // Remove user from roles they're no longer assigned to
            var rolesToRemove = currentRoles.Except(selectedRoles).ToList();
            if (rolesToRemove.Any())
            {
                var removeResult = await UserManager.RemoveFromRolesAsync(user, rolesToRemove);
                if (!removeResult.Succeeded)
                {
                    errorMessage = "Failed to remove roles: " + string.Join(", ", removeResult.Errors.Select(e => e.Description));
                    return;
                }
            }

            // Add user to new roles
            var rolesToAdd = selectedRoles.Except(currentRoles).ToList();
            if (rolesToAdd.Any())
            {
                var addResult = await UserManager.AddToRolesAsync(user, rolesToAdd);
                if (!addResult.Succeeded)
                {
                    errorMessage = "Failed to add roles: " + string.Join(", ", addResult.Errors.Select(e => e.Description));
                    return;
                }
            }

            successMessage = $"Roles updated for {user.Email}.";
            CloseRoleModal();
            await LoadData();
        }
        catch (Exception ex)
        {
            errorMessage = "Error updating roles: " + ex.Message;
        }
    }

    private void CloseRoleModal()
    {
        showRoleModal = false;
        selectedUserForEdit = null;
        roleEditModel = new();
    }

    private void ClearFilters()
    {
        searchTerm = string.Empty;
        selectedRole = string.Empty;
        selectedStatus = string.Empty;
        FilterUsers();
    }

    private string GetUserInitials(string? email)
    {
        if (string.IsNullOrEmpty(email)) return "?";
        var parts = email.Split('@')[0].Split('.');
        if (parts.Length >= 2)
            return (parts[0][0].ToString() + parts[1][0].ToString()).ToUpper();
        return email[0].ToString().ToUpper();
    }

    private string GetRoleBadgeClass(string role)
    {
        return role switch
        {
            "Admin" => "bg-danger",
            "User" => "bg-primary",
            "Guest" => "bg-secondary",
            _ => "bg-info"
        };
    }

    private class UserInfo
    {
        public ApplicationUser User { get; set; } = default!;
        public List<string> Roles { get; set; } = new();
        public bool IsLockedOut { get; set; }
    }

    private class RoleEditModel
    {
        public Dictionary<string, bool> SelectedRoles { get; set; } = new();
    }
}